"use strict";(self.webpackChunklun_dao=self.webpackChunklun_dao||[]).push([[18],{3905:(t,e,n)=>{n.d(e,{Zo:()=>p,kt:()=>m});var a=n(7294);function o(t,e,n){return e in t?Object.defineProperty(t,e,{value:n,enumerable:!0,configurable:!0,writable:!0}):t[e]=n,t}function r(t,e){var n=Object.keys(t);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(t);e&&(a=a.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),n.push.apply(n,a)}return n}function i(t){for(var e=1;e<arguments.length;e++){var n=null!=arguments[e]?arguments[e]:{};e%2?r(Object(n),!0).forEach((function(e){o(t,e,n[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(n,e))}))}return t}function l(t,e){if(null==t)return{};var n,a,o=function(t,e){if(null==t)return{};var n,a,o={},r=Object.keys(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||(o[n]=t[n]);return o}(t,e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(t);for(a=0;a<r.length;a++)n=r[a],e.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(t,n)&&(o[n]=t[n])}return o}var c=a.createContext({}),s=function(t){var e=a.useContext(c),n=e;return t&&(n="function"==typeof t?t(e):i(i({},e),t)),n},p=function(t){var e=s(t.components);return a.createElement(c.Provider,{value:e},t.children)},u="mdxType",g={inlineCode:"code",wrapper:function(t){var e=t.children;return a.createElement(a.Fragment,{},e)}},d=a.forwardRef((function(t,e){var n=t.components,o=t.mdxType,r=t.originalType,c=t.parentName,p=l(t,["components","mdxType","originalType","parentName"]),u=s(n),d=o,m=u["".concat(c,".").concat(d)]||u[d]||g[d]||r;return n?a.createElement(m,i(i({ref:e},p),{},{components:n})):a.createElement(m,i({ref:e},p))}));function m(t,e){var n=arguments,o=e&&e.mdxType;if("string"==typeof t||o){var r=n.length,i=new Array(r);i[0]=d;var l={};for(var c in e)hasOwnProperty.call(e,c)&&(l[c]=e[c]);l.originalType=t,l[u]="string"==typeof t?t:o,i[1]=l;for(var s=2;s<r;s++)i[s]=n[s];return a.createElement.apply(null,i)}return a.createElement.apply(null,n)}d.displayName="MDXCreateElement"},7826:(t,e,n)=>{n.r(e),n.d(e,{assets:()=>c,contentTitle:()=>i,default:()=>g,frontMatter:()=>r,metadata:()=>l,toc:()=>s});var a=n(7462),o=(n(7294),n(3905));const r={title:"Diamond 101 (3)",description:"EIP-2535 Diamond Contract",slug:"diamond101-3",tags:["eip2535","diamond","proxy"],authors:"wiasliaw"},i=void 0,l={permalink:"/blog/diamond101-3",editUrl:"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-07-04-diamond101/diamond101-3.md",source:"@site/blog/2022-07-04-diamond101/diamond101-3.md",title:"Diamond 101 (3)",description:"EIP-2535 Diamond Contract",date:"2022-07-04T00:00:00.000Z",formattedDate:"July 4, 2022",tags:[{label:"eip2535",permalink:"/blog/tags/eip-2535"},{label:"diamond",permalink:"/blog/tags/diamond"},{label:"proxy",permalink:"/blog/tags/proxy"}],readingTime:3.79,truncated:!0,authors:[{name:"wiasliaw",url:"https://github.com/wiasliaw",imageURL:"https://github.com/wiasliaw.png",key:"wiasliaw"}],prevItem:{title:"Diamond 101 (2)",permalink:"/blog/diamond101-2"},nextItem:{title:"Hardhat tracer",permalink:"/blog/hardhat-tracer"}},c={authorsImageUrls:[void 0]},s=[{value:"Storage Management",id:"storage-management",children:[{value:"1. EIP-1967",id:"1-eip-1967",children:[],level:3},{value:"2. AppStorage",id:"2-appstorage",children:[],level:3}],level:2},{value:"Reference",id:"reference",children:[],level:2}],p={toc:s},u="wrapper";function g(t){let{components:e,...n}=t;return(0,o.kt)(u,(0,a.Z)({},p,n,{components:e,mdxType:"MDXLayout"}),(0,o.kt)("p",null,"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u4e09\u7bc7\u6587\u7ae0\uff0c\u5c07\u89e3\u91cb\u9019\u500b EIP \u5177\u9ad4\u7684\u5be6\u4f5c\u7d30\u7bc0\u3002"),(0,o.kt)("p",null,"\u4e0a\u4e00\u7bc7",(0,o.kt)("a",{parentName:"p",href:"/blog/diamond101-2"},"\u6587\u7ae0"),"\u4ecb\u7d39\u4e86 Diamond \u7684 Lookup Table\uff0c\u7528\u4f86\u7d00\u9304 function selector \u548c\u8981\u8abf\u7528\u7684\u5408\u7d04\u5730\u5740\u9032\u53bb\uff0c\u7576\u9700\u8981\u8abf\u7528\u5408\u7d04\u6642\u5247\u6703\u900f\u904e ",(0,o.kt)("inlineCode",{parentName:"p"},"msg.sig")," \u67e5\u8a62 Lookup Table\uff0c\u4e26 delegatecall \u5230\u7d00\u9304\u7684\u5730\u5740\u3002"),(0,o.kt)("h2",{id:"storage-management"},"Storage Management"),(0,o.kt)("p",null,"\u5148\u770b\u770b\u4e4b\u524d\u7684 Proxy \u600e\u9ebc\u7ba1\u7406 storage\u3002Transparent Proxy \u8ddf UUPS \u4e3b\u8981\u7684 storage layout \u90fd\u662f\u5b9a\u7fa9\u5728 Logic Contract \u4e0a\uff0cProxy \u7d00\u9304\u7684\u5730\u5740\u90fd\u6703\u5132\u5b58\u5728\u7279\u5b9a\u7684 slot \u4e0a (\u53c3\u8003 EIP-1967)\uff0c Upgrade \u6642\u5247\u63db\u6389\u8a18\u9304\u5728 Proxy \u4e0a\u7684\u5730\u5740\uff0c\u5c0d\u958b\u767c\u8005\u4f86\u8aaa\u53ea\u8981\u8655\u7406\u597d\u65b0\u7684 Logic Contract \u4e0d\u8981\u8ddf\u820a\u7684\u5408\u7d04\u767c\u751f storage collision \u5373\u53ef\u3002\u800c Diamond \u8981\u7ba1\u7406 Lookup Table \u7684 storage \u9084\u6709\u6578\u500b Logic Contract \u8981\u5132\u5b58\u548c\u5beb\u5165\u7684 storage\u3002\u9019\u908a\u4ee5\u300c\u4e0d\u540c Logic Contract \u7684\u8655\u7406\u300d\u8209\u4f8b\u3002"),(0,o.kt)("p",null,"\u770b\u770b\u4e0b\u9762\u5169\u500b Logic Contract\uff0c\u5982\u679c\u8a3b\u518a\u5230 Diamond \u88e1\u9762\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\uff1f\u56e0\u70ba\u5169\u500b\u51fd\u5f0f\u7684 side effect \u90fd\u662f\u4f5c\u7528\u5728\u540c\u4e00\u500b slot \u4e0a\uff0c\u5148\u8abf\u7528 ",(0,o.kt)("inlineCode",{parentName:"p"},"setA")," \u5beb\u5165\u7684\u6578\u503c\u4e4b\u5f8c\u518d\u8abf\u7528 ",(0,o.kt)("inlineCode",{parentName:"p"},"setB")," \u5c31\u6703\u88ab\u8986\u5beb\u6389\u3002\u800c Solidity \u6c92\u6709\u90a3\u9ebc\u8070\u660e\u77e5\u9053\u9019\u500b slot \u5c08\u5c6c\u65bc\u54ea\u500b Logic Contract \u4e26\u9632\u6b62\u5176\u4ed6 Logic Contract \u5beb\u5165\uff0c\u56e0\u6b64\u4ee5 Diamond \u8a2d\u8a08\u7684\u5408\u7d04\u67b6\u69cb\u9700\u8981\u8a2d\u8a08\u4e00\u5957 storage \u7684\u7ba1\u7406\u6a5f\u5236\u4f86\u9650\u5236 Logic Contract\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"contract LogicA {\n  uint256 private _a; // slot 0\n\n  function setA(uint256 a_) external {\n    _a = a_;\n  }\n}\n\ncontract LogicB {\n  uint256 private _b; // slot 0\n\n  function setB(uint256 b_) external {\n    _b = b_;\n  } \n}\n")),(0,o.kt)("h3",{id:"1-eip-1967"},"1. EIP-1967"),(0,o.kt)("p",null,"EIP-2535 \u6c92\u6709\u898f\u5b9a\u5982\u4f55\u7ba1\u7406 storage\u3002\u4f46\u662f\u4f5c\u8005\u5728\u5176\u4ed6\u6587\u7ae0\u63d0\u51fa\u76f8\u95dc\u7684\u505a\u6cd5\u3002\u7b2c\u4e00\u500b\u662f\u53c3\u8003 EIP-1967 \u5c07\u8cc7\u6599\u64fa\u5230\u7279\u5b9a\u7684 slot \u4e0a\u3002\u6bcf\u500b Logic Contract \u90fd\u5b9a\u7fa9\u4e00\u500b\u7279\u5b9a\u7684\u5730\u65b9\u4f86\u653e\u8cc7\u6599\u5c31\u4e0d\u6703\u767c\u751f storage collision \u4e86\u3002Lookup Table \u4e5f\u662f\u4e00\u6a23\uff0c\u653e\u5230\u7279\u5b9a\u7684 slot \u4e0a\uff0c\u4e5f\u4e0d\u6703\u548c LogicA, LogicB \u767c\u751f storage collision\u3002"),(0,o.kt)("p",null,"\u62ff\u4e0a\u9762\u5169\u500b\u5408\u7d04\u4fee\u6539\uff0c\u5982\u4e0b\u3002Solidity \u53ef\u4ee5 inline assembly \u6307\u5b9a\u8981\u8cc7\u6599\u8981\u653e\u5230\u54ea\u500b slot \u88e1\uff0c\u901a\u5e38\u4ee5\u4e00\u6bb5\u5b57\u4e32\u7684\u96dc\u6e4a\u4f5c\u70ba\u7279\u5b9a\u7684 index \u5132\u5b58\u3002"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},'contract LogicA {\n  bytes32 constant private _slot_a = keccak256("logic_a");\n\n  struct AStorage {\n    uint256 value; // slot[keccak256("logic_a")]\n  }\n\n  function _storage() private pure returns (AStorage storage s) {\n      bytes32 position = _slot_a;\n      assembly {\n          s.slot := position\n      }\n  }\n\n  function setA(uint256 a_) external {\n    _storage().value = a_;\n  }\n}\n\ncontract LogicB {\n  bytes32 constant private _slot_b = keccak256("logic_b");\n\n  struct BStorage {\n    uint256 value; // slot[keccak256("logic_b")]\n  }\n\n  function _storage() private pure returns (BStorage storage s) {\n      bytes32 position = _slot_b;\n      assembly {\n          s.slot := position\n      }\n  }\n\n  function setB(uint256 b_) external {\n    _storage().value = b_;\n  } \n}\n')),(0,o.kt)("h3",{id:"2-appstorage"},"2. AppStorage"),(0,o.kt)("p",null,"\u4f5c\u8005\u63d0\u51fa\u7684\u53e6\u5916\u4e00\u500b\u4f5c\u6cd5\u7a31\u70ba ",(0,o.kt)("inlineCode",{parentName:"p"},"AppStorage"),"\uff0c\u5728\u6bcf\u500b\u5408\u7d04\u90fd\u5b9a\u7fa9\u597d\u4e00\u6a21\u4e00\u6a23\u7684 layout\uff0c\u5c31\u4e0d\u6703\u6709\u8aa4\u5beb\u5230\u5176\u4ed6 slot \u4e86\u3002\u53ef\u4ee5\u53c3\u8003 ",(0,o.kt)("a",{parentName:"p",href:"https://github.com/aavegotchi/aavegotchi-contracts/blob/ff456818465623d9d718869da9047ddce54d9a6e/contracts/Aavegotchi/libraries/LibAppStorage.sol#L189"},"aavegotchi")," \u600e\u9ebc\u5b9a\u7fa9 AppStorage \u7684\u3002\u4e0d\u904e aavegotchi \u4e2d Lookup Table \u9084\u662f\u4f7f\u7528 EIP-1967 \u7684\u65b9\u5f0f\u653e\u5728\u5225\u7684 slot\u3002"),(0,o.kt)("p",null,"\u62ff\u4e0a\u9762\u5169\u500b\u5408\u7d04\u4fee\u6539\uff0c\u5982\u4e0b\uff1a"),(0,o.kt)("pre",null,(0,o.kt)("code",{parentName:"pre",className:"language-javascript"},"contract LogicA {\n  struct GlobalStruct {\n    uint256 a; // slot 0\n    uint256 b; // slot 1\n  }\n\n  GlobalStruct private _gs;\n\n  function setA(uint256 a_) external {\n    _gs.a = a_;\n  }\n}\n\ncontract LogicB {\n  struct GlobalStruct {\n    uint256 a; // slot 0\n    uint256 b; // slot 1\n  }\n\n  GlobalStruct private _gs;\n\n  function setB(uint256 b_) external {\n    _gs.b = b_;\n  } \n}\n")),(0,o.kt)("h2",{id:"reference"},"Reference"),(0,o.kt)("ul",null,(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://eip2535diamonds.substack.com/"},"eip2535 diamonds substack")),(0,o.kt)("li",{parentName:"ul"},(0,o.kt)("a",{parentName:"li",href:"https://github.com/aavegotchi/aavegotchi-contracts"},"aavegotchi contract"))))}g.isMDXComponent=!0}}]);