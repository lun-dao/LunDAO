"use strict";(self.webpackChunklun_dao=self.webpackChunklun_dao||[]).push([[1477],{10:n=>{n.exports=JSON.parse('{"blogPosts":[{"id":"end-of-lundao","metadata":{"permalink":"/blog/end-of-lundao","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2024-01-30-lundao-end/end-of-lundao.md","source":"@site/blog/2024-01-30-lundao-end/end-of-lundao.md","title":"LunDAO \u7684\u7d50\u5c3e","description":"\u7d93\u904e\u9019\u6bb5\u6642\u9593\u7684\u904b\u4f5c\u4e4b\u5f8c\u53ef\u4ee5\u767c\u73fe\uff0cDAO \u7684\u672c\u8cea\u5c31\u662f\u793e\u7fa4\uff0c\u4ed6\u8ddf\u4e00\u822c\u7684\u611b\u597d\u8005\u7fa4\u9ad4\u4e26\u7121\u4e0d\u540c\uff0c\u5c31\u5982\u540c\u53f0\u7063\u7684\u5404\u7a2e\u611b\u597d\u8005\u793e\u7fa4\u5982\u7a0b\u5f0f\u8a9e\u8a00\u793e\u7fa4\u3001\u958b\u653e\u6e90\u78bc\u793e\u7fa4\u7b49\u7b49\u76f8\u540c\uff0c\u90fd\u6703\u9700\u8981\u5728\u53c3\u8207\u793e\u7fa4\u6642\u7522\u751f\u8db3\u5920\u7684\u8a98\u56e0\uff0c\u4e0d\u8ad6\u662f\u5167\u5728\u6210\u56e0\u5982\u300c\u9019\u500b\u793e\u7fa4\u7684\u6210\u54e1\u5f88\u6709\u8da3\u300d\u3001\u300c\u6211\u5728\u9019\u908a\u5b78\u7fd2\u5230\u4e86\u6280\u8853\u300d\uff0c\u6216\u662f\u76f8\u5c0d\u5916\u5728\u7684\u6210\u56e0\u300c\u6211\u53ef\u4ee5\u7372\u5f97\u4e00\u4e9b\u540d\u6c23\u751a\u81f3\u7d93\u6fdf\u56de\u994b\u300d\u7b49\uff0c\u9019\u4e9b\u6709\u5f62\u8207\u7121\u5f62\u7684\u56de\u994b\u624d\u53ef\u4ee5\u8b93\u793e\u7fa4\u6301\u7e8c\u7684\u6efe\u52d5\u8301\u58ef\u3002","date":"2024-01-30T00:00:00.000Z","formattedDate":"January 30, 2024","tags":[{"label":"ending","permalink":"/blog/tags/ending"},{"label":"dao","permalink":"/blog/tags/dao"}],"readingTime":5.27,"truncated":true,"authors":[{"name":"Yuren Ju","title":"Individual Researcher","url":"https://yurenju.medium.com/","imageURL":"https://github.com/yurenju.png","key":"yurenju"}],"nextItem":{"title":"LLAMMA - crvUSD \u7684\u65b0\u6e05\u7b97\u6a5f\u5236","permalink":"/blog/crvusd"}},"content":"\u55e8\u6211\u662f Yuren\u3002\u7d93\u904e\u4e86\u4e00\u6bb5\u6642\u9593\u7684\u6c89\u5bc2\u4e4b\u5f8c\uff0c\u89ba\u5f97\u8a72\u662f\u6642\u9593\u4f86\u5beb\u7bc7\u6587\u7ae0\u4f5c\u70ba\u9019\u500b\u793e\u7fa4\u7684\u56de\u9867\u8207\u7d50\u5c3e\u4e86\u3002\\n\\nLunDAO \u7684\u6210\u7acb\u76ee\u6a19\u662f\u5e0c\u671b\u9f13\u52f5\u64b0\u5beb\u8207 Ethereum \u76f8\u95dc\u7684\u4e2d\u6587\u6587\u7ae0\uff0c\u4f5c\u70ba\u734e\u52f5\u5247\u662f\u5e0c\u671b\u53ef\u4ee5\u904b\u884c\u4e00\u500b\u5fae\u578b\u7684\u7d93\u6fdf\u9ad4\u5236\u53ef\u4ee5\u7522\u751f\u8db3\u5920\u7684\u8a98\u56e0\uff0c\u900f\u904e LUN \u4ee3\u5e63\u734e\u52f5\u6280\u8853\u6587\u7ae0\u4f5c\u8005\u3002\\n\\n\u4f46\u662f\u7d93\u904e\u9019\u6bb5\u6642\u9593\u7684\u904b\u4f5c\u4e4b\u5f8c\u53ef\u4ee5\u767c\u73fe\uff0cDAO \u7684\u672c\u8cea\u5c31\u662f\u793e\u7fa4\uff0c\u4ed6\u8ddf\u4e00\u822c\u7684\u611b\u597d\u8005\u7fa4\u9ad4\u4e26\u7121\u4e0d\u540c\uff0c\u5c31\u5982\u540c\u53f0\u7063\u7684\u5404\u7a2e\u611b\u597d\u8005\u793e\u7fa4\u5982\u7a0b\u5f0f\u8a9e\u8a00\u793e\u7fa4\u3001\u958b\u653e\u6e90\u78bc\u793e\u7fa4\u7b49\u7b49\u76f8\u540c\uff0c\u90fd\u6703\u9700\u8981\u5728\u53c3\u8207\u793e\u7fa4\u6642\u7522\u751f\u8db3\u5920\u7684\u8a98\u56e0\uff0c\u4e0d\u8ad6\u662f\u5167\u5728\u6210\u56e0\u5982\u300c\u9019\u500b\u793e\u7fa4\u7684\u6210\u54e1\u5f88\u6709\u8da3\u300d\u3001\u300c\u6211\u5728\u9019\u908a\u5b78\u7fd2\u5230\u4e86\u6280\u8853\u300d\uff0c\u6216\u662f\u76f8\u5c0d\u5916\u5728\u7684\u6210\u56e0\u300c\u6211\u53ef\u4ee5\u7372\u5f97\u4e00\u4e9b\u540d\u6c23\u751a\u81f3\u7d93\u6fdf\u56de\u994b\u300d\u7b49\uff0c\u9019\u4e9b\u6709\u5f62\u8207\u7121\u5f62\u7684\u56de\u994b\u624d\u53ef\u4ee5\u8b93\u793e\u7fa4\u6301\u7e8c\u7684\u6efe\u52d5\u8301\u58ef\u3002\\n\\n\u4f46\u9019\u4e9b\u4e8b\u60c5\u4e26\u4e0d\u6703\u6c92\u4f86\u7531\u7684\u5c31\u767c\u751f\uff0c\u800c\u662f\u9700\u8981\u6210\u54e1\u6301\u7e8c\u6295\u5165\u5fc3\u529b\u624d\u53ef\u4ee5\u9010\u6f38\u7684\u6efe\u52d5\u9019\u500b\u8f2a\u5b50\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u6211\u5f88\u559c\u6b61\u7684\u6f2b\u756b\u300a\u8ff7\u5bae\u98ef\u300b\u7684\u6545\u4e8b\u662f\u50b3\u7d71\u5730\u57ce\u8ff7\u5bae\u5192\u96aa\u88e1\u9762\u8b1b\u8ff0\u7684\u65e5\u5e38\u6599\u7406\u6545\u4e8b\u3002\u88e1\u9762\u6709\u500b\u89d2\u8272**\u5148\u897f**\u662f\u4e00\u76f4\u5728\u8ff7\u5bae\u88e1\u9762\u81ea\u7d66\u81ea\u8db3\u7684\u77ee\u4eba\uff0c\u7576\u4ed6\u7684\u968a\u53cb\u767c\u73fe\u662f\u56e0\u70ba\u5148\u897f\u5728\u8ff7\u5bae\u88e1\u9762\u6253\u6383\u5ec1\u6240\u624d\u8b93\u5730\u57ce\u7684\u74b0\u5883\u5982\u6b64\u4e7e\u6de8\u6642\uff0c\u968a\u53cb\u554f\u4ed6\u70ba\u4ec0\u9ebc\u8981\u9019\u9ebc\u505a\uff1f\u5148\u897f\u56de\u7b54\uff1a\\n\\n> \u6211\u4e0d\u4f5c\u7684\u8a71\uff0c\u90a3\u8ab0\u8981\u4f86\u7dad\u8b77\u8ff7\u5bae\u7684\u5ec1\u6240\uff1f\u8ab0\u80fd\u5920\u6276\u8d77\u5012\u4e0b\u7684\u5de8\u9b54\u50cf\uff1f\u5de8\u9b54\u50cf\u6d88\u5931\u5f8c\u5176\u4ed6\u9b54\u7269\u5c31\u6703\u8dd1\u4e0a\u4f86\uff0c\u9019\u908a\u5c31\u6703\u5b8c\u5168\u8b8a\u4e86\u6a23\uff0c\u4e0d\u8ad6\u662f\u884c\u8d70\u6216\u662f\u72e9\u7375\u90fd\u7121\u6cd5\u96a8\u5fc3\u6240\u6b32\u7684\u9032\u884c\u4e86\u3002\\n>\\n> \u8ff7\u5bae\u8ddf\u8fb2\u7530\u90fd\u662f\u4e00\u6a23\u7684\u9053\u7406\uff0c\u4e0d\u80fd\u68c4\u4e4b\u4e0d\u9867\u53c8\u60f3\u8981\u4eab\u53d7\u597d\u8655\u3002\u66f4\u91cd\u8981\u7684\u662f\u98df\u7528\u9019\u88e1\u683d\u7a2e\u7684\u8fb2\u4f5c\u7269\u4e26\u4e14\u56de\u994b\u7d66\u8ff7\u5bae\uff0c\u6301\u7e8c\u90a3\u6a23\u7684\u751f\u6d3b\u4e4b\u5f8c\uff0c\u624d\u7d42\u65bc\u89ba\u5f97\u81ea\u5df1\u771f\u6b63\u878d\u5165\u4e86\u9019\u5ea7\u8ff7\u5bae\uff0c\u800c\u9019\u8b93\u6211\u5f88\u958b\u5fc3\u3002\\n\\n\u793e\u7fa4\u4e5f\u662f\u9019\u6a23\u7684\u9053\u7406\uff0c\u5728\u4f7f\u7528\u8457\u793e\u7fa4\u8cc7\u6e90\u7684\u540c\u6642\uff0c\u6709\u6642\u5019\u6703\u5ffd\u7565\u4e86\u4fdd\u6301\u6574\u6f54\u4e7e\u6de8\u7684\u80cc\u5f8c\uff0c\u662f\u6709\u793e\u7fa4\u9577\u5de5\u5728\u6253\u7406\u624d\u53ef\u4ee5\u6709\u8457\u9019\u9ebc\u826f\u597d\u7684\u74b0\u5883\u3002\u5728 LunDAO \u4e4b\u524d\uff0c\u6709\u8a31\u591a\u9577\u5de5\u90fd\u5728\u9ed8\u9ed8\u7684\u7dad\u8b77\u8457\u5340\u584a\u93c8\u793e\u7fa4\u7684\u74b0\u5883\uff0c\u4e0d\u8ad6\u662f [Taipei Ethereum Meetup](https://medium.com/taipei-ethereum-meetup) \u8207\u9678\u9678\u7e8c\u7e8c\u51fa\u73fe\u7684\u5beb\u4f5c\u793e\u7fa4\u5982 [DeFi \u71d2\u9152\u87ba](https://medium.com/defi-taiwan/tagged/defi)\u3001[CryptoCow](https://medium.com/cryptocow) \u90fd\u4e00\u6a23\uff0c\u80cc\u5f8c\u90fd\u662f\u9700\u8981\u4eba\u6301\u7e8c\u7dad\u6301\u624d\u6709\u8fa6\u6cd5\u597d\u597d\u904b\u884c\u3002\\n\\nLunDAO \u6c92\u6709\u8db3\u5920\u7684\u6d3b\u529b\u6301\u7e8c\u7684\u904b\u4f5c\uff0c\u4e3b\u8981\u7684\u539f\u56e0\u9084\u662f\u5728\u65bc\u6c92\u6709\u8fa6\u6cd5\u7522\u751f\u8db3\u5920\u7684\u793e\u7fa4\u52d5\u529b\uff0c\u800c\u78ba\u5be6\u6211\u4e5f\u6c92\u6709\u6295\u6ce8\u5920\u591a\u7684\u80fd\u91cf\uff0c\u4e26\u4e14\u6c92\u6709\u6301\u7e8c\u601d\u8003\u8207\u767c\u6398\u793e\u7fa4\u6210\u54e1\u5beb\u4f5c\u7684\u5167\u5728\u52d5\u6a5f\u5f8c\u8f49\u63db\u6210\u52d5\u529b\uff0c\u800c\u8b8a\u6210\u53ef\u4ee5\u6c38\u7e8c\u7d93\u71df\u7684\u6a21\u6a23\u3002\\n\\n\u4e0d\u904e\u7576\u57f7\u884c\u904e\u9019\u500b\u5c08\u6848\u5f8c\uff0c\u53cd\u904e\u4f86\u53c8\u66f4\u611f\u6fc0\u9019\u4e9b\u4e0d\u540c\u7fa4\u9ad4\u7684\u4eba\u5011\u3002\u4e0d\u8ad6\u9019\u4e9b\u5beb\u4f5c\u793e\u7fa4\u662f\u5426\u6d3b\u8e8d\u4e2d\uff0c\u6211\u5011\u90fd\u66fe\u7d93\u63a5\u624b\u6253\u7406\u904e\u9019\u500b\u958b\u653e\u7684\u7db2\u8def\u7a7a\u9593\uff0c\u8b93\u5192\u96aa\u8005\u7d93\u904e\u6642\uff0c\u6709\u500b\u826f\u597d\u7684\u6587\u737b\u8a18\u8f09\uff08\u5076\u723e\u6709\u9ede\u904e\u6642\u8207\u53e4\u8001\uff09\u8207\u4f11\u606f\u7684\u5730\u65b9\uff0c\u53ef\u4ee5\u8b93\u4ed6\u5011\u53ef\u4ee5\u5132\u5099\u80fd\u91cf\u7e7c\u7e8c\u5f80\u66f4\u6df1\u7684\u5730\u57ce\u8ff7\u5bae\u63a2\u7d22\u3002\\n\\n\u96d6\u7136 LunDAO \u5beb\u5230\u4e86\u7d50\u5c3e\uff0c\u4e0d\u904e\u6211\u9084\u662f\u89ba\u5f97\u9019\u662f\u500b\u597d\u5be6\u9a57\uff0c\u4e5f\u8b1d\u8b1d\u5927\u5bb6\u7684\u53c3\u8207\u3002\\n\\n\u672a\u4f86\u7db2\u57df\u9084\u6703\u7559\u5b58\u4e00\u5e74\u3002\u5373\u4f7f\u7db2\u57df\u904e\u671f\u4e86\uff0c\u6587\u7ae0\u9084\u662f\u6703\u6301\u7e8c\u4fdd\u5b58\u5728 GitHub \u4e0a\u9762\uff0c\u800c\u5404\u4f5c\u8005\u5c0d\u65bc\u81ea\u5df1\u7684\u6587\u7ae0\u7576\u7136\u64c1\u6709\u6240\u6709\u6b0a\uff0c\u4e5f\u6b61\u8fce\u81ea\u884c\u5099\u4efd\u6587\u7ae0\u6216\u8f49\u767c\u3002\u793e\u7fa4\u5269\u4e0b\u7684\u8cc7\u91d1\u5c07\u6703\u6350\u8d08\u7d66 Taipei Ethereum Meetup \u4f5c\u70ba\u63a8\u5ee3\u5beb\u4f5c\u8207\u65e5\u5e38\u71df\u904b\u7528\u9014\u3002\\n\\n\u96d6\u7136\u6211\u81ea\u5df1\u4e0d\u6703\u7e7c\u7e8c\u6295\u6ce8\u5fc3\u529b\u5728 LunDAO \u4e0a\u9762\uff0c\u4e0d\u904e\u5728\u6280\u8853\u5beb\u4f5c\u7684\u9053\u8def\u9084\u662f\u6703\u7e7c\u7e8c\u4e0b\u53bb\u3002\u90a3\u6211\u5011\u5c31\u5728\u5225\u7684\u5730\u65b9\u898b\u56c9\u3002\\n\\n![cover_end-of-lundao.jpg](./cover_end-of-lundao.jpg)"},{"id":"crvusd","metadata":{"permalink":"/blog/crvusd","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-12-05-crvusd/crvusd.md","source":"@site/blog/2022-12-05-crvusd/crvusd.md","title":"LLAMMA - crvUSD \u7684\u65b0\u6e05\u7b97\u6a5f\u5236","description":"LLAMMA \u662f Curve \u5718\u968a\u767c\u8868\u7684\u7a69\u5b9a\u5e63 crvUSD \u7684\u65b0\u6e05\u7b97\u65b9\u5f0f\uff0c\u672c\u6587\u5c07\u6703\u8b1b\u89e3 LLAMMA \u6e05\u7b97\u65b9\u5f0f\u4ee5\u53ca crvUSD \u7684\u7a69\u5b9a\u6a5f\u5236\u3002","date":"2022-12-05T00:00:00.000Z","formattedDate":"December 5, 2022","tags":[{"label":"curve","permalink":"/blog/tags/curve"},{"label":"crvusd","permalink":"/blog/tags/crvusd"},{"label":"llamma","permalink":"/blog/tags/llamma"},{"label":"amm","permalink":"/blog/tags/amm"}],"readingTime":24.12,"truncated":true,"authors":[{"name":"Yuren Ju","title":"Individual Researcher","url":"https://yurenju.medium.com/","imageURL":"https://github.com/yurenju.png","key":"yurenju"}],"prevItem":{"title":"LunDAO \u7684\u7d50\u5c3e","permalink":"/blog/end-of-lundao"},"nextItem":{"title":"Diamond 101 (4)","permalink":"/blog/diamond101-4"}},"content":"2022 \u5e74\u5e95 FTX \u5927\u7206\u70b8\u7684\u540c\u6642\uff0cCurve \u5718\u968a\u91cb\u51fa\u4e86\u6700\u65b0\u7684 crvUSD \u7a69\u5b9a\u5e63\u8a2d\u8a08\u767d\u76ae\u66f8\u3002\u5728\u9019\u4efd\u767d\u76ae\u66f8\u88e1\u9762\u63d0\u51fa\u4e86\u65b0\u7684\u7a69\u5b9a\u5e63\u6e05\u7b97\u6a5f\u5236 LLAMMA (Lending-Liquidating AMM Algorithm)\uff0c\u800c\u9019\u6a23\u7684\u6e05\u7b97\u6a5f\u5236\u5176\u5be6\u4e0d\u53ea\u53ef\u4ee5\u7528\u5728\u7a69\u5b9a\u5e63\u4e0a\u9762\uff0c\u5176\u4ed6\u6709\u6e05\u7b97\u9700\u6c42\u7684\u5c08\u6848\u4e5f\u90fd\u53ef\u4ee5\u53c3\u8003\u9019\u6a23\u7684\u8a2d\u8a08\u3002\u9664\u4e86\u6e05\u7b97\u6a5f\u5236\u4ee5\u5916\uff0c\u767d\u76ae\u66f8\u5167\u4e5f\u63d0\u53ca\u4e86\u5982\u4f55\u8ddf\u7f8e\u91d1\u9328\u5b9a\u7684\u7a69\u5b9a\u6a5f\u5236\u8207\u5408\u7d04 PegKeeper\u3002\\n\\n\u672c\u7bc7\u6587\u7ae0\u6703\u8457\u91cd\u89e3\u91cb LLAMMA \u7684\u6a5f\u5236\uff0c\u4e26\u4e14\u900f\u904e curve-stablecoin \u88e1\u9762\u7684\u6e90\u78bc\u4ee5\u53ca\u6e2c\u8a66\u6848\u4f8b\u4f86\u89e3\u91cb crvUSD \u6e05\u7b97\u6a5f\u5236\uff0c\u4e26\u4e14\u6982\u7565\u7684\u63d0\u5230 crvUSD \u7684\u7a69\u5b9a\u6a5f\u5236\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## \u524d\u60c5\u63d0\u8981\\n\u5728\u9032\u5165\u6b63\u984c\u524d\uff0c\u6211\u5011\u6703\u5148\u89e3\u91cb\u4e00\u4e9b\u76f8\u95dc\u7684\u6982\u5ff5\u4f86\u5e6b\u52a9\u8b80\u8005\u9032\u5165\u4e3b\u984c\uff0c\u4ee5\u4e0b\u6703\u5148\u89e3\u91cb\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\u3001DAI \u7684\u6e05\u7b97\u65b9\u5f0f\u4ee5\u53ca\u50b3\u7d71 AMM \u7684\u904b\u4f5c\u65b9\u5f0f\u3002\\n\\n### \u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\\n\u9996\u5148 crvUSD \u662f\u4e00\u500b\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\uff0c\u9019\u4e5f\u4ee3\u8868\u6240\u9444\u9020\u51fa\u4f86\u7684 crvUSD \u80cc\u5f8c\u90fd\u6709\u8d85\u904e\u767c\u884c\u984d\u5ea6\u7684\u62b5\u62bc\u54c1\u4f86\u652f\u6490\u50f9\u503c\uff0c\u540c\u6642\u5728\u62b5\u62bc\u54c1\u50f9\u683c\u4e0b\u8dcc\u6642\u6703\u89f8\u767c\u6e05\u7b97\u7a0b\u5e8f\u4f86\u78ba\u4fdd\u7a69\u5b9a\u5e63\u80cc\u5f8c\u90fd\u6709\u8db3\u5920\u7684\u50f9\u503c\u652f\u6490\uff0c\u6700\u8457\u540d\u7684\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\u70ba MakerDAO \u7684 DAI\u3002\\n\\n\u76f8\u5c0d\u65bc\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\u7684\u662f\u7b97\u6cd5\u7a69\u5b9a\u5e63\uff0c\u900f\u904e\u6f14\u7b97\u6cd5\u800c\u975e\u62b5\u62bc\u54c1\u4f86\u4fdd\u8b49\u7a69\u5b9a\u5e63\u8207\u7f8e\u91d1\u7684\u9328\u5b9a\uff0c\u9019\u985e\u7a69\u5b9a\u5e63\u8fd1\u671f\u6700\u8457\u540d\u7684\u662f Terra \u7684 UST\u3002\\n\\n### DAI \u7684\u6e05\u7b97\u65b9\u5f0f\\nDAI \u662f\u900f\u904e\u8d85\u984d\u62b5\u62bc\u7684\u65b9\u5f0f\u63d0\u4f9b\u7a69\u5b9a\u5e63\u50f9\u503c\u652f\u6490\u7684\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\u3002\u6bd4\u5982\u8aaa\u7576\u4f7f\u7528\u8005\u62b5\u62bc 3500 \u7b49\u503c\u7f8e\u91d1\u7684 ETH \u6642\uff0c\u53ef\u4ee5\u9444\u9020\u51fa 2000 \u7f8e\u91d1\u7b49\u503c\u7684 DAI\u3002\u4f46\u5982\u679c ETH \u50f9\u683c\u4e0b\u8dcc\u5230\u4e00\u5b9a\u7a0b\u5ea6\u6642\uff0c\u4f7f\u7528\u8005\u7684\u62b5\u62bc\u54c1\u5c31\u6703\u88ab\u6a19\u8a18\u6210\u53ef\u6e05\u7b97\u3002\\n\\n\u9019\u500b\u6e05\u7b97\u904e\u7a0b\u4e2d\uff0c\u62b5\u62bc\u54c1\u5982 ETH \u6703\u7528\u6298\u6263\u7684\u65b9\u5f0f\u51fa\u552e\uff0c\u6240\u6709\u4eba\u90fd\u53ef\u4ee5\u4f86\u53c3\u8207\u6298\u6263\u7684\u62b5\u62bc\u54c1\u7af6\u6a19\u3002\u6bd4\u5982\u8aaa\u5728 ETH \u50f9\u683c\u70ba 2900 \u7f8e\u91d1\u6642\uff0c\u7cfb\u7d71\u6703\u4ee5 2800 \u7f8e\u91d1\u7684\u50f9\u683c\u51fa\u552e\uff0c\u9019\u5c31\u6703\u5438\u5f15\u5957\u5229\u8005\u524d\u4f86\u7af6\u6a19\u3002\\n\\n\u7576\u6e05\u7b97\u7d50\u675f\u5f8c\uff0c\u5982\u679c\u62b5\u62bc\u54c1\u62cd\u8ce3\u7684\u50f9\u683c\u6bd4\u8f03\u597d\uff0c\u5176\u4e2d\u4e00\u90e8\u5206\u7684\u62b5\u62bc\u54c1\u53ef\u80fd\u5c31\u4e0d\u6703\u88ab\u6e05\u7b97\u6389\uff0c\u6b64\u6642\u5c31\u6703\u9084\u7d66\u50b5\u52d9\u4eba\u3002\u4f46\u662f\u5927\u90e8\u5206\u7684\u62b5\u62bc\u54c1\u901a\u5e38\u90fd\u6703\u88ab\u6e05\u7b97\u5c0e\u81f4\u640d\u5931\u6158\u91cd\uff0c\u5373\u4f7f\u50f9\u683c\u56de\u7a69\uff0c\u4f46\u6e05\u7b97\u5df2\u7d93\u9020\u6210\u50b7\u5bb3\u3002\\n\\n![traditional liquidation.png](traditional-liquidation.png)\\n\\n\u63a5\u4e0b\u4f86\u6703\u8b1b\u89e3\u50b3\u7d71\u7684 AMM \u904b\u4f5c\u65b9\u5f0f\u4f5c\u70ba LLAMMA \u7684\u7279\u6b8a\u8a2d\u8a08 AMM \u7684\u5c0d\u7167\u53c3\u8003\u3002\\n\\n### \u50b3\u7d71 AMM \u7684\u904b\u4f5c\u65b9\u5f0f\\n\u4ee5 Uniswap V3 \u70ba\u4f8b\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u900f\u904e Range Order \u7684\u65b9\u5f0f\u4f86\u63d0\u4f9b\u6d41\u52d5\u6027\u3002\u6bd4\u5982\u8aaa\u7576 ETH \u70ba 3000 USD \u6642\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u628a 1 ETH + 0 USD \u653e\u5165 Uniswap V3 \u88e1\u9762\uff0c\u4e26\u4e14\u6307\u5b9a\u5728 3200 - 3800 USD \u7684\u5340\u9593\u63db\u6210 USD\u3002\\n\\n![tranditional-AMM.png](tranditional-AMM.png)\\n\\n\u7576 ETH \u9032\u5165\u4e0a\u8ff0\u5340\u9593\u4e4b\u5f8c\uff0c1 ETH \u5c31\u6703\u6162\u6162\u7684\u88ab\u63db\u6210 USD\uff0c\u7576\u8d85\u904e 3800 USD \u6642\uff0c\u6240\u6709\u7684 ETH \u90fd\u6703\u88ab\u63db\u6210 USD\uff0c\u9019\u500b\u6548\u679c\u5f88\u50cf\u5728\u4e2d\u5fc3\u5316\u4ea4\u6613\u6240\u7576\u4e2d\u5f9e 3200 \u4e00\u8def\u639b\u9650\u50f9\u55ae (Limit Order) \u5230 3800 USD \u7684\u6548\u679c\u3002\\n\\n\u4f46\u8ddf\u9650\u50f9\u55ae\u4e0d\u540c\u7684\u662f\u5982\u679c\u6b64\u6642\u50f9\u683c\u53c8\u8dcc\u56de 3000 \u5f8c\uff0c\u5728 Uniswap v3 \u4e0a\u9762\u6240\u6709\u7684 USD \u53c8\u6703\u88ab\u63db\u56de ETH\u3002\\n\\n\u53cd\u65b9\u5411\u4f86\u8aaa\uff0c\u4f7f\u7528\u8005\u4e5f\u53ef\u4ee5\u63d0\u4f9b\u6bd4\u5982 3000 USD + 0 ETH\uff0c\u4e26\u4e14\u6307\u5b9a\u4f48\u7f72\u5728 2000 - 2500 USD \u7684\u5340\u9593\uff0c\u7576\u50f9\u683c\u4e0b\u8dcc\u6642\uff0cUSD \u5c31\u6703\u9010\u6f38\u7684\u88ab\u63db\u6210 ETH\uff0c\u76f4\u5230\u4f4e\u65bc 2000 USD \u6642\uff0c\u6240\u6709\u7684 USD \u90fd\u6703\u88ab\u63db\u6210 ETH\u3002\\n\\n## LLAMMA\\ncrvUSD \u8ddf DAI \u4e00\u6a23\u4e5f\u662f\u62b5\u62bc\u54c1\u7a69\u5b9a\u5e63\uff0c\u4f46\u65b0\u8a2d\u8a08\u4e86\u4e00\u7a2e\u6e05\u7b97\u6f14\u7b97\u6cd5 LLAMMA\uff0c\u5176\u7d50\u5408 AMM \u7684\u7279\u6027\u8b93\u62b5\u62bc\u54c1\u5728\u50f9\u683c\u4e0b\u8dcc\u6642\u9010\u6f38\u8f49\u79fb\u6210\u7a69\u5b9a\u5e63\uff0c\u8b93\u539f\u672c\u8981\u6e05\u511f\u7684\u50b5\u52d9\u6709\u4e00\u5b9a\u7a0b\u5ea6\u7684\u7a69\u5b9a\u5e63\u53ef\u4ee5\u511f\u9084\uff0c\u540c\u6642\u5728\u50f9\u683c\u56de\u7a69\u6642\u518d\u9010\u6f38\u628a\u7a69\u5b9a\u5e63\u63db\u56de\u62b5\u62bc\u54c1\uff0c\u800c\u4e0d\u662f\u786c\u751f\u751f\u7684\u89f8\u767c\u6e05\u7b97\u5c0e\u81f4\u50b5\u52d9\u4eba\u7684\u8667\u640d\u3002\\n\\n\u9444\u9020 crvUSD \u7684\u6642\u5019\u540c\u6a23\u7684\u6703\u9700\u8981\u5b58\u5165\u62b5\u62bc\u54c1\u5982 ETH \u5230\u667a\u80fd\u5408\u7d04\u4f86\uff0c\u4e0d\u4e00\u6a23\u7684\u662f\u9019\u500b\u62b5\u62bc\u54c1\u6703\u88ab\u653e\u5165\u4e00\u500b LLAMMA \u7279\u6b8a\u8a2d\u8a08\u7684 AMM \u7576\u4e2d\u3002\u8ddf Uniswap \u7684 Range Order \u4e00\u6a23\uff0c\u525b\u5b58\u5165\u62b5\u62bc\u54c1\u5230 AMM \u6642\u6703\u4ee5\u55ae\u908a\u7684\u5f62\u5f0f\u5b58\u5728\uff0c\u800c\u7576\u62b5\u62bc\u54c1\u50f9\u683c\u4e0b\u8dcc\u5230\u4e00\u5b9a\u7a0b\u5ea6\u6642\uff0c\u5c31\u6703\u9010\u6f38\u63db\u6210\u7a69\u5b9a\u5e63\u3002\\n\\n\u8209\u4f8b\u4f86\u8aaa\u7576 ETH \u50f9\u683c\u70ba 3000 \u7f8e\u91d1\u7684\u6642\u5019\uff0c\u4f7f\u7528\u8005\u53ef\u4ee5\u62b5\u62bc 1 ETH \u5230\u7cfb\u7d71\u7684\u667a\u80fd\u5408\u7d04\u88e1\u9762\u3002\u6b64\u6642\u7cfb\u7d71\u6703\u9444\u9020\u51fa crvUSD \u7d66\u4f7f\u7528\u8005\uff0c\u540c\u6642\u62b5\u62bc\u7684 1 ETH \u6703\u88ab\u985e\u4f3c Uniswap v3 \u7684\u65b9\u5f0f\u88ab\u653e\u5165\u4e00\u500b\u7279\u6b8a\u7684 AMM \u88e1\u9762\uff0c\u6bd4\u5982\u8aaa\u6d41\u52d5\u6027\u6703\u88ab\u653e\u5728 500-550 USD \u9019\u500b\u5340\u9593\u7576\u4e2d\uff0c\u800c\u6240\u53d6\u5f97\u7684 LP \u4ee3\u5e63\u5247\u6703\u53ea\u6709\u55ae\u908a\u7684 1 ETH + 0 crvUSD \u6d41\u52d5\u6027\u3002\\n\\n![liquidity-of-LLAMMA.png](liquidity-of-LLAMMA.png)\\n\\n\u7576 ETH \u50f9\u683c\u8dcc\u5230 550 USD \u4ee5\u4e0b\u6642\uff0c\u7cfb\u7d71\u6703\u958b\u59cb\u6162\u6162\u7684\u628a ETH \u63db\u6210 crvUSD\uff0c\u7576\u8dcc\u5230 500 USD \u4ee5\u4e0b\u6642\uff0c\u6240\u6709\u7684\u6d41\u52d5\u6027\u5c31\u6703\u8b8a\u6210 crvUSD\u3002\u7576\u50f9\u683c\u8dcc\u5230\u9019\u500b\u5340\u9593\u6642\uff0c\u7cfb\u7d71\u5c07\u6703\u7528\u6bd4\u5e02\u5834\u4e0a\u66f4\u4fbf\u5b9c\u7684\u50f9\u683c\u552e\u51fa ETH\uff0c\u6b64\u6642\u5c31\u6703\u5438\u5f15\u5e02\u5834\u4e0a\u7684\u4eba\u4f86\u5230\u9019\u500b\u7279\u6b8a\u7684 AMM \u88e1\u9762\u4f86\u8cb7 ETH \u4f86\u7372\u5f97\u6298\u6263\u50f9\u3002\\n\\n\u56e0\u70ba\u7cfb\u7d71\u6703\u9010\u6f38\u7684\u628a\u62b5\u62bc\u54c1 ETH \u63db\u6210\u7a69\u5b9a\u5e63 crvUSD\uff0c\u6240\u4ee5\u5c31\u4e0d\u6703\u50cf DAI \u4e00\u6a23\u5230\u786c\u6e05\u7b97\u9580\u6abb\u5f8c\u5c31\u76f4\u63a5\u628a\u6240\u6709\u62b5\u62bc\u54c1\u90fd\u6e05\u7b97\u6389\u3002\u66f4\u9032\u4e00\u6b65\u7684\u662f\u7576\u62b5\u62bc\u54c1 ETH \u7684\u50f9\u683c\u5982\u679c\u56de\u7a69\u5f8c\uff0c\u4f7f\u7528\u8005\u7684\u6d41\u52d5\u6027\u53c8\u6703\u9010\u6f38\u7684\u5f9e\u7a69\u5b9a\u5e63 crvUSD \u63db\u6210 ETH\u3002\\n\\n![liquidation-of-LLAMMA.png](liquidation-of-LLAMMA.png)\\n\\n\u4e0d\u904e\u9019\u500b\u63db\u56de\u62b5\u62bc\u54c1\u7684\u904e\u7a0b\u4e5f\u53ef\u80fd\u51fa\u73fe Path-Dependence \u7684\u554f\u984c\uff0c\u6211\u5011\u5728\u6700\u5f8c\u7684**\u7d50\u8ad6\u8207\u7591\u554f**\u7ae0\u7bc0\u4f86\u8a0e\u8ad6\u9019\u500b\u554f\u984c\u3002\\n\\n\u9019\u908a\u6709\u4e09\u4ef6\u4e8b\u60c5\u8981\u7279\u5225\u6ce8\u610f\uff1a\\n1. LLAMMA \u8ddf\u50b3\u7d71 AMM \u7684\u65b9\u5411\u76f8\u53cd\uff1a\u50b3\u7d71 AMM \u653e\u5165\u55ae\u908a\u8cc7\u7522\u4e4b\u5f8c\uff0c\u8981\u50f9\u683c\u63d0\u5347\u624d\u53ef\u4ee5\u63db\u6210\u53e6\u5916\u4e00\u908a\uff0c\u800c LLAMMA \u7684\u7279\u6b8a AMM \u5247\u662f\u50f9\u683c\u4e0b\u8dcc\u4e4b\u5f8c\u624d\u6703\u63db\u6210\u53e6\u5916\u4e00\u500b\u8cc7\u7522\uff08\u7a69\u5b9a\u5e63\uff09\\n2. LLAMMA \u9700\u8981\u4f9d\u8cf4\u5916\u90e8\u7684\u9810\u8a00\u6a5f (Oracle) \u50f9\u683c\uff1a\u56e0\u70ba LLAMMA \u9700\u8981\u8ce3\u7684\u6bd4\u5916\u9762\u7684\u66f4\u4fbf\u5b9c\uff0c\u6240\u4ee5\u6703\u9700\u5f15\u5165\u9810\u8a00\u6a5f\u50f9\u683c\uff0c\u624d\u53ef\u4ee5\u77e5\u9053\u6709\u6d41\u52d5\u6027\u7684\u6642\u5019\u8981\u5982\u4f55\u6298\u6263\u5b9a\u50f9\u4f86\u5438\u5f15\u5957\u5229\u8005\uff0c\u5916\u90e8\u50f9\u683c\u8ddf\u5167\u90e8\u50f9\u683c\u5dee\u8ddd\u8d8a\u5927\u6642\uff0c**LLAMMA \u5c31\u6703\u7d66\u51fa\u66f4\u591a\u6298\u6263**\u3002 \\n3. crvUSD \u9084\u662f\u6709\u6e05\u7b97\u6a5f\u5236\uff1a\u96d6\u7136\u53ef\u4ee5\u900f\u904e LLAMMA \u7684\u7279\u6b8a AMM \u9010\u6f38\u8f49\u63db\u6210\u7a69\u5b9a\u5e63\uff0c\u4f46\u662f\u5982\u679c\u50b5\u52d9\u5065\u5eb7\u72c0\u6cc1\u592a\u7cdf\u7cd5\uff0c\u9084\u662f\u6703\u6709\u6700\u5f8c\u7684\u6e05\u7b97\u6a5f\u5236\\n\\n## \u900f\u904e\u6e2c\u8a66\u6848\u4f8b\u89e3\u91cb\u5be6\u969b\u904b\u4f5c\u65b9\u5f0f\\ncrvUSD \u9664\u4e86\u767d\u76ae\u66f8\u4ee5\u5916\u4e5f\u91cb\u51fa\u4e86[\u6e90\u78bc](https://github.com/curvefi/curve-stablecoin)\uff0c\u5176\u4e2d\u7684\u6e2c\u8a66\u6848\u4f8b [test_create_loan](https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L9) \u6b63\u597d\u8986\u84cb\u4e86\u6574\u500b\u501f\u6b3e\u904e\u7a0b\uff0c\u9019\u908a\u5229\u7528\u9019\u500b\u6e2c\u8a66\u6848\u4f8b\u4f86\u89e3\u91cb\u6574\u500b\u6d41\u7a0b\u6703\u66f4\u5bb9\u6613\u7406\u89e3\u3002\\n\\n\u70ba\u4e86\u5f97\u5230\u66f4\u591a\u8cc7\u8a0a\uff0c\u6211 fork \u4e86\u539f\u672c\u7684\u6e90\u78bc\u4e26\u4e14\u5728\u76ee\u6a19\u7684\u6e2c\u8a66\u6848\u4f8b\u88e1\u9762\u5370\u51fa\u4e86\u66f4\u591a\u8cc7\u8a0a\uff08\u4e0d\u592a\u719f\u6089 Vyper \u74b0\u5883\uff0c\u53ea\u80fd\u7528\u6bd4\u8f03\u571f\u7832\u7684\u4f5c\u6cd5\uff09\uff0c\u6709\u8208\u8da3\u7684\u53ef\u4ee5\u53c3\u8003\u4e0b\u9762\u7684 commit \u4e86\u89e3\u6211\u505a\u4e86\u4ec0\u9ebc\u4fee\u6539\uff1a\\n\\nhttps://github.com/yurenju/curve-stablecoin/commit/c3bf52353f41914deb82f1c1c97dcbc5de2d72e4\\n\\n\u9996\u5148\u8981\u5148\u89e3\u91cb\u4e00\u4e0b\u6ce2\u6bb5 (band)\u3002\\n\\n### \u6ce2\u6bb5 (band)\\n\u6ce2\u6bb5\u662f\u7576\u4f7f\u7528\u8005\u628a\u62b5\u62bc\u54c1\u5b58\u5165\u7cfb\u7d71\u6642\uff0c\u62b5\u62bc\u54c1\u6703\u88ab\u5b58\u5165\u7684\u5340\u6bb5\uff0c\u7576\u9810\u8a00\u6a5f\u50f9\u683c\u79fb\u52d5\u5230\u9019\u500b\u5340\u9593\u6642\uff0c\u4f7f\u7528\u8005\u7684\u62b5\u62bc\u54c1\u5c31\u6703\u958b\u59cb\u88ab\u8f49\u63db\u6210\u7a69\u5b9a\u5e63\u3002\u800c\u525b\u958b\u59cb\u5efa\u7acb AMM \u6642\u6703\u6839\u64da\u9810\u8a00\u6a5f\u7684\u50f9\u683c\u5207\u5206\u6ce2\u6bb5\uff0c\u5176\u4e2d\u9810\u8a00\u6a5f\u50f9\u683c\u6240\u5728\u7684\u6ce2\u6bb5\u6703\u662f\u6ce2\u6bb5 0 (band 0)\uff0c\u9810\u8a00\u6a5f\u50f9\u683c\u8d8a\u4f4e\uff0c\u6ce2\u6bb5\u7de8\u865f\u8d8a\u9ad8\u3002\\n\\n![bands-and-oracle-price.png](bands-and-oracle-price.png)\\n\\n\u6bd4\u5982\u8aaa\u5275\u5efa AMM \u7684\u6642\u5019\u9810\u8a00\u6a5f\u5831\u50f9 3000 USD\uff0c\u6b64\u6642\u6ce2\u6bb5 0 \u7684\u50f9\u683c\u5e36\u6703\u662f 2970 - 3000\uff0c\u800c\u6ce2\u6bb5 1 \u7684\u50f9\u683c\u5e36\u662f 2970.0 - 2940.3\u3002\u800c\u7531\u65bc\u76ee\u524d\u50f9\u683c\u843d\u5728\u6ce2\u6bb5 0\uff0c\u6240\u4ee5 `AMM.active_band()` \u5c31\u6703\u56de\u50b3 0\u3002\\n\\n\u81f3\u65bc\u6bcf\u500b\u5340\u9593\u7684\u50f9\u683c\u5bec\u5ea6\u5247\u7531 AMM \u5efa\u69cb\u5b50\u6240\u50b3\u5165\u7684 A (Amplification) \u6c7a\u5b9a\uff0c\u516c\u5f0f\u70ba\uff1a\\n\\n$$\\n\\\\frac{p_{\\\\downarrow}}{p_{\\\\uparrow}}=\\\\frac{A-1}{A}\\n$$\\n\\n\u8209\u4f8b\u4f86\u8aaa\uff0c\u7576\u50f9\u683c\u4e0a\u754c $p_\\\\uparrow$ \u70ba 3000 \u800c A \u70ba 100 \u6642\uff0c\u50f9\u683c\u4e0b\u754c $p_\\\\downarrow$ \u5247\u70ba\uff1a\\n\\n$$\\n\\\\begin{aligned}\\np_{\\\\downarrow} &=\\\\frac{p_{\\\\uparrow}(A-1)}{A} =\\\\frac{3000(100-1)}{100} = 2970\\n\\\\end{aligned}\\n$$\\n\\n\u6bcf\u500b\u6ce2\u6bb5\u7684\u50f9\u683c\u4e0b\u754c\u6b63\u597d\u6703\u63a5\u8457\u4e0a\u500b\u6ce2\u6bb5\u7684\u50f9\u683c\u4e0a\u754c\u5f62\u6210\u4e00\u500b\u9023\u7e8c\u7684\u6d41\u52d5\u6027\u5340\u9593\uff0c\u5982\u679c\u60f3\u77e5\u9053\u8a72\u6ce2\u6bb5\u6240\u4ee3\u8868\u7684\u9810\u8a00\u6a5f\u50f9\u683c\u4e0a\u4e0b\u754c\uff0c\u53ef\u4ee5\u7528\u4ee5\u4e0b\u5169\u500b\u51fd\u5f0f\u67e5\u8a62\uff1a \\n- `AMM.p_oracle_up(band_number)`\\n- `AMM.p_oracle_down(band_number)`\\n\\n\u7576\u6bcf\u6b21\u6709\u4eba\u501f\u51fa crvUSD \u6216\u662f\u6709\u4eba\u8ddf AMM \u4ea4\u6613\u6642\uff0c\u7cfb\u7d71\u6703\u6839\u64da\u7576\u4e0b\u7684\u5916\u90e8\u9810\u8a00\u6a5f\u50f9\u683c\u8207\u76ee\u524d\u7684\u6d41\u52d5\u6027\u4ea4\u6613\u60c5\u5f62\u4f86\u66f4\u65b0\u73fe\u884c\u7684\u5340\u6bb5 `amm.active_band`\u3002\\n\\n\u800c\u5728 `active_band` \u88e1\u9762\u7684\u6d41\u52d5\u6027\u5247\u6703\u958b\u59cb\u88ab\u4ea4\u6613\uff0c\u4e5f\u5c31\u662f\u62b5\u62bc\u54c1\u53ef\u4ee5\u88ab\u4ea4\u6613\u6210\u70ba\u7a69\u5b9a\u5e63\uff0c\u53cd\u4e4b\u4ea6\u7136\u3002\u7576 `active_band` \u7684\u6d41\u52d5\u6027\u88ab\u4ea4\u6613\u6b86\u76e1\u5f8c\uff0c\u6703\u8df3\u5230\u4e0b\u4e00\u500b\u6ce2\u6bb5\u7e7c\u7e8c\u4ea4\u6613\uff0c\u4e26\u4e14\u66f4\u65b0 `active_band` \u5230\u4e0b\u4e00\u500b\u6ce2\u6bb5\u3002\\n\\n### \u5b58\u5165\u62b5\u62bc\u54c1\u4f86\u9444\u9020 crvUSD\\n\u6839\u64da\u6e2c\u8a66\u6848\u4f8b [test_create_loan](https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L9) \u7684\u524d\u7f6e\u689d\u4ef6\u5982\u4e0b\uff1a\\n- \u62b5\u62bc\u54c1\u70ba WETH\uff0c\u76ee\u524d[\u50f9\u683c\u70ba 3000 USD](https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/conftest.py#L9)\\n- \u7a69\u5b9a\u5e63\u70ba crvUSD\\n\\n\u4f7f\u7528\u8005\u547c\u53eb `Controller.create_loan(collateral, debt, number_of_bands)` \u4f86\u9444\u9020\u7a69\u5b9a\u5e63\uff0c\u5b58\u5165\u4e86 [1000 WETH](https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L15)\uff0c\u6b32[\u9444\u9020\u6216\u662f\u8aaa\u501f\u51fa 500,000 crvUSD](https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L17)\uff0c\u4e26\u4e14\u5c07\u6d41\u52d5\u6027\u4f48\u7f72\u5728 5 \u500b\u6ce2\u6bb5\u5167\uff1a\\n\\n```python\\nmarket_controller.create_loan(1000 ETH, 500000 crvUSD, 5)\\n```\\n\\n\u6b64\u6642\u7cfb\u7d71\u6703\u6839\u64da\u62b5\u62bc\u54c1\u6578\u91cf\u3001\u6b32\u9444\u9020\u7684\u7a69\u5b9a\u5e63\u6578\u91cf\u6c7a\u5b9a\u8981\u628a\u6d41\u52d5\u6027\u653e\u5728\u54ea\u4e94\u500b\u6ce2\u6bb5\u5167\u3002\u8981\u6c7a\u5b9a\u662f\u54ea\u4e94\u500b\u6ce2\u6bb5\uff0c\u53ef\u4ee5\u900f\u904e `Controller.calculate_debt_n1(collateral, debt, bands)` \u4f86\u5f97\u5230\u4e0a\u754c\u7684\u6ce2\u6bb5\uff0c\u518d\u52a0\u4e0a\u6ce2\u6bb5\u7e3d\u6578 5 \u5c31\u53ef\u4ee5\u53d6\u5f97\u4e0b\u754c\u3002\\n\\n\u4ee5\u9019\u500b\u4f8b\u5b50\u800c\u8a00\uff0c`calculate_debt_n1(1000 WETH, 500000 crvUSD, 5)` \u6240\u56de\u50b3\u7684\u4e0a\u754c n1 \u70ba `170`\uff0c\u7e3d\u5171\u653e\u5728\u4e94\u500b\u6ce2\u6bb5\u5167\uff0c\u6240\u4ee5\u4e0b\u754c\u5c31\u662f `174`\u3002\\n\\n\u82e5\u60f3\u67e5\u8a62\u9019\u500b\u9023\u7e8c\u6ce2\u6bb5\u7684\u4e0a\u4e0b\u754c\u7684\u9810\u8a00\u6a5f\u50f9\u683c\uff0c\u53ef\u4ee5\u7528 `AMM.p_oracle_up(170)` \u8ddf `AMM.p_oracle_down(174)` \u53d6\u5f97\u3002\u9019\u500b\u9023\u7e8c\u7684\u6ce2\u6bb5\u50f9\u683c\u4e0a\u754c\u70ba 543.38\uff0c\u4e0b\u754c\u5247\u70ba 516.75\u3002\u9019\u4e5f\u4ee3\u8868\u7576\u5916\u90e8\u7684\u9810\u8a00\u6a5f\u50f9\u683c\u964d\u5230\u9019\u500b\u5340\u9593\u6642\uff0c\u4f7f\u7528\u8005\u5b58\u5165\u7684\u62b5\u62bc\u54c1\u6703\u5728 AMM \u88e1\u9762\u88ab\u4ee5\u6bd4\u9810\u8a00\u6a5f\u5831\u50f9\u66f4\u4fbf\u5b9c\u7684\u50f9\u683c\u8ce3\u51fa\uff0c\u8b93\u5957\u5229\u8005\u6703\u60f3\u8981\u5230\u7cfb\u7d71\u5167\u8cb7\u5230\u66f4\u4fbf\u5b9c\u7684\u62b5\u62bc\u54c1\u7372\u5229\u3002\\n\\n\u5b58\u5165\u7684\u62b5\u62bc\u54c1\u5c07\u6703\u5e73\u5747\u7684\u4f48\u7f72\u5728\u9019\u4e94\u500b\u6ce2\u6bb5\u4e0a\uff0c\u4e5f\u53ef\u4ee5\u900f\u904e `AMM.bands_y(band_number)` \u4f86\u53d6\u5f97\u7279\u5b9a\u6ce2\u6bb5\u7684\u62b5\u62bc\u54c1\u6578\u91cf\uff0c\u6bd4\u5982\u8aaa `bands_y(170)` \u6703\u5f97\u5230\u8a72\u6ce2\u6bb5\u7e3d\u5171\u6709 200 WETH \u7684\u62b5\u62bc\u54c1\uff0c\u67e5\u8a62 170 - 174 \u90fd\u6703\u662f 200 WETH\u3002\\n\\n### \u8ddf LLAMMAS \u4ea4\u6613\u6298\u6263\u7684 WETH \u62b5\u62bc\u54c1\\ncurve-stablecoin \u63d0\u4f9b\u4e86\u8a31\u591a\u65b9\u4fbf\u7684\u5de5\u5177\u53ef\u4ee5\u4f7f\u7528\uff0c\u5982\u6e2c\u8a66\u7528\u7684\u9810\u8a00\u6a5f\u8b93\u6211\u5011\u53ef\u4ee5\u76f4\u63a5\u4fee\u6539\u9810\u8a00\u6a5f\u50f9\u683c\u9032\u884c\u6e2c\u8a66\u3002\\n\\n\u6211\u5011\u53ef\u4ee5\u900f\u904e `price_oracle.set_price(p)` \u4f86\u6539\u8b8a\u9810\u8a00\u6a5f\u50f9\u683c\u3002\u9019\u908a\u6211\u5011\u7528 `set_price(540)` \u628a\u50f9\u683c\u5f9e 3000 \u6539\u6210 540\uff0c\u9019\u4e5f\u662f\u6ce2\u6bb5 170 \u7684\u7bc4\u570d\u3002\u4f7f\u7528 `p_oracle_up(170)` \u8207 `p_oracle_down(170)` \u53ef\u4ee5\u5f97\u77e5\u6ce2\u6bb5 170 \u7684\u7bc4\u570d\u7d04\u662f  543.38 - 537.95\u3002\\n\\n\u6b64\u6642\u547c\u53eb `AMM.exchange(0, 1, in_amount, 0)` \u53ef\u4ee5\u7528 crvUSD \u4ea4\u63db WETH \u8cc7\u7522\u3002\u82e5\u4f7f\u7528 100 crvUSD \u53ef\u4ee5\u4ea4\u63db\u5230\u7d04 0.185634 WETH\uff0c\u5e73\u5747\u50f9\u683c\u70ba 538.69 crvUSD\uff0c\u76f8\u8f03\u8d77\u4f86\u6703\u6bd4\u8d77\u9810\u8a00\u6a5f\u50f9\u683c\u7684 540 USD \u66f4\u70ba\u4fbf\u5b9c\u3002\\n\\n\u5047\u8a2d\u4e0a\u9762\u9019\u500b\u4ea4\u6613\u6c92\u6709\u9032\u884c\uff0c\u4f46\u662f\u9810\u8a00\u6a5f\u50f9\u683c\u8abf\u5230 535 USD\uff0c\u4e5f\u5c31\u662f\u8abf\u6574\u5230\u6ce2\u6bb5 171 \u6642\uff0c\u6b64\u6642\u518d\u9032\u884c\u540c\u6a23\u7684\u4ea4\u6613\u7528 100 crvUSD \u4ea4\u6613 WETH\uff0c\u5247\u5e73\u5747\u50f9\u683c\u5247\u70ba 523.87 crvUSD\uff0c\u9019\u4e5f\u8aaa\u660e\u4e86\u9810\u8a00\u6a5f\u50f9\u683c\u4e5f\u6703\u5f71\u97ff AMM \u7684\u5167\u90e8\u50f9\u683c\uff0c\u7576\u9810\u8a00\u6a5f\u50f9\u683c\u8b8a\u4f4e\u6642\uff0cAMM \u62cb\u552e\u62b5\u62bc\u54c1\u7684\u50f9\u683c\u4e5f\u6703\u9032\u4e00\u6b65\u7684\u964d\u4f4e\uff0c\u8b93\u5957\u5229\u8005\u9858\u610f\u5230\u7cfb\u7d71\u88e1\u9762\u4f86\u5957\u5229\uff0c\u9032\u4e00\u6b65\u7684\u5354\u52a9\u50b5\u52d9\u4eba\u7684\u50b5\u52d9\u6709\u66f4\u591a\u7a69\u5b9a\u5e63\u652f\u6490\u3002\\n\\n## crvUSD \u7684\u7a69\u5b9a\u6a5f\u5236 PegKeeper\\ncrvUSD \u9664\u4e86\u900f\u904e LLAMMA \u4f86\u57f7\u884c\u8f49\u63db\u8207\u6e05\u7b97\u5916\uff0c\u9084\u6709\u53e6\u5916\u4e00\u500b\u6a21\u7d44 PegKeeper \u5408\u7d04\u9032\u884c\u7a69\u5b9a\u5e63\u7684\u9328\u5b9a\u529f\u80fd\u3002\\n\\n\u9019\u908a\u6703\u4f7f\u7528\u5230\u4e00\u500b Curve \u4e00\u822c\u7684 AMM \u7a69\u5b9a\u5e63\u4ea4\u6613\u6c60 StableSwap\uff0c\u88e1\u9762\u7684\u4ee3\u5e63\u5c0d\u662f crvUSD \u4ee5\u53ca\u53e6\u5916\u4e00\u500b LP \u4ee3\u5e63\u5982 3Crv \u9032\u800c\u7d44\u5408\u6210\u7684 MetaPool\u3002\\n\\n\u7576 crvUSD \u7684\u50f9\u683c\u9ad8\u65bc 1 USD \u6642\uff08\u6bd4\u5982\u8aaa crvUSD \u7684\u4f7f\u7528\u9700\u6c42\u589e\u52a0\uff09\uff0cPegKeeper \u6703\u9444\u9020\u51fa\u7121\u62b5\u62bc\u7684 crvUSD \u4e26\u4e14\u6ce8\u5165\u9019\u500b StableSwap\u3002\u6b64\u6642\u5957\u5229\u8005\u767c\u73fe\u5e02\u5834\u4e0a\u7684 crvUSD \u50f9\u683c\u9ad8\u65bc 1 USD\uff0c\u4f46\u662f\u9019\u500b StableSwap \u50f9\u683c\u537b\u63a5\u8fd1 1 USD \u6642\u5c31\u6703\u5230 StableSwap Pool \u4f86\u5957\u5229\uff0c\u9032\u800c\u8b93\u5e02\u5834\u4e0a\u7684 crvUSD \u50f9\u683c\u4e0b\u8dcc\u9760\u8fd1 1 USD\u3002\\n\\n\u7576 crvUSD \u50f9\u683c\u4f4e\u65bc 1 USD \u6642\uff0c\u53cd\u904e\u4f86 PegKeeper \u53ef\u4ee5\u5f9e StableSwap \u62bd\u51fa\u8cc7\u91d1\u4e26\u4e14\u92b7\u6bc0\uff0c\u4e26\u4e14\u8b93\u5957\u5229\u8005\u9032\u4f86\u91cd\u65b0\u5e73\u8861\u50f9\u683c\uff0c\u8b93\u5e02\u5834\u4e0a\u7684 crvUSD \u4e0a\u6f32\u9760\u8fd1 1 USD\u3002\\n\\n\u9019\u500b PegKeeper \u5408\u7d04\u96d6\u7136\u53ef\u4ee5\u9444\u9020\u8207\u92b7\u6bc0 crvUSD\uff0c\u4f46\u5b83\u5728\u667a\u80fd\u5408\u7d04\u7684\u908f\u8f2f\u9650\u5236\u53ea\u80fd\u5920\u91dd\u5c0d\u7279\u5b9a\u7684 StableSwap \u6c60\u5b50\u6ce8\u5165\u8207\u62bd\u51fa crvUSD  \u4f86\u9650\u5236\u7528\u9014\u3002\\n\\n## \u7d50\u8ad6\u8207\u7591\u554f\\n\u672c\u7bc7\u6587\u7ae0\u89e3\u91cb\u4e86 crvUSD \u6240\u63d0\u51fa\u7684\u65b0\u6e05\u7b97\u65b9\u5f0f LLAMMA \u900f\u904e AMM \u7684\u7279\u6027\u9032\u884c\u91dd\u5c0d\u50b5\u52d9\u4eba\u66f4\u53cb\u5584\u7684\u6e05\u7b97/\u8f49\u63db\u65b9\u5f0f\uff0c\u4e26\u4e14\u900f\u904e\u6e2c\u8a66\u6848\u4f8b\u4f86\u4e00\u7aba crvUSD \u5be6\u969b\u904b\u4f5c\u7684\u65b9\u5f0f\uff0c\u4e26\u4e14\u6982\u7565\u7684\u89e3\u91cb\u4e86 PegKeeper \u900f\u904e Curve MetaPool \u4f86\u9032\u884c\u7684\u7a69\u5b9a\u6a5f\u5236\u3002\\n\\n### LLAMMA \u6e05\u7b97\u6a5f\u5236\\nLLAMMA \u662f\u500b\u65b0\u7684\u6982\u5ff5\uff0c\u5957\u7528\u4e86 AMM \u7684 range order \u7279\u6027\u5230\u6e05\u7b97\u6a5f\u5236\u4f86\uff0c\u78ba\u5be6\u5c0d\u65bc\u50b5\u52d9\u4eba\u66f4\u6709\u53cb\u5584\uff0c\u7576\u50f9\u683c\u56de\u7a69\u7684\u6642\u5019\u640d\u5931\u7684\u7a0b\u5ea6\u5c31\u6703\u5927\u5e45\u964d\u4f4e\u3002\\n\\n\u76f8\u8f03\u65bc\u5176\u4ed6\u5177\u5099\u6e05\u7b97\u6d41\u7a0b\u7684\u7a69\u5b9a\u5e63\u8207\u501f\u8cb8\u5e73\u53f0\u5982 MakerDAO, Compound, AAVE \u4f86\u8aaa\uff0c\u9019\u4e9b\u5e73\u53f0\u5728\u6e05\u7b97\u6642\u6703\u9700\u8981\u4ef0\u8cf4\u5916\u90e8\u7684\u53bb\u4e2d\u5fc3\u5316\u4ea4\u6613\u6240 (DEX) \u5354\u52a9\u6e05\u7b97\u3002\u7576\u5916\u90e8\u7684 DEX \u6d41\u52d5\u6027\u4e0d\u8db3\u6642\uff0c\u7a69\u5b9a\u5e63/\u501f\u8cb8\u5e73\u53f0\u5c31\u6709\u53ef\u80fd\u7522\u751f\u58de\u5e33\u3002\\n\\n\u6bd4\u5982\u8aaa\u5982\u679c\u6709\u500b\u5927\u6236\u6301\u6709 1M \u7684 CRV \u8cc7\u7522\u4f5c\u70ba\u62b5\u62bc\u9700\u8981\u6e05\u7b97\u6642\uff0c\u50b3\u7d71\u7684\u5e73\u53f0\u6703\u900f\u904e\u6298\u6263\u7684\u65b9\u5f0f\u4e00\u6b21\u51fa\u6e05\u9019 1M \u7684\u8cc7\u7522\uff0c\u6b64\u6642\u5982\u679c\u5916\u90e8 DEX \u6d41\u52d5\u6027\u4e0d\u8db3\u5c0e\u81f4\u6ed1\u50f9\u592a\u9ad8\uff0c\u8b93\u53c3\u8207\u6e05\u7b97\u7684\u5229\u76ca\u4e0d\u8db3\u9032\u800c\u964d\u4f4e\u6e05\u7b97\u8005\u53c3\u8207\u7684\u610f\u9858\u6642\uff0c\u7121\u4eba\u6e05\u7b97\u7684\u72c0\u6cc1\u4e0b\u5c31\u6703\u5c0e\u81f4\u58de\u5e33\u3002\\n\\n\u800c LLAMMA \u56e0\u70ba\u5167\u5efa\u4e86\u6d41\u52d5\u6027\u7684\u95dc\u4fc2\uff0c\u7576\u8cc7\u7522\u50f9\u503c\u4e0b\u8dcc\u6642\uff0c\u62b5\u62bc\u54c1\u6703\u88ab\u9010\u6f38\u7684\u63db\u6210\u7a69\u5b9a\u5e63\uff0c\u800c\u6700\u5f8c\u771f\u7684\u9700\u8981\u6e05\u7b97\u7684\u90e8\u4f4d\u5c31\u6703\u6bd4\u50b3\u7d71\u5e73\u53f0\u8981\u5c0f\u5f97\u591a\u3002\u4ee5\u4e0a\u9762\u7684\u4f8b\u5b50\u4f86\u8aaa 1M \u7684 CRV \u5728\u50f9\u683c\u4e0b\u8dcc\u6642\u5c31\u6703\u9010\u6f38\u7684\u88ab\u63db\u6210\u7a69\u5b9a\u5e63\uff0c\u6700\u7d42\u771f\u7684\u89f8\u53ca\u786c\u6e05\u7b97\u9580\u6abb\u6642\uff0c\u6216\u8a31\u53ea\u5269\u4e0b 1% \u7684\u8cc7\u7522\u9700\u8981\u6e05\u7b97\uff0c\u5c0d\u65bc\u5916\u90e8 DEX \u7684\u6d41\u52d5\u6027\u7684\u4f9d\u8cf4\u5c31\u6703\u4f4e\u5f88\u591a\uff0c\u52a0\u5f37\u5e73\u53f0\u7684\u81ea\u4e3b\u904b\u4f5c\u80fd\u529b\u3002\\n\\n\u4f46\u4ea4\u63db\u4ee3\u5e63\u7684\u6298\u6263\u4e5f\u6703\u5e36\u4f86\u4e00\u4e9b\u96b1\u6182\u3002Paradigm \u7684\u9996\u5e2d\u7814\u7a76\u54e1 Dan Robinson \u5728 [\u4ed6\u7684 Tweet](https://twitter.com/danrobinson/status/1595090420740112385) \u63d0\u5230 LLAMMA \u6703\u6709 **Path-Dependence** \u7684\u554f\u984c\u3002\u7531\u65bc LLAMMA \u5167\u90e8\u7528\u7684 AMM \uff08\u4ee5\u4e0b\u7a31\u70ba LLAMM\uff09\u7684\u5b9a\u50f9 $p$ \u6703\u53c3\u8003\u5916\u90e8\u9810\u8a00\u6a5f\u7684\u5b9a\u50f9 $p_o$\uff0c\u6211\u5011\u5047\u8a2d\u5916\u90e8\u7684\u9810\u8a00\u6a5f\u50f9\u683c\u4f86\u6e90\u4ee5\u53ca AMM \u90fd\u662f Uniswap \u4f86\u89e3\u91cb\u9019\u500b\u554f\u984c\u3002\\n\\n\u7576 ETH \u50f9\u683c\u5f9e 1000 USD \u8b8a\u5316\u5230 1200 USD \u7684\u904e\u7a0b\u7576\u4e2d\uff0c\u5047\u8a2d LLAMM \u6703\u9700\u8981\u5728\u9019\u500b\u5340\u6bb5\u4f86\u628a\u7a69\u5b9a\u5e63\u63db\u56de\u62b5\u62bc\u54c1\u3002\u9019\u500b\u904e\u7a0b\u4e2d LLAMM \u6709\u53ef\u80fd\u6703\u5728\u63db\u56de\u62b5\u62bc\u54c1\u7684\u904e\u7a0b\u4e2d\u627f\u53d7\u50f9\u5dee\u7684\u640d\u5931\uff0c\u7aef\u770b\u5916\u90e8\u50f9\u683c $p_o$ \u7684\u8b8a\u5316\u901f\u5ea6\uff0c\u6211\u5011\u4f86\u770b\u50f9\u683c\u7de9\u6162\u4e0a\u6f32\u8ddf\u5feb\u901f\u4e0a\u6f32\u7684\u5169\u7a2e\u72c0\u6cc1\uff1a\\n\\n**\u50f9\u683c\u7de9\u6162\u4e0a\u6f32**\uff1a\u7576 $p_o$ \u50f9\u683c\u7de9\u6162\u4e0a\u6f32\u6642\uff0cLLAMM \u5167\u90e8\u7684\u50f9\u683c\u6703\u53c3\u8003 $p_o$ \u5b9a\u50f9\uff0c\u7528\u7a0d\u5fae\u9ad8\u4e00\u9ede\u7684\u50f9\u683c\u6536\u8cfc ETH\uff0c\u6bd4\u5982\u8aaa $p_o = \\\\text{1000 USD}$ \u6642\u8ce3 1010 USD \uff0c\u5957\u5229\u8005\u5c31\u6703\u5728 Uniswap \u8cb7 ETH\uff0c\u5728 LLAMM \u8ce3 ETH\u3002ETH \u8ce3\u51fa\u4e4b\u5f8c LLAMM \u5167\u90e8\u7684\u50f9\u683c\u5c31\u6703\u6162\u6162\u9760\u8fd1 1000 USD\uff0c\u6240\u4ee5\u5728\u9019\u500b\u7de9\u6162\u4e0a\u6f32\u7684\u6d41\u7a0b\u4e2d\uff0cLLAMM \u6c60\u5b50\u53ef\u80fd\u6703\u4ee5\u4e9b\u5fae\u6298\u6263\u7684\u65b9\u5f0f\u8cb7\u56de ETH\uff0c\u6bd4\u5982\u8aaa\u5747\u50f9\u70ba 1150 USD\u3002\\n\\n**\u50f9\u683c\u5feb\u901f\u4e0a\u6f32**\uff1a\u7576 $p_o$ \u5feb\u901f\u5f9e 1000 USD \u4e0a\u6f32\u5230 1200 USD \u6642\uff0c\u5feb\u5230\u5957\u5229\u8005\u6c92\u6709\u5728\u9019\u4e4b\u9593\u9032\u884c\u5957\u5229\u3002\u6b64\u6642\u56e0\u70ba $p_o = \\\\text{1200 USD}$\uff0c\u800c LLAMM \u5167\u90e8\u7684\u50f9\u683c\u70ba\u4e86\u8981\u8ddf\u4e0a\u5916\u90e8\u9810\u8a00\u6a5f\u7684\u50f9\u683c\uff0c\u5b83\u5c31\u6703\u7528\u66f4\u9ad8\u7684\u50f9\u683c\u6536\u8cfc ETH\uff0c\u5c31\u53ef\u4ee5\u5438\u5f15\u5957\u5229\u8005\u5728 Uniswap \u8cb7 ETH \u4e26\u4e14\u5728 LLAMM \u8ce3 ETH\u3002\u5982\u6b64\u4e00\u4f86\u8f49\u63db ETH \u7684\u5747\u50f9\u5c31\u6703\u9ad8\u65bc 1200 USD\u3002\\n\\n\u5982\u679c\u7ad9\u5728 LLAMM \u6c60\u5b50\u7684\u89d2\u5ea6\u4f86\u8aaa\uff0c\u50f9\u683c\u7de9\u6162\u4e0a\u6f32\u7684\u72c0\u6cc1\u6703\u8b93\u6536\u8cfc\u50f9\u683c\u6bd4\u8f03\u5408\u7406\uff0c\u4f46\u662f\u5982\u679c\u9047\u5230\u5feb\u901f\u4e0a\u6f32\u6642\uff0c\u5c31\u6703\u9020\u6210 LLAMM \u6c60\u5b50\u627f\u53d7\u50f9\u5dee\u640d\u5931\uff0c\u800c\u9019\u500b\u50f9\u5dee\u640d\u5931\u4e5f\u5c31\u662f\u50b5\u52d9\u4eba\u7684\u640d\u5931\u3002\\n\\n\u7576\u7136\uff0c\u5982\u679c\u8ddf\u5b8c\u5168\u88ab\u6e05\u7b97\u76f8\u8f03\u8d77\u4f86\uff0c\u6216\u8a31\u9019\u6a23\u7684\u50f9\u5dee\u640d\u5931\u9084\u662f\u6bd4\u8f03\u5c0f\u3002\u4f46\u7531\u65bc\u4e4b\u4e2d\u9084\u6709\u8a31\u591a\u4e0d\u78ba\u5b9a\u7684\u56e0\u7d20\uff0c\u9084\u6703\u9700\u8981\u66f4\u591a\u7684\u8cc7\u8a0a\u4f86\u5224\u65b7\u53ef\u80fd\u9020\u6210\u7684\u640d\u5931\u7a0b\u5ea6\u3002\\n\\n\u7e3d\u9ad4\u4f86\u8aaa\uff0cLLAMMA \u78ba\u5be6\u662f\u4e00\u500b\u53ef\u4ee5\u9032\u4e00\u6b65\u7814\u7a76\u7684\u65b0\u6e05\u7b97\u65b9\u6cd5\uff0c\u800c\u4e14\u4e0d\u4e00\u5b9a\u662f\u7a69\u5b9a\u5e63\uff0c\u6709\u9700\u8981\u6e05\u7b97\u7684\u5834\u5408\u5982\u501f\u8cb8\u5e73\u53f0\u6216\u662f\u53bb\u4e2d\u5fc3\u5316\u7684\u884d\u751f\u6027\u5546\u54c1\u5354\u8b70\u4e5f\u53ef\u4ee5\u8003\u616e\u7528\u540c\u6a23\u7684\u6e05\u7b97\u65b9\u5f0f\u4f86\u6e1b\u4f4e\u50b5\u52d9\u4eba\u5728\u6e05\u7b97\u62b5\u62bc\u54c1\u5e36\u4f86\u7684\u640d\u5931\u3002\\n\\n### PegKeeper \u7a69\u5b9a\u6a5f\u5236\\n\u81f3\u65bc PegKeeper \u900f\u904e Curve MetaPool \u6240\u9032\u884c\u7684\u7a69\u5b9a\u639b\u52fe\u65b9\u5f0f\uff0c\u6211\u5247\u6bd4\u8f03\u5b58\u7591\u3002\u5982\u679c\u8aaa DAI \u662f\u900f\u904e\u5347\u606f\u3001\u964d\u606f\u7684\u65b9\u5f0f\u8abf\u6574\u5e02\u5834\u71b1\u5ea6\uff0cPegKeeper \u5247\u662f\u66f4\u70ba\u6fc0\u9032\u76f4\u63a5\u900f\u904e\u985e\u4f3c\u91cf\u5316\u5bec\u9b06/\u7dca\u7e2e\u7684\u65b9\u5f0f\u5370\u51fa\u9214\u7968\u6295\u5230\u6240\u9700\u7684\u5e02\u5834\u3002\u7576\u7136\u900f\u904e\u667a\u80fd\u5408\u7d04\u7684\u9650\u5236\u9084\u662f\u6703\u6bd4\u8d77\u91cf\u5316\u5bec\u9b06\u66f4\u70ba\u900f\u660e\uff0c\u4f46\u662f\u9084\u9700\u8981\u9032\u4e00\u6b65\u6df1\u7a76\u662f\u5426\u6709\u5f71\u97ff\u5e02\u5834\u7d93\u6fdf\u6240\u5e36\u4f86\u7684\u526f\u4f5c\u7528\u3002\\n\\n\u53e6\u5916\u4e00\u65b9\u9762\u5728\u9019\u500b\u7a69\u5b9a\u9328\u5b9a\u7528\u7684 MetaPool \u7576\u4e2d\u65b0\u9444\u9020\u7684 crvUSD \u662f\u7121\u62b5\u62bc\u751f\u6210\u7684\uff0c\u6216\u8005\u662f\u8aaa\u662f\u4ee5\u53e6\u5916\u4e00\u5074\u7684 LP \u4ee3\u5e63\u5982 3crv \u4f5c\u70ba\u62b5\u62bc\u751f\u6210\uff0c\u800c\u900f\u904e\u5957\u5229\u8005\u7684\u642c\u904b\u4f86\u8b93 crvUSD \u91cd\u65b0\u9328\u5b9a\u5230 1 \u7f8e\u91d1\uff0c\u5be6\u969b\u4e0a\u6703\u640d\u5bb3\u6d41\u52d5\u6027\u63d0\u4f9b\u8005\u7684\u5229\u76ca\u3002\u56e0\u70ba\u5957\u5229\u8005\u900f\u904e\u50f9\u5dee\u5957\u5229\u6642\uff0c\u6d41\u52d5\u6027\u63d0\u4f9b\u8005\u5c31\u4f5c\u70ba\u4ed6\u7684\u5c0d\u5bb6\u627f\u53d7\u640d\u5931\u3002\\n\\n\u9019\u65b9\u9762\u9084\u4e0d\u77e5\u9053\u4ea4\u6613\u8cbb\u662f\u5426\u8db3\u4ee5\u8986\u84cb\u50f9\u5dee\u7684\u640d\u5931\uff0c\u53ef\u80fd\u9084\u9700\u8981\u9032\u4e00\u6b65\u7684\u6a5f\u5236\u53bb\u88dc\u511f\u6d41\u52d5\u6027\u63d0\u4f9b\u8005\u624d\u53ef\u4ee5\u5b8c\u6210\u6574\u500b\u7a69\u5b9a\u6a5f\u5236\u3002\u5982\u679c\u6c92\u6709\u734e\u52f5\u6a5f\u5236\uff0c\u8981\u5982\u4f55\u9f13\u52f5\u4f7f\u7528\u8005\u4f86\u70ba crvUSD \u63d0\u4f9b\u7a69\u5b9a\u6a5f\u5236\uff1f\u9019\u4e5f\u662f\u76ee\u524d\u767d\u76ae\u66f8\u4e26\u6c92\u6709\u6db5\u84cb\u5230\u7684\u6982\u5ff5\u3002\\n\\n### \u7d50\u8a9e\\n\u4f46 crvUSD \u76ee\u524d\u4e5f\u9084\u6c92\u6709\u4e0a\u7dda\uff0c\u76f8\u4fe1\u672a\u4f86\u9019\u4e9b\u7591\u554f\u9084\u53ef\u4ee5\u9032\u4e00\u6b65\u7684\u88ab\u56de\u7b54\u6216\u662f\u6539\u5584\uff0c\u4e5f\u671f\u5f85\u4ed6\u5011\u6b63\u5f0f\u4e0a\u7dda\u4f86\u9a57\u8b49\u4ed6\u5011\u7684\u60f3\u6cd5\u3002\\n\\n\u6700\u5f8c\u5982\u679c\u4f60\u5c0d\u672c\u6587\u6709\u4efb\u4f55\u7684\u554f\u984c\uff0c\u6b61\u8fce\u5230 [\u8a0e\u8ad6\u5340](https://github.com/lun-dao/LunDAO/discussions/100) \u63d0\u51fa\uff01\\n\\n\u6587\u672b\u60f3\u611f\u8b1d\u5be9\u7a3f\u4eba [@paco0x](https://github.com/paco0x) \u5c0d\u672c\u6587\u7684\u8ca2\u737b\uff0c\u611f\u8b1d\u4ed6\u63d0\u4f9b\u4e86 Path-Dependence \u4ee5\u53ca LLAMMA \u6e1b\u4f4e\u5916\u90e8\u6d41\u52d5\u6027\u4f9d\u8cf4\u7684\u76f8\u95dc\u8cc7\u8a0a\u3002\u95dc\u65bc\u6587\u7ae0\u5be9\u7a3f\u7684\u8a0e\u8ad6\uff0c\u8acb\u898b [Pull Request #101](https://github.com/lun-dao/LunDAO/pull/101)\u3002"},{"id":"diamond101-4","metadata":{"permalink":"/blog/diamond101-4","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-11-3-diamond101/diamond101-4.md","source":"@site/blog/2022-11-3-diamond101/diamond101-4.md","title":"Diamond 101 (4)","description":"EIP-2535 Diamond Contract","date":"2022-11-03T00:00:00.000Z","formattedDate":"November 3, 2022","tags":[{"label":"eip2535","permalink":"/blog/tags/eip-2535"},{"label":"diamond","permalink":"/blog/tags/diamond"},{"label":"proxy","permalink":"/blog/tags/proxy"}],"readingTime":4.38,"truncated":true,"authors":[{"name":"wiasliaw","url":"https://github.com/wiasliaw","imageURL":"https://github.com/wiasliaw.png","key":"wiasliaw"}],"prevItem":{"title":"LLAMMA - crvUSD \u7684\u65b0\u6e05\u7b97\u6a5f\u5236","permalink":"/blog/crvusd"},"nextItem":{"title":"Diamond 101 (2)","permalink":"/blog/diamond101-2"}},"content":"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u56db\u7bc7\u6587\u7ae0\uff0c\u4f86\u8a0e\u8ad6\u9019\u500b EIP \u8457\u540d\u53cd\u65b9\u7684\u610f\u898b\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u5728 2020 \u5341\u6708\u7684\u6642\u5019\uff0c\u4e00\u9593\u8457\u540d\u7684\u5be9\u8a08\u516c\u53f8\u5beb\u4e86\u4e00\u7bc7\u975e\u5e38\u77e5\u540d\u7684\u6587\u7ae0\uff0c\u9019\u7bc7\u6587\u7ae0\u76f4\u5230\u73fe\u5728\u90fd\u9084\u6703\u88ab\u62ff\u4f86\u8a8d\u70ba\u662f Diamond \u7684\u53cd\u9762\u6559\u6750\u3002\u6a19\u984c\u975e\u5e38\u8073\u52d5\uff0c\u76f4\u63a5\u8aaa\u660e Diamond \u662f\u500b bad design\u3002\u4ee5\u4e0b\u4f86\u770b\u770b Trait of Bits \u627e\u5230\u4e86\u4ec0\u9ebc\u3002\\n\\n![https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/](./trait_of_bits.png)\\n\\n## a. Over-engineered code\\n\\n### IDiamondCut\\n\\n\u770b\u770b\u539f\u672c EIP \u76f8\u95dc\u7684\u5be6\u4f5c\uff0c`diamondCut` \u662f diamond \u552f\u4e00\u7684\u5347\u7d1a\u51fd\u5f0f\uff0c\u4f46\u662f\u9019\u500b\u51fd\u5f0f\u8a2d\u8a08\u7684\u975e\u5e38\u8907\u96dc\u3002Diamond \u662f\u4e00\u500b Lookup Table \u8a18\u9304 function selector \u5c0d\u61c9\u7684\u5730\u5740\uff0c\u5347\u7d1a\u9084\u5206\u6210 Add/Remove/Replace \u4e09\u7a2e\uff0c\u5404\u81ea\u9084\u6709\u4e0d\u540c\u7684\u6aa2\u67e5\uff0c\u4e00\u822c\u7684\u5347\u7d1a\u5408\u7d04\u53ea\u5206\u6210 Set/Unset \u5169\u7a2e\u3002\u9019\u589e\u52a0\u4e86\u5f88\u591a\u5347\u7d1a\u8907\u96dc\u5ea6\u3002\\n\\n\u4e0d\u904e\u5728\u8a62\u554f\u904e\u4f5c\u8005\u70ba\u4f55\u4e0d\u662f Set/Unset \u4e4b\u5f8c\uff0c\u4f5c\u8005\u7d66\u6211\u7684\u7406\u7531\u6211\u4e5f\u53ef\u4ee5\u7406\u89e3\u3002`diamondCut` \u6703\u5728\u4e00\u7b46 transaction \u88e1\u9762\u66f4\u65b0\u8a31\u591a\u7684\u5730\u5740\uff0c\u91dd\u5c0d\u4e0d\u540c\u7684\u884c\u7232\u505a\u6aa2\u67e5\u907f\u514d\u524d\u5f8c\u7684\u4fee\u6539\u767c\u751f\u932f\u8aa4\u3002\\n\\n### IDiamondLoupe\\n\\n\u9019\u90e8\u5206\u7684\u7a0b\u5f0f\u78bc\u8907\u96dc\u5247\u662f\u56e0\u70ba\u771f\u7684\u300cover-engineered\u300d\uff0c\u9023\u5e36\u9020\u6210\u8cc7\u6599\u6b04\u4f4d\u8a2d\u8a08\u8907\u96dc\u3002\\n\\nLookup Table \u8a2d\u8a08\u4e0a\u6975\u70ba\u7c21\u55ae\uff0c`mapping(bytes4 => address)` \u9019\u6a23\u5c31\u597d\u4e86\u3002\u9802\u591a\u4e5f\u53ea\u6709 `IDiamondCut` \u5728\u5347\u7d1a\u904e\u7a0b\u9700\u8981\u505a\u4e0d\u5c11\u8655\u7406\u3002\\n\\n\u518d\u4f86\u770b\u770b `IDiamondLoupe` \u63d0\u4f9b\u4ec0\u9ebc\u6a23\u7684 view function\uff0c\u4e00\u5171\u56db\u500b\uff1a\\n- `facets`: \u63d0\u4f9b\u6240\u6709\u8a3b\u518a\u5728 Lookup Table \u7684 logic contract \u7684\u5730\u5740\u548c\u6240\u6709\u8a3b\u518a\u904e\u7684 function selector\\n- `facetFunctionSelectors`: \u63d0\u4f9b\u4e00\u500b logic contract \u6240\u6709\u8a3b\u518a\u904e\u7684 function selector\\n- `facetAddresses`: \u63d0\u4f9b\u6240\u6709\u8a3b\u518a\u5728 Lookup Table \u7684 logic contract \u7684\u5730\u5740\\n- `facetAddress`: \u5c0b\u627e selector \u662f\u54ea\u500b logic contract \u6240\u63d0\u4f9b\u7684\\n\\n```solidity\\ninterface IDiamondLoupe {\\n  struct Facet {\\n    address facetAddress;\\n    bytes4[] functionSelectors;\\n  }\\n\\n  function facets() external view returns (Facet[] memory facets_);\\n\\n  function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory facetFunctionSelectors_);\\n\\n  function facetAddresses() external view returns (address[] memory facetAddresses_);\\n\\n  function facetAddress(bytes4 _functionSelector) external view returns (address facetAddress_);\\n}\\n```\\n\\n\u9019\u56db\u500b\u51fd\u5f0f\u9020\u6210 Lookup Table \u9700\u8981\u984d\u5916\u8a18\u9304\u6240\u6709\u7684 function selector\uff0c\u6240\u4ee5 storage \u9577\u6210\u4e86\u9019\u526f\u6a21\u6a23\u3002\u9019\u662f\u500b Enumerable Set\uff0c\u4e00\u534a\u7684 view function \u9700\u8981\u5c07\u6574\u500b Set \u6383\u904e\u4e00\u6b21\uff0c\u9019\u61c9\u8a72\u6211\u982d\u4e00\u500b\u770b\u5230\u300c\u70ba\u4e86\u67e5\u8a62\u4f7f\u5f97\u8907\u96dc\u5ea6\u8b8a\u9ad8\u7684\u8a2d\u8a08\u300d\u3002\\n\\n```solidity\\nstruct FacetAddressAndSelectorPosition {\\n  address facetAddress;\\n  uint16 selectorPosition;\\n}\\n\\nstruct DiamondStorage {\\n  mapping(bytes4 => FacetAddressAndSelectorPosition) facetAddressAndSelectorPosition;\\n  bytes4[] selectors;\\n}\\n```\\n\\n## b. Storage pointer risks\\n\\n\u9019\u662f\u6240\u6709\u4f7f\u7528 unstructured storage \u4f5c\u70ba\u7ba1\u7406 storage \u7684\u901a\u75c5\u3002unstructured storage \u662f\u5c07\u8cc7\u6599\u5132\u5b58\u5230\u7279\u5b9a slot \u7684 storage \u7ba1\u7406\u65b9\u5f0f\uff0c\u4f46\u662f\u9019\u6a23\u7684\u624b\u6cd5\u4e0d\u6703\u8f38\u51fa\u6210 storage layout \u7684\u6a94\u6848\uff0c\u6240\u4ee5\u4e5f\u6c92\u8fa6\u6cd5\u7528 slither \u7b49\u5de5\u5177\u5206\u6790\u3002\\n\\n```solidity\\nassembly {\\n  ds.slot := PTR\\n}\\n```\\n\\n## c. Function shadowing\\n\\nFunction shadowing \u662f\u6307 Proxy \u4e0a\u6709\u5be6\u4f5c\u4e00\u4e9b external function\uff0c\u6240\u4ee5\u540c\u6a23 function selector \u7684\u51fd\u5f0f\u4e0d\u6703\u88ab delegatecall \u5230 logic contract \u57f7\u884c\uff0c\u800c\u662f\u5728 proxy \u4e0a\u88ab\u57f7\u884c\u3002\u4f46\u662f\u6211\u5728\u73fe\u5728\u7684 repo \u6c92\u6709\u770b\u5230\u9019\u985e\u554f\u984c\u3002\\n\\n## d. No contract existence check\\n\\nDiamond \u662f\u5728\u5347\u7d1a\u904e\u7a0b\u4e2d\u6aa2\u67e5\uff0c\u53ea\u6709\u5408\u6cd5\u5730\u5740\u624d\u53ef\u4ee5\u5beb\u5165 lookup table\uff0c\u4f46\u662f Trait of Bits \u53ea\u770b\u5230 fallback function \u6c92\u6aa2\u67e5\u3002\\n\\n# Conclusion\\n\\n\u7e3d\u7d50\u4f86\u8aaa\uff0cTrait of Bits \u6aa2\u67e5\u5230\u7684 security issue \u5f88\u591a\u90fd\u662f\u4e0d\u5b58\u5728\u7684\uff0c\u9664\u4e86 over-engineered \u9084\u6709\u8b8a\u9ad8\u7684 gas cost \u4e4b\u5916\uff0cLookup Table \u52a0\u4e0a unstructured storage \u7684\u78ba\u53ef\u4ee5\u505a\u5230\u53ea\u5347\u7d1a\u55ae\u4e00\u500b\u51fd\u5f0f\uff0c\u800c\u4e14\u5347\u7d1a\u53ef\u4ee5\u6709\u66f4\u591a\u7684\u5f48\u6027\uff0c\u4e0d\u904e\u4e5f\u9700\u8981\u958b\u767c\u8005\u719f\u6089\u66f4\u591a\u7684\u77e5\u8b58\u548c\u7ba1\u7406\u591a\u500b logic contract \u6240\u7522\u751f\u7684\u554f\u984c\u3002\\n\\n\u984c\u5916\u8a71\uff0c\u9019\u500b EIP \u4eca\u5e74\u7d42\u65bc Final \u4e86\uff0cOpenzeppelin \u4e5f\u6253\u7b97\u8981\u652f\u63f4 EIP-2535\uff0c\u9700\u8981\u4f86\u5beb\u4e00\u7bc7\u4f86\u70ba\u9019\u7cfb\u5217\u6536\u5c3e XDD\\n\\n![https://twitter.com/mudgen/status/1582918237380960256](./diamond_final.png)\\n\\n# Reference\\n\\n- [Good idea, bad design: How the Diamond standard falls short](https://blog.trailofbits.com/2020/10/30/good-idea-bad-design-how-the-diamond-standard-falls-short/)"},{"id":"diamond101-2","metadata":{"permalink":"/blog/diamond101-2","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-07-04-diamond101/diamond101-2.md","source":"@site/blog/2022-07-04-diamond101/diamond101-2.md","title":"Diamond 101 (2)","description":"EIP-2535 Diamond Contract","date":"2022-07-04T00:00:00.000Z","formattedDate":"July 4, 2022","tags":[{"label":"eip2535","permalink":"/blog/tags/eip-2535"},{"label":"diamond","permalink":"/blog/tags/diamond"},{"label":"proxy","permalink":"/blog/tags/proxy"}],"readingTime":2.65,"truncated":true,"authors":[{"name":"wiasliaw","url":"https://github.com/wiasliaw","imageURL":"https://github.com/wiasliaw.png","key":"wiasliaw"}],"prevItem":{"title":"Diamond 101 (4)","permalink":"/blog/diamond101-4"},"nextItem":{"title":"Diamond 101 (3)","permalink":"/blog/diamond101-3"}},"content":"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u4e8c\u7bc7\u6587\u7ae0\uff0c\u5c07\u89e3\u91cb\u9019\u500b EIP \u5177\u9ad4\u7684\u5be6\u4f5c\u7d30\u7bc0\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## Contract Architecture\\n\\n\u9996\u5148\u4f86\u770b\u4e00\u4e0b\u4f7f\u7528 EIP-2535 \u7684\u5408\u7d04\u67b6\u69cb\u5716\u3002EIP-2535 \u767c\u660e\u4e86\u5f88\u591a\u8853\u8a9e\uff0c\u5716\u4e2d **Diamond** \u5c31\u662f Proxy Contract\uff0c**Facet** \u5c31\u662f Logic Contract\u3002\u4e00\u6709\u5408\u7d04\u8abf\u7528\uff0c\u5247\u6703\u5148\u5728 Lookup Table \u67e5\u8a62\u6709\u6c92\u6709 selector \u7684\u8cc7\u6599\uff0c\u7136\u5f8c\u8abf\u7528 delegatecall \u904e\u53bb\uff0c\u8cc7\u6599\u4e00\u6a23\u5beb\u5728 Proxy \u88e1\u9762\u3002\\n\\n![](./diamond_structure.png)\\n\\n## Lookup Table\\n\\nLookup Table \u7684\u8cc7\u6599\u7d50\u69cb\u53ef\u4ee5\u4ee5 `mapping` \u6216\u662f array \u7b49\u4f86\u8a2d\u8a08\uff0c\u4f5c\u8005\u4ee5 `bytes4[]` \u548c `mapping` \u4e00\u8d77\u4f7f\u7528\uff0c\u4e3b\u8981\u662f\u70ba\u4e86\u9054\u6210 Enumerable \u7684\u7279\u6027\u3002\u53e6\u5916\u70ba\u4e86\u907f\u514d storage collision\uff0c\u4e5f\u5c07 Lookup Table \u653e\u5230\u7279\u5b9a\u7684 storage \u88e1\u9762\u3002\\n\\n**Lookup Table** \u7684\u8cc7\u6599\u7d50\u69cb\u548c storage slot\\n```js\\nbytes32 constant DIAMOND_STORAGE_POSITION = keccak256(\\"diamond.standard.diamond.storage\\");\\n\\nstruct FacetAddressAndSelectorPosition {\\n    address facetAddress;\\n    uint16 selectorPosition;\\n}\\n\\nstruct DiamondStorage {\\n    // function selector => facet address and selector position in selectors array\\n    mapping(bytes4 => FacetAddressAndSelectorPosition) facetAddressAndSelectorPosition;\\n    bytes4[] selectors;\\n    mapping(bytes4 => bool) supportedInterfaces;\\n    // owner of the contract\\n    address contractOwner;\\n}\\n```\\n\\n## Loupe\\n\\n\u5be6\u4f5c\u4e86 Lookup Table \u67e5\u8a62\u529f\u80fd\u7684 Facet \u7a31\u70ba Loupe\uff0c\u4e3b\u8981\u529f\u80fd\u70ba Lookup Table \u7684\u67e5\u8a62\u3002\u70ba\u4f55 Lookup Table \u7684\u8cc7\u6599\u7d50\u69cb\u90a3\u9ebc\u8907\u96dc\uff0c\u770b\u770b\u9019\u5806\u67e5\u8a62\u51fd\u5f0f\u80fd\u4ec0\u9ebc\u8cc7\u6599\u5c31\u77e5\u9053\u4e86\u3002\\n\\n```js\\ninterface IDiamondLoupe {\\n    struct Facet {\\n        address facetAddress;\\n        bytes4[] functionSelectors;\\n    }\\n\\n    function facets() external view returns (Facet[] memory facets_);\\n\\n    function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory facetFunctionSelectors_);\\n\\n    function facetAddresses() external view returns (address[] memory facetAddresses_);\\n\\n    function facetAddress(bytes4 _functionSelector) external view returns (address facetAddress_);\\n}\\n```\\n\\n## diamondCut\\n\\n`diamondCut` \u5247\u662f\u4e00\u500b\u51fd\u5f0f\uff0c\u5c08\u9580\u7ba1\u7406\uff08\u65b0\u589e\u3001\u522a\u9664\u3001\u4fee\u6b63\uff09Lookup Table\u3002\\n\\n```js\\ninterface IDiamondCut {\\n    // Add = 0, Replace = 1, Remove = 2\\n    enum FacetCutAction {Add, Replace, Remove}\\n\\n    struct FacetCut {\\n        address facetAddress;\\n        FacetCutAction action;\\n        bytes4[] functionSelectors;\\n    }\\n\\n    function diamondCut(\\n        FacetCut[] calldata _diamondCut,\\n        address _init,\\n        bytes calldata _calldata\\n    ) external;\\n\\n    event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);\\n}\\n```\\n\\n## Glossary\\n\\n\u5217\u51fa EIP2535 \u767c\u660e\u7684\u8853\u8a9e\\n\\n- **diamond**: Proxy Contract\\n- **facet**: Logic Contract\\n- **loupe**: \u4e00\u500b\u5be6\u4f5c Diamond \u67e5\u8a62\u4ecb\u9762\u7684 Facet\\n- **diamondCut**: \u4e00\u500b\u7279\u5b9a\u7684\u51fd\u5f0f\u540d\u7a31\uff0c\u5c08\u9580\u7528\u4f86\u7ba1\u7406\uff08\u65b0\u589e\u3001\u522a\u9664\u3001\u4fee\u6b63\uff09Lookup Table\\n- **Upgradeable Diamond**: \u6709\u8a3b\u518a `diamondCut` \u7684 Diamond Contract\uff0c\u53ef\u4ee5\u8a3b\u518a\u65b0\u7684\u51fd\u5f0f\u5230 Lookup Table \u88e1\u505a\u5347\u7d1a\\n- **Finished Diamond**: \u4e00\u500b Upgradeable Diamond\uff0c\u6b77\u7d93\u5347\u7d1a\u8fed\u4ee3\u5f8c\u529f\u80fd\u90fd\u5b8c\u5168\u4e86\uff0c\u6700\u5f8c\u5c07 `diamondCut` \u79fb\u9664 Lookup Table\\n- **Single Cut Diamond**: \u53ea\u5728 constructor \u8a3b\u518a function \u9032\u8a3b\u518a\u8868\uff0c\u90e8\u7f72\u5b8c\u6210\u5f8c\u5c31\u4e0d\u80fd\u505a\u4efb\u4f55\u5347\u7d1a"},{"id":"diamond101-3","metadata":{"permalink":"/blog/diamond101-3","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-07-04-diamond101/diamond101-3.md","source":"@site/blog/2022-07-04-diamond101/diamond101-3.md","title":"Diamond 101 (3)","description":"EIP-2535 Diamond Contract","date":"2022-07-04T00:00:00.000Z","formattedDate":"July 4, 2022","tags":[{"label":"eip2535","permalink":"/blog/tags/eip-2535"},{"label":"diamond","permalink":"/blog/tags/diamond"},{"label":"proxy","permalink":"/blog/tags/proxy"}],"readingTime":3.79,"truncated":true,"authors":[{"name":"wiasliaw","url":"https://github.com/wiasliaw","imageURL":"https://github.com/wiasliaw.png","key":"wiasliaw"}],"prevItem":{"title":"Diamond 101 (2)","permalink":"/blog/diamond101-2"},"nextItem":{"title":"Hardhat tracer","permalink":"/blog/hardhat-tracer"}},"content":"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u4e09\u7bc7\u6587\u7ae0\uff0c\u5c07\u89e3\u91cb\u9019\u500b EIP \u5177\u9ad4\u7684\u5be6\u4f5c\u7d30\u7bc0\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u4e0a\u4e00\u7bc7[\u6587\u7ae0](./diamond101-2.md)\u4ecb\u7d39\u4e86 Diamond \u7684 Lookup Table\uff0c\u7528\u4f86\u7d00\u9304 function selector \u548c\u8981\u8abf\u7528\u7684\u5408\u7d04\u5730\u5740\u9032\u53bb\uff0c\u7576\u9700\u8981\u8abf\u7528\u5408\u7d04\u6642\u5247\u6703\u900f\u904e `msg.sig` \u67e5\u8a62 Lookup Table\uff0c\u4e26 delegatecall \u5230\u7d00\u9304\u7684\u5730\u5740\u3002\\n\\n## Storage Management\\n\\n\u5148\u770b\u770b\u4e4b\u524d\u7684 Proxy \u600e\u9ebc\u7ba1\u7406 storage\u3002Transparent Proxy \u8ddf UUPS \u4e3b\u8981\u7684 storage layout \u90fd\u662f\u5b9a\u7fa9\u5728 Logic Contract \u4e0a\uff0cProxy \u7d00\u9304\u7684\u5730\u5740\u90fd\u6703\u5132\u5b58\u5728\u7279\u5b9a\u7684 slot \u4e0a (\u53c3\u8003 EIP-1967)\uff0c Upgrade \u6642\u5247\u63db\u6389\u8a18\u9304\u5728 Proxy \u4e0a\u7684\u5730\u5740\uff0c\u5c0d\u958b\u767c\u8005\u4f86\u8aaa\u53ea\u8981\u8655\u7406\u597d\u65b0\u7684 Logic Contract \u4e0d\u8981\u8ddf\u820a\u7684\u5408\u7d04\u767c\u751f storage collision \u5373\u53ef\u3002\u800c Diamond \u8981\u7ba1\u7406 Lookup Table \u7684 storage \u9084\u6709\u6578\u500b Logic Contract \u8981\u5132\u5b58\u548c\u5beb\u5165\u7684 storage\u3002\u9019\u908a\u4ee5\u300c\u4e0d\u540c Logic Contract \u7684\u8655\u7406\u300d\u8209\u4f8b\u3002\\n\\n\u770b\u770b\u4e0b\u9762\u5169\u500b Logic Contract\uff0c\u5982\u679c\u8a3b\u518a\u5230 Diamond \u88e1\u9762\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\uff1f\u56e0\u70ba\u5169\u500b\u51fd\u5f0f\u7684 side effect \u90fd\u662f\u4f5c\u7528\u5728\u540c\u4e00\u500b slot \u4e0a\uff0c\u5148\u8abf\u7528 `setA` \u5beb\u5165\u7684\u6578\u503c\u4e4b\u5f8c\u518d\u8abf\u7528 `setB` \u5c31\u6703\u88ab\u8986\u5beb\u6389\u3002\u800c Solidity \u6c92\u6709\u90a3\u9ebc\u8070\u660e\u77e5\u9053\u9019\u500b slot \u5c08\u5c6c\u65bc\u54ea\u500b Logic Contract \u4e26\u9632\u6b62\u5176\u4ed6 Logic Contract \u5beb\u5165\uff0c\u56e0\u6b64\u4ee5 Diamond \u8a2d\u8a08\u7684\u5408\u7d04\u67b6\u69cb\u9700\u8981\u8a2d\u8a08\u4e00\u5957 storage \u7684\u7ba1\u7406\u6a5f\u5236\u4f86\u9650\u5236 Logic Contract\u3002\\n\\n```javascript\\ncontract LogicA {\\n  uint256 private _a; // slot 0\\n\\n  function setA(uint256 a_) external {\\n    _a = a_;\\n  }\\n}\\n\\ncontract LogicB {\\n  uint256 private _b; // slot 0\\n\\n  function setB(uint256 b_) external {\\n    _b = b_;\\n  } \\n}\\n```\\n\\n### 1. EIP-1967\\n\\nEIP-2535 \u6c92\u6709\u898f\u5b9a\u5982\u4f55\u7ba1\u7406 storage\u3002\u4f46\u662f\u4f5c\u8005\u5728\u5176\u4ed6\u6587\u7ae0\u63d0\u51fa\u76f8\u95dc\u7684\u505a\u6cd5\u3002\u7b2c\u4e00\u500b\u662f\u53c3\u8003 EIP-1967 \u5c07\u8cc7\u6599\u64fa\u5230\u7279\u5b9a\u7684 slot \u4e0a\u3002\u6bcf\u500b Logic Contract \u90fd\u5b9a\u7fa9\u4e00\u500b\u7279\u5b9a\u7684\u5730\u65b9\u4f86\u653e\u8cc7\u6599\u5c31\u4e0d\u6703\u767c\u751f storage collision \u4e86\u3002Lookup Table \u4e5f\u662f\u4e00\u6a23\uff0c\u653e\u5230\u7279\u5b9a\u7684 slot \u4e0a\uff0c\u4e5f\u4e0d\u6703\u548c LogicA, LogicB \u767c\u751f storage collision\u3002\\n\\n\u62ff\u4e0a\u9762\u5169\u500b\u5408\u7d04\u4fee\u6539\uff0c\u5982\u4e0b\u3002Solidity \u53ef\u4ee5 inline assembly \u6307\u5b9a\u8981\u8cc7\u6599\u8981\u653e\u5230\u54ea\u500b slot \u88e1\uff0c\u901a\u5e38\u4ee5\u4e00\u6bb5\u5b57\u4e32\u7684\u96dc\u6e4a\u4f5c\u70ba\u7279\u5b9a\u7684 index \u5132\u5b58\u3002\\n```javascript\\ncontract LogicA {\\n  bytes32 constant private _slot_a = keccak256(\\"logic_a\\");\\n\\n  struct AStorage {\\n    uint256 value; // slot[keccak256(\\"logic_a\\")]\\n  }\\n\\n  function _storage() private pure returns (AStorage storage s) {\\n      bytes32 position = _slot_a;\\n      assembly {\\n          s.slot := position\\n      }\\n  }\\n\\n  function setA(uint256 a_) external {\\n    _storage().value = a_;\\n  }\\n}\\n\\ncontract LogicB {\\n  bytes32 constant private _slot_b = keccak256(\\"logic_b\\");\\n\\n  struct BStorage {\\n    uint256 value; // slot[keccak256(\\"logic_b\\")]\\n  }\\n\\n  function _storage() private pure returns (BStorage storage s) {\\n      bytes32 position = _slot_b;\\n      assembly {\\n          s.slot := position\\n      }\\n  }\\n\\n  function setB(uint256 b_) external {\\n    _storage().value = b_;\\n  } \\n}\\n```\\n\\n### 2. AppStorage\\n\\n\u4f5c\u8005\u63d0\u51fa\u7684\u53e6\u5916\u4e00\u500b\u4f5c\u6cd5\u7a31\u70ba `AppStorage`\uff0c\u5728\u6bcf\u500b\u5408\u7d04\u90fd\u5b9a\u7fa9\u597d\u4e00\u6a21\u4e00\u6a23\u7684 layout\uff0c\u5c31\u4e0d\u6703\u6709\u8aa4\u5beb\u5230\u5176\u4ed6 slot \u4e86\u3002\u53ef\u4ee5\u53c3\u8003 [aavegotchi](https://github.com/aavegotchi/aavegotchi-contracts/blob/ff456818465623d9d718869da9047ddce54d9a6e/contracts/Aavegotchi/libraries/LibAppStorage.sol#L189) \u600e\u9ebc\u5b9a\u7fa9 AppStorage \u7684\u3002\u4e0d\u904e aavegotchi \u4e2d Lookup Table \u9084\u662f\u4f7f\u7528 EIP-1967 \u7684\u65b9\u5f0f\u653e\u5728\u5225\u7684 slot\u3002\\n\\n\u62ff\u4e0a\u9762\u5169\u500b\u5408\u7d04\u4fee\u6539\uff0c\u5982\u4e0b\uff1a\\n```javascript\\ncontract LogicA {\\n  struct GlobalStruct {\\n    uint256 a; // slot 0\\n    uint256 b; // slot 1\\n  }\\n\\n  GlobalStruct private _gs;\\n\\n  function setA(uint256 a_) external {\\n    _gs.a = a_;\\n  }\\n}\\n\\ncontract LogicB {\\n  struct GlobalStruct {\\n    uint256 a; // slot 0\\n    uint256 b; // slot 1\\n  }\\n\\n  GlobalStruct private _gs;\\n\\n  function setB(uint256 b_) external {\\n    _gs.b = b_;\\n  } \\n}\\n```\\n\\n## Reference\\n\\n- [eip2535 diamonds substack](https://eip2535diamonds.substack.com/)\\n- [aavegotchi contract](https://github.com/aavegotchi/aavegotchi-contracts)"},{"id":"hardhat-tracer","metadata":{"permalink":"/blog/hardhat-tracer","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-05-22-hardhat-tracer/hardhat-tracer.md","source":"@site/blog/2022-05-22-hardhat-tracer/hardhat-tracer.md","title":"Hardhat tracer","description":"\u5982\u4f55\u5229\u7528 Hardhat tracer \u5957\u4ef6\u4f86\u89e3\u6790\u7279\u5b9a\u7684\u4ea4\u6613","date":"2022-05-22T00:00:00.000Z","formattedDate":"May 22, 2022","tags":[{"label":"Hardhat","permalink":"/blog/tags/hardhat"},{"label":"Nomic Labs","permalink":"/blog/tags/nomic-labs"},{"label":"Plugin","permalink":"/blog/tags/plugin"},{"label":"Trace Transactions","permalink":"/blog/tags/trace-transactions"}],"readingTime":11.395,"truncated":true,"authors":[{"name":"Chuan-Chun Wang","url":"https://github.com/a2468834","imageURL":"https://github.com/a2468834.png","key":"a2468834"}],"prevItem":{"title":"Diamond 101 (3)","permalink":"/blog/diamond101-3"},"nextItem":{"title":"Hardhat \u7c21\u4ecb","permalink":"/blog/hardhat-intro"}},"content":"\u672c\u6587\u7ae0\u5c07\u5c55\u793a\u5982\u4f55\u4f7f\u7528\u77e5\u540d\u958b\u767c\u6846\u67b6 Hardhat \u7684\u9644\u52a0\u5143\u4ef6\u300chardhat-tracer\u300d\uff0c\u4ee4\u958b\u767c\u8005\u80fd\u8996\u89ba\u5316\u5730\u4e86\u89e3\u7279\u5b9a transaction \u904b\u4f5c\u904e\u7a0b\uff0c\u52a0\u901f\u958b\u767c\u6d41\u7a0b\u8207\u964d\u4f4e\u9664\u932f\u96e3\u5ea6\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u958b\u767c\u5927\u578b\u667a\u80fd\u5408\u7d04\uff08smart contract\uff09\u5c08\u6848\u7684\u904e\u7a0b\u4e2d\uff0c\u4e00\u5b9a\u5c11\u4e0d\u4e86\u8207\u5176\u4ed6\u5408\u7d04\u505a\u4e92\u52d5\uff0c\u4f8b\u5982\uff1aDEX \u805a\u5408\u5668\uff08aggregator\uff09\u7684\u958b\u767c\u5718\u968a\uff0c\u5c31\u5fc5\u9808\u719f\u6089\u5982\u4f55\u8207 DEX \u5408\u7d04\u76f4\u63a5\u4e92\u52d5\u3002\u56e0\u6b64\uff0c\u5982\u4f55\u53d6\u5f97\u4e00\u6b3e\u597d\u7528\u7684\u5de5\u5177\u80fd\u5feb\u901f\u3001\u7c21\u8981\u3001\u8996\u89ba\u5316\u5730\u5448\u73fe\u51fa\u57f7\u884c\u4e00\u689d transaction \u904e\u7a0b\uff0c\u5305\u542b\u6240\u6709 message call\u3001event log \u7b49\uff0c\u5c31\u986f\u5f97\u683c\u5916\u91cd\u8981\uff0c\u672c\u6587\u5c07\u4ecb\u7d39\u5e7e\u6b3e\u5de5\u5177\u53ef\u4ee5\u9054\u6210\u6b64\u4e00\u76ee\u7684\u3002\u96a8\u8457\u76ee\u524d smart contract \u5c08\u6848\u65e5\u76ca\u8907\u96dc\uff0c\u958b\u767c\u8005\u5c0d\u9019\u65b9\u9762\u7684\u9700\u6c42\u84ec\u52c3\u767c\u5c55\uff0c\u56e0\u6b64\u65b0\u5957\u4ef6\u63a8\u9673\u51fa\u65b0\uff1b\u975e\u5e38\u6b61\u8fce\u71b1\u5fc3\u7684\u8b80\u8005\u524d\u5f80 LunDAO [Issues](https://github.com/lun-dao/LunDAO/issues) \u6216 [Discussions](https://github.com/lun-dao/LunDAO/discussions) \u9801\u9762\u8207\u5927\u5bb6\u5206\u4eab\u3002\\n\\n\\n\\n\u5b89\u88dd\u74b0\u5883\u8207\u6ce8\u610f\u4e8b\u9805\\n---\\n\\n\u672c\u6587**\u4e0d\u6703**\u63d0\u4f9b Hardhat \u7684\u5b89\u88dd\u6307\u5f15\u6216\u57fa\u790e\u6559\u5b78\uff0c\u76f8\u95dc\u5167\u5bb9\u656c\u8acb\u53c3\u8003 LunDAO \u5176\u4ed6\u6587\u7ae0\uff08\u4f8b\u5982\uff1a[Hardhat \u7c21\u4ecb](../2022-04-24-hardhat-intro/index.md)\uff09\u3002\\n\\n\u4ee5\u4e0b\u5217\u51fa\u7b46\u8005\u5be6\u969b\u6e2c\u8a66\u80fd\u5920\u904b\u884c\u672c\u6587\u6b65\u9a5f\u7684\u8edf\u9ad4\u689d\u4ef6\uff0c\u5be6\u969b\u60c5\u6cc1\u5fc5\u4e0d\u9650\u65bc\u6b64\u914d\u7f6e\u656c\u8acb\u8b80\u8005\u53c3\u914c\u8003\u91cf\u3002\\n\\n- Software\\n  - OS\\n    - Windows 10 Pro 21H1 (w/o WSL)\\n    - Ubuntu 20.04.4 LTS (GNU/Linux 5.4.0-1053-raspi aarch64)\\n  - Node.js v16.14.2\\n  - Yarn 1.22.18\\n  - hardhat-tracer v1.1.0-**rc.6**\\n\\n\u7531\u65bc\u672c\u6587\u5f8c\u7e8c\u6703\u6d89\u53ca\u4f7f\u7528 Hardhat Network \u7684\u5167\u5bb9\uff0c\u56e0\u6b64\u5f37\u70c8\u63a8\u85a6\u8b80\u8005\u61c9\u5177\u5099\u6b64\u90e8\u5206\u64cd\u4f5c\u7d93\u9a57\uff1bLunDAO \u4ea6\u5df2\u6709\u6b64\u7cfb\u5217\u6559\u5b78\u6587\u7ae0\uff0c\u6b61\u8fce\u591a\u52a0\u95b1\u8b80\u4e26\u8207\u5927\u5bb6\u8a0e\u8ad6\u3002\\n\\n\\n\\n\u4f7f\u7528 hardhat-tracer \u5957\u4ef6\\n---\\n\u7531\u65bc hardhat-tracer \u6703\u9700\u8981\u5411 Ethereum node \u767c\u9001 `debug_traceTransaction`\u3001`eth_getStorageAt`\u3001`eth_getCode` \u7b49 JSON-RPC method \u6488\u53d6\u6b77\u53f2\u8cc7\u6599\uff0c\u56e0\u6b64\u52d9\u5fc5\u78ba\u8a8d\u60a8\u5df2\u7d93\u9023\u63a5\u5230\u6b78\u6a94\u7bc0\u9ede\uff08archive node\uff09\u3002\u60a8\u53ef\u4ee5\u81ea\u884c\u67b6\u8a2d[^2] archive node\uff0c\u6216\u4f7f\u7528\u7bc0\u9ede\u4f9b\u61c9\u5546\u63d0\u4f9b\u7684\u670d\u52d9\uff1b\u5728\u7b46\u8005\u64b0\u6587\u7684\u7576\u4e0b\uff0cAlchemy \u4ecd\u6709\u63d0\u4f9b\u514d\u8cbb Ethereum mainnet archive node\uff0c\u56e0\u6b64\u7b46\u8005\u9078\u64c7\u4f7f\u7528\u6b64\u670d\u52d9\u3002\\n\\n\u5047\u8a2d\u6211\u5011\u60f3\u77e5\u9053\u9019\u500b transaction[^1] \u7684\u8a73\u7d30\u904e\u7a0b\uff08View on [Etherscan](https://etherscan.io/tx/0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c)\uff09\uff1a\\n> 0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c\\n\\n\u95dc\u65bc `hardhat.config.js` \u7684\u5167\u5bb9\uff0c\u4ee5\u4e0b\u50c5\u5217\u51fa\u8207\u6b64\u5957\u4ef6\u6709\u95dc\u7684\u6b04\u4f4d\uff0c\u5176\u4ed6\u7d30\u7bc0\u8acb\u53c3\u8003\u76f8\u95dc\u8aaa\u660e\u6587\u4ef6\u3002\\n\\n```Javascript\\nrequire(\\"hardhat-tracer\\");\\n\\nmodule.exports = {\\n    networks: {\\n        mainnet: {\\n          url: process.env.AlchemyURL,\\n        },\\n        hardhat: {\\n            forking: {\\n                url: process.env.AlchemyURL,\\n            }\\n        },\\n    },\\n};\\n```\\n\\n1. \u5728\u8cc7\u6599\u593e\u5e95\u4e0b\u5b89\u88dd hardhat-tracer \u5957\u4ef6\uff08\u5047\u8a2d\u8a72\u8cc7\u6599\u593e\u5df2\u5b89\u88dd\u5b8c\u6210 Hardhat\uff09\\n\\n```\\n$ yarn add hardhat-tracer\\n```\\n\\n2. \u57f7\u884c\u4ee5\u4e0b\u6307\u4ee4\uff08\u6ce8\u610f\u8981\u6307\u5b9a `--network` \u53c3\u6578[^3]\u8b93 Hardhat \u80fd\u9023\u7d50\u5230\u6b63\u78ba\u7684\u7db2\u8def\uff09\\n\\n```\\n$ yarn hardhat --network \\"hardhat\\" trace --hash \\"0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c\\"\\n```\\n\\n3. \u7b49\u5019\u6578\u5206\u9418\u4e4b\u5f8c\uff0c\u5c31\u53ef\u4ee5\u770b\u5230 terminal \u986f\u793a\u4ee5\u4e0b\u8cc7\u8a0a\\n\\n```\\n$ yarn hardhat --network \\"hardhat\\" trace --hash \\"0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c\\"\\nyarn run v1.22.18\\n\\nSeems that it is taking time to fetch the state involved.\\nPlease note that this process may take several minutes.\\nA lot of eth_getStorageAt requests are currently being made to the rpc.\\n\\nCALL UnknownContractAndFunction(to=0x3b7157e5e732863170597790b4c005436572570f, input=0xf6326fb3, ret=0x)\\n   EVENT <UnknownContract 0x3b7157E5E732863170597790b4c005436572570F>.UnknownEvent(0x000000000000000000000000000000000000000000000000008e1bc9bf040000, [0x8752a472e571a816aea92eec8dae9baf628e840f4929fbcc2d155e6233ff68a7, 0x000000000000000000000000e760f546a925a4cfdcc62a674d14cc42a676c06f, 0x000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2])\\n   CALL UnknownContractAndFunction(to=0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2, input=0xd0e30db0, ret=0x)\\n      EVENT <UnknownContract 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2>.UnknownEvent(0x000000000000000000000000000000000000000000000000008e1bc9bf040000, [0xe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c, 0x0000000000000000000000003b7157e5e732863170597790b4c005436572570f])\\n```\\n\\n4. \u4ee5\u4e0a\u89e3\u6790\u7d50\u679c\u70ba hardhat-tracer \u9810\u8a2d\u89e3\u6790\u6a21\u5f0f\uff0c\u50c5\u986f\u793a event log \u548c function call\uff1b\u82e5\u60a8\u60f3\u8981\u4e00\u4f75\u4e86\u89e3 state variables \u7684\u8b80\u5beb\u60c5\u6cc1\uff08[`SLOAD`](https://www.evm.codes/#54)\u3001[`SSTORE`](https://www.evm.codes/#55)\uff09\uff0c\u90a3\u9ebc\u53ef\u4ee5\u591a\u52a0\u4e0a `--fulltrace` \u53c3\u6578\\n\\n```\\n$ yarn hardhat --network \\"hardhat\\" trace --fulltrace --hash \\"0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c\\"\\nyarn run v1.22.18\\n\\nSeems that it is taking time to fetch the state involved.\\nPlease note that this process may take several minutes.\\nA lot of eth_getStorageAt requests are currently being made to the rpc.\\n\\nCALL UnknownContractAndFunction(to=0x3b7157e5e732863170597790b4c005436572570f, input=0xf6326fb3, ret=0x)\\n   SLOAD 0x0000000000000000000000000000000000000000000000000000000000000001 => (0x0000000000000000000000000000000000000000000000000000000000000001)\\n   SSTORE 0x0000000000000000000000000000000000000000000000000000000000000001 <= (0x0000000000000000000000000000000000000000000000000000000000000002)\\n   SLOAD 0x0000000000000000000000000000000000000000000000000000000000000005 => (0x0000000000000000000000000000000000000000000000000000000062196d80)\\n   SLOAD 0x0000000000000000000000000000000000000000000000000000000000000006 => (0x00000000000000000000000000000000000000000000000000000000621d6200)\\n   SLOAD 0x5cc08dfcef394bb3e1501dd9c602b313a910bc96e6e3b9f14c10c5608560cb26 => (0x0000000000000000000000005f4ec3df9cbd43714fe2740f5e3616155c5b8419)\\n   SLOAD 0xe49870035e3714aceb7aadebead18a1e5a95f2d32ab68a7ffb99d8329af3a56d => (0x0000000000000000000000000000000000000000000000000000000000000000)\\n   SLOAD 0xe49870035e3714aceb7aadebead18a1e5a95f2d32ab68a7ffb99d8329af3a56d => (0x0000000000000000000000000000000000000000000000000000000000000000)\\n   SSTORE 0xe49870035e3714aceb7aadebead18a1e5a95f2d32ab68a7ffb99d8329af3a56d <= (0x000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2)\\n   SLOAD 0xe49870035e3714aceb7aadebead18a1e5a95f2d32ab68a7ffb99d8329af3a56e => (0x0000000000000000000000000000000000000000000000000000000000000000)\\n   SSTORE 0xe49870035e3714aceb7aadebead18a1e5a95f2d32ab68a7ffb99d8329af3a56e <= (0x000000000000000000000000000000000000000000000000008e1bc9bf040000)\\n   SLOAD 0x5cc08dfcef394bb3e1501dd9c602b313a910bc96e6e3b9f14c10c5608560cb27 => (0x00000000000000000000000000000000000000000000025e69bc17dc01d0d07f)\\n   SSTORE 0x5cc08dfcef394bb3e1501dd9c602b313a910bc96e6e3b9f14c10c5608560cb27 <= (0x00000000000000000000000000000000000000000000025e6a4a33a5c0d4d07f)\\n   EVENT <UnknownContract 0x3b7157E5E732863170597790b4c005436572570F>.UnknownEvent(0x000000000000000000000000000000000000000000000000008e1bc9bf040000, [0x8752a472e571a816aea92eec8dae9baf628e840f4929fbcc2d155e6233ff68a7, 0x000000000000000000000000e760f546a925a4cfdcc62a674d14cc42a676c06f, 0x000000000000000000000000c02aaa39b223fe8d0a0e5c4f27ead9083c756cc2])\\n   CALL UnknownContractAndFunction(to=0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2, input=0xd0e30db0, ret=0x)\\n      SLOAD 0x42dd4d28989ab1eee96fb196b01de4c17c0f145bc71364b95645949f1f133408 => (0x00000000000000000000000000000000000000000000025e69bc17dc01d0d07f)\\n      SSTORE 0x42dd4d28989ab1eee96fb196b01de4c17c0f145bc71364b95645949f1f133408 <= (0x00000000000000000000000000000000000000000000025e6a4a33a5c0d4d07f)\\n      EVENT <UnknownContract 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2>.UnknownEvent(0x000000000000000000000000000000000000000000000000008e1bc9bf040000, [0xe1fffcc4923d04b559f4d29a8bfc6cda04eb5b0d3c460751c2402c5c5cc9109c, 0x0000000000000000000000003b7157e5e732863170597790b4c005436572570f])\\n   SSTORE 0x0000000000000000000000000000000000000000000000000000000000000001 <= (0x0000000000000000000000000000000000000000000000000000000000000001)\\n```\\n\\n\u5230\u9019\u908a\u70ba\u6b62\uff0c\u6211\u5011\u5df2\u7d93\u6210\u529f\u4f7f\u7528 hardhat-tracer \u5957\u4ef6\u4f86\u89e3\u6790 transaction \u4e86\u3002\u7136\u800c\uff0c\u4ee5\u4e0a\u8cc7\u8a0a\u5728\u5408\u7d04\u5730\u5740\u3001event \u540d\u7a31\u7b49\u90e8\u5206\uff0c\u4ee5\u539f\u59cb\u578b\u614b\u5448\u73fe\u9020\u6210\u7248\u9762\u5197\u9577\u4e14\u6df7\u4e82\uff0c\u4e0d\u5229\u65bc\u6211\u5011\u95b1\u8b80\u3002\\n\\n\u6240\u5e78 hardhat-tracer \u5957\u4ef6\u63d0\u4f9b address name tag \u529f\u80fd\uff0c\u8b93\u6211\u5011\u53ef\u4ee5\u81ea\u5b9a\u7fa9\u4ec0\u9ebc\u5730\u5740\u8981\u4ee5\u4ec0\u9ebc\u540d\u7a31\u6a19\u7c64\u4f86\u986f\u793a\u3002\u53e6\u5916\uff0chardhat-tracer \u4e5f\u652f\u63f4\u532f\u5165\u5df2\u77e5\u5408\u7d04\u7684\u7a0b\u5f0f\u78bc\u6216 `interface`\uff0c\u8b93\u89e3\u6790\u7d50\u679c\u53ef\u4ee5\u81ea\u52d5\u5e36\u5165\u8a72\u5408\u7d04\u4f86\u986f\u793a\u3002\\n\\n\u6839\u64da\u4e0a\u8ff0\u7d50\u679c\uff0c\u6211\u5011\u53ef\u767c\u73fe\u57f7\u884c transaction \u7684\u904e\u7a0b\u6703\u8207\u5169\u500b\u5408\u7d04\u4e92\u52d5 \u2014 `0x3b7157E5E732863170597790b4c005436572570F` \u548c `0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2`\uff1b\u56e0\u6b64\uff0c\u6211\u5011\u53ef\u4ee5\u524d\u5f80 Etherscan \u4f86\u67e5\u8a62\u9019\u4e9b\u5408\u7d04\u7684 ABI\uff0c\u518d\u642d\u914d [ABI2Solidity](https://bia.is/tools/abi2solidity/) \u4f86\u628a JSON format \u8f49\u6210 solidity `interface` format\u3002\\n\\n5. \u6309\u7167\u4e00\u822c\u4f7f\u7528 Hardhat \u7684\u7fd2\u6163\uff0c\u6211\u5011\u5728 `contracts` \u5b50\u76ee\u9304\u5e95\u4e0b\u5275\u5efa\u9019\u4efd solidity code [^4]\\n\\n```solidity\\n// SPDX-License-Identifier: GPL-3.0\\npragma solidity 0.8.7;\\n\\n// Assume that 0x3b7157E5E732863170597790b4c005436572570F is named as \\"TokenSale\\".\\ninterface TokenSale {\\n  function WETH (  ) external view returns ( address );\\n  function allocateTokensForSale ( uint256 _amount ) external;\\n  function availableTokens (  ) external view returns ( uint256 );\\n  function deposit ( address _token, uint256 _amount ) external;\\n  function depositETH (  ) external;\\n  function enableWithdrawals (  ) external;\\n  function finalizeRaise (  ) external;\\n  function getSupportedTokens (  ) external view returns ( address[] memory );\\n  function getTokenOracle ( address _token ) external view returns ( address );\\n  function getTokenOracles (  ) external view returns ( address[] memory oracles );\\n  function getUserClaimableTokens ( address _user ) external view returns ( uint256 );\\n  function owner (  ) external view returns ( address );\\n  function renounceOwnership (  ) external;\\n  function saleSchedule (  ) external view returns ( uint256 startTimestamp, uint256 endTimestamp );\\n  function saleToken (  ) external view returns ( address );\\n  function setSaleSchedule ( uint256 _start, uint256 _end ) external;\\n  function totalRaisedUSD (  ) external view returns ( uint256 );\\n  function transferOwnership ( address newOwner ) external;\\n  function transferToTreasury (  ) external;\\n  function treasury (  ) external view returns ( address );\\n  function userAccounts ( address ) external view returns ( address token, uint256 depositedAmount );\\n  function withdraw (  ) external;\\n  function withdrawalsEnabled (  ) external view returns ( bool );\\n}\\n\\n//  Assume that 0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2 is named as \\"WrappedEther\\".\\ninterface WrappedEther {\\n  function name (  ) external view returns ( string memory );\\n  function approve ( address guy, uint256 wad ) external returns ( bool );\\n  function totalSupply (  ) external view returns ( uint256 );\\n  function transferFrom ( address src, address dst, uint256 wad ) external returns ( bool );\\n  function withdraw ( uint256 wad ) external;\\n  function decimals (  ) external view returns ( uint8 );\\n  function balanceOf ( address ) external view returns ( uint256 );\\n  function symbol (  ) external view returns ( string memory );\\n  function transfer ( address dst, uint256 wad ) external returns ( bool );\\n  function deposit (  ) external payable;\\n  function allowance ( address, address ) external view returns ( uint256 );\\n}\\n```\\n\\n6. \u57f7\u884c `$ yarn hardhat compile` \u7de8\u8b6f\u6240\u6709 solidity codes\\n7. \u9032\u5165 `hardhat.config.js` \u65b0\u589e\u4ee5\u4e0b\u6b04\u4f4d\uff0c\u8b93\u7279\u5b9a address \u4ee5\u958b\u767c\u8005\u81ea\u5b9a\u7fa9\u7684\u540d\u7a31\u6a19\u7c64\uff08name tage\uff09\u986f\u793a\\n\\n```Javascript\\nmodule.exports = {\\n    tracer: {\\n        nameTags: {\\n            [\\"0x3b7157E5E732863170597790b4c005436572570F\\"]: \\"TokenSale\\",\\n            [\\"0xC02aaA39b223FE8D0A0e5C4F27eAD9083C756Cc2\\"]: \\"WrappedEther\\",\\n            [\\"0xe760f546a925a4cfdcc62a674d14cc42a676c06f\\"]: \\"Someone\\",\\n        }\\n    },\\n};\\n```\\n\\n8. \u91cd\u65b0\u57f7\u884c hardhat-tracer \u6307\u4ee4\uff0c\u6211\u5011\u53ef\u4ee5\u770b\u5230\u53ef\u8b80\u6027\u8b8a\u5f97\u5f88\u9ad8\uff08\u6bd4\u8d77 step 3 \u4f86\u8aaa\uff09\\n\\n```\\n$ yarn hardhat --network \\"hardhat\\" trace --hash \\"0xca722f52d743bfecb555993d64439aa6e6653914ad87073fb27bfbe42f67d62c\\"\\nyarn run v1.22.18\\n\\nSeems that it is taking time to fetch the state involved.\\nPlease note that this process may take several minutes.\\nA lot of eth_getStorageAt requests are currently being made to the rpc.\\n\\nCALL TokenSale.depositETH{value: 40000000000000000}()\\n   EVENT TokenSale.Deposited(depositor=[Someone], token=[WrappedEther], amount=40000000000000000)\\n   CALL WrappedEther.deposit{value: 40000000000000000}()\\n      EVENT WrappedEther.Deposit(dst=[TokenSale], wad=40000000000000000)\\n```\\n\\n[^2]: \u9700\u8981\u6e96\u5099\u5927\u5bb9\u91cf SSD\uff0c\u5176\u9918\u786c\u9ad4\u689d\u4ef6\u8f03\u7121\u56b4\u82db\u9650\u5236\uff08\u6a39\u6885\u6d3e 4B \u5373\u8db3\u4ee5\u904b\u884c Go-Ethereum\uff09\\n\\n[^3]: \u7531\u65bc `debug_traceTransaction` \u5c6c\u65bc Alchemy \u9700\u4ed8\u8cbb\u7684 API method\uff0c\u56e0\u6b64\u82e5\u8b80\u8005\u4f7f\u7528 Growth \u4ee5\u4e0a\u7684\u65b9\u6848\uff0c\u90a3\u9ebc\u60a8\u53ef\u4ee5\u76f4\u63a5\u4ee5 `--network \\"mainnet\\"` \u9023\u7d50 Alchemy\uff1b\u53e6\u4e00\u7a2e\u514d\u8cbb\u7684\u66ff\u4ee3\u65b9\u6848\u5247\u70ba\u6539\u7528 Hardhat Network \u4f86\u89e3\u6790 transaction\uff0c\u53ea\u5c0d Alchemy \u767c\u9001 `eth_getStorageAt`\u3001`eth_getCode` \u7b49\u8acb\u6c42\uff0c\u56e0\u6b64\u7b46\u8005\u5728\u6b64\u4ee5 `--network \\"hardhat\\"` \u53c3\u6578\u8209\u4f8b\\n\\n[^4]: \u5982\u679c\u8b80\u8005\u77e5\u9053\u5f85\u89e3\u6790 transaction \u7684\u6240\u6709\u4e92\u52d5\u5408\u7d04 source code\uff0c\u90a3\u9ebc\u63a8\u85a6\u60a8\u76f4\u63a5\u628a\u90a3\u4e9b\u7a0b\u5f0f\u78bc\u52a0\u5165 `contracts` \u5b50\u76ee\u9304\u5e95\u4e0b\u505a\u7de8\u8b6f\uff0c\u9019\u6a23\u80fd\u8b93 hardhat-tracer \u986f\u793a\u7d50\u679c\u64c1\u6709\u6700\u9ad8\u7684\u53ef\u8b80\u6027\uff1b\u82e5\u7121\u6cd5\u53d6\u5f97\u6240\u6709 source code\uff0c\u5247\u53ea\u4f7f\u7528\u5408\u7d04\u5011 ABI \u6240\u8f49\u6210\u7684 `interface` \u505a\u7de8\u8b6f\u4ea6\u53ef\u3002\\n\\n\\n\\n\u4f7f\u7528\u5716\u5f62\u5316\u4ecb\u9762\u5de5\u5177\\n---\\n\u9664\u4e86\u4f7f\u7528\u4e0a\u8ff0\u5957\u4ef6\u4e4b\u5916\uff0c\u76ee\u524d\u4e5f\u6709\u8a31\u591a\u7db2\u7ad9\u63d0\u4f9b\u514d\u8cbb\u89e3\u6790 transaction \u7684\u670d\u52d9\u3002\\n\\n\u5047\u8a2d\u6211\u5011\u60f3\u77e5\u9053\u4ee5\u4e0b\u9019\u7b46 transaction[^1] \u7684\u57f7\u884c\u904e\u7a0b\uff08View on [Etherscan](https://etherscan.io/tx/0x4a7c2dabf8695f18835ff2aeb133df1a89f0af3759b1832e493bee10e721d998)\uff09\uff1a\\n> 0x4a7c2dabf8695f18835ff2aeb133df1a89f0af3759b1832e493bee10e721d998\\n\\n\\n### Etherscan Parity Trace\\n\\n![etherscan-parity-trace-1](./etherscan-parity-trace-1.png)\\n\\n\u5982\u4e0a\u5716\u6240\u793a\uff0c\u9ede\u64ca\u300cParity Trace\u300d\u9078\u9805\u4e4b\u5f8c\uff0c\u5c07\u958b\u555f\u5982\u540c\u4e0b\u5716\u7684\u53e6\u4e00\u500b\u5206\u9801\u3002\\n\\n![etherscan-parity-trace-2](./etherscan-parity-trace-2.png)\\n\\n\u6b64\u65b9\u6cd5\u5448\u73fe\u7684\u6548\u679c\u8f03\u4e0d\u8996\u89ba\u5316\uff0c\u7136\u800c\u61c9\u70ba\u76ee\u524d\u6700\u901a\u7528\u7684\u5206\u6790\u65b9\u5f0f\uff1b\u4e0d\u53ea Etherscan \u6709\u652f\u63f4 Parity VM tracer\uff0c\u5176\u5b83\u7684 block explorer \u7db2\u7ad9\u61c9\u80fd\u627e\u5230\u985e\u4f3c\u529f\u80fd\u3002\\n\\n\\n### Etherscan Transaction Decoder\\n\\n![etherscan-txn-decoder-1](./etherscan-txn-decoder-1.png)\\n\\n\u5982\u4e0a\u5716\u6240\u793a\uff0c\u9ede\u64ca\u300cTransaction Decoder\u300d\u9078\u9805\u4e4b\u5f8c\uff0c\u5c07\u958b\u555f\u5982\u540c\u4e0b\u5716\u7684\u53e6\u4e00\u500b\u5206\u9801\u3002\\n\\n![etherscan-txn-decoder-2](./etherscan-txn-decoder-2.png)\\n\\n\u53ef\u4ee5\u770b\u5230 Etherscan \u5df2\u7d93\u5206\u9580\u5225\u985e\u5730\u5c07\u57f7\u884c transaction \u7684\u904e\u7a0b\u6703\u767c\u51fa\u7684 event log\u3001message call \u7b49\u91cd\u8981\u4e8b\u4ef6\uff0c\u4ee5\u689d\u5217\u8868\u683c\u7684\u65b9\u5f0f\u5448\u73fe\u51fa\u4f86\u3002\\n\\n\\n### EthTx.info\\n\\n\u6b64\u670d\u52d9\u4ee5 Python \u64b0\u5beb\u7684[\u958b\u6e90\u8edf\u9ad4](https://github.com/ethtx/ethtx)\u6240\u5efa\u7acb\uff0c\u4e26\u7531 [Token Flow](https://tokenflow.live/) \u5718\u968a\u6240\u7dad\u8b77\uff0c\u5728\u7b46\u8005\u64b0\u6587\u7576\u4e0b\u70ba\u514d\u8cbb\u516c\u958b\u8b93\u6240\u6709\u958b\u767c\u8005\u81ea\u7531\u4f7f\u7528\u3002\\n\\n1. \u524d\u5f80 https://ethtx.info/\\n2. \u9078\u64c7\u6b63\u78ba\u7684\u7db2\u8def\uff08\u6b64\u4f8b\u70ba ETH mainnet\uff09\uff0c\u4e26\u8f38\u5165\u5c0d\u61c9\u7684 transaction hash\\n3. \u6309\u4e0b\u300cDecode now\u300d\u6309\u9215\uff0c\u4e26\u975c\u5019\u6578\u5206\u9418\uff08\u53ef\u80fd\u56e0\u7db2\u7ad9\u58c5\u585e\u5ea6\u800c\u6709\u4e0d\u540c\uff09\\n\\n![ethtx-info](./ethtx-info.png)\\n\\n### Tenderly\\n\\n\u524d\u5f80 [Tenderly](https://dashboard.tenderly.co/explorer) \u5b98\u7db2\uff0c\u5728\u641c\u5c0b\u6846\u7576\u4e2d\u8f38\u5165 transaction hash \u4e26\u6309\u4e0b\u9001\u51fa\u67e5\u8a62\uff0c\u5373\u53ef\u7372\u5f97\u5982\u4e0b\u5716\u6240\u793a\u7684\u7db2\u9801\u3002\\n\\n![tenderly](tenderly.png)\\n\\n\u7531\u65bc Tenderly \u4e0d\u53ea\u63d0\u4f9b\u5206\u6790 transaction \u7684\u529f\u80fd\uff0c\u9084\u6709\u9700\u591a\u5be6\u7528\u7684\u5176\u5b83\u5de5\u5177\uff08\u4f8b\u5982\uff1asimulator\u3001local transaction analysis\uff09\uff1b\u82e5\u8b80\u8005\u6709\u8208\u8da3\u7684\u8a71\uff0c\u5efa\u8b70\u53ef\u8a3b\u518a\u4e00\u500b\u514d\u8cbb\u5e33\u865f\u3002\\n\\n[^1]: \u7b46\u8005\u96a8\u6a5f\u6311\u9078\u7684 transaction hash\uff0c\u4e26\u6c92\u6709\u4efb\u4f55\u7279\u6b8a\u7528\u610f\\n\\n\\n\\nRelated resources\\n---\\n- Hardhat\\n  - https://hardhat.org/config/\\n- Alchemy\\n  - https://www.alchemy.com/\\n  - https://docs.alchemy.com/alchemy/enhanced-apis/debug-api\\n- Smart Contracts at Etherscan\\n  - https://etherscan.io/address/0x3b7157E5E732863170597790b4c005436572570F\\n  - https://etherscan.io/address/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\\n- hardhat-tracer\\n  - https://www.npmjs.com/package/hardhat-tracer\\n  - https://github.com/zemse/hardhat-tracer\\n- ABI2Solidity\\n  - https://bia.is/tools/abi2solidity/\\n  - https://github.com/maxme/abi2solidity\\n- Etherscan Transaction Decoder\\n  - https://etherscan.io/tx-decoder\\n- EthTx.info\\n  - https://github.com/ethtx/ethtx\\n- Tenderly\\n  - https://dashboard.tenderly.co/explorer"},{"id":"hardhat-intro","metadata":{"permalink":"/blog/hardhat-intro","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-04-24-hardhat-intro/index.md","source":"@site/blog/2022-04-24-hardhat-intro/index.md","title":"Hardhat \u7c21\u4ecb","description":"Hardhat \u662f\u4e00\u5957\u958b\u767c\u667a\u80fd\u5408\u7d04\u7528\u7684\u958b\u767c\u5de5\u5177\uff0c\u672c\u7bc7\u6587\u7ae0\u6703\u4ecb\u7d39 Hardhat \u7684\u57fa\u790e\u4f7f\u7528\u65b9\u5f0f\u3002","date":"2022-04-24T00:00:00.000Z","formattedDate":"April 24, 2022","tags":[{"label":"hardhat","permalink":"/blog/tags/hardhat"},{"label":"ethereum","permalink":"/blog/tags/ethereum"},{"label":"solidity","permalink":"/blog/tags/solidity"}],"readingTime":13.17,"truncated":true,"authors":[{"name":"Yuren Ju","title":"Individual Researcher","url":"https://yurenju.medium.com/","imageURL":"https://github.com/yurenju.png","key":"yurenju"}],"prevItem":{"title":"Hardhat tracer","permalink":"/blog/hardhat-tracer"},"nextItem":{"title":"Diamond 101 (1)","permalink":"/blog/diamond101"}},"content":"\u64b0\u5beb\u4e00\u822c\u7a0b\u5f0f\u8a9e\u8a00\u5982 node.js \u6642\uff0c\u901a\u5e38\u53ea\u8981\u6e96\u5099\u57f7\u884c\u74b0\u5883\u8207\u7de8\u8f2f\u5668\u5c31\u53ef\u4ee5\u958b\u59cb\u9032\u884c\u958b\u767c\u4e86\u3002\u800c\u958b\u767c Solidity \u5247\u6709\u4e9b\u8a31\u4e0d\u540c\uff0c\u7531\u65bc\u7a0b\u5f0f\u6703\u9700\u8981\u8dd1\u5728\u5340\u584a\u93c8\u7db2\u8def\u4e0a\uff0c\u6240\u4ee5\u9019\u500b\u57f7\u884c\u74b0\u5883\u6703\u6bd4\u8f03\u8907\u96dc\uff0c\u6703\u9700\u8981\u900f\u904e RPC \u9023\u63a5\u4e26\u4e14\u4f48\u7f72\u5230\u5340\u584a\u93c8\u7db2\u8def\u4e0a\u9762\u4e26\u4e14\u57f7\u884c\u3001\u9664\u932f\u8207\u6e2c\u8a66\u3002\\n\\nHardhat \u5c31\u662f\u958b\u767c Solidity \u667a\u80fd\u5408\u7d04\u6642\u6240\u9700\u8981\u7684\u958b\u767c\u5de5\u5177\uff0c\u9664\u4e86\u5167\u5efa\u4e00\u500b\u958b\u767c\u7528\u7684\u672c\u5730\u5340\u584a\u93c8\u7db2\u8def Hardhat Network \u5916\u9084\u6253\u9020\u4e86\u4e00\u5957 plugin \u7cfb\u7d71\u8b93\u8a31\u591a\u8ddf\u5340\u584a\u93c8\u76f8\u95dc\u7684\u5de5\u5177\u53ef\u4ee5\u6574\u5408\u5230 hardhat \u8b93\u958b\u767c\u8005\u53ef\u4ee5\u66f4\u5bb9\u6613\u9032\u884c\u958b\u767c\u3001\u9664\u932f\u3001\u6e2c\u8a66\u7b49\uff0c\u540c\u6642 Hardhat \u91dd\u5c0d TypeScript \u7684\u652f\u63f4\u6bd4\u8d77\u5176\u4ed6\u985e\u4f3c\u5de5\u5177\u9084\u8981\u512a\u826f\uff0c\u9019\u5728\u64b0\u5beb\u6e2c\u8a66\u6642\u6703\u6709\u5f88\u5927\u7684\u5e6b\u52a9\u3002\\n\\n\u672c\u6587\u5c07\u6703\u7c21\u4ecb hardhat \u7684\u7528\u6cd5\u8207\u8ddf\u5176\u4ed6\u5de5\u5177\u6bd4\u8f03\u7684\u512a\u52e2\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u6587\u4e2d\u7684\u904b\u884c\u74b0\u5883\u7d71\u4e00\u90fd\u662f Node.js v16 \u904b\u884c\u5728 macOS \u74b0\u5883\uff0c\u5176\u4ed6\u4f5c\u696d\u7cfb\u7d71\u53ef\u80fd\u6703\u6709\u4e9b\u5fae\u7684\u4e0d\u540c\uff0c\u4f46\u5dee\u5225\u61c9\u8a72\u4e0d\u5927\u3002\\n\\n## \u8a2d\u5b9a\u7bc4\u4f8b\u5c08\u6848\\n\u70ba\u4e86\u8aaa\u660e hardhat \u7684\u5404\u7a2e\u529f\u80fd\uff0c\u5728\u9019\u908a\u5148\u8a2d\u5b9a\u4e00\u500b\u7531 hardhat \u63d0\u4f9b\u7684\u4e00\u500b\u7bc4\u672c\u5c08\u6848\uff0c\u8acb\u5148\u5efa\u7acb\u4e00\u500b\u76ee\u9304 `hardhat-sample` \u4e26\u4e14\u5728\u88e1\u9762\u57f7\u884c hardhat \u6307\u4ee4\uff1a\\n\\n```shell\\n$ mkdir hardhat-sample\\n$ cd hardhat-sample\\n$ npx hardhat\\n```\\n\\nnpx \u662f\u4e00\u500b\u7531 node.js \u63d0\u4f9b\u7684\u6307\u4ee4\u53ef\u4ee5\u57f7\u884c\u7531 node.js \u64b0\u5beb\u7684 CLI \u7a0b\u5e8f\uff0c\u5982\u679c\u8a72 CLI \u7a0b\u5e8f\u9084\u6c92\u5b89\u88dd\uff0c\u4ed6\u6703\u8a62\u554f\u4f60\u662f\u5426\u8981\u5b89\u88dd\u4e26\u4e14\u5f9e\u81ea\u52d5\u4e0b\u8f09\uff0c\u6240\u4ee5\u9996\u6b21\u57f7\u884c\u6642\u6703\u8a62\u554f\u4f60\u662f\u5426\u8981\u5b89\u88dd hardhat\uff0c\u6309\u4e0b\u78ba\u8a8d\u5373\u53ef\u7e7c\u7e8c\uff0c\u63a5\u4e0b\u4f86\u6703\u770b\u5230 hardhat \u7684\u5c0e\u5f15\u756b\u9762\u3002\\n\\n![Hardhat cli initial](hardhat-cli-init.png)\\n\u9078\u64c7 `Create a basic sample project`\uff0c\u4e26\u4e14\u5728\u63a5\u4e0b\u4f86\u7684\u554f\u984c\u90fd\u6309 Enter \u9078\u64c7\u9810\u8a2d\u503c\uff0chardhat \u6703\u958b\u59cb\u5b89\u88dd\u76f8\u95dc\u7684\u5957\u4ef6\uff0c\u7a0d\u7b49\u4e00\u6bb5\u6642\u9593\u6703\u5b89\u88dd\u5b8c\u7562\u3002\\n\\n\u7576\u5b89\u88dd\u5b8c\u7562\u4e4b\u5f8c\u518d\u8f38\u5165\u4e00\u6b21 `npx hardhat` \u5c31\u6703\u986f\u793a\u4ee5\u4e0b\u8f38\u51fa\uff1a\\n\\n```\\n$ npx hardhat\\n\\nHardhat version 2.9.2\\n\\n... skip\\n\\nAVAILABLE TASKS:\\n\\n  accounts\\tPrints the list of accounts\\n  check   \\tCheck whatever you need\\n  clean   \\tClears the cache and deletes all artifacts\\n  compile \\tCompiles the entire project, building all artifacts\\n  console \\tOpens a hardhat console\\n  flatten \\tFlattens and prints contracts and their dependencies\\n  help    \\tPrints this message\\n  node    \\tStarts a JSON-RPC server on top of Hardhat Network\\n  run     \\tRuns a user-defined script after compiling the project\\n  test    \\tRuns mocha tests\\n\\nTo get help for a specific task run: npx hardhat help [task]\\n```\\n\\n\u5230\u9019\u908a\u5c31\u7522\u751f\u4e86\u4e00\u500b\u7bc4\u4f8b\u7528\u7684\u5c08\u6848\u4e86\uff0c\u9664\u4e86\u53ef\u4ee5\u770b\u5230 hardhat \u6709\u63d0\u4f9b\u8a31\u591a\u6307\u4ee4\u53ef\u4ee5\u4f7f\u7528\u5305\u542b\u7de8\u8b6f\u3001\u6e2c\u8a66\u7b49\u7b49\u5916\uff0c\u7bc4\u4f8b\u5c08\u6848\u4e5f\u5305\u542b\u4e86\u4e00\u4e9b\u4f48\u7f72\u7528\u7684\u8173\u672c\u3001\u7bc4\u672c\u667a\u80fd\u5408\u7d04\u4ee5\u53ca\u6e2c\u8a66\u3002\\n\\n## Hardhat \u8a2d\u5b9a\u6a94\\n\u5c08\u6848\u7684\u6839\u76ee\u9304\u5e95\u4e0b\u6703\u6709\u4e00\u500b `hardhat.config.js` \u6a94\u6848\uff0c\u9019\u662f\u8a2d\u7f6e hardhat \u7684\u5730\u65b9\uff0c\u4f60\u53ef\u4ee5\u5728\u9019\u908a\u555f\u7528 hardhat plugin\u3001\u52a0\u5165\u4e00\u4e9b\u5e38\u7528\u7684\u5de5\u4f5c\u8b8a\u6210\u4e00\u500b\u65b0\u7684 hardhat \u6307\u4ee4\uff0c\u4e5f\u53ef\u4ee5\u5728\u9019\u908a\u8a2d\u5b9a\u7de8\u8b6f\u5668\u8207\u9023\u63a5\u5230\u4e0d\u540c\u7684\u7db2\u8def\u3002\\n\\n\u9810\u8a2d\u7684 `hardhat.config.js` \u5982\u4e0b\uff1a\\n\\n```javascript\\n// 1. import plugin\\nrequire(\\"@nomiclabs/hardhat-waffle\\");\\n\\n// 2. add tasks\\ntask(\\"accounts\\", \\"Prints the list of accounts\\", async (taskArgs, hre) => {\\n  const accounts = await hre.ethers.getSigners();\\n\\n  for (const account of accounts) {\\n    console.log(account.address);\\n  }\\n});\\n\\n// 3. export configuration\\nmodule.exports = {\\n  solidity: \\"0.8.4\\",\\n};\\n```\\n\\n\u8a3b\u89e3\u6240\u6a19\u793a\u7684\u4e09\u5927\u90e8\u5206\uff0c\u5404\u5225\u662f\u555f\u7528 `hatdhat-waffle` plugin\u3001\u52a0\u5165\u4e00\u500b\u65b0\u6307\u4ee4\u8ddf\u8a2d\u5b9a hardhat \u6240\u7528\u7684\u7de8\u8b6f\u5668\u3002\\n\\n## \u7de8\u8b6f Solidity \u6a94\u6848\\n\u57f7\u884c `npx hardhat compile` \u6642\uff0c\u5728 `contracts` \u76ee\u9304\u7684\u667a\u80fd\u5408\u7d04\u6703\u88ab\u7de8\u8b6f\uff0c\u800c\u7de8\u8b6f\u5f8c\u7684\u7522\u7269 (Artifacts) \u6703\u5beb\u5230 `artifacts` \u76ee\u9304\u5e95\u4e0b\uff0c\u6bd4\u5982\u8aaa\u7de8\u8b6f\u7d50\u675f\u5f8c\u6703\u7522\u751f `artifacts/contracts/Greeter.sol/Greeter.json` \u9019\u500b\u5c31\u662f\u5408\u7d04\u7684 abi\uff0c\u7576\u4f48\u7f72\u5230 Ethereum \u7db2\u8def\u5f8c\u5c31\u53ef\u4ee5\u7528\u9019\u4efd\u6a94\u6848\u4f86\u8ddf\u5408\u7d04\u4e92\u52d5\u3002\\n\\n\u7de8\u8b6f Solidity \u6a94\u6848\u7684\u7de8\u8b6f\u5668\u7248\u672c\u53ef\u4ee5\u5728 `hardhat.config.js` \u88e1\u9762\u8a2d\u5b9a\uff0c\u4e0a\u9762\u7684\u7bc4\u4f8b\u6307\u5b9a `solidity: \\"0.8.4\\"` \u662f\u6700\u57fa\u790e\u7684\u8a2d\u5b9a\uff0c\u9084\u6709\u4e00\u4e9b\u4e5f\u53ef\u4ee5\u8a2d\u5b9a\u7684\u9805\u76ee\uff1a\\n\\n- \u6700\u4f73\u5316\uff1a\u8a2d\u5b9a\u8981\u4e0d\u8981\u958b\u555f\u7de8\u8b6f\u6700\u4f73\u5316\u4ee5\u53ca\u6700\u4f73\u5316\u7684\u7a0b\u5ea6\uff0c\u9810\u8a2d\u662f\u95dc\u9589\u6700\u4f73\u5316[^\u8a3b1]\\n- EVM \u7248\u672c\uff1aEVM \u5728\u4e0d\u540c\u7684\u5206\u5c94\u5f8c\u6703\u591a\u51fa\u4e00\u4e9b\u65b0\u7684\u529f\u80fd\u6216\u683c\u5f0f\u4e0a\u7684\u5dee\u7570\uff0c\u9019\u908a\u4e5f\u53ef\u4ee5\u6307\u5b9a\\n\\n\u8a2d\u5b9a\u7684\u65b9\u6cd5\u5982\u4e0b\uff0c\u66f4\u8a73\u7d30\u7684\u8cc7\u8a0a\u53ef\u4ee5\u53c3\u8003 hardhat \u5b98\u65b9\u7db2\u7ad9\u88e1\u9762\u7684 [Compiling your contracts](https://hardhat.org/guides/compile-contracts.html) \u4e00\u7bc0\u3002\\n```javascript\\nsolidity: {\\n  version: \\"0.5.15\\",\\n  settings: {\\n    optimizer: {\\n      enabled: true, // \u555f\u7528\u6700\u4f73\u5316\\n      runs: 200 // \u6700\u4f73\u5316\u7684\u8a55\u4f30\u65b9\u5f0f\\n    },\\n    evmVersion: \\"istanbul\\" // \u53ef\u4ee5\u9078\u64c7 instanbul, berlin, london \u7b49\\n  }\\n}\\n```\\n\\n\u800c `runs` \u53c3\u6578\u662f\u958b\u767c\u8005\u8a55\u4f30\u9019\u500b\u5408\u7d04\u9810\u4f30\u6703\u57f7\u884c\u5e7e\u6b21\uff0c\u63d0\u4f9b\u7d66\u7de8\u8b6f\u5668\u57f7\u884c\u6700\u4f73\u5316\u6642\u7684\u53c3\u8003\u4f9d\u64da\uff0c\u53ef\u4ee5\u95b1\u8b80 [LunDAO discord \u8a0e\u8ad6](https://discord.com/channels/927177880318922802/927177880318922807/967717928290107392)\u3002\\n\\n\u5982\u679c\u4f60\u9047\u5230\u7de8\u8b6f\u5668\u8207 solidity \u6a94\u6848\u4e2d\u6240\u6307\u5b9a\u7684\u7248\u672c\u6c92\u6709\u76f8\u7b26\u6642\uff0c\u4e5f\u53ef\u4ee5\u6307\u5b9a\u591a\u91cd\u7de8\u8b6f\u5668\u7248\u672c\uff0c\u6bd4\u5982\u8aaa\u4f60\u81ea\u5df1\u7684\u5408\u7d04\u7528 0.6\uff0c\u4f46\u662f\u4f60\u6240\u5f15\u7528\u7684 openzeppelin \u5408\u7d04\u5247\u662f 0.5\uff0c\u6b64\u6642\u53ef\u4ee5\u5728 Hardhat \u8a2d\u5b9a\u6a94\u88e1\u9762\u6307\u5b9a\u591a\u7a2e\u4e0d\u540c\u7248\u672c\u7684 solidity\u3002\\n\\n```javascript\\nmodule.exports = {\\n  solidity: {\\n    compilers: [\\n      {\\n        version: \\"0.5.5\\",\\n      },\\n      {\\n        version: \\"0.6.7\\"\\n      },\\n    ],\\n  },\\n};\\n```\\n\\n## \u57f7\u884c\u6e2c\u8a66\\n\u57f7\u884c `npx hardhat test` \u6703\u958b\u59cb\u57f7\u884c\u6e2c\u8a66\uff0c\u57f7\u884c\u6e2c\u8a66\u524d hardhat \u6703\u5148\u5c07\u6240\u6709\u7684\u667a\u80fd\u5408\u7d04\u7de8\u8b6f\u5b8c\u7562\u5f8c\u624d\u57f7\u884c\uff0c\u5728 `test/` \u76ee\u9304\u5e95\u4e0b\u7684\u6240\u6709 JavaScript \u6e2c\u8a66\u6a94\u6848\u90fd\u6703\u88ab\u57f7\u884c\u3002\\n\\n\u6211\u5011\u9019\u908a\u5c0d\u7167\u8457 solidity \u8207\u6e2c\u8a66\u6a94\u6848\u4e00\u8d77\u770b\uff1a\\n\\n```javascript\\n// Greeter.sol\\n//SPDX-License-Identifier: Unlicense\\npragma solidity ^0.8.0;\\n\\nimport \\"hardhat/console.sol\\";\\n\\ncontract Greeter {\\n    string private greeting;\\n\\n    constructor(string memory _greeting) {\\n        console.log(\\"Deploying a Greeter with greeting:\\", _greeting);\\n        greeting = _greeting;\\n    }\\n\\n    function greet() public view returns (string memory) {\\n        return greeting;\\n    }\\n\\n    function setGreeting(string memory _greeting) public {\\n        console.log(\\"Changing greeting from \'%s\' to \'%s\'\\", greeting, _greeting);\\n        greeting = _greeting;\\n    }\\n}\\n```\\n\\n```javascript\\n// sample-test.js\\nconst { expect } = require(\\"chai\\");\\nconst { ethers } = require(\\"hardhat\\");\\n\\ndescribe(\\"Greeter\\", function () {\\n  it(\\"Should return the new greeting once it\'s changed\\", async function () {\\n    const Greeter = await ethers.getContractFactory(\\"Greeter\\");\\n    const greeter = await Greeter.deploy(\\"Hello, world!\\");\\n    await greeter.deployed();\\n\\n    expect(await greeter.greet()).to.equal(\\"Hello, world!\\");\\n\\n    const setGreetingTx = await greeter.setGreeting(\\"Hola, mundo!\\");\\n\\n    // wait until the transaction is mined\\n    await setGreetingTx.wait();\\n\\n    expect(await greeter.greet()).to.equal(\\"Hola, mundo!\\");\\n  });\\n});\\n\\n```\\n\\n\u6e2c\u8a66\u6a94\u6848\u6703\u628a Greeter \u5408\u7d04\u900f\u904e `ethers.getContractFactory(\\"Greeter\\")` \u53d6\u5f97 Factory \u5408\u7d04\uff0c\u4e26\u4e14\u900f\u904e  `Greeter.deploy(\\"Hello, world!\\")` \u4f48\u7f72\u5230\u672c\u5730\u7684\u6e2c\u8a66\u7db2\u8def\u88e1\u9762\uff0c\u5230\u7b49\u4f48\u7f72\u6210\u529f\u5f8c\u5c31\u958b\u59cb\u9032\u884c\u6e2c\u8a66\u3002\\n\\n\u9019\u500b\u672c\u5730\u6e2c\u8a66\u7db2\u8def Hardhat Network \u6703\u5728\u6e2c\u8a66\u7d50\u675f\u4e4b\u5f8c\u92b7\u6bc0\u6240\u6709\u6e2c\u8a66\u6240\u4f48\u7f72\u4e0a\u53bb\u7684\u5408\u7d04\u8207\u72c0\u614b\u3002\\n\\n## \u4f48\u7f72\\nHardhat \u5b98\u65b9\u96d6\u7136\u6c92\u6709\u63d0\u4f9b\u4f48\u7f72\u5de5\u5177\uff0c\u4f46\u662f\u53ef\u4ee5\u900f\u904e `hardhat script` \u6307\u4ee4\u505a\u5230\u3002\u4e0b\u9054\u4ee5\u4e0b\u6307\u4ee4\u4e4b\u5f8c\u53ef\u4ee5\u4f48\u7f72\u5230\u5167\u5efa\u7684 Hardhat network\uff1a\\n\\n```shell\\n$ npx hardhat run ./scripts/sample-script.js \\nDeploying a Greeter with greeting: Hello, Hardhat!\\nGreeter deployed to: 0x5FbDB2315678afecb367f032d93F642f64180aa3\\n```\\n\\n\u4f46\u7531\u65bc\u662f\u4f48\u7f72\u65bc\u672c\u5730\u7684\u958b\u767c\u7528\u7db2\u8def Hardhat Network\uff0c\u800c\u9019\u500b\u5340\u584a\u93c8\u7db2\u8def\u5728\u6307\u4ee4\u57f7\u884c\u7d50\u675f\u5f8c\u5c31\u6703\u92b7\u6bc0\u6240\u6709\u5728\u4e0a\u9762\u4f48\u7f72\u7684\u5408\u7d04\u8207\u72c0\u614b\uff0c\u6240\u4ee5\u9664\u4e86\u57f7\u884c\u6307\u4ee4\u7684\u7576\u4e0b\u53ef\u4ee5\u547c\u53eb\u51fd\u5f0f\u6e2c\u8a66\u5916\u6c92\u6709\u5176\u4ed6\u53ef\u4ee5\u6e2c\u8a66\u7684\u65b9\u6cd5\u3002\\n\\n\u6b64\u6642\u53ef\u4ee5\u5728 `hardhat.config.js` \u88e1\u9762\u52a0\u5165\u4e00\u500b Ethereum \u7684\u7db2\u8def\u5982 mainnet \u6216\u662f\u6e2c\u8a66\u7db2\u8def Rinkeby, Ropsten \u4f86\u9032\u884c\u6e2c\u8a66\u3002\\n\\n\u6bd4\u5982\u8aaa\u4f60\u53ef\u4ee5\u5148\u7528 MetaMask \u5728\u6e2c\u8a66\u7db2\u8def Rinkeby \u5efa\u7acb\u4e00\u500b\u5e33\u865f\uff0c\u53d6\u5f97\u6e2c\u8a66\u7528\u7684 ETH \u4e26\u4e14\u532f\u51fa\u8a3b\u8a18\u8a5e\u3002\u7136\u5f8c\u5230 [Infura](https://infura.io/) \u6216\u662f [alchemy](https://www.alchemy.com/) \u7533\u8acb\u4e00\u500b API \u4f86\u5b58\u53d6 Rinkeby\uff0c\u4e26\u4e14\u6539\u8a2d\u5b9a\u6a94 `hardhat.config.js`\uff1a\\n\\n```javascript\\nmodule.exports = {\\n  solidity: \\"0.8.4\\",\\n  networks: {\\n    rinkeby: {\\n        url: \\"https://rinkeby.infura.io/v3/<INFURA_PROJECT_ID>\\",\\n        accounts: {\\n            mnemonic: \\"<YOUR_MNEMONIC>\\",\\n        },\\n        chainId: 4, // \u53ef\u4ee5\u67e5\u770b https://chainlist.org/\\n    }\\n  },\\n};\\n```\\n\\n\u8a2d\u5b9a\u5b8c\u7562\u5f8c\u5c31\u53ef\u4ee5\u7528\u76f8\u540c\u7684\u6307\u4ee4\u4f46\u52a0\u5165 `--network` \u4f48\u7f72\u5230 Rinkeby \u7db2\u8def\u4e0a\u9762\uff1a\\n\\n```shell\\n$ npx hardhat run --network rinkeby ./scripts/sample-script.js\\n```\\n\\n\u9019\u6a23\u9019\u4efd Greeter \u5408\u7d04\u5c31\u6703\u88ab\u4f48\u7f72\u5230 Rinkeby \u6e2c\u8a66\u7db2\u8def\u4e0a\u9762\u4e86\u3002\u9019\u908a\u7684\u7bc4\u4f8b\u7d66\u7684\u6bd4\u8f03\u7c21\u6613\uff0c\u4f46\u5be6\u969b\u4e0a\u901a\u5e38\u6703\u628a\u53ef\u62bd\u63db\u7684\u8cc7\u8a0a\u5982 `INFURA_PROJECT_ID` \u6216 `MNEMONIC` \u900f\u904e\u74b0\u5883\u8b8a\u6578\u50b3\u5165\uff0c\u4e26\u4e14\u7528 [dotenv](https://github.com/motdotla/dotenv) \u6a21\u7d44\u7ba1\u7406\u3002\\n\\n## \u6bd4\u8f03\\n\u8ddf Hardhat \u985e\u4f3c\u7684\u5de5\u5177\u6709\u5e7e\u500b\u5982 Truffle \u8207 Remix\uff0c\u4f46\u662f Hardhat \u8ddf\u5176\u4ed6\u7684\u5de5\u5177\u6bd4\u8f03\u6709\u4e9b\u984d\u5916\u7684\u597d\u8655\u3002\\n\\n### \u8207 Truffle \u6bd4\u8f03\\n[Truffle](https://trufflesuite.com/) \u539f\u751f\u5167\u5efa\u4e86 web3.js \u51fd\u5f0f\u5eab\uff0c\u4e0d\u904e\u820a\u7684\u7248\u672c\u88e1\u9762\u6df7\u7528\u4e86\u4e0d\u76f8\u5bb9\u7684\u5169\u7a2e web3.js \u51fd\u5f0f\u5eab\uff0c\u958b\u767c\u4e0a\u7d93\u5e38\u6703\u5f88\u56f0\u60d1\u3002\u4e0d\u904e\u7b46\u8005\u5f88\u4e45\u6c92\u7528 Truffle \u4e86\uff0c\u6216\u8a31\u73fe\u5728\u5df2\u7d93\u6c92\u6709\u9019\u500b\u554f\u984c\uff0c\u800c\u5169\u7a2e web3.js \u7248\u672c\u5c0e\u81f4\u7684\u554f\u984c\u662f\u4e0d\u77e5\u9053\u600e\u9ebc\u7528 web3 \u51fd\u5f0f\u5eab\u4e5f\u5e36\u51fa\u4e86\u4e0b\u4e00\u500b\u512a\u52e2 - TypeScript \u652f\u63f4\u3002\\n\\nHardhat \u539f\u751f\u5c31\u662f\u63a1\u7528 TypeScript \u958b\u767c\uff0c\u9019\u5728\u63a1\u7528 Hardhat \u9032\u884c\u667a\u80fd\u5408\u7d04\u958b\u767c\u6642\uff0c\u6e05\u695a\u7684\u578b\u5225\u5728\u88fd\u4f5c\u958b\u767c\u5de5\u5177\u4ee5\u53ca\u64b0\u5beb\u6e2c\u8a66\u4e0a\u9762\u80fd\u5920\u66f4\u6709\u6548\u7387\uff0c\u9019\u5728\u5f8c\u7e8c\u7684\u6587\u7ae0\u6703\u5728\u89e3\u91cb\u5982\u4f55\u8a2d\u5b9a TypeScript \u4ee5\u53ca\u4ed6\u6240\u63d0\u4f9b\u7684\u512a\u52e2\u3002\\n\\n\u53e6\u5916\u6709\u4e00\u4e9b Truffle \u63d0\u4f9b\u7684\u5de5\u5177\u6211\u4e00\u76f4\u90fd\u6c92\u627e\u5230\u597d\u7528\u7684\u5730\u65b9\uff0c\u6bd4\u5982\u8aaa Truffle \u7684\u93c8\u4e0a migration \u6a5f\u5236\u90fd\u6c92\u6709\u5408\u9069\u5408\u7406\u7684\u4f7f\u7528\u65b9\u5f0f\uff0c\u800c\u91cd\u65b0\u5c07 `mocha` \u7684 `describe()` \u5305\u88dd\u6210 `contract()` \u63d0\u4f9b\u7684 [clear-room feature](https://trufflesuite.com/docs/truffle/testing/writing-tests-in-javascript/#use-contract-instead-of-describe) \u4e00\u76f4\u90fd\u6c92\u611f\u53d7\u5230\u7279\u5225\u5be6\u7528\u7684\u5730\u65b9\uff0c\u800c\u5168\u57df\u7684 `artifacts.require()` \u4e5f\u8b93\u4eba\u611f\u5230\u6709\u4e9b\u56f0\u60d1\u3002\\n\\n\u76f8\u8f03\u8d77\u4f86 Hardhat \u901a\u5e38\u90fd\u662f\u6bd4\u8f03\u660e\u78ba\u7684\u64b0\u5beb\u65b9\u5f0f\u5982\u4e0b\u9762\u7684\u4f8b\u5b50\uff0c\u6211\u89ba\u5f97\u6bd4\u8f03\u5bb9\u6613\u7406\u89e3\u8207\u95b1\u8b80\u3002\\n```javascript\\n// truffle\'s implicit global function `artifacts`\\nconst MetaCoin = artifacts.require(\\"MetaCoin\\"); // where does artifacts come from?\\nMetaCoin.deployed()\\n\\n// hardhat\'s explicit function\\nconst { ethers } = require(\\"hardhat\\"); // explicitly import via hardhat\\nconst Greeter = await ethers.getContractFactory(\\"Greeter\\");\\n```\\n\\n### \u8207 Remix IDE \u6bd4\u8f03\\n[Remix](https://remix-project.org/) \u6bd4\u8f03\u9069\u5408\u5feb\u901f\u7684\u6e2c\u8a66\u8207\u9664\u932f\uff0c\u4f46\u4ee5\u7db2\u9801\u4f5c\u70ba\u57fa\u790e\u958b\u767c\u7684\u958b\u767c\u5957\u4ef6\u6bd4\u8f03\u4e0d\u9069\u5408\u5718\u968a\u958b\u767c\u4f7f\u7528\u3002\u4e00\u822c\u4f86\u8aaa\u5982\u679c\u60f3\u8981\u5feb\u901f\u6e2c\u8a66\u6642\uff0cRemix \u6703\u66f4\u52a0\u7684\u5408\u7528\uff0c\u4f46\u662f\u5982\u679c\u60f3\u8981\u653e\u5728 Github \u8b93\u5718\u968a\u4e00\u8d77\u5354\u4f5c\u958b\u767c\uff0cHardhat \u6216\u662f Truffle \u6703\u6bd4\u8f03\u9069\u5408\u3002\\n\\n### \u65b0\u5de5\u5177 foundry\\n[Foundry](https://github.com/foundry-rs/foundry) \u662f LunDAO \u7684 discord \u7fa4\u7d44\u4e0a\u9762\u6700\u8fd1\u8a0e\u8ad6\u7684\u5de5\u5177\uff0c\u770b\u8d77\u4f86\u6bd4\u8d77 Hardhat \u628a Hardhat Network \u8ddf\u6846\u67b6\u6253\u5305\u5728\u4e00\u8d77\uff0cFoundry \u63d0\u4f9b\u4e86\u4e00\u500b\u66f4\u7368\u7acb\u7684\u958b\u767c\u5de5\u5177\uff0c\u770b\u8d77\u4f86\u662f\u500b\u4e0d\u932f\u7684\u65b0\u9078\u64c7\uff0c\u6216\u8a31\u4e4b\u5f8c\u4e5f\u6703\u64b0\u6587\u4ecb\u7d39\u3002\\n\\n## \u7d50\u8ad6\\n\u5982\u540c\u4e0a\u9762\u7684\u6bd4\u8f03\uff0c\u7b46\u8005\u81ea\u5df1\u662f\u6bd4\u8f03\u504f\u597d Hardhat\uff0c\u540c\u6642\u4e5f\u5728\u5718\u968a\u4e2d\u63a1\u7528\u4e86\u8d85\u904e\u5169\u5e74\u7684\u6642\u9593\uff0c\u5728 Perpetual Protocol V1 \u5230 V2 \u7684\u8f49\u63db\u4e5f\u9084\u662f\u63a1\u7528\u4e86\u76f8\u540c\u5de5\u5177\uff0c\u9019\u4e5f\u8b93 hardhat \u6210\u70ba\u4e86\u5718\u968a\u7684\u5fc5\u5099\u5de5\u5177\u3002\\n\\n\u800c Hardhat \u4e0a\u9762\u8c50\u5bcc\u7684\u5de5\u5177\u5982 [hardhat-deploy](https://github.com/wighawag/hardhat-deploy), [hardhat-etherscan](https://hardhat.org/plugins/nomiclabs-hardhat-etherscan.html) \u8207 [hardhat-gas-reporter](https://github.com/cgewecke/hardhat-gas-reporter) \u7b49\u7b49\u90fd\u8b93\u958b\u767c\u5de5\u4f5c\u80fd\u5920\u66f4\u9806\u5229\u7684\u9032\u884c\u3002\\n\\n\u7136\u800c hardhat \u63d0\u4f9b\u7684\u5f48\u6027\u6846\u67b6\u6709\u6642\u5019\u5728\u958b\u767c\u4e0a\u4e5f\u6703\u9020\u6210\u4e00\u4e9b\u56f0\u64fe\uff0c\u63a5\u4e0b\u4f86 Hardhat \u7cfb\u5217\u6587\u7ae0\u5c07\u6703\u66f4\u6df1\u5165\u7684\u89e3\u91cb Hardhat \u7d50\u69cb\u8207\u539f\u7406\uff0c\u7576\u5728\u5927\u91cf\u4f7f\u7528 Hardhat \u53ef\u4ee5\u66f4\u660e\u767d\u767c\u751f\u4e86\u4ec0\u9ebc\u4e8b\u60c5\u4ee5\u53ca\u5982\u4f55\u89e3\u6c7a\u4f7f\u7528 Hardhat \u6703\u9047\u5230\u7684\u554f\u984c\u3002\\n\\n[^\u8a3b1]: \u95dc\u9589\u6700\u4f73\u5316\u6642\u4ecd\u6703\u6709\u90e8\u5206\u7684\u6700\u4f73\u5316\uff0c\u8acb\u53c3\u8003 [LunDAO discord \u8a0e\u8ad6](https://discord.com/channels/927177880318922802/927177880318922807/967723565623423006)"},{"id":"diamond101","metadata":{"permalink":"/blog/diamond101","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-04-20-diamond101/diamond101-1.md","source":"@site/blog/2022-04-20-diamond101/diamond101-1.md","title":"Diamond 101 (1)","description":"EIP-2535 Diamond Contract","date":"2022-04-20T00:00:00.000Z","formattedDate":"April 20, 2022","tags":[{"label":"eip2535","permalink":"/blog/tags/eip-2535"},{"label":"diamond","permalink":"/blog/tags/diamond"},{"label":"proxy","permalink":"/blog/tags/proxy"}],"readingTime":5.995,"truncated":true,"authors":[{"name":"wiasliaw","url":"https://github.com/wiasliaw","imageURL":"https://github.com/wiasliaw.png","key":"wiasliaw"}],"prevItem":{"title":"Hardhat \u7c21\u4ecb","permalink":"/blog/hardhat-intro"},"nextItem":{"title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (1)","permalink":"/blog/hardhat-forking-1"}},"content":"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u4e00\u7bc7\u6587\u7ae0\uff0c\u5c07\u89e3\u91cb\u4ec0\u9ebc\u662f\u53ef\u5347\u7d1a\u5408\u7d04\u3001\u5e38\u898b\u7684\u5be6\u4f5c\u4ee5\u53ca\u4e0d\u540c\u5be6\u4f5c\u4e4b\u9593\u7684\u8a2d\u8a08\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n## Proxy \u7684\u7d44\u6210\\n\\n![](./transparent_proxy_func.jpeg)\\n\\n\u53ef\u5347\u7d1a\u5408\u7d04\u9867\u540d\u601d\u7fa9\u5c31\u662f\u53ef\u4ee5\u66f4\u65b0\u908f\u8f2f\u7684\u5408\u7d04\uff0c\u5be6\u4f5c\u5927\u591a\u57fa\u65bc Proxy\u3002Proxy \u662f\u4e00\u7a2e Solidity \u7684 design pattern\uff0c\u5c07\u8cc7\u6599\u8207\u908f\u8f2f\u5206\u958b\u8655\u7406\uff0c\u53ea\u8981\u80fd\u66ff\u63db\u6389\u908f\u8f2f\uff0c\u5c31\u80fd\u5347\u7d1a\u3002\\n\\n### Delegatecall\\n\\n\u9996\u5148\u9700\u8981\u5148\u4f86\u88dc\u5145\u4e00\u9ede\u80cc\u666f\u77e5\u8b58\u3002\u76ee\u524d\u6240\u6709\u7684 Proxy \u90fd\u662f `delegatecall` \u7684\u61c9\u7528\u3002\u7c21\u55ae\u8aaa\u660e `delegatecall` \u5c31\u662f\u4ee5\u5225\u7684\u5408\u7d04\u7684\u51fd\u5f0f\u4f86\u64cd\u4f5c\u767c\u51fa `delegatecall` \u7684\u5408\u7d04\u7684 storage\u3002\u800c\u4e00\u822c\u7684\u5408\u7d04\u8abf\u7528\u5247\u662f\u4ee5\u81ea\u5df1\u7684\u51fd\u5f0f\u64cd\u4f5c\u81ea\u5df1\u7684 storage\u3002\u8209\u4f8b\u4f86\u8aaa\uff0c\u7576 A \u5408\u7d04\u5c0d B \u5408\u7d04\u8abf\u7528 `delegatecall` \u6642\uff0cB \u5408\u7d04\u7684\u51fd\u5f0f\u6703\u88ab\u8abf\u7528\uff0c\u4f46\u662f\u5c0d storage \u7684\u5beb\u5165\u90fd\u6703\u57f7\u884c A \u5408\u7d04\u4e0a\u3002\u9644\u4e0a[\u5e38\u898b\u7684 delegatecall \u5be6\u4f5c](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5a75065659a65e65bb04890192e3a4bcb7917fff/contracts/proxy/Proxy.sol#L22-L45)\u3002\\n\\nDelegatecall \u4e5f\u884d\u751f\u51fa\u4e0d\u5c11\u6709\u8da3\u7684 EIP\uff0c\u4f8b\u5982 [EIP-1167](https://eips.ethereum.org/EIPS/eip-1167)\uff0c\u4ee5\u6700\u5c0f\u7684\u6210\u672c\u8907\u88fd\u4e00\u500b\u5408\u7d04\u3002\\n\\n### fallback \u8207 receive\\n\\n\u6709\u95dc\u5408\u7d04\u8abf\u7528\u7684\u4ea4\u6613 (transaction) \u7684 data \u6b04\u4f4d\u4e0d\u6703\u7a7a\u8457\uff0c\u524d\u9762 4 \u500b bytes \u70ba function selector\uff0c\u7528\u4f86\u8b93 EVM \u77e5\u9053\u8981\u57f7\u884c\u5408\u7d04\u4e2d\u7684\u54ea\u6bb5 bytecode\u3002\u8981\u662f\u6c92\u6709 function selector \u6216\u662f function selector \u4e0d\u5728\u5408\u7d04\u4e2d\u600e\u9ebc\u8fa6\uff1f\u9019\u6642\u5247\u6703\u770b\u5408\u7d04\u6709\u6c92\u6709\u5be6\u4f5c `fallback` \u6216\u662f `receive`\uff0c\u5169\u8005\u89f8\u767c\u7684\u689d\u4ef6\u5982\u4e0b\uff1a\\n\\n- `fallback`:\\n  - \u5408\u7d04\u4e2d\u6c92\u6709\u5c0d\u61c9\u7684 function selector\\n  - \u6c92\u6709 receive \u6642\\n- `receive`:\\n  - \u4ea4\u6613\u7684 data \u70ba\u7a7a (\u4e0d\u7ba1 value \u70ba\u591a\u5c11)\\n\\nProxy \u5408\u7d04\u4e2d\u4e0d\u6703\u7d00\u9304\u908f\u8f2f\u5408\u7d04 (logic contract) \u6bcf\u4e00\u500b function selector\uff0c\u5c31\u6703\u5229\u7528 fallback \u7684\u7279\u6027\u8655\u7406\u6240\u6709\u7684\u5408\u7d04\u8abf\u7528\uff0c\u5c07\u6240\u6709\u7684\u5408\u7d04\u8abf\u7528\u90fd delegatecall \u81f3\u908f\u8f2f\u5408\u7d04 (logic contract)\u3002\u53ef\u4ee5\u4f86\u770b\u4e00\u4e0b [Openzeppelin](https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/proxy/Proxy.sol) \u63d0\u4f9b\u7684\u5be6\u4f5c\uff0c\u5c31\u662f delegatecall \u8ddf fallback, receive \u7684\u7d44\u5408\u62f3\u3002\\n\\n## Transparent Proxy\\n\\n![](./transparent_proxy.jpeg)\\n\\n\u67b6\u69cb\u5716\u5982\u4e0a\uff0c\u4f86\u770b\u4e00\u4e0b Openzeppelin \u7684\u4ecb\u7d39\\n\\n> The way we deal with this problem is via the transparent proxy pattern. The goal of a transparent proxy is to be indistinguishable by a user from the actual logic contract.\\n\\n\u9019\u662f\u4f55\u610f\u5462\uff1f\u4e3b\u8981\u662f\u8981\u8b93\u4f7f\u7528\u8005\u8ddf\u908f\u8f2f\u5408\u7d04 (logic contract) \u7dca\u7dca\u9023\u7d50\u5728\u4e00\u8d77\uff0c\u4e0d\u904e\u9019\u6a23\u5beb\u4e5f\u5f88\u8b93\u4eba\u96e3\u61c2\u3002\u7c21\u55ae\u4f86\u8aaa\u5c31\u662f\u4f7f\u7528\u8005\u6240\u767c\u8d77\u7684\u5408\u7d04\u8abf\u7528\u90fd\u8981\u4ee5 delegatecall \u8abf\u7528\u908f\u8f2f\u5408\u7d04 (logic contract)\uff0c\u800c admin \u6240\u767c\u8d77\u7684\u5408\u7d04\u8abf\u7528\u6c38\u9060\u4e0d\u6703\u5230\u908f\u8f2f\u5408\u7d04\u3002\\n\\n\u793a\u610f\u5716\u5982\u4e0b\\n\\n| msg.sender | owner()             | upgradeTo()    | transfer()           |\\n| ---------- | ------------------- | -------------- | -------------------- |\\n| admin      | returns proxy.owner | upgrades proxy | reverts              |\\n| user       | returns ERC20 owner | reverts        | sends ERC20 transfer | \\n\\nOpenzeppelin \u63a1\u7528 EIP-1967 \u4f5c\u70ba\u5be6\u4f5c\u3002\u5be6\u4f5c\u4e0a\uff0cProxy \u88e1\u9762\u7684\u6bcf\u500b\u7ba1\u7406 proxy \u7684 function \u90fd\u6703\u52a0\u4e0a\u8eab\u4efd\u9a57\u8b49\u7684\u6d41\u7a0b\uff0c\u53ea\u8b93 admin \u53ef\u4ee5\u8abf\u7528\u3002\u4f46\u662f\u70ba\u4f55\u9084\u8981\u4e00\u500b\u800c ProxyAdmin \u5462\uff1fProxyAdmin \u4e3b\u8981\u7528\u9014\u662f\u70ba\u4e86\u57f7\u884c\u67e5\u8a62\u7684\u7528\u9014\u9084\u6709\u8b93 owner \u89e3\u653e\u3002\\n\\n\u8209\u500b\u4f8b\u5b50\uff0c`admin()` \u61c9\u8a72\u8981\u662f\u500b `view function` \u4f46\u662f\u56e0\u70ba fallback \u7684\u95dc\u4fc2\u4e0d\u80fd\u6a19\u793a `view`\uff0c\u9700\u8981\u5229\u7528\u53e6\u5916\u4e00\u500b\u5408\u7d04\u518d\u5305\u88dd\u4e00\u5c64\u624d\u80fd\u6a19\u793a `view`\u3002\u6b64\u5916 admin \u4e5f\u53ef\u80fd\u540c\u6642\u662f user\uff0c\u628a\u6b0a\u9650\u4ea4\u7d66 ProxyAdmin \u540c\u6642\u6709\u66f4\u597d\u7684 function interface \u53ef\u4ee5\u8abf\u7528\uff0c\u4e5f\u53ef\u4ee5\u8b93 admin \u89e3\u958b\u9650\u5236\u3002\\n\\n**Proxy \u4e2d admin function \u7684\u8209\u4f8b**\\n\\n```javascript\\nmodifier ifAdmin() {\\n    if (msg.sender == _getAdmin()) {\\n        _;\\n    } else {\\n        _fallback();\\n    }\\n}\\n\\nfunction admin() external ifAdmin returns (address admin_) {\\n    admin_ = _getAdmin();\\n}\\n```\\n\\n**ProxyAdmin \u4e2d\u5c0d admin function \u7684\u5c01\u88dd**\\n\\n\u8ddf `staticcall` \u4e00\u8d77\u4f7f\u7528\uff0c\u624d\u80fd\u6a19\u793a\u70ba `view`\\n\\n```javascript\\nfunction getProxyAdmin(TransparentUpgradeableProxy proxy) public view virtual returns (address) {\\n    (bool success, bytes memory returndata) = address(proxy).staticcall(hex\\"f851a440\\");\\n    require(success);\\n    return abi.decode(returndata, (address));\\n}\\n```\\n\\n## UUPS\\n\\n![](./uups_proxy.jpeg)\\n\\nUUPS \u7684\u898f\u683c\u548c\u4ecb\u9762\u662f\u57fa\u65bc EIP-1822\uff0c\u4e0d\u904e Openzeppelin \u4e5f\u662f\u548c EIP-1967 \u642d\u914d\u4f5c\u70ba\u5be6\u4f5c\u3002Transparent Proxy \u6700\u5927\u7684\u5dee\u7570\u5728\u505a upgrade \u7684\u51fd\u5f0f\u540c\u6a23\u4e5f\u653e\u5728\u908f\u8f2f\u5408\u7d04\u4e2d\uff0c\u8b93 Proxy \u53ea\u7559 fallback \u548c receive\u3002\u5347\u7d1a\u5408\u7d04\u4e5f\u9700\u8981\u900f\u904e delegatecall \u8abf\u7528\u908f\u8f2f\u5408\u7d04\u3002\u5408\u7d04\u67b6\u69cb\u66f4\u70ba\u7cbe\u7c21\uff0c\u4e0d\u7528\u984d\u5916\u7684\u8eab\u4efd\u9a57\u8b49\u6216\u662f\u984d\u5916\u7684 Admin \u5408\u7d04\u3002\\n\\n## Diamond\\n\\n![](./diamond.jpeg)\\n\\nDiamond \u600e\u9ebc\u5347\u7d1a\u8ddf Transparent Proxy \u8ddf UUPS \u622a\u7136\u4e0d\u540c\u3002Transparent Proxy \u8ddf UUPS \u6bcf\u6b21\u66f4\u65b0\u90fd\u9700\u8981\u5c07\u6574\u4efd\u5408\u7d04\u66f4\u65b0\uff0c\u9664\u4e86\u4e0d\u9700\u8981\u66f4\u65b0\u7684\u90e8\u5206\u4e5f\u9023\u5e36\u66f4\u65b0\u4e86\uff0c\u800c\u4e14\u56e0\u70ba\u5408\u7d04\u5927\u5c0f\u6709\u4e0a\u9650 (EIP-170) \u4e5f\u4e0d\u80fd\u5728\u55ae\u500b\u5408\u7d04\u4e00\u76f4\u589e\u52a0\u65b0\u7684\u908f\u8f2f\u3002\u6240\u4ee5\u6709\u4eba\u63d0\u51fa\u4e86 EIP-2535\uff0c\u4e3b\u8981\u662f\u5efa\u7acb\u4e00\u5f35\u8868\u4f86\u8a3b\u518a\u4e0d\u540c\u7684 function selector\u3002\u6709\u8da3\u7684\u5730\u65b9\u5728\u65bc\u53ef\u4ee5\u8a3b\u518a\u4e0d\u540c\u5408\u7d04\u7684 function selector\u3002\u4e5f\u5c31\u662f\u8aaa delegatecall \u53ef\u4ee5\u8abf\u7528\u7684\u5408\u7d04\u4e0d\u53ea\u9650\u65bc\u4e00\u500b\u3002\u9664\u4e86\u5f48\u6027\u8b8a\u5927\u4e4b\u5916\uff0c\u4e5f\u53ef\u4ee5\u53ea\u65b0\u589e\u6216\u662f\u4fee\u6539\u5176\u4e2d\u4e00\u500b function selector\u3002\\n\\n## Reference\\n\\n- EIPS\\n    - [EIP-7 Delegatecall](https://eips.ethereum.org/EIPS/eip-7)\\n    - [EIP-170 Contract code size limit](https://eips.ethereum.org/EIPS/eip-170)\\n    - [EIP-1167 Minimal Proxy Contract](https://eips.ethereum.org/EIPS/eip-1167)\\n        - \u9032\u968e\u95b1\u8b80: [Deep dive into the Minimal Proxy contract](https://blog.openzeppelin.com/deep-dive-into-the-minimal-proxy-contract/)\\n    - [EIP-1822 Universal Upgradeable Proxy Standard (UUPS)](https://eips.ethereum.org/EIPS/eip-1822)\\n    - [EIP-1967 Standard Proxy Storage Slots](https://eips.ethereum.org/EIPS/eip-1967)\\n    - [EIP-2535 Diamonds, Multi-Facet Proxy](https://eips.ethereum.org/EIPS/eip-2535)\\n- [Solidity 0.6.x features: fallback and receive functions](https://blog.soliditylang.org/2020/03/26/fallback-receive-split/)\\n- [OpenZeppelin Blog: The transparent proxy pattern](https://blog.openzeppelin.com/the-transparent-proxy-pattern/)\\n- [Deconstructing a Solidity Contract\u200a\u2014\u200aPart III: The Function Selector](https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-iii-the-function-selector-6a9b6886ea49/)\\n- [UUPS Proxies \u4f7f\u7528\u6587](https://medium.com/taipei-ethereum-meetup/uups-proxies-%E4%BD%BF%E7%94%A8%E6%96%87-6210c81a946f)"},{"id":"hardhat-forking-1","metadata":{"permalink":"/blog/hardhat-forking-1","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-03-23-hardhat-forking/hardhat-forking-1.md","source":"@site/blog/2022-03-23-hardhat-forking/hardhat-forking-1.md","title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (1)","description":"\u5982\u4f55\u5229\u7528 Hardhat \u9032\u884c\u4e3b\u7db2\u5206\u53c9","date":"2022-03-23T00:00:00.000Z","formattedDate":"March 23, 2022","tags":[{"label":"Mainnet Fork","permalink":"/blog/tags/mainnet-fork"},{"label":"Mainnet Forking","permalink":"/blog/tags/mainnet-forking"},{"label":"Hardhat","permalink":"/blog/tags/hardhat"},{"label":"Nomic Labs","permalink":"/blog/tags/nomic-labs"}],"readingTime":12.56,"truncated":true,"authors":[{"name":"Chuan-Chun Wang","url":"https://github.com/a2468834","imageURL":"https://github.com/a2468834.png","key":"a2468834"}],"prevItem":{"title":"Diamond 101 (1)","permalink":"/blog/diamond101"},"nextItem":{"title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (2)","permalink":"/blog/hardhat-forking-2"}},"content":"\u672c\u6587\u7ae0\u5c07\u5c55\u793a\u600e\u9ebc\u4f7f\u7528\u77e5\u540d\u958b\u767c\u5de5\u5177 Hardhat \u7684\u4e3b\u7db2\u5206\u53c9\uff08mainnet forking\uff09\uff0c\u4ee4\u958b\u767c\u8005\u53ef\u4efb\u610f\u6307\u5b9a\u6b32\u5206\u53c9\u7684\u5340\u584a\u93c8\u9ad8\u5ea6\uff0c\u4e26\u8207 Hardhat \u5167\u5efa\u7684\u81ea\u5b9a\u7fa9 testnet\uff08Hardhat Network\uff09\u7d50\u5408\uff0c\u4eab\u53d7\u6700\u9ad8\u4eff\u771f\u5ea6\u3001\u6700\u7c21\u4fbf\u7684\u958b\u767c\u74b0\u5883\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u5728 Ethereum \u958b\u767c Dapp \u5c11\u4e0d\u4e86\u64b0\u5beb\u667a\u80fd\u5408\u7d04\uff08smart contract\uff09\uff1b\u9664\u4e86\u4f7f\u7528 Go Ethereum\uff08Geth\uff09\u3001OpenEthereum \u7b49\u5de5\u5177\u81ea\u5efa\u4e00\u689d local testnet\uff0c\u4e26\u5c07\u5408\u7d04\u90e8\u5c6c\u5728\u4e0a\u9762\u4e4b\u5916\uff0c\u9084\u53ef\u5c07\u5408\u7d04\u90e8\u5c6c\u5230\u5404\u5927\u516c\u958b\u6e2c\u8a66\u7db2\uff08testnet\uff09[^1]\u3002\u7136\u800c\uff0c\u9019\u4e9b\u65b9\u6cd5\u96d6\u7136\u90fd\u4f7f\u7528\u8207\u4e3b\u7db2\uff08mainnet\uff09\u5e7e\u4e4e\u76f8\u540c\u7684[^2]\u7a0b\u5f0f\u78bc\u7576\u4f5c L1 \u5e95\u5c64\uff0c\u4f46\u662f\u8207\u76f4\u63a5\u90e8\u5c6c\u5728 mainnet \u6700\u5927\u7684\u5dee\u7570\u5c31\u662f\uff1a\u4f60\u5e7e\u4e4e\u7121\u6cd5\u8b93\u4f60\u7684 Dapp \u8207\u5176\u4ed6\u77e5\u540d\u5408\u7d04\u3001DEX \u505a\u4e92\u52d5\u3002\\n\\nDeFi \u4e4b\u6240\u4ee5\u5728\u8fd1\u5e74\u53d7\u5230\u5168\u7403\u77da\u76ee\uff0c\u5176\u4e2d\u4e00\u500b\u539f\u56e0\u83ab\u904e\u65bc\u5176\u9ad8\u5ea6\u7684\u4e92\u64cd\u4f5c\u6027\uff08interoperability\uff09\uff1b\u5404\u500b\u5408\u7d04\u4e4b\u9593\u53ef\u4ee5\u900f\u904e\u7a0b\u5f0f\u547c\u53eb\uff0c\u8f15\u9b06\u5730\u8207\u5f7c\u6b64\u4e92\u52d5\uff0c\u9054\u6210\u50b3\u7d71\u91d1\u878d\u6240\u7121\u6cd5\u4f01\u53ca\u7684\u5de8\u5927\u9748\u6d3b\u80fd\u529b\u3002\\n\\n\u7136\u800c\uff0c\u5982\u679c\u4f60\u6b63\u5728\u958b\u767c\u7684 Dapp/DeFi \u5c08\u6848\uff0c\u7121\u6cd5\u5728\u6975\u5ea6\u4eff\u771f\u7684\u74b0\u5883\u7576\u4e2d\uff0c\u901a\u904e\u5b8c\u6574\u7684\u6e2c\u8a66\u5373\u8cbf\u7136\u4e0a\u7dda\uff0c\u5247\u6b64\u670d\u52d9\u5c07\u66b4\u9732\u65bc\u5de8\u5927\u98a8\u96aa\u4e4b\u4e0b\u3002\\n\\n\u90e8\u5c6c\u5408\u7d04\u65bc (local) testnet \u7576\u4e2d\uff0c\u70ba\u6c42\u6700\u7cbe\u7dfb\u7684\u6a21\u64ec\u74b0\u5883\uff0c\u4f60\u5c07\u6703\u8017\u8cbb\u6975\u5927\u5fc3\u529b\u9010\u4e00\u8907\u88fd\u6240\u6709\u7b2c\u4e09\u65b9\u5408\u7d04\u3001DEX \u7684\u7a0b\u5f0f\u78bc\uff0c\u4e26\u91cd\u65b0\u4f48\u7f72\u65bc\u6a21\u64ec\u74b0\u5883\u7576\u4e2d\uff0c\u9019\u5b8c\u5168\u4e0d\u662f\u4e00\u500b\u53ef\u884c\u7684\u65b9\u6cd5\u3002\\n\\nHardhat \u7684\u8aaa\u660e\u6587\u4ef6\u662f\u9019\u9ebc\u4ecb\u7d39 mainnet forking\uff1a\\n\\n> You can start an instance of Hardhat Network that forks mainnet. **This means that it will simulate having the same state as mainnet**, but it will work as a local development network. [^3]\\n\\n\u672c\u6587\u7ae0\u5c07\u5e36\u9818\u5404\u4f4d\u8b80\u8005\u719f\u6089 mainnet forking \u7684\u4f7f\u7528\u65b9\u6cd5\uff0c\u4e26\u5728\u53e6\u4e00\u7bc7\u6587\u7ae0\u7576\u4e2d\u8209\u5e7e\u500b\u4f8b\u5b50\u8b93\u8b80\u8005\u80fd\u9ad4\u6703 mainnet forking \u7684\u65b9\u4fbf\u6027\uff0c\u4ee5\u671f\u5404\u4f4d\u8b80\u8005\u90fd\u80fd\u5584\u7528\u6b64\u5de5\u5177\u3002\\n\\n[^1]: \u4f8b\u5982\uff1aRinkeby\u3001Goerli\u3001Kintsugi \u7b49\\n[^2]: \u53ef\u80fd\u56e0\u4e0d\u540c testnet \u5171\u8b58\u6a5f\u5236\uff0c\u800c\u8207\u4e3b\u7db2\u7565\u6709\u5dee\u7570\uff0c\u4f46\u662f\u4e00\u822c\u4f86\u8aaa\u5f88\u7f55\u898b\u51fa\u73fe Dapp \u80fd\u5920\u904b\u884c\u65bc testnet \u537b\u7121\u6cd5\u904b\u884c\u65bc mainnet\uff0c\u5c24\u5176\u6240\u6709\u7db2\u8def\u7684 EVM \u5be6\u4f5c\u7d30\u7bc0\u5747\u76f8\u540c\\n[^3]: https://hardhat.org/hardhat-network/guides/mainnet-forking.html#mainnet-forking\\n\\n\\n\\n\u80cc\u666f\u77e5\u8b58\u8207\u74b0\u5883\\n---\\nMainnet forking \u80cc\u5f8c\u7684\u904b\u4f5c\u6a5f\u5236\uff0c\u6982\u5ff5\u4e0a\u5c31\u662f\u6a21\u64ec\u4e00\u500b\u4eff\u9020 Ethereum mainnet \u7684 local testnet\uff0c\u8b93\u958b\u767c\u8005\u8aa4\u4ee5\u70ba\u81ea\u5df1\u662f\u8ddf mainnet \u4e92\u52d5\u3002\\n\\n\u7576\u958b\u767c\u8005\u547c\u53eb\u5408\u7d04\u6216\u767c\u9001 tx \u6642\uff0c\u5982\u679c\u8a72\u300c\u4eff\u9020\u7248\u300dlocal testnet \u67e5\u7121\u8cc7\u8a0a\uff08\u8a72\u8cc7\u8a0a\u53ef\u80fd\u662f\u7d00\u9304\u5728\u67d0\u500b\u6b77\u53f2 block \u7576\u4e2d\uff09\uff0c\u5247 Hardhat \u5957\u4ef6\u8f49\u5411\u6b78\u6a94\u7bc0\u9ede\uff08archive node\uff09\u8a62\u554f\u8cc7\u8a0a\u7684\u5167\u5bb9\uff0c\u4e26\u5c07\u56de\u50b3\u7684\u7d50\u679c\u7d93\u904e\u9069\u7576\u5305\u88dd\u5f8c\u4e1f\u7d66\u958b\u767c\u8005\u3002\u56e0\u6b64\uff0c\u958b\u767c\u8005\u5fc5\u9700\u4e3b\u52d5\u63d0\u4f9b\u5169\u500b\u689d\u4ef6\uff1a(1) archive node (2) \u6307\u5b9a\u7684\u5340\u584a\u9ad8\u5ea6\uff08\u4ee5\u6b64\u9ad8\u5ea6\u70ba\u57fa\u6e96\u5283\u5206\u51fa\u4f55\u8b02\u6b77\u53f2 block\uff09\u3002\\n\\n\u672c\u6587**\u4e0d\u6703**\u63d0\u4f9b Hardhat \u8207\u5176\u4ed6\u76f8\u95dc\u5957\u4ef6\u7684\u5b89\u88dd\u6307\u5f15\uff0c\u76f8\u95dc\u64cd\u4f5c\u7d30\u7bc0\u53ef\u4ee5\u53c3\u8003 LunDAO \u5176\u4ed6\u6559\u5b78\u6587\u7ae0\u3002\u82e5\u60a8\u5df2\u77e5\u9053\u5982\u4f55\u4f7f\u7528 Hardhat \u90e8\u5c6c ERC-20 \u5408\u7d04\uff0c\u5247\u672c\u6587\u6df1\u5ea6\u6070\u5de7\u9069\u5408\u60a8\u3002\u4ee5\u4e0b\u70ba\u7b46\u8005\u5df2\u6e2c\u8a66\u80fd\u5920\u6210\u529f\u904b\u884c\u672c\u6587\u7ae0\u6b65\u9a5f\u7684\u8edf\u786c\u9ad4\u689d\u4ef6\uff0c\u8acb\u8b80\u8005\u53c3\u914c\u4f7f\u7528\u3002\\n\\n- Software\\n  - Windows\\n    - OS\uff1aWindows 10 Pro 21H1 (w/o WSL)\\n    - nodejs v14.17.4\\n    - yarn 1.22.17\\n  - Linux\\n    - OS\uff1aUbuntu 20.04.4 LTS (GNU/Linux 5.4.0-1053-raspi aarch64)\\n    - \u5176\u4ed6\u540c Windows \u8edf\u9ad4\u914d\u7f6e\\n- Hardware\\n  - \u57fa\u672c\u4e0a\u7121\u9650\u5236\uff0c\u4e0b\u5217\u70ba\u7d93\u904e\u6e2c\u8a66\u53ef\u884c\u7684\u7d44\u5408\\n  - Windows\uff1aIntel Core i7-10510U (16GB) with 4G LTE cellular hotspot\\n  - Linux\uff1aRaspberry Pi 4B (4GB) with 1Gbps network\\n\\n\\n\\n\u91cd\u8981\u5fc5\u5099\u689d\u4ef6\\n---\\n\u7531\u65bc mainnet forking \u7684\u904b\u4f5c\u904e\u7a0b\u9700\u8207 archive node \u4f5c\u4e92\u52d5\uff1b\u56e0\u6b64\uff0c**\u4f60\u5fc5\u9700\u6e96\u5099\u597d archive node** \u4e26\u5c07 Hardhat \u9023\u63a5\u4e0a\u5b83\u3002\u6700\u76f4\u767d\u5730\u65b9\u5f0f\u5373\u900f\u904e Geth\u3001OpenEthereum \u7b49\u5de5\u5177\u81ea\u67b6\u7bc0\u9ede[^5]\uff0c\u6216\u53ef\u4f7f\u7528\u5e02\u9762\u4e0a\u77e5\u540d\u7684\u6578\u5bb6 SaaS \u7bc0\u9ede\u4f9b\u61c9\u5546\u4e4b\u670d\u52d9[^6]\u3002\u672c\u6587\u70ba\u6c42\u904e\u7a0b\u8f15\u9b06\u597d\u5b78\u7fd2\uff0c\u4ee5\u4e0b\u5c07\u642d\u914d Alchemy \u63d0\u4f9b\u7684\u670d\u52d9\u3002\\n\\n\u53e6\u5916\uff0c\u7531\u65bc Hardhat Network \u662f EVM-compatible blockchain\uff0c\u56e0\u6b64\u7406\u8ad6\u4e0a\u4efb\u4f55 EVM-compatible chain \u7684\u6b78\u6a94\u7bc0\u9ede\u7686\u6709\u6a5f\u6703\u4f7f\u7528 mainnet forking\uff0c\u4f46\u5be6\u969b\u4e0a\u53ef\u80fd\u8207 Ethereum mainnet \u76f8\u6bd4\u6709\u6240\u9650\u5236\uff0c\u7b46\u8005\u50c5\u53e6\u5916\u4f7f\u7528\u904e Polygon mainnet \u4ea6\u53ef\u9806\u5229\u904b\u4f5c\u3002\\n\\n[^5]: \u900f\u904e\u6a39\u6885\u6d3e 4B \u53ef\u4ee5\u642d\u5efa\u6b78\u6a94\u7bc0\u9ede\uff0c\u4e0d\u4ee5\u6316\u7926\u70ba\u76ee\u7684\u4f86\u642d\u5efa\u6b78\u6a94\u7bc0\u9ede\u975e\u96e3\u4e8b\uff0c\u53ea\u9700\u8981\u6e96\u5099\u5927\u5bb9\u91cf\u7684 SATA3 SSD \u5373\u53ef\uff0c\u8a73\u7d30\u8acb\u53c3\u8003\u6587\u672b\u7684\u5ef6\u4f38\u95b1\u8b80 Ethereum on ARM\\n[^6]: Infura\u3001Alchemy\u3001QuickNode \u5747\u6709\u63d0\u4f9b\u5b58\u53d6\u6b78\u6a94\u7bc0\u9ede\u7684\u670d\u52d9\uff0c\u5176\u4e2d Alchemy \u5728\u4f5c\u8005\u64b0\u6587\u6642\u70ba\u514d\u8cbb\u670d\u52d9\u3002\\n\\n\\n\\nStep 1\uff1a\u5efa\u7f6e\u74b0\u5883\\n---\\n\u76ee\u6a19\uff1a\u6210\u529f\u555f\u52d5 Hardhat Network\\n\\n1. \u65b0\u589e\u4e00\u500b\u7a7a\u767d\u8cc7\u6599\u593e\u300c`hardhat_fork`\u300d\\n```Shell\\n$ mkdir hardhat_fork\\n$ cd hardhat_fork\\n```\\n2. \u5b89\u88dd\u5fc5\u5099\u7684 JavaScript \u5957\u4ef6\\n   - \u70ba\u6c42\u6240\u6709\u8b80\u8005\u90fd\u80fd\u5728\u7b2c\u4e00\u6b21\u64cd\u4f5c\u6642\u6210\u529f\u5b8c\u6210\uff0c\u672c\u6587\u5c07\u6240\u6709\u5957\u4ef6\u5df2\u6307\u5b9a\u7248\u672c\u865f\u5b89\u88dd\\n   - \u4f5c\u8005\u5efa\u8b70\u8b80\u8005\u5b78\u6703\u4e4b\u5f8c\uff0c\u4ee5\u4f7f\u7528\u6700\u65b0 stable version \u70ba\u4f73\\n```Shell\\n$ yarn init # \u6c92\u6709\u60f3\u66f4\u52d5\u7684\u90e8\u5206\uff0c\u5c31\u6309 Enter \u9375\u5e36\u904e\u5373\u53ef\\n...\\n$ yarn add dotenv@16.0.0\\n$ yarn add hardhat@2.8.4\\n$ yarn add @nomiclabs/hardhat-waffle@2.0.2\\n$ yarn add @nomiclabs/hardhat-web3@2.0.0\\n$ yarn add @nomiclabs/hardhat-ethers@2.0.5\\n$ yarn add web3@1.7.0\\n$ yarn add ethers@5.5.4\\n...\\n```\\n3. \u555f\u52d5 Hardhat Network \u521d\u59cb\u5316\u8a2d\u5b9a\\n```Shell\\n$ yarn hardhat\\nyarn run v1.22.15\\n888    888                      888 888               888\\n888    888                      888 888               888\\n888    888                      888 888               888\\n8888888888  8888b.  888d888 .d88888 88888b.   8888b.  888888\\n888    888     \\"88b 888P\\"  d88\\" 888 888 \\"88b     \\"88b 888\\n888    888 .d888888 888    888  888 888  888 .d888888 888\\n888    888 888  888 888    Y88b 888 888  888 888  888 Y88b.\\n888    888 \\"Y888888 888     \\"Y88888 888  888 \\"Y888888  \\"Y888\\n\\nWelcome to Hardhat v2.8.4\\n\\n? What do you want to do? \u2026\\n  Create a basic sample project\\n  Create an advanced sample project\\n  Create an advanced sample project that uses TypeScript\\n\u25b8 Create an empty hardhat.config.js # \u8acb\u9078\u64c7\u9019\u500b\u9078\u9805\uff0c\u4e26\u6309 Enter\\n  Quit\\n\\n$ ls\\nhardhat.config.js  node_modules  package.json  yarn.lock\\n```\\n4. \u4f60\u53ef\u4ee5\u767c\u73fe `hardhat_fork` \u8cc7\u6599\u593e\u5e95\u4e0b\u591a\u4e86\u4e00\u500b\u540d\u70ba `hardhat.config.js` \u7684\u6a94\u6848\uff1b\u5b83\u5c31\u662f\u7528\u4f86\u8abf\u6574 Hardhat Network \u548c\u5176\u4ed6 hardhat \u5957\u4ef6\u904b\u4f5c\u6a21\u5f0f\u7684\u91cd\u8981\u53c3\u6578\u6a94\u3002\\n\\n\\n\\nStep 2\uff1a\u8abf\u6574 `hardhat.config.js`\\n---\\n\u76ee\u6a19\uff1a\u8a2d\u5b9a\u9032\u884c mainnet forking \u6240\u9700\u7684\u76f8\u95dc\u53c3\u6578\\n\\n1. \u5728 `hardhat_fork` \u8cc7\u6599\u593e\uff0c\u65b0\u589e\u4e00\u500b\u7a7a\u767d\u6a94\u6848\u53eb\u505a `.env`\uff0c\u4e26\u4ee5\u6587\u5b57\u7de8\u8f2f\u5668\u5c07\u4ee5\u4e0b\u5167\u5bb9\u63d2\u5165\u5176\u4e2d\\n   - \u8a18\u5f97\u5148\u524d\u5f80 Alchemy \u8a3b\u518a\u5e33\u865f\uff0c\u4e26\u5275\u7acb\u4e00\u500b\u7a7a\u767d app \u5c08\u6848\uff08\u9810\u8a2d\u53ef\u5b58\u53d6 archive node\uff09\\n```\\nMainnet = \\"https://eth-mainnet.alchemyapi.io/v2/<your_Alchemy_key>\\"\\n```\\n2. \u4f7f\u7528\u4efb\u4f55\u6587\u5b57\u7de8\u8f2f\u5668\uff0c\u5c0d `hardhat.config.js` \u9032\u884c\u7de8\u8f2f\uff0c\u5c07\u6a94\u6848\u6539\u6210\u4ee5\u4e0b\u6a23\u5b50\uff08\u53ef\u4ee5\u76f4\u63a5\u8907\u88fd\u3001\u8cbc\u4e0a\uff0c\u53d6\u4ee3\u5168\u90e8\u6a94\u6848\u5167\u5bb9\uff09\\n```js\\nrequire(\\"@nomiclabs/hardhat-waffle\\");\\nrequire(\\"@nomiclabs/hardhat-web3\\");\\nrequire(\\"@nomiclabs/hardhat-ethers\\");\\nrequire(\'dotenv\').config();\\n\\ntask(\\"height\\", \\"Print the current block height\\")\\n  .setAction(async (taskArgs) => {\\n    const block_height = await web3.eth.getBlockNumber();\\n    console.log(`The current block height is ${block_height}`);\\n  });\\n\\nmodule.exports = {\\n  networks: {\\n    hardhat: {\\n      forking: {\\n        url: process.env.Mainnet,\\n        blockNumber: 14297759\\n      }\\n    }\\n  }\\n};\\n// \u9ad8\u5ea6 14297759 \u767c\u751f\u5728 2022-03-01 00:00:18 (UTC+0)\uff0c\u9078\u64c7\u6b64\u6578\u5b57\u65b9\u4fbf\u5f8c\u7e8c\u89e3\u8aaa\\n```\\n3. \u70ba\u4ec0\u9ebc\u8981\u9019\u6a23\u8a2d\u5b9a\u5462\uff1f\\n   - `task()` \u7684\u7a0b\u5f0f\u7247\u6bb5\u76ee\u7684\u662f\u5275\u9020\u80fd\u5370\u51fa\u76ee\u524d\u5340\u584a\u9ad8\u5ea6\u7684\u6307\u4ee4\uff08\u4ee5 Hardhat Network \u5206\u53c9\u51fa\u4f86\u7684\u4e3b\u7db2\u4f86\u770b\uff09\uff0c\u95dc\u65bc task \u7684\u7de8\u5beb\u65b9\u6cd5\u8a73\u898b\u6587\u672b\u7684\u5ef6\u4f38\u95b1\u8b80\\n   - `network` \u9805\u76ee\u5e95\u4e0b\uff0c\u6211\u5011\u8a2d\u5b9a `hardhat` \u7db2\u8def\u7684\u76f8\u95dc\u53c3\u6578\uff0c\u5305\u542b archive node \u7684\u5b58\u53d6\u7db2\u5740\u8207\u5206\u53c9\u9ad8\u5ea6\\n   - \u7531\u65bc `network` \u9805\u76ee\u5e95\u4e0b\u53ef\u4ee5\u540c\u6642\u8a2d\u5b9a\u591a\u500b\u4e0d\u540c\u7684\u7db2\u8def\uff0c\u4ee5\u4e0b\u70ba\u7c21\u6613\u7bc4\u4f8b\uff0c\u8a73\u7d30\u8fa6\u6cd5\u8acb\u53c3\u898b\u6587\u672b\u5ef6\u4f38\u95b1\u8b80\\n```js\\nmodule.exports = {\\n  solidity: {...},\\n  networks: {\\n    arbitrum: {\\n      url: process.env.Arbitrum, \\n      accounts: [process.env.PriKey0, process.env.PriKey1]\\n    },\\n    hardhat: {...}\\n  }\\n};\\n```\\n\\n\\n\\nStep 3\uff1a\u4f7f\u7528\u81ea\u5b9a\u7fa9\u7684 Hardhat task `height`\\n---\\n\u76ee\u6a19\uff1a\u900f\u904e\u81ea\u5b9a\u7fa9\u7684 `height` task \u4f86\u78ba\u8a8d mainnet forking \u53ef\u6b63\u5e38\u904b\u4f5c\\n\\n1. \u5217\u51fa\u6240\u6709\u53ef\u7528\u7684 Hardhat task\\n   - `--network \\"hardhat\\"` \u4ee3\u8868\u547d\u4ee4 Hardhat \u4f7f\u7528 Hardhat Network\\n   - \u5982\u679c\u8b80\u8005\u5728 `hardhat.config.js` \u88e1\u9762\u8a2d\u7f6e\u5176\u4ed6\u7db2\u8def\uff0c\u5247\u53ef\u900f\u904e\u6b64\u53c3\u6578\u96a8\u6642\u5207\u63db\u7db2\u8def\\n   - \u6211\u5011\u53ef\u4ee5\u767c\u73fe\u5230\u300c`AVAILABLE TASKS`\u300d\u51fa\u73fe\u4e86\u4e00\u884c `height Print the current block height` \u6587\u5b57\uff0c\u8207\u7a0d\u65e9\u6211\u5011\u5728 `hardhat.config.js` \u64b0\u5beb\u7684\u5167\u5bb9\u4e00\u81f4\\n```Shell\\n$ yarn hardhat --network \\"hardhat\\" help\\nyarn run v1.22.17\\nHardhat version 2.8.4\\n\\nUsage: hardhat [GLOBAL OPTIONS] <TASK> [TASK OPTIONS]\\n\\nGLOBAL OPTIONS:\\n  --config              A Hardhat config file.\\n  --emoji               Use emoji in messages.\\n  --help                Shows this message, or a task\'s help if its name is provided\\n  --max-memory          The maximum amount of memory that Hardhat can use.\\n  --network             The network to connect to.\\n  --show-stack-traces   Show stack traces.\\n  --tsconfig            A TypeScript config file.\\n  --verbose             Enables Hardhat verbose logging\\n  --version             Shows hardhat\'s version.\\n\\nAVAILABLE TASKS:\\n  check         Check whatever you need\\n  clean         Clears the cache and deletes all artifacts\\n  compile       Compiles the entire project, building all artifacts\\n  console       Opens a hardhat console\\n  flatten       Flattens and prints contracts and their dependencies\\n  height        Print the current block height\\n  help          Prints this message\\n  node          Starts a JSON-RPC server on top of Hardhat Network\\n  run           Runs a user-defined script after compiling the project\\n  test          Runs mocha tests\\n```\\n2. \u904b\u884c `height` \u6307\u4ee4\\n   - \u7531\u65bc\u76ee\u524d Ethereum \u7684\u6700\u65b0\u5340\u584a\u9ad8\u5ea6\u5fc5\u5b9a\u4e0d\u53ea 14297759\uff0c\u56e0\u6b64\u53ef\u898b\u6211\u5011\u5df2\u6210\u529f\u5275\u9020\u4e00\u500b\u5168\u65b0\u7684 mainnet forking \u74b0\u5883\\n```Shell\\n$ yarn hardhat --network \\"hardhat\\" height\\nyarn run v1.22.17\\nThe current block height is 14297759\\n```\\n3. \u5229\u7528 `node` \u6307\u4ee4\uff0c\u958b\u59cb\u904b\u4f5c Hardhat Network \u7bc0\u9ede\\n   - **\u8acb\u6ce8\u610f**\uff1a\u9019\u4e9b\u5730\u5740\u8207\u79c1\u9470\u90fd\u7531\u5df2\u77e5\u7684 key derivation \u904e\u7a0b[^7]\u7522\u751f\uff1b\u63db\u53e5\u8a71\u8aaa\uff0c\u4efb\u4f55\u4f7f\u7528 Hardhat \u7684\u958b\u767c\u8005\u7686\u77e5\u9019\u4e9b\u79c1\u9470\uff0c\u56e0\u6b64**\u5207\u52ff\u5728\u516c\u958b\u7db2\u8def\u5c07\u6771\u897f\u50b3\u9001\u9032\u9019\u4e9b\u5730\u5740\uff01**\\n   - \u524d\u6587\u5df2\u63d0\u904e Hardhat Network \u9810\u8a2d\u63d0\u4f9b 20 \u500b\u5404\u5177 10000 ETH \u7684\u5e33\u865f\u4f9b\u958b\u767c\u8005\u81ea\u7531\u4f7f\u7528\\n   - \u642d\u914d\u6211\u5011\u73fe\u5df2\u5b78\u6703\u7684 mainnet forking \u6280\u5de7\uff0c\u5247\u53ef\u958b\u59cb\u4f7f\u7528\u9019\u4e9b\u5e7e\u4e4e\u7528\u4e0d\u5b8c\u7684 ETH \uff0c\u5728\u81ea\u5df1\u7684 local testnet \u505a\u5404\u985e\u958b\u767c\\n\\n```Shell\\n$ yarn hardhat --network \\"hardhat\\" node\\nyarn run v1.22.17\\nStarted HTTP and WebSocket JSON-RPC server at http://127.0.0.1:8545/\\n\\nAccounts\\n========\\n\\nWARNING: These accounts, and their private keys, are publicly known.\\nAny funds sent to them on Mainnet or any other live network WILL BE LOST.\\n\\nAccount #0: 0xf39fd6e51aad88f6f4ce6ab8827279cfffb92266 (10000 ETH)\\nPrivate Key: ...\\n\\nAccount #1: 0x70997970c51812dc3a010c7d01b50e0d17dc79c8 (10000 ETH)\\nPrivate Key: ...\\n\\n...\\n\\nAccount #19: 0x8626f6940e2eb28930efb4cef49b2d1f2c9c1199 (10000 ETH)\\nPrivate Key: ...\\n\\nWARNING: These accounts, and their private keys, are publicly known.\\nAny funds sent to them on Mainnet or any other live network WILL BE LOST.\\n```\\n\\n\u672c\u6587\u5230\u6b64\u5df2\u5b8c\u6210\u6240\u6709\u6b65\u9a5f\uff0c\u606d\u559c\u5404\u4f4d\u8b80\u8005\u5df2\u5b78\u6703\u5982\u4f55\u4f7f\u7528 Hardhat \u9032\u884c mainnet forking\u3002\u53e6\u4e00\u7bc7[\u6587\u7ae0](./hardhat-forking-2.md)\u5c07\u64cd\u4f5c\u7c21\u55ae\u7684\u7bc4\u4f8b\uff0c\u5411\u6709\u8208\u8da3\u7684\u8b80\u8005\u5c55\u793a Hardhat Network \u7684\u6709\u8da3\u61c9\u7528\u3002\\n\\n[^7]: \u6709\u8208\u8da3\u7684\u8b80\u8005\u8acb\u53c3\u898b\u9019\u500b\u9023\u7d50 https://hardhat.org/hardhat-network/reference/#accounts\\n\\n\\n\\nRelated resources\\n---\\n- Yarn\\n  - https://classic.yarnpkg.com/en/\\n- Hardhat\\n  - GitHub\uff1ahttps://github.com/NomicFoundation/hardhat\\n  - Mainnet forking\uff1ahttps://hardhat.org/hardhat-network/guides/mainnet-forking.html\\n  - Configuration\uff1ahttps://hardhat.org/config/\\n  - Hardhat Network Reference\uff1ahttps://hardhat.org/hardhat-network/reference/\\n  - Creating a task\uff1ahttps://hardhat.org/guides/create-task.html\\n  - Hardhat Runtime Environment (HRE)\uff1ahttps://hardhat.org/advanced/hardhat-runtime-environment.html\\n- Alchemy\\n  - https://www.alchemy.com/\\n- Ethereum on ARM\\n  - https://ethereum-on-arm-documentation.readthedocs.io/en/latest/quick-guide/about-quick-start.html\\n- Wrapped Ether\\n  - https://weth.io/index.html\\n\\nFurther reading\\n---\\n- Infura\\n  - https://infura.io/\\n- QuickNode\\n  - https://www.quicknode.com/\\n- Truffle\\n  - Simulate Live Networks with Forked Sandboxes\uff1ahttps://trufflesuite.com/blog/sandbox-forking-with-truffle-teams/index.html"},{"id":"hardhat-forking-2","metadata":{"permalink":"/blog/hardhat-forking-2","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-03-23-hardhat-forking/hardhat-forking-2.md","source":"@site/blog/2022-03-23-hardhat-forking/hardhat-forking-2.md","title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (2)","description":"\u5229\u7528 Hardhat \u4e3b\u7db2\u5206\u53c9\u505a\u4e00\u4e9b\u9177\u70ab\u7684\u4e8b\u60c5","date":"2022-03-23T00:00:00.000Z","formattedDate":"March 23, 2022","tags":[{"label":"Mainnet Fork","permalink":"/blog/tags/mainnet-fork"},{"label":"Mainnet Forking","permalink":"/blog/tags/mainnet-forking"},{"label":"Hardhat","permalink":"/blog/tags/hardhat"},{"label":"Nomic Labs","permalink":"/blog/tags/nomic-labs"}],"readingTime":9.84,"truncated":true,"authors":[{"name":"Chuan-Chun Wang","url":"https://github.com/a2468834","imageURL":"https://github.com/a2468834.png","key":"a2468834"}],"prevItem":{"title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (1)","permalink":"/blog/hardhat-forking-1"},"nextItem":{"title":"\u57fa\u672c\u529f\uff1a\u4ece\u5408\u7ea6\u770b token \u6570\u91cf","permalink":"/blog/total-tokens-looksrare"}},"content":"\u5728\u4e0a\u4e00\u7bc7[\u6587\u7ae0](./hardhat-forking-1.md)\u6211\u5011\u5df2\u7d93\u5b78\u6703\u4e86\u600e\u9ebc\u4f7f\u7528 Hardhat mainnet forking\uff0c\u4f46\u662f\u8b80\u8005\u53ef\u80fd\u5c1a\u6709\u7591\u60d1\u4e0d\u77e5\u9053\u9019\u6a23\u7684\u529f\u80fd\u53ef\u4ee5\u505a\u4ec0\u9ebc\uff1f\u672c\u7bc7\u6587\u7ae0\u5c07\u5ef6\u7e8c\u76f8\u540c\u4e3b\u984c\uff0c\u4e26\u7d66\u51fa\u5e7e\u500b\u4f8b\u5b50\uff0c\u5411\u8b80\u8005\u5c55\u793a mainnet forking \u80fd\u5920\u70ba\u958b\u767c\u904e\u7a0b\u5e36\u4f86\u7684\u65b9\u4fbf\u6027\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\\n\\n\u7bc4\u4f8b\u4e00\uff1a\u8207 `WETH9` \u5408\u7d04\u4e92\u52d5\\n---\\n\u5982\u540c\u524d\u6587\u6240\u8ff0\uff0cinteroperability \u662f smart contract \u4e00\u500b\u76f8\u7576\u91cd\u8981\u7684\u7279\u6027\uff0c\u800c\u4ee5\u7a0b\u5f0f\u7684\u89d2\u5ea6\u4f86\u770b\u5373\u70ba\u5408\u7d04\u4e92\u76f8\u547c\u53eb\u3002\u5047\u8a2d\u6211\u5011\u4eca\u5929\u8981\u958b\u767c\u4e00\u500b\u5408\u7d04\u6703\u8207 Wrapped Ether\uff08`WETH9`\uff09[^3]\u5408\u7d04\u4e92\u52d5\uff0c\u90a3\u9ebc\u6703\u767c\u751f\u4ec0\u9ebc\u4e8b\u5462\uff1f\\n\\n[^3]: \u95dc\u65bc\u4ec0\u9ebc\u662f Wrapped Ether\uff1f\u8acb\u53c3\u8003\u6587\u672b\u5ef6\u4f38\u95b1\u8b80\uff0c\u6216\u8acb\u8b80\u8005\u81ea\u884c\u67e5\u8a62\u5176\u4ed6\u7db2\u8def\u8cc7\u6599\u3002\\n\\n\u82e5\u7121 mainnet forking \u53ef\u7528\uff0c\u5247\u6211\u5011\u5fc5\u9700\u5148\u5c07 `WETH9` \u90e8\u5c6c\u5728 local Hardhat Network \uff08\u4e14\u6703\u5f97\u5230\u8207\u4e3b\u7db2\u4e0d\u4e00\u6a23\u7684\u5408\u7d04\u5730\u5740\uff09\uff0c\u65b9\u80fd\u8207\u4e4b\u4e92\u52d5\u3001\u9032\u884c\u5f8c\u7e8c\u7684\u958b\u767c\u6d41\u7a0b\uff1b\u53ef\u60f3\u800c\u77e5\u9019\u5c31\u662f\u589e\u52a0\u8907\u96dc\u5ea6\uff0c\u537b\u964d\u4f4e\u4eff\u771f\u5ea6\u7684\u571f\u6cd5\u7149\u92fc\u65b9\u6cd5\u3002\\n\\n\u82e5\u6709 mainnet forking \u53ef\u7528\uff0c\u5247\u6211\u5011\u4ec0\u9ebc\u90fd\u4e0d\u9700\u8981\u505a\u3002\u76f4\u63a5\u8207 Etherscan \u4e0a\u9762\u67e5\u8a62\u5230\u7684 `WETH9` \u5408\u7d04\u5730\u5740\u4e92\u52d5\u5373\u53ef\uff0c\u5b8c\u5168\u6a21\u64ec\u6211\u5011\u5408\u7d04\u5728\u672a\u4f86\u4e0a\u7dda\u6642\u7684\u64cd\u4f5c\u74b0\u5883\u3002\\n\\n\u4ee5\u4e0b\u5c07\u900f\u904e\u57f7\u884c\u4e00\u6bb5\u7c21\u77ed\u7684 JavaScript \u8173\u672c\uff0c\u5411\u8b80\u8005\u5c55\u793a\u8981\u600e\u9ebc\u5728\u5df2\u5b8c\u6210 mainnet forking \u7684 Hardhat Network \u4e4b\u5167\uff0c\u8207\u77e5\u540d\u7684 `WETH9` \u4e92\u52d5\u3002\\n\\n1. \u5ef6\u7e8c\u524d\u6587\u7684\u64cd\u4f5c\u74b0\u5883\\n2. \u5728 `hardhat_fork` \u8cc7\u6599\u593e\u5e95\u4e0b\u5275\u7acb\u65b0\u8cc7\u6599\u593e `scripts`\\n3. \u524d\u5f80 Etherscan.io \u6216\u4efb\u4f55\u4f60\u4fe1\u4efb\u7684 Ethereum blockchain explorer \u5c0b\u627e WETH \u5408\u7d04\\n   - https://etherscan.io/address/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2#code\\n4. \u5c07\u5408\u7d04 ABI \u5132\u5b58\u6210 `contract-abi.json` \u6a94\u6848\uff0c\u4e26\u653e\u7f6e\u65bc `hardhat_fork/scripts` \u8cc7\u6599\u593e\u5e95\u4e0b\\n   - \u82e5\u662f\u4f7f\u7528 Etherscan\uff0c\u5247\u9700\u6efe\u52d5\u81f3\u7db2\u9801\u6700\u4e0b\u65b9\uff0c\u5982\u5716\u6240\u793a\\n\\n![weth9-contract-abi](./weth9-contract-abi.png)\\n\\n4. \u524d\u5f80\u9019\u500b Gist \u4e0b\u8f09 `interact.js` \u8173\u672c\uff0c\u4e26\u4e14\u628a\u5b83\u5132\u5b58\u5728 `hardhat_fork/scripts` \u8cc7\u6599\u593e\u5e95\u4e0b\\n   - https://gist.github.com/a2468834/6101244f5000e467ec8904ac5f0ec41d\\n   - \u6216\u53ef\u81f3 GitHub \u4e0a\u9762 LunDAO repo \u4e0b\u8f09\\n5. \u622a\u81f3\u76ee\u524d\u70ba\u6b62\uff0c`hardhat_fork` \u8cc7\u6599\u593e\u61c9\u8a72\u8981\u9577\u5f97\u50cf\u9019\u6a23\u5b50[^8]\\n```Shell\\n\ud83d\udcc2 hardhat_fork\\n \u2502\\n \u251c\u2500\u2500 \ud83d\udcc2 scripts\\n \u2502    \u2502\\n \u2502    \u251c\u2500\u2500 \ud83d\udcc4 contract-abi.json\\n \u2502    \u2502\\n \u2502    \u2514\u2500\u2500 \ud83d\udcc4 interact.js\\n \u2502\\n \u251c\u2500\u2500 \ud83d\udcc4 .env\\n \u2502\\n \u2514\u2500\u2500 \ud83d\udcc4 hardhat.config.js\\n```\\n6. \u57f7\u884c\u6307\u4ee4\\n```Shell\\n$ yarn hardhat --network \\"hardhat\\" run scripts/interact.js\\nyarn run v1.22.17\\n\\nCheck contract status\\n--------------------------------------------------------------------------------\\n        ETH-Balance                     WETH-Balance\\nWETH9   7160157.033871775794435313      7160157.033871775794435313\\n\\n[Step 0] Before we started\\n--------------------------------------------------------------------------------\\nAccount Address             ETH-Balance     WETH-Balance\\n#0      0xf39f......2266    10000.000       0.000\\n#1      0x2feb......a6f3    4.294           13813.827\\n\\n[Step 1] Account#1 deposits 3 ETH in contract\\n--------------------------------------------------------------------------------\\nAccount Address             ETH-Balance     WETH-Balance\\n#0      0xf39f......2266    10000.000       0.000\\n#1      0x2feb......a6f3    1.291           13816.827\\n\\n[Step 2] Account#1 sends 13 WETH to Account#0\\n--------------------------------------------------------------------------------\\nAccount Address             ETH-Balance     WETH-Balance\\n#0      0xf39f......2266    10000.000       13.000\\n#1      0x2feb......a6f3    1.286           13803.827\\n\\n[Step 3] Account#0 withdraws 13 WETH from contract\\n--------------------------------------------------------------------------------\\nAccount Address             ETH-Balance     WETH-Balance\\n#0      0xf39f......2266    10012.997       0.000\\n#1      0x2feb......a6f3    1.286           13803.827\\n\\n================================================================================\\n{\\n  hash: \'0x1dfa3eee62caaf1aa06d60b9fd57d67d17fe23c9f9452c1e3284056e6fad6e48\',\\n  type: 2,\\n  accessList: [],\\n  blockHash: \'0x3750ecaf4f7ccf733ceed460a0aeb54b3dd2373dc199ba5b420e062c5d39f165\',\\n  blockNumber: 14297760,\\n...\\n```\\n\\n\u4ee5\u4e0b\u7b46\u8005\u5c07\u5c0d `interact.js` \u7684\u7a0b\u5f0f\u78bc\u505a\u4e00\u4e9b\u91cd\u9ede\u89e3\u6790\\n\\n### Line 8-9\\n\u958b\u555f mainnet forking \u6a21\u5f0f\u8b93\u6211\u5011\u5f97\u4ee5\u76f4\u63a5\u8207\u771f\u5be6\u7684 `WETH9` \u5408\u7d04\u5730\u5740\u4e92\u52d5\uff0c\u4e0d\u9700\u8981\u984d\u5916\u90e8\u5c6c\u5176\u4ed6\u5408\u7d04\u3002\u53e6\u5916\uff0c`somebody` \u5730\u5740\u5247\u662f\u96a8\u6a5f\u6311\u9078\u7684\u4e00\u500b\u5730\u5740\uff0c\u6070\u5de7\u8a72\u5730\u5740\u540c\u6642\u64c1\u6709 eth \u548c weth\uff0c\u5728\u63a5\u4e0b\u4f86\u7684\u64cd\u4f5c\u7576\u4e2d\u53ef\u898b\u5947\u6548\u3002\\n```javascript\\nconst weth9_address = \\"0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2\\";\\nconst somebody      = \\"0x2feb1512183545f48f6b9c5b4ebfcaf49cfca6f3\\";\\n```\\n\\n\\n### Line 13-30\\n\u7528\u4f86\u8b93\u5370\u5728 terminal \u7684\u6587\u5b57\u770b\u8d77\u4f86\u6392\u7248\u7f8e\u7f8e\u7684\u51fd\u6578\u5011\uff0c\u4e26\u6c92\u6709\u7279\u5225\u4e4b\u8655\\n```javascript\\nfunction addressSlicing(address) {\\n    /* Skip */\\n}\\n\\nasync function printAccountAndBalance(provider, contract, account0, account1) {\\n    /* Skip */\\n}\\n```\\n\\n\\n### Line 34-35\\n`hre`\uff08Hardhat Runtime Environment, HRE\uff09\u662f\u4e00\u500b Hardhat Network \u555f\u52d5\u4e4b\u5f8c\uff0c\u5305\u542b\u6240\u6709 Hardhat \u5957\u4ef6\u529f\u80fd\u7684\u7269\u4ef6\uff0c\u8a73\u7d30\u5167\u5bb9\u8acb\u898b\u6587\u672b\u5ef6\u4f38\u95b1\u8b80\u3002\\n\\n`hre.ethers.getSigners()` \u56de\u50b3\u4e00\u500b\u9577\u5ea6\u70ba 20 \u7684 ethers.js Signer \u9663\u5217\uff0c\u5c31\u662f\u524d\u6587\u6240\u8ff0\u7684\u90a3\u4e8c\u5341\u500b\u5404\u6709 10000 ETH \u7684\u5e33\u865f\\n```javascript\\nconst HRE_EOAs = await hre.ethers.getSigners();\\nconst provider = await hre.ethers.provider;\\n```\\n\\n\\n### Line 40-43,47\\n\u5728 mainnet forking \u6a21\u5f0f\u4e4b\u4e0b\uff0cHardhat Network \u5141\u8a31\u958b\u767c\u8005\u767c\u9001 tx\uff0c**\u5373\u4fbf\u4f60\u6839\u672c\u672a\u6301\u6709\u8a72\u5730\u5740\u7684\u79c1\u9470**\u3002\u6709\u4e86\u9019\u500b\u529f\u80fd\uff0c\u6211\u5011\u53ef\u4ee5\u96a8\u610f\u5c0b\u627e\u4efb\u4f55\u5177\u5099\u6211\u5011\u6709\u8208\u8da3\u689d\u4ef6\u7684\u5730\u5740\uff08EOA \u6216 contract address \u5747\u53ef\uff09\uff0c\u7136\u5f8c\u4ee5\u5b83\u7684\u540d\u7fa9\u767c\u9001 tx \u4f86\u9032\u884c\u5404\u5f0f\u64cd\u4f5c\uff0c\u8b93 mainnet forking \u7684\u6e2c\u8a66\u74b0\u5883\u517c\u5177\u9ad8\u4eff\u771f\u5ea6\u8207\u9ad8\u4fbf\u5229\u6027\u3002\\n\\n\u9664\u4e86 `hardhat_impersonateAccount` \u529f\u80fd\u4e4b\u5916\uff0c\u9084\u6709\u5176\u4ed6\u4f8b\u5982\uff1a`hardhat_setNonce`\u3001`hardhat_setBalance`\u3001`hardhat_setCode`\u3001`hardhat_setStorageAt`\u7b49\u529f\u80fd\uff0c\u8a73\u7d30\u53ef\u898b[\u9019\u908a](https://hardhat.org/hardhat-network/guides/mainnet-forking.html#customizing-hardhat-network-s-behavior)\u7684\u8aaa\u660e\u3002\\n```javascript\\nawait hre.network.provider.request({\\n    method: \\"hardhat_impersonateAccount\\",\\n    params: [somebody]\\n});\\n```\\n\\n\\n### Line 50-56\\n\u6b64 JavaScript \u8173\u672c\u5370\u51fa `WETH9` \u7684 token \u7e3d\u767c\u884c\u91cf\u8207\u6b64\u5730\u5740\u7684 balance\uff0c\u6211\u5011\u53ef\u898b\u5169\u500b\u6578\u503c\u76f8\u7b49\u4e14\u8207 Etherscan \u4e0a\u7684\u9918\u984d\u543b\u5408\u3002\u7531\u65bc Etherscan Analytics \u5206\u9801\u8b39\u986f\u793a\u7576\u65e5\u65e5\u672b\u9918\u984d\uff0c\u56e0\u6b64\u9700\u67e5\u8a62\u524d\u4e00\u65e5\u9918\u984d\u70ba\u6e96\u3002\\n\\n![Etherscan-Analytics](./etherscan-analytics.png)\\n\\n\\n### Line 64-68\\n\u6211\u5011\u4ee5 `somebody` \u5730\u5740\u7684\u540d\u7fa9\uff08i.e., \u4f7f\u7528 `signer_1` \u767c\u51fa txn\uff09\uff0c\u5411 `WETH9` \u5408\u7d04\u5b58\u6b3e 3 eth\uff1b\u4e4b\u6240\u4ee5\u6b64\u884c\u70ba\u4e0d\u662f invalid tx\uff0c\u6b78\u529f\u65bc\u524d\u8ff0\u7684 `hardhat_impersonateAccount` \u529f\u80fd[^9]\uff0c\u5b83\u8b93\u6211\u5011\u80fd\u5920\u5728 Hardhat Network \u5167\u4ee5\u672a\u77e5\u5bc6\u9470\u5730\u5740\u7684\u540d\u7fa9\u767c\u9001 tx\u3002\\n```javascript\\nvar overrides = {value : hre.ethers.utils.parseEther(\\"3.0\\")};\\nWETH9         = WETH9.connect(signer_1);\\ntxn_array.push(await WETH9.deposit(overrides));\\nawait printAccountAndBalance(provider, WETH9, signer_0, signer_1);\\n```\\n\\n\\n### Line 72-80\\n\u9019\u500b\u6bb5\u843d\u628a `Account#1`\uff08\u5373 `somebody` \u5730\u5740\uff09\u7684 13 \u500b weth \u8f49\u7d66 `Account#0`\uff08\u5373 HRE \u9810\u8a2d\u5730\u5740 No.0\uff09\u3002\\n```javascript\\nWETH9 = WETH9.connect(signer_1);\\ntxn_array.push(\\n    await WETH9.transferFrom(\\n        signer_1.address, \\n        signer_0.address, \\n        hre.ethers.utils.parseEther(\\"13.0\\")\\n));\\nawait printAccountAndBalance(provider, WETH9, signer_0, signer_1);\\n```\\n\\n\\n### Line 84-89\\n\u7531\u65bc\u50b3\u9001 tx \u9700\u8981\u8017\u8cbb tx fee\uff0c\u6240\u4ee5\u6211\u5011\u53ef\u4ee5\u767c\u73fe\u6700\u7d42\u5370\u51fa\u7684\u7d50\u679c\u986f\u793a\uff1a`Account #0` \u548c `Account #1` \u7684 eth \u9918\u984d\u7e3d\u548c\u6bd4\u6700\u521d\u7684\u6642\u5019\u5c11\u4e00\u4e9b\u3002\\n\\n\\n### Line 93-97\\n\u6700\u5f8c\u6703\u5370\u51fa\u7a0d\u65e9\u767c\u9001\u7684\u6240\u6709 tx \u7684\u7d30\u7bc0\uff1b\u8b80\u8005\u53ef\u4ee5\u900f\u904e `blockNumber` \u67e5\u89ba\u9019\u4e9b tx \u8207\u7576\u521d\u6307\u5b9a mainnet forking \u5340\u584a\u9ad8\u5ea6\u4e4b\u9593\u7684\u95dc\u806f\u6027\uff0c\u53ef\u898b Hardhat Network \u662f\u6709\u5728\u9010\u6b65\u9577\u9ad8\u3002\\n\\n\\n[^8]: \u6709\u7701\u7565\u4e00\u4e9b\u8207\u672c\u6587\u7121\u95dc\u7684\u6a94\u6848\u8207\u8cc7\u6599\u593e\\n[^9]: https://hardhat.org/hardhat-network/reference/#hardhat-impersonateaccount\\n\\n\\n\\n\u7bc4\u4f8b\u4e8c\uff1a\u6293\u53d6 `public` \u8b8a\u6578\u7684\u6b77\u53f2\u6578\u64da\\n---\\n\u9019\u500b\u7bc4\u4f8b\u8981\u89e3\u6c7a\u7684\u662f\u53e6\u4e00\u500b\u4e8b\u60c5\uff1a\u8981\u600e\u9ebc\u6293\u53d6 Ethereum \u4e0a\u9762\u67d0\u500b\u6578\u64da\u7684\u6b77\u53f2\u8cc7\u6599\u5462\uff1f\\n\\nEtherscan \u63d0\u4f9b\u5716\u5f62\u5316\u4ecb\u9762\u8b93\u958b\u767c\u8005\u53ef\u4ee5\u5feb\u901f\u67e5\u8a62\u5408\u7d04\u5167 `public` `view`/`pure` function \u7684\u56de\u50b3\u503c\uff0c\u4f46\u662f\u5982\u679c\u6211\u5011\u6709\u8208\u8da3\u7684\u56de\u50b3\u503c\u53ea\u6703\u51fa\u73fe\u5728\u7279\u5b9a block number \u5462\uff1f\u9019\u6642\u5019\u9664\u4e86\u4f7f\u7528 Dune Analytics \u7b49\u7db2\u7ad9\u63d0\u4f9b\u7684\u670d\u52d9\uff0c\u6211\u5011\u5176\u5be6\u53ef\u4ee5\u900f\u904e mainnet forking \u7684\u529f\u80fd\u4f86\u81ea\u5df1\u5be6\u4f5c\u3002\\n\\n\u4ee5\u4e0b\u5c07\u4f7f\u7528\u53e6\u4e00\u4efd JavaScript \u8173\u672c\uff0c\u53ea\u9700\u5c07\u524d\u4e00\u500b\u7bc4\u4f8b\u7684\u7b2c\u56db\u6b65\u9a5f\u6539\u70ba\u4e0b\u8f09\u6b64\u8173\u672c\uff0c\u5373\u53ef\u6210\u529f\u57f7\u884c\u3002\\n- https://gist.github.com/a2468834/71c59d580c1da21337350cdfc47e515b\\n- \u6216\u53ef\u81f3 GitHub \u4e0a\u9762 LunDAO repo \u4e0b\u8f09\\n- \u622a\u81f3\u76ee\u524d\u70ba\u6b62\uff0c`hardhat_fork` \u8cc7\u6599\u593e\u61c9\u8a72\u8981\u9577\u5f97\u50cf\u9019\u6a23\u5b50[^4]\\n```Shell\\n\ud83d\udcc2 hardhat_fork\\n \u2502\\n \u251c\u2500\u2500 \ud83d\udcc2 scripts\\n \u2502    \u2502\\n \u2502    \u251c\u2500\u2500 \ud83d\udcc4 contract-abi.json\\n \u2502    \u2502\\n \u2502    \u251c\u2500\u2500 \ud83d\udcc4 interact.js\\n \u2502    \u2502\\n \u2502    \u2514\u2500\u2500 \ud83d\udcc4 query.js\\n \u2502\\n \u251c\u2500\u2500 \ud83d\udcc4 .env\\n \u2502\\n \u2514\u2500\u2500 \ud83d\udcc4 hardhat.config.js\\n```\\n\\n\u57f7\u884c\u6307\u4ee4\u4e4b\u5f8c\uff0c\u53ef\u898b terminal \u5370\u51fa\u985e\u4f3c\u9019\u6a23\u5b50\u7684\u6587\u5b57\\n```Shell\\n$ yarn hardhat --network \\"hardhat\\" run scripts/query.js\\nyarn run v1.22.17\\n\\nMethod 1\\n----------------------------------------\\nBlock number: 14379900\\nTotalSupply:  7080076.411770262795354559\\n----------------------------------------\\nBlock number: 14379901\\nTotalSupply:  7080077.697963348707441243\\n----------------------------------------\\nBlock number: 14379902\\nTotalSupply:  7080074.493707533508180991\\n...\\n```\\n\\n\u4ee5\u4e0b\u7b46\u8005\u5c07\u5c0d `query.js` \u7684\u7a0b\u5f0f\u78bc\u505a\u4e00\u4e9b\u91cd\u9ede\u89e3\u6790\\n\\n### Line 14-19,28-29\\n\u6b64\u8173\u672c\u900f\u904e\u5faa\u5e8f\u8b8a\u63db mainnet forking \u7684\u5206\u53c9\u9ad8\u5ea6\uff0c\u9054\u6210\u300c\u67e5\u8a62\u67d0\u500b\u5340\u9593\u5167\uff0c`WETH9` \u5408\u7d04\u7684 `totalSupply()` \u6578\u503c\u8b8a\u5316\u300d\\n```javascript\\nvar config = {  method: \\"hardhat_reset\\",\\n                params: [{\\n                    forking: {\\n                        jsonRpcUrl: process.env.Mainnet,\\n                        blockNumber: 0}}]\\n};\\nconfig.params[0].forking.blockNumber = block_i;\\nawait hre.network.provider.request(config);\\n```\\n\\n\\n### Line 38-51\\n\u4e8b\u5be6\u4e0a\uff0c\u67e5\u8a62 `public` `view`/`pure` function \u7684\u6b77\u53f2\u6578\u64da\uff0c\u4e0d\u9700\u8981\u7528\u5230 mainnet forking \u6a21\u5f0f\u3002\u53ef\u4ee5\u55ae\u7d14\u900f\u904e\u547c\u53eb\u5408\u7d04\u51fd\u6578\uff0c\u984d\u5916\u9644\u52a0 `blockTag` \u5373\u53ef[^5]\u3002`method1()` \u70ba\u4f7f\u7528 mainnet forking \u7684\u65b9\u6cd5\uff0c`method2()` \u5247\u662f\u4e0d\u9700\u4f7f\u7528 mainnet forking \u7684\u65b9\u6cd5\u3002\\n```javascript\\nasync function method2() {\\n    /* Skip */\\n}\\n```\\n\\n\\n### Line 55-56\\n\u57f7\u884c\u7684\u6642\u5019\u8a18\u5f97\u628a\u5176\u4e2d\u4e00\u884c\u7684\u8a3b\u89e3\u62ff\u6389\uff1b\u53e6\u5916\uff0cmainnet forking \u7684\u5206\u53c9\u9ad8\u5ea6\u4e0d\u80fd\u5c0f\u65bc\u60f3\u8981\u67e5\u8a62`public` `view`/`pure` function \u7684\u6b77\u53f2\u6578\u64da\u7684\u5340\u584a\u9ad8\u5ea6\u3002\\n```javascript\\nasync function main() {\\n    // Delete one of the following comments\\n    //await method1();\\n    //await method2();\\n}\\n```\\n\\n\\n[^4]: \u6709\u7701\u7565\u4e00\u4e9b\u8207\u672c\u6587\u7121\u95dc\u7684\u6a94\u6848\u8207\u8cc7\u6599\u593e\\n[^5]: `blockTag` \u662f ethers.js \u7684\u8a9e\u6cd5\uff0cweb3.js \u7684 API \u4f7f\u7528\u65b9\u6cd5\u53ef\u80fd\u6709\u6240\u4e0d\u540c\\n\\n\\n\\nRelated resources\\n---\\n- Yarn\\n  - https://classic.yarnpkg.com/en/\\n- Hardhat\\n  - GitHub\uff1ahttps://github.com/NomicFoundation/hardhat\\n  - Mainnet forking\uff1ahttps://hardhat.org/hardhat-network/guides/mainnet-forking.html\\n  - Configuration\uff1ahttps://hardhat.org/config/\\n  - Hardhat Network Reference\uff1ahttps://hardhat.org/hardhat-network/reference/\\n  - Creating a task\uff1ahttps://hardhat.org/guides/create-task.html\\n  - Hardhat Runtime Environment (HRE)\uff1ahttps://hardhat.org/advanced/hardhat-runtime-environment.html\\n- Alchemy\\n  - https://www.alchemy.com/\\n- Ethereum on ARM\\n  - https://ethereum-on-arm-documentation.readthedocs.io/en/latest/quick-guide/about-quick-start.html\\n- Wrapped Ether\\n  - https://weth.io/index.html\\n\\nFurther reading\\n---\\n- Infura\\n  - https://infura.io/\\n- QuickNode\\n  - https://www.quicknode.com/\\n- Truffle\\n  - Simulate Live Networks with Forked Sandboxes\uff1ahttps://trufflesuite.com/blog/sandbox-forking-with-truffle-teams/index.html"},{"id":"total-tokens-looksrare","metadata":{"permalink":"/blog/total-tokens-looksrare","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-03-13-total-tokens-looksrare/index.md","source":"@site/blog/2022-03-13-total-tokens-looksrare/index.md","title":"\u57fa\u672c\u529f\uff1a\u4ece\u5408\u7ea6\u770b token \u6570\u91cf","description":"\u4e0d\u77e5\u9053\u4f60\u662f\u5426\u548c\u6211\u4e00\u6837\uff0c\u603b\u662f\u62c5\u5fc3\u5173\u6ce8\u7684 token \u589e\u53d1\uff0c\u4f46\u53c8\u5bf9 CoinGecko \u6216\u8005 Etherscan \u4e0a\u7684\u6570\u5b57\u5fc3\u6000\u7591\u8651\u3002\u4ee5\u592a\u574a\u4e0a\u6bcf\u4e2a token \u90fd\u662f\u72ec\u7acb\u7684\u5408\u7ea6\uff0c\u90a3\u5c31\u6df1\u5165\u5408\u7ea6\u6765\u63a2\u4e2a\u7a76\u7adf\u5427\u3002Code is Law\uff01","date":"2022-03-13T00:00:00.000Z","formattedDate":"March 13, 2022","tags":[{"label":"ERC20","permalink":"/blog/tags/erc-20"},{"label":"LooksRare","permalink":"/blog/tags/looks-rare"}],"readingTime":3.45,"truncated":true,"authors":[{"name":"zjiekai","url":"https://github.com/zjiekai/","imageURL":"https://github.com/zjiekai.png","key":"zjiekai"}],"prevItem":{"title":"Hardhat mainnet forking\uff1a\u4e3b\u7db2\u5206\u53c9 (2)","permalink":"/blog/hardhat-forking-2"},"nextItem":{"title":"MEV - \u6700\u5927\u53ef\u63d0\u53d6\u50f9\u503c","permalink":"/blog/mev"}},"content":"\u4e0d\u77e5\u9053\u4f60\u662f\u5426\u548c\u6211\u4e00\u6837\uff0c\u603b\u662f\u62c5\u5fc3\u5173\u6ce8\u7684 token \u589e\u53d1\uff0c\u4f46\u53c8\u5bf9 CoinGecko \u6216\u8005 Etherscan \u4e0a\u7684\u6570\u5b57\u5fc3\u6000\u7591\u8651\u3002\u4ee5\u592a\u574a\u4e0a\u6bcf\u4e2a token \u90fd\u662f\u72ec\u7acb\u7684\u5408\u7ea6\uff0c\u90a3\u5c31\u6df1\u5165\u5408\u7ea6\u6765\u63a2\u4e2a\u7a76\u7adf\u5427\u3002Code is Law\uff01 \\n\\n\x3c!--truncate--\x3e\\n\\n\u8ba9\u6211\u4eec\u4ee5\u6700\u8fd1\u53d1\u884c\u7684 LooksRare \u9879\u76ee\u4e3a\u4f8b\u3002\\n\\n| ![coingecko](./coingecko.png) |\\n|:--:|\\n| 2022-01-16 CoinGecko \u622a\u56fe |\\n| ![etherscan](./etherscan-looks.png) |\\n| 2022-01-16 Etherscan \u622a\u56fe |\\n\\n\u53ef\u4ee5\u4ece CoinGecko \u770b\u5230\u6709 `Total Supply` \u548c `Max Supply` \u4e24\u4e2a\u6982\u5ff5\u3002\u4ece Etherscan \u7684 token \u9875\u9762\u53c8\u4f1a\u770b\u5230 `Max Total Supply`\u3002 \u8fd9\u4e09\u4e2a\u6570\u5b57\u5e76\u4e0d\u4e00\u81f4\u3002\u6211\u5e76\u4e0d\u6e05\u695a CoinGecko \u548c Etherscan \u7684\u5177\u4f53\u673a\u5236\uff0c\u6240\u4ee5\u76f4\u63a5\u770b\u770b\u8fd9\u4e2a token \u7684\u5408\u7ea6\u5427\u3002 \\n\\n```js\\n    // File 1 of 7 : LooksRareToken.sol\\n    constructor(\\n        address _premintReceiver,\\n        uint256 _premintAmount,\\n        uint256 _cap\\n    ) ERC20(\\"LooksRare Token\\", \\"LOOKS\\") {\\n        require(_cap > _premintAmount, \\"LOOKS: Premint amount is greater than cap\\");\\n        // Transfer the sum of the premint to address\\n        _mint(_premintReceiver, _premintAmount);\\n        _SUPPLY_CAP = _cap;\\n    }\\n```\\n\\n\u4ee5\u592a\u574a\u667a\u80fd\u5408\u7ea6\u90e8\u7f72\u540e\uff0c\u9996\u5148\u8fd0\u884c\u7684\u5c31\u662f `constructor` \u51fd\u6570\u3002\u53ef\u4ee5\u770b\u51fa LOOKS \u7684 `constructor` \u6709\u4e09\u4e2a\u53c2\u6570\u3002 \\n\\n| ![constructor](./constructor.png) |\\n|:--:|\\n| [\u5408\u7ea6\u5730\u5740\u9875\u9762\u4e2d Contract Tab \u6700\u4e0b\u9762\u7684\u90e8\u5206](https://etherscan.io/address/0xf4d2888d29d722226fafa5d9b24f9164c092421e#code) |\\n\\n\u5728 Etherscan \u4e0a\u627e\u51fa[\u8be5\u5408\u7ea6\u7684\u4fe1\u606f](https://etherscan.io/address/0xf4d2888d29d722226fafa5d9b24f9164c092421e)\uff0c\u627e\u51fa `Constructor Arguments`\u3002 \u770b\u5230 `_cap` \u4f20\u5165\u7684\u503c\u4e3a `1000000000000000000000000000`\uff0c\u8fd9\u4e2a\u503c\u9664 10^18 \u5c31\u662f 1000 mil\uff0c\u5c31\u80fd\u548c CoinGecko \u4e2d\u7684`Max Supply`\u5bf9\u5e94\u4e0a\u4e86\u3002\\n\\n```js\\n    // File 3 of 7 : ERC20.sol\\n    function decimals() public view virtual override returns (uint8) {\\n        return 18;\\n    }\\n```\\n\\n\u4e3a\u4ec0\u4e48\u8981\u9664\u4ee5 10^18 \u5462\uff1f \u8fd9\u662f\u56e0\u4e3a\u666e\u901a\u7528\u6237\u770b\u5230\u7684 1 \u4e2a token\uff0c\u5176\u5b9e\u662f `10^decimals` \u4e2a\u6700\u5c0f\u5355\u4f4d\u3002\u8fd9\u6837\uff0c\u5408\u7ea6\u7a0b\u5e8f\u53ea\u5904\u7406\u6574\u6570\uff0c\u800c\u5728\u754c\u9762\u4e0a\u53ef\u4ee5\u663e\u793a\u5c0f\u6570\uff08\u4f8b\u5982 0.1 \u6216 0.01\uff09\u4e2a\u7684 token\u3002\\n\\n\u90a3\u4e48 CoinGecko \u7684 `Total Supply` \u53c8\u662f\u4ec0\u4e48\u5462\uff1f \u8fd9\u4e2a\u6570\u5b57\u548c Etherscan \u7684 `Max Total Supply` \u662f\u63a5\u8fd1\u7684\uff0c\u90fd\u662f 231.xxx mil\u3002\u6709\u7406\u7531\u731c\u6d4b\u8fd9\u662f\u4e00\u4e2a\u52a8\u6001\u7684\u6570\u5b57\uff0c\u4e24\u4e2a\u7f51\u7ad9\u90fd\u60f3\u76d1\u6d4b\u8fd9\u4e2a\u52a8\u6001\u6570\u5b57\uff0c\u4f46\u4e0d\u592a\u540c\u6b65\u3002\u6709\u4e86\u8fd9\u4e2a\u731c\u60f3\u540e\uff0c\u518d\u56de\u5934\u770b\u770b LOOKS \u7684\u5408\u7ea6\u3002\\n\\n```js\\n    // File 3 of 7 : ERC20.sol\\n    function totalSupply() public view virtual override returns (uint256) {\\n        return _totalSupply;\\n    }\\n```\\n\\n\u7b26\u5408 `ERC20` \u6807\u51c6\u7684 token \u90fd\u6709\u53ea\u8bfb\u51fd\u6570 `totalSupply()`\u3002\u8fd9\u662f\u4e00\u4e2a `view` \u51fd\u6570\uff0c\u53ef\u4ee5\u8bfb\u53d6\u94fe\u4e0a state\uff0c\u4f46\u4e0d\u4f1a\u5199\u5165\u3002\u968f\u7740\u94fe\u4e0a\u4e0d\u65ad\u51fa\u73b0\u65b0 block\uff0c`view` \u51fd\u6570\u7684\u8fd4\u56de\u503c\u4e5f\u53ef\u80fd\u53d8\u5316\u3002\u5728 Etherscan \u4e0a\u53ef\u4ee5\u76f4\u63a5\u8bfb\u53d6\uff0c\u53ef\u4ee5\u53d1\u73b0\u786e\u5b9e\u662f 231.xxx mil\u3002\\n\\n\u4e4b\u524d\u6ce8\u610f\u5230\u7684 `_cap` \u53ea\u662f\u521d\u59cb\u5316 `_SUPPLY_CAP` \u53d8\u91cf\uff0c\u5e76\u6ca1\u6709\u6539\u53d8 `_totalSupply`\u3002\u4e00\u4e2a\u503c\u5f97\u601d\u8003\u7684\u5c0f\u95ee\u9898\u662f\uff1a\u5f53\u5408\u7ea6\u521a\u90e8\u7f72\u7684\u65f6\u5019\uff0ctotalSupply \u4f1a\u662f\u591a\u5c11\u5462\uff1f Etherscan \u4e0a\u8c03\u7528 `view` \u51fd\u6570\uff0c\u5e94\u8be5\u8fd8\u4e0d\u80fd\u6307\u5b9a block number\uff08\u53ef\u4ee5\u901a\u8fc7\u652f\u6301\u5386\u53f2\u4fe1\u606f\u7684 json rpc \u67e5\u8be2\uff0c\u5982 alchemyapi\uff09\u3002\\n\\n\u4e00\u70b9\u9898\u5916\u8bdd\uff1atoken \u7684\u53d1\u884c\u91cf\u4fe1\u606f\u662f\u5982\u6b64\u91cd\u8981\uff0c\u4efb\u4f55 ERC20 token \u90fd\u9700\u8981\u63d0\u4f9b `totalSupply()` \u63a5\u53e3\u3002\u5373\u4f7f\u662f\u975e ERC20 token\uff0c\u5982 2018 \u5e74\u7684 [PowH3D (P3D)](https://etherscan.io/address/0xb3775fb83f7d12a36e0475abdd1fca35c091efbe)\uff0c\u4e5f\u63d0\u4f9b\u4e86 `totalSupply()` \u54e6\u3002\\n\\n\\nERC20\uff1a https://eips.ethereum.org/EIPS/eip-20\\n\\n`view`\u51fd\u6570\uff1a https://medium.com/taipei-ethereum-meetup/solidity-weekly-11-70c5208a3bf1"},{"id":"mev","metadata":{"permalink":"/blog/mev","editUrl":"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-02-13-mev/index.md","source":"@site/blog/2022-02-13-mev/index.md","title":"MEV - \u6700\u5927\u53ef\u63d0\u53d6\u50f9\u503c","description":"\u89e3\u91cb MEV (\u6700\u5927\u53ef\u63d0\u53d6\u50f9\u503c) \u7684\u6210\u56e0\u4ee5\u53ca\u539f\u7406\uff0c\u4e26\u4e14\u7c21\u8ff0\u76ee\u524d\u7684\u89e3\u6c7a\u65b9\u6848\u3002","date":"2022-02-13T00:00:00.000Z","formattedDate":"February 13, 2022","tags":[{"label":"MEV","permalink":"/blog/tags/mev"},{"label":"Miner Extractable Value","permalink":"/blog/tags/miner-extractable-value"},{"label":"Maximal Extractable Value","permalink":"/blog/tags/maximal-extractable-value"}],"readingTime":13.975,"truncated":true,"authors":[{"name":"Yuren Ju","title":"Individual Researcher","url":"https://yurenju.medium.com/","imageURL":"https://github.com/yurenju.png","key":"yurenju"}],"prevItem":{"title":"\u57fa\u672c\u529f\uff1a\u4ece\u5408\u7ea6\u770b token \u6570\u91cf","permalink":"/blog/total-tokens-looksrare"}},"content":"\u6700\u5927\u53ef\u63d0\u53d6\u50f9\u503c (Maximal Extractable Value, MEV) \u662f\u4e00\u7a2e\u900f\u904e\u6539\u8b8a\u4ea4\u6613\u9806\u5e8f\u4f86\u7372\u5f97\u5229\u76ca\u7684\u65b9\u6cd5\u3002\u6bd4\u5982\u8aaa\u7926\u5de5\u53ef\u4ee5\u5728 Uniswap \u4ea4\u6613\u4e2d\u767c\u73fe\u53ef\u4ee5\u71df\u5229\u7684\u6a5f\u6703\u4e26\u4e14\u81ea\u52d5\u5316\u7684\u57f7\u884c\u7279\u5b9a\u7684\u7b56\u7565\u4f86\u71df\u5229\uff0c\u800c\u9019\u6a23\u7684\u884c\u70ba\u6709\u53ef\u80fd\u6703\u8b93\u539f\u672c\u7684\u4ea4\u6613\u8005\u8667\u640d\uff0c\u4f46\u6709\u8da3\u7684\u662f\u9019\u4e5f\u6c92\u6709\u9055\u53cd\u5340\u584a\u93c8\u7684\u898f\u5247\uff0c\u53ea\u662f\u5229\u7528\u5340\u584a\u93c8\u4f86\u5b8c\u6210\u7684\u4e00\u7a2e\u884c\u70ba\uff0c\u7576\u7136\u9019\u6a23\u7684\u884c\u70ba\u6709\u53ef\u80fd\u50b7\u5bb3\u5340\u584a\u93c8\u7684\u751f\u614b\u7cfb\u3002\u672c\u6587\u5c07\u6703\u4ee5 Ethereum \u4f5c\u70ba\u7bc4\u4f8b\u4f86\u8b1b\u89e3\u9019\u6a23\u884c\u70ba\u7684\u904b\u4f5c\u539f\u7406\u3002\\n\\n\x3c!--truncate--\x3e\\n\\n\u9996\u5148\u6211\u5011\u9700\u8981\u4e86\u89e3\u5728 Ethereum \u4ea4\u6613\u662f\u600e\u9ebc\u88ab\u57f7\u884c\u7684\u3002\\n\\n## \u767c\u751f\u4ea4\u6613\u524d\uff0c\u4f60\u7684 tx \u5728\u54ea\u88e1\uff1f\\nAlice \u60f3\u8981\u9001\u51fa\u4e00\u500b\u4ea4\u6613\u5728 Uniswap \u4e0a\u9762\u5c07 3000 USDC \u63db\u6210 1 ETH\uff0c\u7576\u6309\u4e0b MetaMask \u4e0a\u9762\u7684\u9001\u51fa\u4e4b\u5f8c\uff0c\u5be6\u969b\u4e0a\u4ed6\u7684\u4ea4\u6613\u662f\u600e\u9ebc\u6a23\u88ab\u8655\u7406\u7684\u5462\uff1f\\n\\n\u300c\u5728 Uniswap \u4e0a\u7528 3000 USDC \u4ea4\u63db 1 ETH\u300d\u9019\u4ef6\u4e8b\u60c5\u6211\u5011\u53ef\u4ee5\u770b\u6210\u662f Alice \u7684\u610f\u5716\uff0c\u4e00\u4ef6\u4ed6\u60f3\u8981\u57f7\u884c\u7684\u4e8b\u60c5\uff0c\u7a31\u70ba pending transaction\u3002\u9019\u500b pending tx \u6703\u88ab\u50b3\u9001\u5230 Ethereum \u4e0a\u9762\u7684\u7bc0\u9ede\uff0c\u800c\u7bc0\u9ede\u4e4b\u9593\u6703\u4e92\u76f8\u4ea4\u63db pending tx\uff0c\u76e1\u53ef\u80fd\u7684\u8b93\u66f4\u591a\u7bc0\u9ede\u77e5\u9053\u4f7f\u7528\u8005\u6709\u9019\u500b\u9700\u6c42\uff0c\u9019\u4e9b\u9084\u6c92\u88ab\u6253\u5305\u5230\u5340\u584a\u88e1\u9762\u7684 pending tx \u5c31\u6703\u88ab\u653e\u5230\u7bc0\u9ede\u7279\u5b9a\u5340\u57df\u5148\u5132\u85cf\u8d77\u4f86\uff0c\u9019\u500b\u5340\u57df\u53eb\u505a mempool\u3002\u800c\u6bcf\u500b\u7bc0\u9ede\u56e0\u70ba\u6703\u6536\u53d6\u4f86\u81ea\u4e0d\u540c\u5730\u65b9\u7684 pending tx\uff0c\u6240\u4ee5\u6bcf\u500b\u7bc0\u9ede\u7684 mempool \u5167\u5bb9\u53ef\u80fd\u90fd\u4e0d\u4e00\u6a23\uff0c\u6392\u5e8f\u4e5f\u6703\u4e0d\u4e00\u6a23\u3002\\n\\n![pending tx](pending-tx.png)\\n\\n\u7bc0\u9ede\u6709\u5e7e\u7a2e\u4e0d\u540c\u7684\u578b\u614b\uff0c\u800c\u7926\u5de5\u4e5f\u662f\u7bc0\u9ede\u7684\u4e00\u7a2e\u578b\u614b\uff0c\u4ed6\u7684\u5de5\u4f5c\u662f\u8ca0\u8cac\u628a mempool \u88e1\u9762\u7684 pending tx \u6253\u5305\u8d77\u4f86\u8b8a\u6210\u4e00\u500b\u5340\u584a\uff0c\u7136\u5f8c\u8ddf\u5176\u4ed6\u7926\u5de5\u4e00\u8d77\u7af6\u722d\u8a18\u5e33\u6b0a\uff0c\u7576\u5176\u4e2d\u4e00\u500b\u7926\u5de5\u722d\u53d6\u5230\u4e86\u8a18\u5e33\u6b0a\u5f8c\uff0c\u9019\u500b\u5340\u584a\u5c31\u6703\u88ab\u767c\u4f48\u51fa\u53bb\uff0c\u6b64\u6642 Alice \u7684 pending tx \u624d\u8b8a\u6210\u4e00\u500b\u5df2\u7d93\u4e0a\u93c8\u7684\u4ea4\u6613 (transaction)\u3002\\n\\n## \u7926\u5de5\u600e\u9ebc\u6311\u9078 pending tx\\n\u56e0\u70ba\u5305\u88dd\u3001\u767c\u5e03\u5340\u584a\u662f\u4e00\u4ef6\u5229\u76ca\u5c0e\u5411\u7684\u4e8b\u60c5\uff0c\u6bcf\u767c\u5e03\u4e00\u500b\u5340\u584a\u7926\u5de5\u53ef\u4ee5\u5f97\u5230\u56fa\u5b9a\u7684\u5340\u584a\u734e\u52f5\uff0c\u9084\u6709\u5728\u9019\u500b\u5340\u584a\u88e1\u9762\u7684\u4ea4\u6613\u6240\u63d0\u4f9b\u7684\u4ea4\u6613\u8cbb\u3002\u6bd4\u5982\u8aaa 14143088 \u9019\u500b\u5340\u584a\u7e3d\u5171\u6709 360 \u500b\u88ab\u6253\u5305\u9032\u53bb\u7684\u4ea4\u6613\uff0c\u800c\u767c\u5e03\u9019\u500b\u5340\u584a\u53ef\u4ee5\u5f97\u5230\u7684\u56fa\u5b9a\u734e\u52f5\u662f 2 ETH (\u4f9d\u7167\u4eca\u5929\u7684\u532f\u7387\u662f 16 \u842c\u53f0\u5e63)\uff0c\u800c\u5f8c\u9762\u5169\u500b\u6578\u5b57 `2.410435284410848966 - 2.13247814979521476 ~= 0.2 ETH` \u5247\u662f\u6240\u6709\u4ea4\u6613\u63d0\u4f9b\u7684\u4ea4\u6613\u8cbb\u52a0\u7e3d\u3002\u70ba\u4ec0\u9ebc\u6709\u5169\u500b\u6578\u5b57\u6d89\u53ca\u5230 EIP-1559 \u9019\u908a\u5c31\u4e0d\u5148\u6df1\u5165\u8a0e\u8ad6\u3002\\n\\n![block 14143088](./block-14143088.png)\\n\\n\u81f3\u65bc\u7926\u5de5\u662f\u600e\u9ebc\u6311\u9078\u54ea\u4e9b\u4ea4\u6613\u8981\u88ab\u653e\u5230\u9019\u500b\u5340\u584a\u88e1\u9762\uff0c\u57fa\u672c\u4e0a\u5c31\u662f\u524d\u9762\u8b1b\u7684\u5229\u76ca\u5c0e\u5411\u3002\u4e00\u822c\u7684\u60c5\u6cc1\uff0c\u7926\u5de5\u6703\u6392\u5e8f\u6240\u6709\u4ea4\u6613\u88e1\u9762\u63d0\u4f9b\u7684\u4ea4\u6613\u8cbb\uff0c\u4e26\u4e14\u512a\u5148\u6253\u5305\u63d0\u4f9b\u6bd4\u8f03\u591a\u4ea4\u6613\u8cbb\u7684\u4ea4\u6613\u3002\u6240\u4ee5\u4ea4\u6613\u8cbb\u63d0\u4f9b\u8f03\u591a\u7684\u4ea4\u6613\u6703\u6392\u5e8f\u5728\u524d\u9762\u88ab\u6253\u5305\u9032\u53bb\u5340\u584a\u88e1\u9762\uff0c\u5982\u679c\u4f60\u4ea4\u6613\u8cbb\u63d0\u4f9b\u7684\u5c11\uff0c\u5c31\u6703\u904e\u4e86\u5f88\u4e45\u7b49\u5230\u6240\u6709\u4ea4\u6613\u90fd\u6d88\u5316\u7684\u5dee\u4e0d\u591a\u624d\u6703\u8f2a\u5230\u4f60\u3002\\n\\n\u4f46\u9019\u908a\u662f\u6307\u4e00\u822c\u7684\u60c5\u6cc1\uff0c\u5be6\u969b\u4e0a\u8981\u628a\u4ec0\u9ebc\u4ea4\u6613\u6253\u5305\u9032\u53bb\u5340\u584a\u4e26\u6c92\u6709\u9650\u5236\uff0c\u7926\u5de5\u53ef\u4ee5\u7528\u5404\u7a2e\u65b9\u5f0f\u6c7a\u5b9a\u54ea\u4e9b\u5340\u584a\u8981\u6253\u5305\u3002\\n\\n## \u4e09\u660e\u6cbb\u653b\u64ca (Sandwich Attack)\\n\u7531\u65bc\u7926\u5de5\u53ef\u4ee5\u81ea\u884c\u6c7a\u5b9a\u54ea\u4e9b\u4ea4\u6613\u8981\u88ab\u6253\u5305\u9032\u53bb\u5340\u584a\u88e1\u9762\uff0c\u800c\u9019\u4e9b pending tx \u5728 mempool \u88e1\u9762\u662f\u4e00\u500b\u516c\u958b\u7684\u8cc7\u8a0a\uff0c\u4e00\u822c\u7bc0\u9ede\u6703\u63d0\u4f9b\u516c\u958b\u7684\u65b9\u6cd5\u8b93\u4efb\u4f55\u4eba\u53ef\u4ee5\u67e5\u8a62\u76ee\u524d mempool \u88e1\u9762\u6709\u54ea\u4e9b\u4ea4\u6613\u6b63\u5728\u7b49\u5f85\u88ab\u6253\u5305\u3002\\n\\n\u9019\u908a\u5c31\u51fa\u73fe\u4e86\u4e00\u4e9b\u53ef\u4ee5\u64cd\u4f5c\u7684\u7a7a\u9593\u3002\\n\\n\u524d\u9762\u8209\u4f8b\u7684 Alice \u6253\u7b97\u7528 3,000 USDC \u4ea4\u63db 1 ETH\uff0c\u800c\u6bcf\u6b21\u7684\u4ea4\u6613\u90fd\u6703\u5f71\u97ff\u4e0b\u4e00\u6b21\u4ea4\u6613\u7684\u50f9\u683c\u3002\\n\\n\u9019\u6a23\u7684\u4ea4\u6613\u5167\u5bb9\u662f\u53ef\u4ee5\u76f4\u63a5\u5f9e pending tx \u4e2d\u88ab\u89e3\u6790\u51fa\u4f86\u3002\u5982\u679c\u6709\u4eba\u767c\u73fe\u4e00\u7a2e\u81ea\u52d5\u7684\u908f\u8f2f\uff0c\u4ed6\u5206\u6790 mempool \u88e1\u9762\u7684\u6bcf\u4e00\u500b\u4ea4\u6613\uff0c\u4e26\u4e14\u627e\u5230\u4e00\u500b\u65b9\u6cd5\u53ef\u4ee5\u5f9e\u4e2d\u7372\u5229\uff0c\u6bd4\u5982\u8aaa Bob \u767c\u73fe mempool \u88e1\u9762\u6709 Alice \u9019\u7b46\u4ea4\u6613\uff0c\u800c\u4e14\u4ed6\u53ea\u8981\u53ef\u4ee5\u6392\u5e8f\u9019\u4e9b\u4ea4\u6613\u7684\u57f7\u884c\u9806\u5e8f\uff1a\\n1. Bob \u5148\u7528 6,000 USDC \u8cb7 2 ETH \u5c0e\u81f4 ETH \u6f32\u50f9\uff0c\u5f71\u97ff\u5230 Alice \u7684\u4ea4\u6613\\n2. Alice \u7528 3,000 USDC \u53ea\u80fd\u8cb7\u5230 0.8 ETH\uff0c\u6b64\u6642 ETH \u518d\u5ea6\u6f32\u50f9\\n3. Bob \u518d\u6b21\u628a 2 ETH \u8ce3\u6389\uff0c\u7531\u65bc Alice \u628a\u50f9\u683c\u4e5f\u588a\u9ad8\u4e86\uff0c\u6240\u4ee5 Bob \u53ef\u4ee5\u628a 2 ETH \u8ce3\u5230 6,600 USDC\\n\\n![MEV](./mev.png)\\n\\n\u9019\u6a23 Bob \u53ea\u8981\u53ef\u4ee5\u6392\u5e8f\u4ea4\u6613\uff0c\u7b2c\u4e00\u6b65\u82b1\u8cbb\u7684 6000 USDC \u5728\u7b2c\u4e09\u6b65\u5c31\u8cfa\u56de\u4f86\u4e86\uff0c\u9019\u6a23\u5c31\u53ef\u4ee5\u6191\u7a7a\u8cfa 600 USDC\uff0c\u9019\u6a23\u7684\u884c\u70ba\u6211\u5011\u7a31\u70ba\u4e09\u660e\u6cbb\u653b\u64ca (Sandwich Attack)\\n\\n\u4f46\u662f\u8981\u600e\u9ebc\u66f4\u52d5\u4ea4\u6613\u9806\u5e8f\u5462\uff1f\u9019\u5c31\u662f\u4e00\u4ef6\u7926\u5de5\uff08\u6216\u662f\u4efb\u4f55\u53ef\u4ee5\u6539\u8b8a\u4ea4\u6613\u7684\u4eba\uff09\u80fd\u505a\u5230\u7684\u4e8b\u60c5\u4e86\u3002\u7576\u7926\u5de5\u767c\u73fe\u4e00\u500b\u4ea4\u6613\u5728\u4ed6\u524d\u5f8c\u593e\u64ca\u5169\u500b\u984d\u5916\u7684\u4ea4\u6613\u5c31\u53ef\u4ee5\u5f9e\u4e2d\u7372\u5229\u6642\uff0c\u540c\u6642\u4ed6\u9084\u8981\u6709\u80fd\u529b\u8b93\u7576\u4e0b\u9019\u500b\u5340\u584a\u662f\u80fd\u5920\u7531\u4ed6\u53d6\u5f97\u8a18\u5e33\u6b0a\u7684\u3002\u6240\u4ee5\u5be6\u969b\u767c\u751f\u7684\u6d41\u7a0b\u6703\u662f\uff1a\\n\\n1. \u7926\u5de5\u767c\u73fe\u53ef\u63d0\u53d6\u50f9\u503c\u7684\u4ea4\u6613\\n2. \u81ea\u52d5\u7522\u751f\u593e\u64ca\u7684\u4ea4\u6613\u4e26\u4e14\u6392\u5165\u5340\u584a\u5167\\n3. \u53d6\u5f97\u8a72\u5340\u584a\u7684\u8a18\u5e33\u6b0a\u4e26\u4e14\u7372\u5229\\n\\n\u800c\u7b2c\u4e09\u6b65\u7576\u4f60\u6709\u66f4\u9ad8\u7684\u7b97\u529b\u6642\uff0c\u80fd\u5920\u57f7\u884c\u6210\u529f\u7684\u6a5f\u7387\u8d8a\u5927\u3002\u5982\u679c\u767c\u73fe\u9019\u500b\u6a5f\u6703\u7684\u90a3\u500b\u5340\u584a\u6c92\u6709\u53d6\u5f97\u8a18\u5e33\u6b0a\uff0c\u9019\u500b\u6a5f\u6703\u5c31\u6d88\u5931\u4e86\uff0c\u4ed6\u539f\u672c\u7528\u4f86\u593e\u64ca\u7684\u5169\u500b\u4ea4\u6613\u5728\u4e0b\u500b\u5340\u584a\u5c31\u4e0d\u6703\u518d\u51fa\u73fe\u3002\u6bd4\u5982\u8aaa\u4e00\u500b\u7926\u5de5\uff08\u6216\u662f\u7926\u6c60\u3001\u7926\u5834\uff09\u6709\u5168\u7db2 20% \u7684\u7b97\u529b\uff0c\u5982\u679c\u5728\u6bcf\u6b21\u4ed6\u767c\u73fe\u6709\u5229\u53ef\u5716\u7684\u4ea4\u6613\u6642\u90fd\u81ea\u52d5\u7684\u767c\u51fa\u593e\u64ca\u4ea4\u6613\u4f01\u5716\u7372\u5229\uff0c\u900f\u904e\u4ed6\u76f8\u5c0d\u9ad8\u7684\u7b97\u529b\u7d2f\u7a4d\u4e0b\u4f86\u53ef\u80fd\u5c31\u6703\u662f\u5f88\u5927\u4e00\u7b46\u6536\u76ca\uff0c\u5373\u6642\u4ed6\u7684\u7b97\u529b\u6c92\u8fa6\u6cd5\u8b93\u4ed6\u6bcf\u6b21\u90fd\u80fd\u5920\u53d6\u5f97\u8a18\u5e33\u6b0a\u3002\\n\\n\u9019\u6a23\u7684\u4e09\u660e\u6cbb\u653b\u64ca\u884c\u70ba\u88ab\u7a31\u70ba Miner Extractable Value (MEV) \u6216\u662f Maximal Extractable Value\uff0c\u800c MEV \u53ea\u8981\u662f\u900f\u904e\u8b8a\u66f4\u4ea4\u6613\u9806\u5e8f\u5c31\u53ef\u4ee5\u6b78\u985e\u5230\u6b64\u7a2e\u884c\u70ba\uff0c\u9664\u4e86\u4e09\u660e\u6cbb\u653b\u64ca\u4e4b\u5916\u9084\u6709\u66f4\u7c21\u55ae\u7684 MEV \u65b9\u5f0f\u5982 front running\u3002\\n\\n## Front running\\nfront running \u662f\u53ea\u8981\u5075\u6e2c\u5230\u7279\u5b9a\u55ae\u4e00\u7b46\u4ea4\u6613\u767c\u73fe\u53ef\u4ee5\u7372\u5229\u6642\uff0c\u5c31\u6703\u767c\u51fa\u4e00\u6a21\u4e00\u6a23\u7684\u4ea4\u6613\uff0c\u4f46\u66f4\u9ad8 gas \u7684\u4ea4\u6613\u4f86\u7372\u5229\uff0c\u800c\u57f7\u884c\u5f8c\u53ef\u80fd\u539f\u672c\u57f7\u884c\u4ea4\u6613\u7684\u4eba\u7684\u4ea4\u6613\u5c31\u6703\u5931\u6557\uff08\u6216\u662f\u6e1b\u5c11\u7372\u5229\uff09\u3002\\n\\nfront running \u7684\u884c\u70ba\u5982\u679c\u4e0d\u662f\u7926\u5de5\u4e5f\u53ef\u4ee5\u505a\u5230\uff0c\u53ea\u8981\u82b1\u8cbb\u5927\u91cf\u7684 gas \u5373\u53ef\u3002\u6211\u5011\u7528\u4e00\u500b\u6e05\u7b97\u7684\u4f8b\u5b50\u4f86\u770b\u770b front running \u7684 MEV \u6703\u600e\u9ebc\u9032\u884c\u3002\\n\\n1. Alice \u62b5\u62bc\u5728 Compound \u7684 100 ETH \u56e0\u70ba\u62b5\u62bc\u54c1\u4e0d\u8db3\u7684\u539f\u56e0\u8981\u88ab\u6e05\u7b97\u4e86\uff0cCompound \u4ee5\u5e02\u50f9 1 ETH = 3000 USDC \u7684 95% \u62cd\u8ce3 Alice \u7684 100 ETH\uff0c\u539f\u672c\u50f9\u503c 300,000 USDC \u6253\u6298\u5f8c\u53ea\u5269 285,000 USDC\u3002\\n2. Bob \u898b\u5230\u6b64\u6a5f\u6703\u7acb\u523b\u7528 285,000 USDC \u60f3\u8981\u8cb7\u4e0b 100 ETH\uff0c\u4e26\u4e14\u5c07 gas \u8a2d\u5b9a\u6210 50\uff0c\u5c07\u4ea4\u6613\u9001\u51fa\u3002\\n3. Chris \u4f5c\u70ba\u4e00\u500b\u76e3\u807d mempool \u7684\u4eba\uff0c\u5bdf\u89ba\u5230\u4e86\u4e00\u7b46\u6e05\u7b97\u4ea4\u6613\u767c\u5230\u4e86 mempool\uff0c\u5373\u6642\u8a08\u7b97\u5f8c\u5f97\u77e5\u6b64\u4ea4\u6613\u53ef\u7372\u5229 5%\uff0c\u6240\u4ee5\u767c\u51fa\u4e86\u4e00\u7b46\u8ddf Bob \u4e00\u6a21\u4e00\u6a23\u7684\u4ea4\u6613\uff0c\u7528 285,000 USDC \u4f86\u8cb7\u4e0b 100 ETH\uff0c\u4e26\u4e14\u628a gas \u52a0\u500d\u6210 100 \u4f86\u4f01\u5716\u84cb\u904e\u539f\u672c\u7684\u4ea4\u6613\uff0c\u4e26\u4e14\u767c\u51fa\u4e86\u4ea4\u6613\u3002\\n4. \u6b64\u6642\u6709\u5168\u7db2 20% \u7b97\u529b\u7684\u7926\u5de5 Dexter \u540c\u6a23\u4e5f\u767c\u73fe\u4e86\u6b64\u6a5f\u6703\uff0cmempool \u88e1\u9762\u6709\u5169\u7b46\u4ea4\u6613\u90fd\u60f3\u900f\u904e\u6e05\u7b97\u8cfa\u9322\uff0c\u6240\u4ee5\u4ed6\u4e5f\u767c\u4e86\u4e00\u6a21\u4e00\u6a23\u7684\u6e05\u7b97\u4ea4\u6613\uff0c\u4f46\u662f\u4ed6\u662f\u7926\u5de5\uff0c\u6240\u4ee5\u76f4\u63a5\u628a\u81ea\u5df1\u7684\u4ea4\u6613\u653e\u5230\u63a5\u4e0b\u4f86\u8981\u9001\u51fa\u7684\u5340\u584a\u5167\uff0c\u4e26\u4e14\u4e0d\u767c\u5230 mempool \u88e1\u9762\u76f4\u63a5\u81ea\u5df1\u7af6\u722d\u8a18\u5e33\u6b0a\u3002\\n5. \u6700\u7d42\u7684\u7d50\u679c Dexter \u900f\u904e\u81ea\u5df1 20% \u7684\u7b97\u529b\uff0c\u5728\u9019\u6b21\u7af6\u722d\u4e2d\u7372\u5f97\u4e86\u5229\u6f64\uff0c\u4ed6\u7b11\u4e86\u7b11\uff0c\u7926\u5de5\u7684\u5feb\u6a02\u5c31\u662f\u5982\u6b64\u6a38\u5be6\u7121\u83ef\u4e14\u67af\u71e5\u3002\\n\\n\u7531\u65bc\u5229\u76ca\u7684\u9a45\u52d5\u4e26\u4e14 mempool \u662f\u516c\u958b\u7684\u60c5\u6cc1\u4e0b\uff0c\u6703\u6709\u5f88\u591a\u4eba\u64b0\u5beb\u8a31\u591a\u975e\u5e38\u6709\u5f48\u6027\u7684\u8173\u672c\u4f86\u76e3\u63a7 mempool\uff0c\u7576\u4ed6\u767c\u73fe\u6392\u5e8f\u4ea4\u6613\u53ef\u4ee5\u5e36\u4f86\u5229\u76ca\u6642\uff0c\u5c31\u6703\u81ea\u52d5\u7684\u6392\u5e8f\u4ea4\u6613\u4f86\u7372\u5229\u3002\u9019\u6a23\u5c31\u6703\u8b8a\u6210\u6a5f\u5668\u4eba\u5927\u6230\uff0c\u7121\u6578\u7684\u6a5f\u5668\u4eba\u76e3\u63a7\u8457 mempool\uff0c\u767c\u73fe\u8cfa\u9322\u6a5f\u6703\u5c31\u6703\u81ea\u52d5\u7684\u6392\u5e8f\u4ea4\u6613\uff0c\u5982\u679c MEV \u767c\u8d77\u8005\u4e0d\u662f\u7926\u5de5\uff0c\u6240\u4ee5\u9700\u8981\u628a\u4ea4\u6613\u9001\u56de mempool \u6642\uff0c\u76e3\u63a7\u8457 mempool \u7684\u5176\u4ed6\u4eba\u770b\u5230\u4f60\u65b0\u767c\u51fa\u7684\u4ea4\u6613\u6642\uff0c\u540c\u6a23\u4e5f\u6703\u6beb\u4e0d\u7559\u60c5\u7684\u518d\u51fa\u767c\u65b0\u7684\u4ea4\u6613\u4f01\u5716\u7372\u5f97\u4f60\u7684\u6536\u76ca\u3002\\n\\n\u6240\u4ee5\u53ea\u8981\u4f60\u8e0f\u5165\u4e86 mempool \u5c31\u50cf\u8e0f\u5165\u4e86\u4e09\u9ad4\u7684\u9ed1\u6697\u68ee\u6797\u4e00\u6a23\uff0c\u7576\u4f60\u767c\u51fa\u610f\u5716\u6216\u662f\u4fe1\u865f\u6642\uff0c\u5f37\u5927\u7684\u63a0\u98df\u8005\u5c31\u6703\u64b2\u9762\u800c\u4f86\u3002\\n\\n## \u5be6\u969b\u767c\u751f\u7684 MEV \u6848\u4f8b\\n\\nFlashbots \u7684 [MEV Explore][6] \u63d0\u4f9b\u4e86\u4e00\u500b\u6392\u540d\u53ef\u4ee5\u5075\u6e2c\u51fa\u55ae\u4e00\u4ea4\u6613\u7684 MEV\uff0c\u6240\u4ee5\u53ef\u4ee5\u5f9e\u9019\u908a\u4f86\u770b\u5230\u4e00\u4e9b\u900f\u904e front running \u7684\u884c\u70ba\uff0c\u4e0d\u904e\u4e09\u660e\u6cbb\u653b\u64ca\u56e0\u70ba\u6d89\u53ca\u5230\u591a\u7b46\u4ea4\u6613\uff0c\u6240\u4ee5\u5728\u9019\u500b\u7db2\u7ad9\u4e0a\u5c31\u6c92\u8fa6\u6cd5\u5075\u6e2c\u5230\u3002\u76ee\u524d\u5728\u7db2\u7ad9\u4e0a\u6240\u8ffd\u8e64\u5230\u6700\u9ad8\u7684\u4e00\u6b21 MEV \u662f\u4ea4\u6613 [0xd70b...7d41][8] \u5f9e\u4e2d\u7372\u53d6\u4e86\u9ad8\u9054\u4e09\u767e\u842c\u7f8e\u91d1\u7684\u5229\u6f64\u3002\\n\\n\u9019\u500b\u4ea4\u6613\u7d50\u5408\u4e86\u9583\u96fb\u8cb8 (Flashloan) \u4f86\u9054\u6210\u9019\u6b21\u7684 MEV \u884c\u70ba\uff0c\u5f80\u5f8c\u6211\u5011\u53ef\u4ee5\u66f4\u6df1\u5165\u7684\u63a2\u8a0e\u9583\u96fb\u8cb8\u3002\\n\\nUniswap \u6216\u5176\u4ed6\u6709\u8003\u616e\u5230\u9019\u6a23\u884c\u70ba\u7684\u667a\u80fd\u5408\u7d04\u6703\u5be6\u4f5c\u4e00\u4e9b\u6a5f\u5236\u4f86\u9632\u7bc4\u9019\u7a2e\u884c\u70ba\uff0c\u4f46\u662f\u9019\u7a2e\u653b\u64ca\u5982\u679c\u662f\u81ea\u52d5\u767c\u52d5\u7684\u60c5\u6cc1\u4e0b\uff0c\u4efb\u4f55\u6c92\u6709\u8003\u616e MEV \u884c\u70ba\u7684\u667a\u80fd\u5408\u7d04\u90fd\u6709\u53ef\u80fd\u81ea\u52d5\u7684\u6210\u70ba\u63d0\u53d6\u50f9\u503c\u7684\u5c0d\u8c61\u3002\\n\\n## \u89e3\u6c7a\u65b9\u6848\\n\u6709\u4e9b\u65b9\u6cd5\u662f\u300c\u6253\u4e0d\u904e\u5c31\u52a0\u5165\u4ed6\u300d\uff0c[Eden Network][1] \u767c\u884c\u4e86\u4ee3\u5e63\uff0c\u7576\u4f60\u52a0\u5165\u4ed6\u5011\u7684\u7d93\u6fdf\u9ad4\u5236\u5f8c\uff0c\u4ed6\u6703\u5e6b\u4f60\u512a\u5148\u767c\u9001\u4ea4\u6613\uff0c\u540c\u6642\uff0c\u4f60\u4e5f\u6210\u70ba\u4e86\u63a0\u98df\u8005\u3002\\n\\n[CowSwap][3] \u8b93\u4f60\u7c3d\u7f72\u4e00\u500b [meta transaction][2]\uff0c\u4e26\u4e14\u5728\u93c8\u4e0b\u9032\u884c\u8a02\u55ae\u7684\u64ae\u5408\uff0c\u5982\u679c\u64ae\u5408\u6210\u529f\u5c31\u76f4\u63a5\u628a\u4ea4\u6613\u900f\u904e\u7121\u6cd5\u767c\u52d5 MEV \u7684\u65b9\u5f0f\u767c\u5e03\u4e0a\u93c8\uff0c\u5982\u679c\u6c92\u8fa6\u6cd5\u93c8\u4e0b\u64ae\u5408\u6210\u529f\uff0c\u5247\u6703\u900f\u904e\u93c8\u4e0a\u7684\u4ea4\u6613\u6240\u9032\u884c\u4ea4\u6613\uff0c\u4f46\u662f\u6703\u76f4\u63a5\u9001\u5230\u7531 CowSwap \u6240\u7ba1\u7406\u7684\u7bc0\u9ede\uff0c\u4e0d\u6703\u66b4\u9732\u5728\u516c\u958b\u7684 mempool \u4e0a\u9762\uff0c\u4f46\u662f\u64ae\u5408\u6a5f\u5236\u5c31\u8b8a\u6210\u4e0d\u662f\u5728\u93c8\u4e0a\u904b\u884c\uff0c\u6e1b\u4f4e\u4e86\u53bb\u4e2d\u5fc3\u5316\u7684\u7a0b\u5ea6\u3002\\n\\n\u800c [Flashbots][4] \u63d0\u4f9b\u4e86\u4fee\u6539\u904e\u5f8c\u7684 go-ethereum \u8b93\u4ea4\u6613\u76f4\u63a5\u9001\u7d66\u7926\u5de5\uff0c\u800c\u4e0d\u6703\u66b4\u9732\u5728 mempool\uff0c\u800c\u8af7\u523a\u7684\u662f\u76ee\u524d\u5f88\u5927\u4e00\u90e8\u5206\u7684 MEV \u653b\u64ca\u884c\u70ba\u90fd\u662f\u900f\u904e flashbots \u9054\u6210\u3002\\n\\n\u4f60\u6709\u77e5\u9053\u5176\u4ed6\u66f4\u597d\u7684\u89e3\u6c7a\u65b9\u6848\u55ce\uff1f\u6b61\u8fce\u5230 LunDAO \u7684 [GitHub Discussion][5] \u8a0e\u8ad6\uff01\\n\\n## \u6ce8\u91cb\\n- \u76ee\u524d Miner Extractable Value \u9010\u6f38\u7684\u63a1\u7528\u4e00\u500b\u65b0\u7684\u540d\u8a5e Maximal Extractable Value \u4f86\u53d6\u4ee3\u4f86\u66f4\u6e96\u78ba\u7684\u63cf\u8ff0\u9019\u6a23\u7684\u884c\u70ba\uff0c\u8a73\u60c5\u8acb\u898b [Why MEV as Maximal Extractable Value instead of Miner Extractable Value?][7] \\n\\n[1]: https://www.edennetwork.io/\\n[2]: https://yurenju.medium.com/perp-meta-tx-e53cfb65367\\n[3]: https://cowswap.exchange/\\n[4]: https://ethereum.org/en/developers/docs/mev/#mev-extraction-flashbots\\n[5]: https://github.com/lun-dao/LunDAO/discussions/76\\n[6]: https://explore.flashbots.net/leaderboard\\n[7]: https://explore.flashbots.net/faq\\n[8]: https://etherscan.io/tx/0xd70b42daec5bb9ac6e5df3d25d309f186db50df701f667e1f20b22448ea27d41"}]}')}}]);