"use strict";(self.webpackChunklun_dao=self.webpackChunklun_dao||[]).push([[2342],{3905:(e,t,n)=>{n.d(t,{Zo:()=>s,kt:()=>f});var a=n(7294);function r(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function o(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);t&&(a=a.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,a)}return n}function l(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?o(Object(n),!0).forEach((function(t){r(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):o(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function i(e,t){if(null==e)return{};var n,a,r=function(e,t){if(null==e)return{};var n,a,r={},o=Object.keys(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||(r[n]=e[n]);return r}(e,t);if(Object.getOwnPropertySymbols){var o=Object.getOwnPropertySymbols(e);for(a=0;a<o.length;a++)n=o[a],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(r[n]=e[n])}return r}var c=a.createContext({}),d=function(e){var t=a.useContext(c),n=t;return e&&(n="function"==typeof e?e(t):l(l({},t),e)),n},s=function(e){var t=d(e.components);return a.createElement(c.Provider,{value:t},e.children)},u="mdxType",p={inlineCode:"code",wrapper:function(e){var t=e.children;return a.createElement(a.Fragment,{},t)}},m=a.forwardRef((function(e,t){var n=e.components,r=e.mdxType,o=e.originalType,c=e.parentName,s=i(e,["components","mdxType","originalType","parentName"]),u=d(n),m=r,f=u["".concat(c,".").concat(m)]||u[m]||p[m]||o;return n?a.createElement(f,l(l({ref:t},s),{},{components:n})):a.createElement(f,l({ref:t},s))}));function f(e,t){var n=arguments,r=t&&t.mdxType;if("string"==typeof e||r){var o=n.length,l=new Array(o);l[0]=m;var i={};for(var c in t)hasOwnProperty.call(t,c)&&(i[c]=t[c]);i.originalType=e,i[u]="string"==typeof e?e:r,l[1]=i;for(var d=2;d<o;d++)l[d]=n[d];return a.createElement.apply(null,l)}return a.createElement.apply(null,n)}m.displayName="MDXCreateElement"},9513:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>c,contentTitle:()=>l,default:()=>p,frontMatter:()=>o,metadata:()=>i,toc:()=>d});var a=n(7462),r=(n(7294),n(3905));const o={title:"Diamond 101 (2)",description:"EIP-2535 Diamond Contract",slug:"diamond101-2",tags:["eip2535","diamond","proxy"],authors:"wiasliaw"},l=void 0,i={permalink:"/blog/diamond101-2",editUrl:"https://github.com/lun-dao/LunDAO/tree/main/blog/2022-07-04-diamond101/diamond101-2.md",source:"@site/blog/2022-07-04-diamond101/diamond101-2.md",title:"Diamond 101 (2)",description:"EIP-2535 Diamond Contract",date:"2022-07-04T00:00:00.000Z",formattedDate:"July 4, 2022",tags:[{label:"eip2535",permalink:"/blog/tags/eip-2535"},{label:"diamond",permalink:"/blog/tags/diamond"},{label:"proxy",permalink:"/blog/tags/proxy"}],readingTime:2.65,truncated:!0,authors:[{name:"wiasliaw",url:"https://github.com/wiasliaw",imageURL:"https://github.com/wiasliaw.png",key:"wiasliaw"}],prevItem:{title:"Diamond 101 (4)",permalink:"/blog/diamond101-4"},nextItem:{title:"Diamond 101 (3)",permalink:"/blog/diamond101-3"}},c={authorsImageUrls:[void 0]},d=[{value:"Contract Architecture",id:"contract-architecture",children:[],level:2},{value:"Lookup Table",id:"lookup-table",children:[],level:2},{value:"Loupe",id:"loupe",children:[],level:2},{value:"diamondCut",id:"diamondcut",children:[],level:2},{value:"Glossary",id:"glossary",children:[],level:2}],s={toc:d},u="wrapper";function p(e){let{components:t,...o}=e;return(0,r.kt)(u,(0,a.Z)({},s,o,{components:t,mdxType:"MDXLayout"}),(0,r.kt)("p",null,"\u672c\u6587\u70ba Diamond 101 \u7cfb\u5217\u7684\u7b2c\u4e8c\u7bc7\u6587\u7ae0\uff0c\u5c07\u89e3\u91cb\u9019\u500b EIP \u5177\u9ad4\u7684\u5be6\u4f5c\u7d30\u7bc0\u3002"),(0,r.kt)("h2",{id:"contract-architecture"},"Contract Architecture"),(0,r.kt)("p",null,"\u9996\u5148\u4f86\u770b\u4e00\u4e0b\u4f7f\u7528 EIP-2535 \u7684\u5408\u7d04\u67b6\u69cb\u5716\u3002EIP-2535 \u767c\u660e\u4e86\u5f88\u591a\u8853\u8a9e\uff0c\u5716\u4e2d ",(0,r.kt)("strong",{parentName:"p"},"Diamond")," \u5c31\u662f Proxy Contract\uff0c",(0,r.kt)("strong",{parentName:"p"},"Facet")," \u5c31\u662f Logic Contract\u3002\u4e00\u6709\u5408\u7d04\u8abf\u7528\uff0c\u5247\u6703\u5148\u5728 Lookup Table \u67e5\u8a62\u6709\u6c92\u6709 selector \u7684\u8cc7\u6599\uff0c\u7136\u5f8c\u8abf\u7528 delegatecall \u904e\u53bb\uff0c\u8cc7\u6599\u4e00\u6a23\u5beb\u5728 Proxy \u88e1\u9762\u3002"),(0,r.kt)("p",null,(0,r.kt)("img",{src:n(2215).Z})),(0,r.kt)("h2",{id:"lookup-table"},"Lookup Table"),(0,r.kt)("p",null,"Lookup Table \u7684\u8cc7\u6599\u7d50\u69cb\u53ef\u4ee5\u4ee5 ",(0,r.kt)("inlineCode",{parentName:"p"},"mapping")," \u6216\u662f array \u7b49\u4f86\u8a2d\u8a08\uff0c\u4f5c\u8005\u4ee5 ",(0,r.kt)("inlineCode",{parentName:"p"},"bytes4[]")," \u548c ",(0,r.kt)("inlineCode",{parentName:"p"},"mapping")," \u4e00\u8d77\u4f7f\u7528\uff0c\u4e3b\u8981\u662f\u70ba\u4e86\u9054\u6210 Enumerable \u7684\u7279\u6027\u3002\u53e6\u5916\u70ba\u4e86\u907f\u514d storage collision\uff0c\u4e5f\u5c07 Lookup Table \u653e\u5230\u7279\u5b9a\u7684 storage \u88e1\u9762\u3002"),(0,r.kt)("p",null,(0,r.kt)("strong",{parentName:"p"},"Lookup Table")," \u7684\u8cc7\u6599\u7d50\u69cb\u548c storage slot"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},'bytes32 constant DIAMOND_STORAGE_POSITION = keccak256("diamond.standard.diamond.storage");\n\nstruct FacetAddressAndSelectorPosition {\n    address facetAddress;\n    uint16 selectorPosition;\n}\n\nstruct DiamondStorage {\n    // function selector => facet address and selector position in selectors array\n    mapping(bytes4 => FacetAddressAndSelectorPosition) facetAddressAndSelectorPosition;\n    bytes4[] selectors;\n    mapping(bytes4 => bool) supportedInterfaces;\n    // owner of the contract\n    address contractOwner;\n}\n')),(0,r.kt)("h2",{id:"loupe"},"Loupe"),(0,r.kt)("p",null,"\u5be6\u4f5c\u4e86 Lookup Table \u67e5\u8a62\u529f\u80fd\u7684 Facet \u7a31\u70ba Loupe\uff0c\u4e3b\u8981\u529f\u80fd\u70ba Lookup Table \u7684\u67e5\u8a62\u3002\u70ba\u4f55 Lookup Table \u7684\u8cc7\u6599\u7d50\u69cb\u90a3\u9ebc\u8907\u96dc\uff0c\u770b\u770b\u9019\u5806\u67e5\u8a62\u51fd\u5f0f\u80fd\u4ec0\u9ebc\u8cc7\u6599\u5c31\u77e5\u9053\u4e86\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"interface IDiamondLoupe {\n    struct Facet {\n        address facetAddress;\n        bytes4[] functionSelectors;\n    }\n\n    function facets() external view returns (Facet[] memory facets_);\n\n    function facetFunctionSelectors(address _facet) external view returns (bytes4[] memory facetFunctionSelectors_);\n\n    function facetAddresses() external view returns (address[] memory facetAddresses_);\n\n    function facetAddress(bytes4 _functionSelector) external view returns (address facetAddress_);\n}\n")),(0,r.kt)("h2",{id:"diamondcut"},"diamondCut"),(0,r.kt)("p",null,(0,r.kt)("inlineCode",{parentName:"p"},"diamondCut")," \u5247\u662f\u4e00\u500b\u51fd\u5f0f\uff0c\u5c08\u9580\u7ba1\u7406\uff08\u65b0\u589e\u3001\u522a\u9664\u3001\u4fee\u6b63\uff09Lookup Table\u3002"),(0,r.kt)("pre",null,(0,r.kt)("code",{parentName:"pre",className:"language-js"},"interface IDiamondCut {\n    // Add = 0, Replace = 1, Remove = 2\n    enum FacetCutAction {Add, Replace, Remove}\n\n    struct FacetCut {\n        address facetAddress;\n        FacetCutAction action;\n        bytes4[] functionSelectors;\n    }\n\n    function diamondCut(\n        FacetCut[] calldata _diamondCut,\n        address _init,\n        bytes calldata _calldata\n    ) external;\n\n    event DiamondCut(FacetCut[] _diamondCut, address _init, bytes _calldata);\n}\n")),(0,r.kt)("h2",{id:"glossary"},"Glossary"),(0,r.kt)("p",null,"\u5217\u51fa EIP2535 \u767c\u660e\u7684\u8853\u8a9e"),(0,r.kt)("ul",null,(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"diamond"),": Proxy Contract"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"facet"),": Logic Contract"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"loupe"),": \u4e00\u500b\u5be6\u4f5c Diamond \u67e5\u8a62\u4ecb\u9762\u7684 Facet"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"diamondCut"),": \u4e00\u500b\u7279\u5b9a\u7684\u51fd\u5f0f\u540d\u7a31\uff0c\u5c08\u9580\u7528\u4f86\u7ba1\u7406\uff08\u65b0\u589e\u3001\u522a\u9664\u3001\u4fee\u6b63\uff09Lookup Table"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Upgradeable Diamond"),": \u6709\u8a3b\u518a ",(0,r.kt)("inlineCode",{parentName:"li"},"diamondCut")," \u7684 Diamond Contract\uff0c\u53ef\u4ee5\u8a3b\u518a\u65b0\u7684\u51fd\u5f0f\u5230 Lookup Table \u88e1\u505a\u5347\u7d1a"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Finished Diamond"),": \u4e00\u500b Upgradeable Diamond\uff0c\u6b77\u7d93\u5347\u7d1a\u8fed\u4ee3\u5f8c\u529f\u80fd\u90fd\u5b8c\u5168\u4e86\uff0c\u6700\u5f8c\u5c07 ",(0,r.kt)("inlineCode",{parentName:"li"},"diamondCut")," \u79fb\u9664 Lookup Table"),(0,r.kt)("li",{parentName:"ul"},(0,r.kt)("strong",{parentName:"li"},"Single Cut Diamond"),": \u53ea\u5728 constructor \u8a3b\u518a function \u9032\u8a3b\u518a\u8868\uff0c\u90e8\u7f72\u5b8c\u6210\u5f8c\u5c31\u4e0d\u80fd\u505a\u4efb\u4f55\u5347\u7d1a")))}p.isMDXComponent=!0},2215:(e,t,n)=>{n.d(t,{Z:()=>a});const a=n.p+"assets/images/diamond_structure-acb686d981b420ee3059b00f5f070a75.png"}}]);