<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="LunDAO RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="LunDAO Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-react-helmet="true">Hardhat mainnet forking：主網分叉 (2) | LunDAO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://lundao.tech/blog/hardhat-forking-2"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Hardhat mainnet forking：主網分叉 (2) | LunDAO"><meta data-react-helmet="true" name="description" content="利用 Hardhat 主網分叉做一些酷炫的事情"><meta data-react-helmet="true" property="og:description" content="利用 Hardhat 主網分叉做一些酷炫的事情"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-03-23T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/a2468834"><meta data-react-helmet="true" property="article:tag" content="Mainnet Fork,Mainnet Forking,Hardhat,Nomic Labs"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://lundao.tech/blog/hardhat-forking-2"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/hardhat-forking-2" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/hardhat-forking-2" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ba61c7d6.css">
<link rel="preload" href="/assets/js/runtime~main.67d47840.js" as="script">
<link rel="preload" href="/assets/js/main.2d5310ba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">LunDAO</b></a><a class="navbar__item navbar__link" href="/docs/publish-guideline">關於</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">文章</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>DAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/end-of-lundao">LunDAO 的結尾</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/crvusd">LLAMMA - crvUSD 的新清算機制</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-4">Diamond 101 (4)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-2">Diamond 101 (2)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-3">Diamond 101 (3)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Hardhat mainnet forking：主網分叉 (2)</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-03-23T00:00:00.000Z" itemprop="datePublished">March 23, 2022</time> · <!-- -->10 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/a2468834" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/a2468834.png" alt="Chuan-Chun Wang"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/a2468834" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Chuan-Chun Wang</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>在上一篇<a href="/blog/hardhat-forking-1">文章</a>我們已經學會了怎麼使用 Hardhat mainnet forking，但是讀者可能尚有疑惑不知道這樣的功能可以做什麼？本篇文章將延續相同主題，並給出幾個例子，向讀者展示 mainnet forking 能夠為開發過程帶來的方便性。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="範例一與-weth9-合約互動">範例一：與 <code>WETH9</code> 合約互動<a class="hash-link" href="#範例一與-weth9-合約互動" title="Direct link to heading">​</a></h2><p>如同前文所述，interoperability 是 smart contract 一個相當重要的特性，而以程式的角度來看即為合約互相呼叫。假設我們今天要開發一個合約會與 Wrapped Ether（<code>WETH9</code>）<sup id="fnref-3"><a href="#fn-3" class="footnote-ref">3</a></sup>合約互動，那麼會發生什麼事呢？</p><p>若無 mainnet forking 可用，則我們必需先將 <code>WETH9</code> 部屬在 local Hardhat Network （且會得到與主網不一樣的合約地址），方能與之互動、進行後續的開發流程；可想而知這就是增加複雜度，卻降低仿真度的土法煉鋼方法。</p><p>若有 mainnet forking 可用，則我們什麼都不需要做。直接與 Etherscan 上面查詢到的 <code>WETH9</code> 合約地址互動即可，完全模擬我們合約在未來上線時的操作環境。</p><p>以下將透過執行一段簡短的 JavaScript 腳本，向讀者展示要怎麼在已完成 mainnet forking 的 Hardhat Network 之內，與知名的 <code>WETH9</code> 互動。</p><ol><li>延續前文的操作環境</li><li>在 <code>hardhat_fork</code> 資料夾底下創立新資料夾 <code>scripts</code></li><li>前往 Etherscan.io 或任何你信任的 Ethereum blockchain explorer 尋找 WETH 合約<ul><li><a href="https://etherscan.io/address/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2#code" target="_blank" rel="noopener noreferrer">https://etherscan.io/address/0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2#code</a></li></ul></li><li>將合約 ABI 儲存成 <code>contract-abi.json</code> 檔案，並放置於 <code>hardhat_fork/scripts</code> 資料夾底下<ul><li>若是使用 Etherscan，則需滾動至網頁最下方，如圖所示</li></ul></li></ol><p><img alt="weth9-contract-abi" src="/assets/images/weth9-contract-abi-1e48dad0a8fdf34fa37201948a0ca076.png"></p><ol start="4"><li>前往這個 Gist 下載 <code>interact.js</code> 腳本，並且把它儲存在 <code>hardhat_fork/scripts</code> 資料夾底下<ul><li><a href="https://gist.github.com/a2468834/6101244f5000e467ec8904ac5f0ec41d" target="_blank" rel="noopener noreferrer">https://gist.github.com/a2468834/6101244f5000e467ec8904ac5f0ec41d</a></li><li>或可至 GitHub 上面 LunDAO repo 下載</li></ul></li><li>截至目前為止，<code>hardhat_fork</code> 資料夾應該要長得像這樣子<sup id="fnref-8"><a href="#fn-8" class="footnote-ref">8</a></sup></li></ol><div class="codeBlockContainer_J+bg language-Shell theme-code-block"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">📂 hardhat_fork</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── 📂 scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    ├── 📄 contract-abi.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    └── 📄 interact.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── 📄 .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> └── 📄 hardhat.config.js</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><ol start="6"><li>執行指令</li></ol><div class="codeBlockContainer_J+bg language-Shell theme-code-block"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$ yarn hardhat --network &quot;hardhat&quot; run scripts/interact.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yarn run v1.22.17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Check contract status</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        ETH-Balance                     WETH-Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">WETH9   7160157.033871775794435313      7160157.033871775794435313</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Step 0] Before we started</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account Address             ETH-Balance     WETH-Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0      0xf39f......2266    10000.000       0.000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#1      0x2feb......a6f3    4.294           13813.827</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Step 1] Account#1 deposits 3 ETH in contract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account Address             ETH-Balance     WETH-Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0      0xf39f......2266    10000.000       0.000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#1      0x2feb......a6f3    1.291           13816.827</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Step 2] Account#1 sends 13 WETH to Account#0</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account Address             ETH-Balance     WETH-Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0      0xf39f......2266    10000.000       13.000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#1      0x2feb......a6f3    1.286           13803.827</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">[Step 3] Account#0 withdraws 13 WETH from contract</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">--------------------------------------------------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Account Address             ETH-Balance     WETH-Balance</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#0      0xf39f......2266    10012.997       0.000</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">#1      0x2feb......a6f3    1.286           13803.827</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">================================================================================</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">{</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  hash: &#x27;0x1dfa3eee62caaf1aa06d60b9fd57d67d17fe23c9f9452c1e3284056e6fad6e48&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  type: 2,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  accessList: [],</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blockHash: &#x27;0x3750ecaf4f7ccf733ceed460a0aeb54b3dd2373dc199ba5b420e062c5d39f165&#x27;,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  blockNumber: 14297760,</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>以下筆者將對 <code>interact.js</code> 的程式碼做一些重點解析</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-8-9">Line 8-9<a class="hash-link" href="#line-8-9" title="Direct link to heading">​</a></h3><p>開啟 mainnet forking 模式讓我們得以直接與真實的 <code>WETH9</code> 合約地址互動，不需要額外部屬其他合約。另外，<code>somebody</code> 地址則是隨機挑選的一個地址，恰巧該地址同時擁有 eth 和 weth，在接下來的操作當中可見奇效。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> weth9_address </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0xc02aaa39b223fe8d0a0e5c4f27ead9083c756cc2&quot;</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> somebody      </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;0x2feb1512183545f48f6b9c5b4ebfcaf49cfca6f3&quot;</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-13-30">Line 13-30<a class="hash-link" href="#line-13-30" title="Direct link to heading">​</a></h3><p>用來讓印在 terminal 的文字看起來排版美美的函數們，並沒有特別之處</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">addressSlicing</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Skip */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printAccountAndBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">provider</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> contract</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> account0</span><span class="token parameter punctuation" style="color:#393A34">,</span><span class="token parameter"> account1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Skip */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-34-35">Line 34-35<a class="hash-link" href="#line-34-35" title="Direct link to heading">​</a></h3><p><code>hre</code>（Hardhat Runtime Environment, HRE）是一個 Hardhat Network 啟動之後，包含所有 Hardhat 套件功能的物件，詳細內容請見文末延伸閱讀。</p><p><code>hre.ethers.getSigners()</code> 回傳一個長度為 20 的 ethers.js Signer 陣列，就是前文所述的那二十個各有 10000 ETH 的帳號</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> </span><span class="token maybe-class-name">HRE_EOAs</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ethers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">getSigners</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">const</span><span class="token plain"> provider </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ethers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">provider</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-40-4347">Line 40-43,47<a class="hash-link" href="#line-40-4347" title="Direct link to heading">​</a></h3><p>在 mainnet forking 模式之下，Hardhat Network 允許開發者發送 tx，<strong>即便你根本未持有該地址的私鑰</strong>。有了這個功能，我們可以隨意尋找任何具備我們有興趣條件的地址（EOA 或 contract address 均可），然後以它的名義發送 tx 來進行各式操作，讓 mainnet forking 的測試環境兼具高仿真度與高便利性。</p><p>除了 <code>hardhat_impersonateAccount</code> 功能之外，還有其他例如：<code>hardhat_setNonce</code>、<code>hardhat_setBalance</code>、<code>hardhat_setCode</code>、<code>hardhat_setStorageAt</code>等功能，詳細可見<a href="https://hardhat.org/hardhat-network/guides/mainnet-forking.html#customizing-hardhat-network-s-behavior" target="_blank" rel="noopener noreferrer">這邊</a>的說明。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hardhat_impersonateAccount&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token literal-property property" style="color:#36acaa">params</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token plain">somebody</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-50-56">Line 50-56<a class="hash-link" href="#line-50-56" title="Direct link to heading">​</a></h3><p>此 JavaScript 腳本印出 <code>WETH9</code> 的 token 總發行量與此地址的 balance，我們可見兩個數值相等且與 Etherscan 上的餘額吻合。由於 Etherscan Analytics 分頁謹顯示當日日末餘額，因此需查詢前一日餘額為準。</p><p><img alt="Etherscan-Analytics" src="/assets/images/etherscan-analytics-3438b17d267da1be587a6607b0a8fbc1.png"></p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-64-68">Line 64-68<a class="hash-link" href="#line-64-68" title="Direct link to heading">​</a></h3><p>我們以 <code>somebody</code> 地址的名義（i.e., 使用 <code>signer_1</code> 發出 txn），向 <code>WETH9</code> 合約存款 3 eth；之所以此行為不是 invalid tx，歸功於前述的 <code>hardhat_impersonateAccount</code> 功能<sup id="fnref-9"><a href="#fn-9" class="footnote-ref">9</a></sup>，它讓我們能夠在 Hardhat Network 內以未知密鑰地址的名義發送 tx。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> overrides </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token literal-property property" style="color:#36acaa">value</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ethers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parseEther</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;3.0&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token plain">         </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signer_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">txn_array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">deposit</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">overrides</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printAccountAndBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signer_0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signer_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-72-80">Line 72-80<a class="hash-link" href="#line-72-80" title="Direct link to heading">​</a></h3><p>這個段落把 <code>Account#1</code>（即 <code>somebody</code> 地址）的 13 個 weth 轉給 <code>Account#0</code>（即 HRE 預設地址 No.0）。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token constant" style="color:#36acaa">WETH9</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">connect</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">signer_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">txn_array</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">push</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">transferFrom</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signer_1</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        signer_0</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">address</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">ethers</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">utils</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">parseEther</span><span class="token punctuation" style="color:#393A34">(</span><span class="token string" style="color:#e3116c">&quot;13.0&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">printAccountAndBalance</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">provider</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token constant" style="color:#36acaa">WETH9</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signer_0</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> signer_1</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-84-89">Line 84-89<a class="hash-link" href="#line-84-89" title="Direct link to heading">​</a></h3><p>由於傳送 tx 需要耗費 tx fee，所以我們可以發現最終印出的結果顯示：<code>Account #0</code> 和 <code>Account #1</code> 的 eth 餘額總和比最初的時候少一些。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-93-97">Line 93-97<a class="hash-link" href="#line-93-97" title="Direct link to heading">​</a></h3><p>最後會印出稍早發送的所有 tx 的細節；讀者可以透過 <code>blockNumber</code> 查覺這些 tx 與當初指定 mainnet forking 區塊高度之間的關聯性，可見 Hardhat Network 是有在逐步長高。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="範例二抓取-public-變數的歷史數據">範例二：抓取 <code>public</code> 變數的歷史數據<a class="hash-link" href="#範例二抓取-public-變數的歷史數據" title="Direct link to heading">​</a></h2><p>這個範例要解決的是另一個事情：要怎麼抓取 Ethereum 上面某個數據的歷史資料呢？</p><p>Etherscan 提供圖形化介面讓開發者可以快速查詢合約內 <code>public</code> <code>view</code>/<code>pure</code> function 的回傳值，但是如果我們有興趣的回傳值只會出現在特定 block number 呢？這時候除了使用 Dune Analytics 等網站提供的服務，我們其實可以透過 mainnet forking 的功能來自己實作。</p><p>以下將使用另一份 JavaScript 腳本，只需將前一個範例的第四步驟改為下載此腳本，即可成功執行。</p><ul><li><a href="https://gist.github.com/a2468834/71c59d580c1da21337350cdfc47e515b" target="_blank" rel="noopener noreferrer">https://gist.github.com/a2468834/71c59d580c1da21337350cdfc47e515b</a></li><li>或可至 GitHub 上面 LunDAO repo 下載</li><li>截至目前為止，<code>hardhat_fork</code> 資料夾應該要長得像這樣子<sup id="fnref-4"><a href="#fn-4" class="footnote-ref">4</a></sup></li></ul><div class="codeBlockContainer_J+bg language-Shell theme-code-block"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">📂 hardhat_fork</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── 📂 scripts</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    ├── 📄 contract-abi.json</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    ├── 📄 interact.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │    └── 📄 query.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> ├── 📄 .env</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> │</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"> └── 📄 hardhat.config.js</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>執行指令之後，可見 terminal 印出類似這樣子的文字</p><div class="codeBlockContainer_J+bg language-Shell theme-code-block"><div class="codeBlockContent_csEI Shell"><pre tabindex="0" class="prism-code language-Shell codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">$ yarn hardhat --network &quot;hardhat&quot; run scripts/query.js</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">yarn run v1.22.17</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Method 1</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Block number: 14379900</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TotalSupply:  7080076.411770262795354559</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Block number: 14379901</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TotalSupply:  7080077.697963348707441243</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">----------------------------------------</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">Block number: 14379902</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">TotalSupply:  7080074.493707533508180991</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">...</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>以下筆者將對 <code>query.js</code> 的程式碼做一些重點解析</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-14-1928-29">Line 14-19,28-29<a class="hash-link" href="#line-14-1928-29" title="Direct link to heading">​</a></h3><p>此腳本透過循序變換 mainnet forking 的分叉高度，達成「查詢某個區間內，<code>WETH9</code> 合約的 <code>totalSupply()</code> 數值變化」</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">var</span><span class="token plain"> config </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain">  </span><span class="token literal-property property" style="color:#36acaa">method</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token string" style="color:#e3116c">&quot;hardhat_reset&quot;</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                </span><span class="token literal-property property" style="color:#36acaa">params</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">[</span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                    </span><span class="token literal-property property" style="color:#36acaa">forking</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token literal-property property" style="color:#36acaa">jsonRpcUrl</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> process</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">env</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access maybe-class-name">Mainnet</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">                        </span><span class="token literal-property property" style="color:#36acaa">blockNumber</span><span class="token operator" style="color:#393A34">:</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">]</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">params</span><span class="token punctuation" style="color:#393A34">[</span><span class="token number" style="color:#36acaa">0</span><span class="token punctuation" style="color:#393A34">]</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">forking</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">blockNumber</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> block_i</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword control-flow" style="color:#00009f">await</span><span class="token plain"> hre</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">network</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">provider</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">request</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">config</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-38-51">Line 38-51<a class="hash-link" href="#line-38-51" title="Direct link to heading">​</a></h3><p>事實上，查詢 <code>public</code> <code>view</code>/<code>pure</code> function 的歷史數據，不需要用到 mainnet forking 模式。可以單純透過呼叫合約函數，額外附加 <code>blockTag</code> 即可<sup id="fnref-5"><a href="#fn-5" class="footnote-ref">5</a></sup>。<code>method1()</code> 為使用 mainnet forking 的方法，<code>method2()</code> 則是不需使用 mainnet forking 的方法。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">method2</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">/* Skip */</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_y2LR" id="line-55-56">Line 55-56<a class="hash-link" href="#line-55-56" title="Direct link to heading">​</a></h3><p>執行的時候記得把其中一行的註解拿掉；另外，mainnet forking 的分叉高度不能小於想要查詢<code>public</code> <code>view</code>/<code>pure</code> function 的歷史數據的區塊高度。</p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">async</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">main</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">// Delete one of the following comments</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//await method1();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token comment" style="color:#999988;font-style:italic">//await method2();</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="related-resources">Related resources<a class="hash-link" href="#related-resources" title="Direct link to heading">​</a></h2><ul><li>Yarn<ul><li><a href="https://classic.yarnpkg.com/en/" target="_blank" rel="noopener noreferrer">https://classic.yarnpkg.com/en/</a></li></ul></li><li>Hardhat<ul><li>GitHub：<a href="https://github.com/NomicFoundation/hardhat" target="_blank" rel="noopener noreferrer">https://github.com/NomicFoundation/hardhat</a></li><li>Mainnet forking：<a href="https://hardhat.org/hardhat-network/guides/mainnet-forking.html" target="_blank" rel="noopener noreferrer">https://hardhat.org/hardhat-network/guides/mainnet-forking.html</a></li><li>Configuration：<a href="https://hardhat.org/config/" target="_blank" rel="noopener noreferrer">https://hardhat.org/config/</a></li><li>Hardhat Network Reference：<a href="https://hardhat.org/hardhat-network/reference/" target="_blank" rel="noopener noreferrer">https://hardhat.org/hardhat-network/reference/</a></li><li>Creating a task：<a href="https://hardhat.org/guides/create-task.html" target="_blank" rel="noopener noreferrer">https://hardhat.org/guides/create-task.html</a></li><li>Hardhat Runtime Environment (HRE)：<a href="https://hardhat.org/advanced/hardhat-runtime-environment.html" target="_blank" rel="noopener noreferrer">https://hardhat.org/advanced/hardhat-runtime-environment.html</a></li></ul></li><li>Alchemy<ul><li><a href="https://www.alchemy.com/" target="_blank" rel="noopener noreferrer">https://www.alchemy.com/</a></li></ul></li><li>Ethereum on ARM<ul><li><a href="https://ethereum-on-arm-documentation.readthedocs.io/en/latest/quick-guide/about-quick-start.html" target="_blank" rel="noopener noreferrer">https://ethereum-on-arm-documentation.readthedocs.io/en/latest/quick-guide/about-quick-start.html</a></li></ul></li><li>Wrapped Ether<ul><li><a href="https://weth.io/index.html" target="_blank" rel="noopener noreferrer">https://weth.io/index.html</a></li></ul></li></ul><h2 class="anchor anchorWithStickyNavbar_y2LR" id="further-reading">Further reading<a class="hash-link" href="#further-reading" title="Direct link to heading">​</a></h2><ul><li>Infura<ul><li><a href="https://infura.io/" target="_blank" rel="noopener noreferrer">https://infura.io/</a></li></ul></li><li>QuickNode<ul><li><a href="https://www.quicknode.com/" target="_blank" rel="noopener noreferrer">https://www.quicknode.com/</a></li></ul></li><li>Truffle<ul><li>Simulate Live Networks with Forked Sandboxes：<a href="https://trufflesuite.com/blog/sandbox-forking-with-truffle-teams/index.html" target="_blank" rel="noopener noreferrer">https://trufflesuite.com/blog/sandbox-forking-with-truffle-teams/index.html</a></li></ul></li></ul><div class="footnotes"><hr><ol><li id="fn-3">關於什麼是 Wrapped Ether？請參考文末延伸閱讀，或請讀者自行查詢其他網路資料。<a href="#fnref-3" class="footnote-backref">↩</a></li><li id="fn-8">有省略一些與本文無關的檔案與資料夾<a href="#fnref-8" class="footnote-backref">↩</a></li><li id="fn-9"><a href="https://hardhat.org/hardhat-network/reference/#hardhat-impersonateaccount" target="_blank" rel="noopener noreferrer">https://hardhat.org/hardhat-network/reference/#hardhat-impersonateaccount</a><a href="#fnref-9" class="footnote-backref">↩</a></li><li id="fn-4">有省略一些與本文無關的檔案與資料夾<a href="#fnref-4" class="footnote-backref">↩</a></li><li id="fn-5"><code>blockTag</code> 是 ethers.js 的語法，web3.js 的 API 使用方法可能有所不同<a href="#fnref-5" class="footnote-backref">↩</a></li></ol></div></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/mainnet-fork">Mainnet Fork</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/mainnet-forking">Mainnet Forking</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/hardhat">Hardhat</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/nomic-labs">Nomic Labs</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lun-dao/LunDAO/tree/main/blog/2022-03-23-hardhat-forking/hardhat-forking-2.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/hardhat-forking-1"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->Hardhat mainnet forking：主網分叉 (1)</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/total-tokens-looksrare"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">基本功：从合约看 token 数量<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#範例一與-weth9-合約互動" class="table-of-contents__link toc-highlight">範例一：與 <code>WETH9</code> 合約互動</a><ul><li><a href="#line-8-9" class="table-of-contents__link toc-highlight">Line 8-9</a></li><li><a href="#line-13-30" class="table-of-contents__link toc-highlight">Line 13-30</a></li><li><a href="#line-34-35" class="table-of-contents__link toc-highlight">Line 34-35</a></li><li><a href="#line-40-4347" class="table-of-contents__link toc-highlight">Line 40-43,47</a></li><li><a href="#line-50-56" class="table-of-contents__link toc-highlight">Line 50-56</a></li><li><a href="#line-64-68" class="table-of-contents__link toc-highlight">Line 64-68</a></li><li><a href="#line-72-80" class="table-of-contents__link toc-highlight">Line 72-80</a></li><li><a href="#line-84-89" class="table-of-contents__link toc-highlight">Line 84-89</a></li><li><a href="#line-93-97" class="table-of-contents__link toc-highlight">Line 93-97</a></li></ul></li><li><a href="#範例二抓取-public-變數的歷史數據" class="table-of-contents__link toc-highlight">範例二：抓取 <code>public</code> 變數的歷史數據</a><ul><li><a href="#line-14-1928-29" class="table-of-contents__link toc-highlight">Line 14-19,28-29</a></li><li><a href="#line-38-51" class="table-of-contents__link toc-highlight">Line 38-51</a></li><li><a href="#line-55-56" class="table-of-contents__link toc-highlight">Line 55-56</a></li></ul></li><li><a href="#related-resources" class="table-of-contents__link toc-highlight">Related resources</a></li><li><a href="#further-reading" class="table-of-contents__link toc-highlight">Further reading</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">關於</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>關於 LunDAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/publish-guideline">投稿文章</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">閱讀文章</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/request-for-article">文章提案</a></li><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>社群貢獻指南<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">DAO治理</div><ul class="footer__items"><li class="footer__item"><a href="https://coordinape.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>貢獻投票 (Coordinape)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://snapshot.org/#/lundao.eth" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>治理投票 (Snapshot)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/treasury">社群金庫</a></li></ul></div><div class="col footer__col"><div class="footer__title">社群</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>討論區<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/9s3RQmajBu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 LunDAO. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67d47840.js"></script>
<script src="/assets/js/main.2d5310ba.js"></script>
</body>
</html>