<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="LunDAO RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="LunDAO Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-react-helmet="true">Diamond 101 (1) | LunDAO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://lundao.tech/blog/diamond101"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="Diamond 101 (1) | LunDAO"><meta data-react-helmet="true" name="description" content="EIP-2535 Diamond Contract"><meta data-react-helmet="true" property="og:description" content="EIP-2535 Diamond Contract"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-04-20T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://github.com/wiasliaw"><meta data-react-helmet="true" property="article:tag" content="eip2535,diamond,proxy"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://lundao.tech/blog/diamond101"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/diamond101" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/diamond101" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ba61c7d6.css">
<link rel="preload" href="/assets/js/runtime~main.67d47840.js" as="script">
<link rel="preload" href="/assets/js/main.2d5310ba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">LunDAO</b></a><a class="navbar__item navbar__link" href="/docs/publish-guideline">關於</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">文章</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>DAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/end-of-lundao">LunDAO 的結尾</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/crvusd">LLAMMA - crvUSD 的新清算機制</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-4">Diamond 101 (4)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-2">Diamond 101 (2)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-3">Diamond 101 (3)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">Diamond 101 (1)</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-04-20T00:00:00.000Z" itemprop="datePublished">April 20, 2022</time> · <!-- -->6 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://github.com/wiasliaw" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/wiasliaw.png" alt="wiasliaw"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://github.com/wiasliaw" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">wiasliaw</span></a></div></div></div></div></div></header><div class="markdown" itemprop="articleBody"><p>本文為 Diamond 101 系列的第一篇文章，將解釋什麼是可升級合約、常見的實作以及不同實作之間的設計。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="proxy-的組成">Proxy 的組成<a class="hash-link" href="#proxy-的組成" title="Direct link to heading">​</a></h2><p><img src="data:image/jpeg;base64,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"></p><p>可升級合約顧名思義就是可以更新邏輯的合約，實作大多基於 Proxy。Proxy 是一種 Solidity 的 design pattern，將資料與邏輯分開處理，只要能替換掉邏輯，就能升級。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="delegatecall">Delegatecall<a class="hash-link" href="#delegatecall" title="Direct link to heading">​</a></h3><p>首先需要先來補充一點背景知識。目前所有的 Proxy 都是 <code>delegatecall</code> 的應用。簡單說明 <code>delegatecall</code> 就是以別的合約的函式來操作發出 <code>delegatecall</code> 的合約的 storage。而一般的合約調用則是以自己的函式操作自己的 storage。舉例來說，當 A 合約對 B 合約調用 <code>delegatecall</code> 時，B 合約的函式會被調用，但是對 storage 的寫入都會執行 A 合約上。附上<a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/5a75065659a65e65bb04890192e3a4bcb7917fff/contracts/proxy/Proxy.sol#L22-L45" target="_blank" rel="noopener noreferrer">常見的 delegatecall 實作</a>。</p><p>Delegatecall 也衍生出不少有趣的 EIP，例如 <a href="https://eips.ethereum.org/EIPS/eip-1167" target="_blank" rel="noopener noreferrer">EIP-1167</a>，以最小的成本複製一個合約。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="fallback-與-receive">fallback 與 receive<a class="hash-link" href="#fallback-與-receive" title="Direct link to heading">​</a></h3><p>有關合約調用的交易 (transaction) 的 data 欄位不會空著，前面 4 個 bytes 為 function selector，用來讓 EVM 知道要執行合約中的哪段 bytecode。要是沒有 function selector 或是 function selector 不在合約中怎麼辦？這時則會看合約有沒有實作 <code>fallback</code> 或是 <code>receive</code>，兩者觸發的條件如下：</p><ul><li><code>fallback</code>:<ul><li>合約中沒有對應的 function selector</li><li>沒有 receive 時</li></ul></li><li><code>receive</code>:<ul><li>交易的 data 為空 (不管 value 為多少)</li></ul></li></ul><p>Proxy 合約中不會紀錄邏輯合約 (logic contract) 每一個 function selector，就會利用 fallback 的特性處理所有的合約調用，將所有的合約調用都 delegatecall 至邏輯合約 (logic contract)。可以來看一下 <a href="https://github.com/OpenZeppelin/openzeppelin-contracts/blob/master/contracts/proxy/Proxy.sol" target="_blank" rel="noopener noreferrer">Openzeppelin</a> 提供的實作，就是 delegatecall 跟 fallback, receive 的組合拳。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="transparent-proxy">Transparent Proxy<a class="hash-link" href="#transparent-proxy" title="Direct link to heading">​</a></h2><p><img src="/assets/images/transparent_proxy-4c5d8c7ba4c2a4ffaa680c18c1a9dd53.jpeg"></p><p>架構圖如上，來看一下 Openzeppelin 的介紹</p><blockquote><p>The way we deal with this problem is via the transparent proxy pattern. The goal of a transparent proxy is to be indistinguishable by a user from the actual logic contract.</p></blockquote><p>這是何意呢？主要是要讓使用者跟邏輯合約 (logic contract) 緊緊連結在一起，不過這樣寫也很讓人難懂。簡單來說就是使用者所發起的合約調用都要以 delegatecall 調用邏輯合約 (logic contract)，而 admin 所發起的合約調用永遠不會到邏輯合約。</p><p>示意圖如下</p><table><thead><tr><th>msg.sender</th><th>owner()</th><th>upgradeTo()</th><th>transfer()</th></tr></thead><tbody><tr><td>admin</td><td>returns proxy.owner</td><td>upgrades proxy</td><td>reverts</td></tr><tr><td>user</td><td>returns ERC20 owner</td><td>reverts</td><td>sends ERC20 transfer</td></tr></tbody></table><p>Openzeppelin 採用 EIP-1967 作為實作。實作上，Proxy 裡面的每個管理 proxy 的 function 都會加上身份驗證的流程，只讓 admin 可以調用。但是為何還要一個而 ProxyAdmin 呢？ProxyAdmin 主要用途是為了執行查詢的用途還有讓 owner 解放。</p><p>舉個例子，<code>admin()</code> 應該要是個 <code>view function</code> 但是因為 fallback 的關係不能標示 <code>view</code>，需要利用另外一個合約再包裝一層才能標示 <code>view</code>。此外 admin 也可能同時是 user，把權限交給 ProxyAdmin 同時有更好的 function interface 可以調用，也可以讓 admin 解開限制。</p><p><strong>Proxy 中 admin function 的舉例</strong></p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">modifier </span><span class="token function" style="color:#d73a49">ifAdmin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">if</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">msg</span><span class="token punctuation" style="color:#393A34">.</span><span class="token property-access">sender</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">==</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_getAdmin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        _</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"> </span><span class="token keyword control-flow" style="color:#00009f">else</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">        </span><span class="token function" style="color:#d73a49">_fallback</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">admin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> external ifAdmin </span><span class="token function" style="color:#d73a49">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address admin_</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    admin_ </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">_getAdmin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p><strong>ProxyAdmin 中對 admin function 的封裝</strong></p><p>跟 <code>staticcall</code> 一起使用，才能標示為 <code>view</code></p><div class="codeBlockContainer_J+bg language-javascript theme-code-block"><div class="codeBlockContent_csEI javascript"><pre tabindex="0" class="prism-code language-javascript codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token keyword" style="color:#00009f">function</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">getProxyAdmin</span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter maybe-class-name">TransparentUpgradeableProxy</span><span class="token parameter"> proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token keyword" style="color:#00009f">public</span><span class="token plain"> view virtual </span><span class="token function" style="color:#d73a49">returns</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token parameter">address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">{</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">bool success</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> bytes memory returndata</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token function" style="color:#d73a49">address</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">proxy</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">staticcall</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">hex</span><span class="token string" style="color:#e3116c">&quot;f851a440&quot;</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token function" style="color:#d73a49">require</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">success</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token keyword control-flow" style="color:#00009f">return</span><span class="token plain"> abi</span><span class="token punctuation" style="color:#393A34">.</span><span class="token method function property-access" style="color:#d73a49">decode</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">returndata</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">address</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">)</span><span class="token punctuation" style="color:#393A34">;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token punctuation" style="color:#393A34">}</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_y2LR" id="uups">UUPS<a class="hash-link" href="#uups" title="Direct link to heading">​</a></h2><p><img src="data:image/jpeg;base64,/9j/4AAQSkZJRgABAQAAAQABAAD/4gIoSUNDX1BST0ZJTEUAAQEAAAIYAAAAAAQwAABtbnRyUkdCIFhZWiAAAAAAAAAAAAAAAABhY3NwAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAA9tYAAQAAAADTLQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAlkZXNjAAAA8AAAAHRyWFlaAAABZAAAABRnWFlaAAABeAAAABRiWFlaAAABjAAAABRyVFJDAAABoAAAAChnVFJDAAABoAAAAChiVFJDAAABoAAAACh3dHB0AAAByAAAABRjcHJ0AAAB3AAAADxtbHVjAAAAAAAAAAEAAAAMZW5VUwAAAFgAAAAcAHMAUgBHAEIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAFhZWiAAAAAAAABvogAAOPUAAAOQWFlaIAAAAAAAAGKZAAC3hQAAGNpYWVogAAAAAAAAJKAAAA+EAAC2z3BhcmEAAAAAAAQAAAACZmYAAPKnAAANWQAAE9AAAApbAAAAAAAAAABYWVogAAAAAAAA9tYAAQAAAADTLW1sdWMAAAAAAAAAAQAAAAxlblVTAAAAIAAAABwARwBvAG8AZwBsAGUAIABJAG4AYwAuACAAMgAwADEANv/bAEMAAwICAgICAwICAgMDAwMEBgQEBAQECAYGBQYJCAoKCQgJCQoMDwwKCw4LCQkNEQ0ODxAQERAKDBITEhATDxAQEP/bAEMBAwMDBAMECAQECBALCQsQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEBAQEP/AABEIAEcBDwMBIgACEQEDEQH/xAAbAAEBAQEBAQEBAAAAAAAAAAAABwYIBQQBCf/EAEMQAAAFAwIBBgoJBAEEAwAAAAECAwQFAAYHCBESExYYWJbTFBchOFZXd5e11QkVIiMxQZWk0jI3hbZ1JTM2YYGltP/EABoBAQACAwEAAAAAAAAAAAAAAAADBAECBQb/xAAvEQEAAQICBQwCAwAAAAAAAAAAAQIDERQhUVKh4QQFEhUyQXGBkcHR8BOxMTNC/9oADAMBAAIRAxEAPwDrPTJpk02z+m3E87O6fMayMlI2PBO3jx3abBZdyuowRMoqooZITHOYwiYTCIiIiIj5apfRO0sdWnFXY2O7mmk7zWMN+z+3vhyFVWglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mnRO0sdWnFXY2O7mqrSglXRO0sdWnFXY2O7mmk7zWMN+z+3vhyFVWpVpO81jDfs/t74chQVWlKUEf1WRMVP4laQU7GNJGNkb4sho8Zu0SrIOUFLojCqJKJmASnIYoiUSiAgICIDX19E7Sx1acVdjY7uaalv7dRHtAsT/aouqrQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzTonaWOrTirsbHdzVVpQSronaWOrTirsbHdzXNX0j2nrAVjaMch3TZWD8f2/NMvqnwaRi7ZZNHSHHKtCH4FU0ynLxEOYo7D5SmEB8gjXdVcq/Sj+Ynk3/C/GGVBVdJ3msYb9n9vfDkKqtSrSd5rGG/Z/b3w5CqrQKUpQKUqEazZibhsRxh4Fe5CrPb0tiPWQtyUPHSL1svLNklmqDgiqIpnVTOZMBFVMPt+UxQ8oBd6Vx1H3HqGxI3lJa3LRnWUPddw27blrQOS7oNMPGjlwq4Teu1HKTlyoRDYzcSpCsob7o/CBOIArTN9QWbvrIk86iLNG0yX4ljZVBJs7+sjvxXBkpIl3V4Abg7HiBuJROLcBOKoD5BDp+lceWvrIydcFv3hdji07TbRuJpdhb98lRdmcHVcg/5GTdshIr9hoi1+/IKoCYxgUIOwpG36Dw3kKXydFXDczpi0bw6VyyUVAKIgbidMWavgxnCgiIgIncIuRKJQABT5Mdh3ERCgUpSgUpSgVKtJ3msYb9n9vfDkKqtcv6ZNQmP4XTbiiGew+RTuGFjwTZUzXG1xOkTHIwRKYU1kmJk1SbgOxyGMUwbCURAQGg6gpUjU1S4rROKSsVkwpg/EPFZdHk/+vrCZx1cx0JiG67jxQzvBG54SOPKszTmLLmKwOVuYFVU1zmZplTIdIiifKGUIUgnA4mACiNBQtS39uoj2gWJ/tUXVVr+d1hfSH2pq0seLs1xYE5bt2sr2sVy6BFE7yMMQLqjA4gclL9yI7CIFVAobiBSnOav6I0ClKUClKUClSDLc7NxmbcGRMdMPWrGXnplGQbIuDkSeJkg3ipCKkAdlClUIQ4AYBADFAQ8oANZfM2dMr2xc9+NMbw9qGisVWi3u64BnhX5eUKsDtQrVoZM5St9kmKu66gKF4zlLwbFMYA6HpXLslqYys8l2102rb1qDYRsgwlhLISAuSzBTO1Wibh15DAmUSKOjJlREoj9jlBMIDwV4uL8/5kvBg4jMfRNrA2syKSmZ4bmkXariRB1JSCREGzlRb7gCJMTm5ZYVCcRipgUpSiYA68pSlApSlArlX6UfzE8m/wCF+MMq6qrlX6UfzE8m/wCF+MMqCq6TvNYw37P7e+HIVValWk7zWMN+z+3vhyFVWgUpSgV4l2WXbN8smUddMb4a3jpRjNNicsonybxm4I4bK7kMUR4FUyG4R3KO2xgEBEK9ulB49yWjb13EjU7hj/CyxEk3l2YcqdPknaBuJJT7Bg4uER/pHco/mA1i3WnLEzu+nGRFYeVLKunYyKiSU8/SY+HCgKHhpWZFgblc8kIlBYpAUD8QMBvLVMpQRa49MlkR1hzFuYjtqDgJOTtLmOVZ8Lpwz+qjGNuDhAFQ8KUICqxinUEVBMocBUAFD70bHFhwWLrAt3HNspCnFW1GN4toBv6jJopgQDGH8zG24jD+YiI1o6UClKUClKUCpVpO81jDfs/t74chVVqVaTvNYw37P7e+HIUFVrLZPxra2X7FlMcXsi8WgpoEk36LV4o1UWSIqRQUhUSEpwIfgApgKIblMYN/LWppQQjLWO7ExdheAtHHVpRVuw7bIFiCmzjmxUU+LnTFbnNwhuc47eU5tzCPlERGrvUq1Lf26iPaBYn+1RdVWgUpXjXpLubfs6dnmYFFeNjHTxIDBuAnTSMYN/8A1uAVtTTNdUUx3sVT0Yxl7NKjhbDtVYoKzEGxl3hg3WeSDcjhZY/5mMY4CPlH8g8gfgAAFfvi/sL0IgP01H+NdHIUbe7ipZurZ38GsyZhvH+XiQ4XzHSSykA6UeRriOm30W4bLHSMkcxVmaySn2kznKICbYQMPkrJSOkjB8sRmnJQ9xOitWgxy3L3fLqmkWQrHX8FfGO5Ez1AFFDmBJcTkADmKAAUwlH98X1hehEB+mo/xp4vrC9CID9NR/jTIUbc+nEzdWzv4MddmkxzdubW2QHTuCbQze6467tmp5BJyo5ZkS5MqjUrjwFRYVES7uxS5XkRFLYf6x3LzStgt64i11bPcphEo+CpoozT5JF0h4Ud2CLtMqwEdpFcKqKFIuChSmObYAARCvn8X1hehEB+mo/xp4vrC9CID9NR/jTIUbc+nEzdWzv4LFSo74v7C9CID9NR/jTxfWF6EQH6aj/GmQo259OJm6tnfwWKlSeAZNLSu+Bb263TYM5lysxds0C8CBtmqyxVATD7JTgKO24AAiBx338m1Yqnyix+CqIxxxjFZs3fy044YFcq/Sj+Ynk3/C/GGVdVVyr9KP5ieTf8L8YZVAlVXSd5rGG/Z/b3w5CqrXP+J4jVPi/Flm4z8V+KpPmlb8dBeG+MSRR8K8FbJo8ryf1Gbg4uT4uHiNtvtuO29avnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq0qVc49U/qbxV7y5H5FTnHqn9TeKveXI/IqCq1KtJ3msYb9n9vfDkKc49U/qbxV7y5H5FWgwhZUrjXC9g45nXDReStW14qEeKtDmMgou2aJoqGTMYpTCQTEEQESlHbbcA/Cg2tKUoJVqW/t1Ee0CxP9qi6qtT/OlnXVfOPyxFlJRS00yuC3p1sjKPFGjVf6umGb46R1k0ljp8ZGpiAYEj7GMG4bb15XOPVP6m8Ve8uR+RUFVrL5S/tld3/Av/AP8AOeslzj1T+pvFXvLkfkVeFfk/qSWse4kZ3E+NWcaeJdleOGmQn7ldFAUTcodNI0KmVQ4F3ECCoQDCAAJi77hLY/tp8Y/bS72J8GvrKXVfiVr3dZVpnjDODXlIuo8i4K8INhQYruuIS7Dx7ggJdtw24t/y2rV1isl4vaZICBdlumctuWtmSGTjJSHM38IRUMgq3UKJXCSqRyHSXUKIGIP4gIbCFdqrHDQ5cYY6UwLqjumbcEY2JhtWcdFjJaXcFUnU2pE27CTXYHKUwpG4lVBQ4yF2Ao8QgYxeHiErq0M/Sb3PZ2NnM5ZCktAwi8+WVSRMk6lQZmTErcSiJ0kyv24GPxAPKGEgFEAEweW30hLxVysIi2cl3nCWwytR7CrPmz5opIPjPJJV24RWFZucOEeVHhVIUqhdg2PuJhN5dw6YbnTvJtbVhM3kDYgXHbs4qk3nkhj1CRnge4qtDtzOPCBIyKiUE1wRN92qcOMmww43EuFGLUn1TzRbMk76dY3jYaHQuNzbsfIT92to5m5M2XdoruVljkHkEgO1KQgcJ1DnV2AgFLxj5z7VpLXTYzaYxRjhxNyLi1H1zSBAlUEvqpuiss2KKYmKYro5lm6/Jl2IU5URETBuAVuX+m+21YO3YqEu+5IV5as9KXDFyjYWazlFxIKuVHJRK4bqIiXZ4sUginxFAC7G3ARNng0fWw1hG8FDZQv2LSKykYh4u2dMxcP4x45O4UaLKKNjCIFUVVEipdligof7YiO4ZmLjGNDFwGue3GLi3rbuAIh6umjb8dOPFrhZtZJSQkG7YwqtYwQBRwgQzogqnIJeH7zgKfkzbdYVF4bS7bttS7d1bWQ71ioflYx1IwjV43TaybpigigisscEeXKJk2yAKkSUTTV5MOIuwmA1oraiKo7TWvo/5fCr/wCYWZ/y6/w15VRqMXa5uppJ2s4sqGipWaJLqeDM5STUj2qu7B2B+Nwmg4OTYgmENkjbmACjwgImD0uceqf1N4q95cj8iqlzh26fD3la5H2avH2hVa5V+lH8xPJv+F+MMqqvOPVP6m8Ve8uR+RVKtUeL9U+pTBNzYU5h4qtznH4F/wBT5+yLzkPB3iDn/s/UqfFxchw/1htxb+XbYaC26qpSlApSlApSlApSlApSlApSlApSlApSlApSlApSlAry7qhhuO2Ji3irAkMowcMgUENwJyiZib//ABxUpWaappmKo7mJiKowlGn+W7RtxyaHvF+aJl2/2HLYUFFgKcPxEp0ymKJR/Ly77fiAD5K+fx74p9Kv2Lnu6Ur3Fjm+1etU3JmcZiJ+6HmLvKq7dc0Rhok8e+KfSr9i57unj3xT6VfsXPd0pUvVdnXO74R525qj75nj3xT6VfsXPd08e+KfSr9i57ulKdV2dc7vgztzVH3zPHvin0q/Yue7p498U+lX7Fz3dKU6rs653fBnbmqPvm0ljyrLItxRU5baorRECuq5VdmKJOUWM3URKkUhtj/gscwiIAH2QAN9/JXaUryPOcdHlNVuP4p0R+/d6HkWmzFffOkpSlc9bf/Z"></p><p>UUPS 的規格和介面是基於 EIP-1822，不過 Openzeppelin 也是和 EIP-1967 搭配作為實作。Transparent Proxy 最大的差異在做 upgrade 的函式同樣也放在邏輯合約中，讓 Proxy 只留 fallback 和 receive。升級合約也需要透過 delegatecall 調用邏輯合約。合約架構更為精簡，不用額外的身份驗證或是額外的 Admin 合約。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="diamond">Diamond<a class="hash-link" href="#diamond" title="Direct link to heading">​</a></h2><p><img src="/assets/images/diamond-b43ece3c1e273bb17fe9da9842389c4c.jpeg"></p><p>Diamond 怎麼升級跟 Transparent Proxy 跟 UUPS 截然不同。Transparent Proxy 跟 UUPS 每次更新都需要將整份合約更新，除了不需要更新的部分也連帶更新了，而且因為合約大小有上限 (EIP-170) 也不能在單個合約一直增加新的邏輯。所以有人提出了 EIP-2535，主要是建立一張表來註冊不同的 function selector。有趣的地方在於可以註冊不同合約的 function selector。也就是說 delegatecall 可以調用的合約不只限於一個。除了彈性變大之外，也可以只新增或是修改其中一個 function selector。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="reference">Reference<a class="hash-link" href="#reference" title="Direct link to heading">​</a></h2><ul><li>EIPS<ul><li><a href="https://eips.ethereum.org/EIPS/eip-7" target="_blank" rel="noopener noreferrer">EIP-7 Delegatecall</a></li><li><a href="https://eips.ethereum.org/EIPS/eip-170" target="_blank" rel="noopener noreferrer">EIP-170 Contract code size limit</a></li><li><a href="https://eips.ethereum.org/EIPS/eip-1167" target="_blank" rel="noopener noreferrer">EIP-1167 Minimal Proxy Contract</a><ul><li>進階閱讀: <a href="https://blog.openzeppelin.com/deep-dive-into-the-minimal-proxy-contract/" target="_blank" rel="noopener noreferrer">Deep dive into the Minimal Proxy contract</a></li></ul></li><li><a href="https://eips.ethereum.org/EIPS/eip-1822" target="_blank" rel="noopener noreferrer">EIP-1822 Universal Upgradeable Proxy Standard (UUPS)</a></li><li><a href="https://eips.ethereum.org/EIPS/eip-1967" target="_blank" rel="noopener noreferrer">EIP-1967 Standard Proxy Storage Slots</a></li><li><a href="https://eips.ethereum.org/EIPS/eip-2535" target="_blank" rel="noopener noreferrer">EIP-2535 Diamonds, Multi-Facet Proxy</a></li></ul></li><li><a href="https://blog.soliditylang.org/2020/03/26/fallback-receive-split/" target="_blank" rel="noopener noreferrer">Solidity 0.6.x features: fallback and receive functions</a></li><li><a href="https://blog.openzeppelin.com/the-transparent-proxy-pattern/" target="_blank" rel="noopener noreferrer">OpenZeppelin Blog: The transparent proxy pattern</a></li><li><a href="https://blog.openzeppelin.com/deconstructing-a-solidity-contract-part-iii-the-function-selector-6a9b6886ea49/" target="_blank" rel="noopener noreferrer">Deconstructing a Solidity Contract — Part III: The Function Selector</a></li><li><a href="https://medium.com/taipei-ethereum-meetup/uups-proxies-%E4%BD%BF%E7%94%A8%E6%96%87-6210c81a946f" target="_blank" rel="noopener noreferrer">UUPS Proxies 使用文</a></li></ul></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/eip-2535">eip2535</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/diamond">diamond</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/proxy">proxy</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lun-dao/LunDAO/tree/main/blog/2022-04-20-diamond101/diamond101-1.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/hardhat-intro"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->Hardhat 簡介</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/hardhat-forking-1"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Hardhat mainnet forking：主網分叉 (1)<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#proxy-的組成" class="table-of-contents__link toc-highlight">Proxy 的組成</a><ul><li><a href="#delegatecall" class="table-of-contents__link toc-highlight">Delegatecall</a></li><li><a href="#fallback-與-receive" class="table-of-contents__link toc-highlight">fallback 與 receive</a></li></ul></li><li><a href="#transparent-proxy" class="table-of-contents__link toc-highlight">Transparent Proxy</a></li><li><a href="#uups" class="table-of-contents__link toc-highlight">UUPS</a></li><li><a href="#diamond" class="table-of-contents__link toc-highlight">Diamond</a></li><li><a href="#reference" class="table-of-contents__link toc-highlight">Reference</a></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">關於</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>關於 LunDAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/publish-guideline">投稿文章</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">閱讀文章</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/request-for-article">文章提案</a></li><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>社群貢獻指南<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">DAO治理</div><ul class="footer__items"><li class="footer__item"><a href="https://coordinape.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>貢獻投票 (Coordinape)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://snapshot.org/#/lundao.eth" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>治理投票 (Snapshot)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/treasury">社群金庫</a></li></ul></div><div class="col footer__col"><div class="footer__title">社群</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>討論區<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/9s3RQmajBu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 LunDAO. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67d47840.js"></script>
<script src="/assets/js/main.2d5310ba.js"></script>
</body>
</html>