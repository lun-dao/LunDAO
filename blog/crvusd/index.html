<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.14">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="LunDAO RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="LunDAO Atom Feed">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.24/dist/katex.min.css" integrity="sha384-odtC+0UGzzFL/6PNoE8rX/SPcQDXBJ+uRepguP4QkPCm2LBxH3FA3y+fKSiJ+AmM" crossorigin="anonymous"><title data-react-helmet="true">LLAMMA - crvUSD 的新清算機制 | LunDAO</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://lundao.tech/blog/crvusd"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" property="og:title" content="LLAMMA - crvUSD 的新清算機制 | LunDAO"><meta data-react-helmet="true" name="description" content="LLAMMA 是 Curve 團隊發表的穩定幣 crvUSD 的新清算方式，本文將會講解 LLAMMA 清算方式以及 crvUSD 的穩定機制。"><meta data-react-helmet="true" property="og:description" content="LLAMMA 是 Curve 團隊發表的穩定幣 crvUSD 的新清算方式，本文將會講解 LLAMMA 清算方式以及 crvUSD 的穩定機制。"><meta data-react-helmet="true" property="og:image" content="https://lundao.tech/assets/images/liquidation-of-LLAMMA-54449a8ac1ba84dd3c2711f048425154.png"><meta data-react-helmet="true" name="twitter:image" content="https://lundao.tech/assets/images/liquidation-of-LLAMMA-54449a8ac1ba84dd3c2711f048425154.png"><meta data-react-helmet="true" property="og:type" content="article"><meta data-react-helmet="true" property="article:published_time" content="2022-12-05T00:00:00.000Z"><meta data-react-helmet="true" property="article:author" content="https://yurenju.medium.com/"><meta data-react-helmet="true" property="article:tag" content="curve,crvusd,llamma,amm"><link data-react-helmet="true" rel="icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://lundao.tech/blog/crvusd"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/crvusd" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://lundao.tech/blog/crvusd" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.ba61c7d6.css">
<link rel="preload" href="/assets/js/runtime~main.67d47840.js" as="script">
<link rel="preload" href="/assets/js/main.2d5310ba.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"light")}()</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_OuoZ">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><div class="navbar__logo"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--light_4Vu1"><img src="/img/logo.svg" alt="My Site Logo" class="themedImage_TMUO themedImage--dark_uzRr"></div><b class="navbar__title">LunDAO</b></a><a class="navbar__item navbar__link" href="/docs/publish-guideline">關於</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">文章</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link"><span>DAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a><div class="toggle_iYfV toggle_2i4l toggleDisabled_xj38"><div class="toggleTrack_t-f2" role="button" tabindex="-1"><div class="toggleTrackCheck_mk7D"><span class="toggleIcon_pHJ9">🌜</span></div><div class="toggleTrackX_dm8H"><span class="toggleIcon_pHJ9">🌞</span></div><div class="toggleTrackThumb_W6To"></div></div><input type="checkbox" class="toggleScreenReader_h9qa" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><aside class="col col--3"><nav class="sidebar_q+wC thin-scrollbar" aria-label="Blog recent posts navigation"><div class="sidebarItemTitle_9G5K margin-bottom--md">Recent posts</div><ul class="sidebarItemList_6T4b"><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/end-of-lundao">LunDAO 的結尾</a></li><li class="sidebarItem_cjdF"><a aria-current="page" class="sidebarItemLink_zyXk sidebarItemLinkActive_wcJs" href="/blog/crvusd">LLAMMA - crvUSD 的新清算機制</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-4">Diamond 101 (4)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-2">Diamond 101 (2)</a></li><li class="sidebarItem_cjdF"><a class="sidebarItemLink_zyXk" href="/blog/diamond101-3">Diamond 101 (3)</a></li></ul></nav></aside><main class="col col--7" itemscope="" itemtype="http://schema.org/Blog"><article itemprop="blogPost" itemscope="" itemtype="http://schema.org/BlogPosting"><header><h1 class="blogPostTitle_d4p0" itemprop="headline">LLAMMA - crvUSD 的新清算機制</h1><div class="blogPostData_-Im+ margin-vert--md"><time datetime="2022-12-05T00:00:00.000Z" itemprop="datePublished">December 5, 2022</time> · <!-- -->25 min read</div><div class="row margin-top--md margin-bottom--sm"><div class="col col--6 authorCol_8c0z"><div class="avatar margin-bottom--sm"><a href="https://yurenju.medium.com/" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img class="image_9q7L" src="https://github.com/yurenju.png" alt="Yuren Ju"></a><div class="avatar__intro" itemprop="author" itemscope="" itemtype="https://schema.org/Person"><div class="avatar__name"><a href="https://yurenju.medium.com/" target="_blank" rel="noopener noreferrer" itemprop="url"><span itemprop="name">Yuren Ju</span></a></div><small class="avatar__subtitle" itemprop="description">Individual Researcher</small></div></div></div></div></header><meta itemprop="image" content="https://lundao.tech/assets/images/liquidation-of-LLAMMA-54449a8ac1ba84dd3c2711f048425154.png"><div class="markdown" itemprop="articleBody"><p>2022 年底 FTX 大爆炸的同時，Curve 團隊釋出了最新的 crvUSD 穩定幣設計白皮書。在這份白皮書裡面提出了新的穩定幣清算機制 LLAMMA (Lending-Liquidating AMM Algorithm)，而這樣的清算機制其實不只可以用在穩定幣上面，其他有清算需求的專案也都可以參考這樣的設計。除了清算機制以外，白皮書內也提及了如何跟美金錨定的穩定機制與合約 PegKeeper。</p><p>本篇文章會著重解釋 LLAMMA 的機制，並且透過 curve-stablecoin 裡面的源碼以及測試案例來解釋 crvUSD 清算機制，並且概略的提到 crvUSD 的穩定機制。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="前情提要">前情提要<a class="hash-link" href="#前情提要" title="Direct link to heading">​</a></h2><p>在進入正題前，我們會先解釋一些相關的概念來幫助讀者進入主題，以下會先解釋抵押品穩定幣、DAI 的清算方式以及傳統 AMM 的運作方式。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="抵押品穩定幣">抵押品穩定幣<a class="hash-link" href="#抵押品穩定幣" title="Direct link to heading">​</a></h3><p>首先 crvUSD 是一個抵押品穩定幣，這也代表所鑄造出來的 crvUSD 背後都有超過發行額度的抵押品來支撐價值，同時在抵押品價格下跌時會觸發清算程序來確保穩定幣背後都有足夠的價值支撐，最著名的抵押品穩定幣為 MakerDAO 的 DAI。</p><p>相對於抵押品穩定幣的是算法穩定幣，透過演算法而非抵押品來保證穩定幣與美金的錨定，這類穩定幣近期最著名的是 Terra 的 UST。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="dai-的清算方式">DAI 的清算方式<a class="hash-link" href="#dai-的清算方式" title="Direct link to heading">​</a></h3><p>DAI 是透過超額抵押的方式提供穩定幣價值支撐的抵押品穩定幣。比如說當使用者抵押 3500 等值美金的 ETH 時，可以鑄造出 2000 美金等值的 DAI。但如果 ETH 價格下跌到一定程度時，使用者的抵押品就會被標記成可清算。</p><p>這個清算過程中，抵押品如 ETH 會用折扣的方式出售，所有人都可以來參與折扣的抵押品競標。比如說在 ETH 價格為 2900 美金時，系統會以 2800 美金的價格出售，這就會吸引套利者前來競標。</p><p>當清算結束後，如果抵押品拍賣的價格比較好，其中一部分的抵押品可能就不會被清算掉，此時就會還給債務人。但是大部分的抵押品通常都會被清算導致損失慘重，即使價格回穩，但清算已經造成傷害。</p><p><img alt="traditional liquidation.png" src="/assets/images/traditional-liquidation-a640d1627bd418a2e8130a27e3245a94.png"></p><p>接下來會講解傳統的 AMM 運作方式作為 LLAMMA 的特殊設計 AMM 的對照參考。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="傳統-amm-的運作方式">傳統 AMM 的運作方式<a class="hash-link" href="#傳統-amm-的運作方式" title="Direct link to heading">​</a></h3><p>以 Uniswap V3 為例，使用者可以透過 Range Order 的方式來提供流動性。比如說當 ETH 為 3000 USD 時，使用者可以把 1 ETH + 0 USD 放入 Uniswap V3 裡面，並且指定在 3200 - 3800 USD 的區間換成 USD。</p><p><img alt="tranditional-AMM.png" src="/assets/images/tranditional-AMM-61827a9c7dbeeb7f14fa826474c39db5.png"></p><p>當 ETH 進入上述區間之後，1 ETH 就會慢慢的被換成 USD，當超過 3800 USD 時，所有的 ETH 都會被換成 USD，這個效果很像在中心化交易所當中從 3200 一路掛限價單 (Limit Order) 到 3800 USD 的效果。</p><p>但跟限價單不同的是如果此時價格又跌回 3000 後，在 Uniswap v3 上面所有的 USD 又會被換回 ETH。</p><p>反方向來說，使用者也可以提供比如 3000 USD + 0 ETH，並且指定佈署在 2000 - 2500 USD 的區間，當價格下跌時，USD 就會逐漸的被換成 ETH，直到低於 2000 USD 時，所有的 USD 都會被換成 ETH。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="llamma">LLAMMA<a class="hash-link" href="#llamma" title="Direct link to heading">​</a></h2><p>crvUSD 跟 DAI 一樣也是抵押品穩定幣，但新設計了一種清算演算法 LLAMMA，其結合 AMM 的特性讓抵押品在價格下跌時逐漸轉移成穩定幣，讓原本要清償的債務有一定程度的穩定幣可以償還，同時在價格回穩時再逐漸把穩定幣換回抵押品，而不是硬生生的觸發清算導致債務人的虧損。</p><p>鑄造 crvUSD 的時候同樣的會需要存入抵押品如 ETH 到智能合約來，不一樣的是這個抵押品會被放入一個 LLAMMA 特殊設計的 AMM 當中。跟 Uniswap 的 Range Order 一樣，剛存入抵押品到 AMM 時會以單邊的形式存在，而當抵押品價格下跌到一定程度時，就會逐漸換成穩定幣。</p><p>舉例來說當 ETH 價格為 3000 美金的時候，使用者可以抵押 1 ETH 到系統的智能合約裡面。此時系統會鑄造出 crvUSD 給使用者，同時抵押的 1 ETH 會被類似 Uniswap v3 的方式被放入一個特殊的 AMM 裡面，比如說流動性會被放在 500-550 USD 這個區間當中，而所取得的 LP 代幣則會只有單邊的 1 ETH + 0 crvUSD 流動性。</p><p><img alt="liquidity-of-LLAMMA.png" src="/assets/images/liquidity-of-LLAMMA-257b1cd61a7cf5a0d0c23633505753da.png"></p><p>當 ETH 價格跌到 550 USD 以下時，系統會開始慢慢的把 ETH 換成 crvUSD，當跌到 500 USD 以下時，所有的流動性就會變成 crvUSD。當價格跌到這個區間時，系統將會用比市場上更便宜的價格售出 ETH，此時就會吸引市場上的人來到這個特殊的 AMM 裡面來買 ETH 來獲得折扣價。</p><p>因為系統會逐漸的把抵押品 ETH 換成穩定幣 crvUSD，所以就不會像 DAI 一樣到硬清算門檻後就直接把所有抵押品都清算掉。更進一步的是當抵押品 ETH 的價格如果回穩後，使用者的流動性又會逐漸的從穩定幣 crvUSD 換成 ETH。</p><p><img alt="liquidation-of-LLAMMA.png" src="/assets/images/liquidation-of-LLAMMA-54449a8ac1ba84dd3c2711f048425154.png"></p><p>不過這個換回抵押品的過程也可能出現 Path-Dependence 的問題，我們在最後的<strong>結論與疑問</strong>章節來討論這個問題。</p><p>這邊有三件事情要特別注意：</p><ol><li>LLAMMA 跟傳統 AMM 的方向相反：傳統 AMM 放入單邊資產之後，要價格提升才可以換成另外一邊，而 LLAMMA 的特殊 AMM 則是價格下跌之後才會換成另外一個資產（穩定幣）</li><li>LLAMMA 需要依賴外部的預言機 (Oracle) 價格：因為 LLAMMA 需要賣的比外面的更便宜，所以會需引入預言機價格，才可以知道有流動性的時候要如何折扣定價來吸引套利者，外部價格跟內部價格差距越大時，<strong>LLAMMA 就會給出更多折扣</strong>。 </li><li>crvUSD 還是有清算機制：雖然可以透過 LLAMMA 的特殊 AMM 逐漸轉換成穩定幣，但是如果債務健康狀況太糟糕，還是會有最後的清算機制</li></ol><h2 class="anchor anchorWithStickyNavbar_y2LR" id="透過測試案例解釋實際運作方式">透過測試案例解釋實際運作方式<a class="hash-link" href="#透過測試案例解釋實際運作方式" title="Direct link to heading">​</a></h2><p>crvUSD 除了白皮書以外也釋出了<a href="https://github.com/curvefi/curve-stablecoin" target="_blank" rel="noopener noreferrer">源碼</a>，其中的測試案例 <a href="https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L9" target="_blank" rel="noopener noreferrer">test_create_loan</a> 正好覆蓋了整個借款過程，這邊利用這個測試案例來解釋整個流程會更容易理解。</p><p>為了得到更多資訊，我 fork 了原本的源碼並且在目標的測試案例裡面印出了更多資訊（不太熟悉 Vyper 環境，只能用比較土砲的作法），有興趣的可以參考下面的 commit 了解我做了什麼修改：</p><p><a href="https://github.com/yurenju/curve-stablecoin/commit/c3bf52353f41914deb82f1c1c97dcbc5de2d72e4" target="_blank" rel="noopener noreferrer">https://github.com/yurenju/curve-stablecoin/commit/c3bf52353f41914deb82f1c1c97dcbc5de2d72e4</a></p><p>首先要先解釋一下波段 (band)。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="波段-band">波段 (band)<a class="hash-link" href="#波段-band" title="Direct link to heading">​</a></h3><p>波段是當使用者把抵押品存入系統時，抵押品會被存入的區段，當預言機價格移動到這個區間時，使用者的抵押品就會開始被轉換成穩定幣。而剛開始建立 AMM 時會根據預言機的價格切分波段，其中預言機價格所在的波段會是波段 0 (band 0)，預言機價格越低，波段編號越高。</p><p><img alt="bands-and-oracle-price.png" src="/assets/images/bands-and-oracle-price-20be22f01f9c17e5000584d1a51b0f32.png"></p><p>比如說創建 AMM 的時候預言機報價 3000 USD，此時波段 0 的價格帶會是 2970 - 3000，而波段 1 的價格帶是 2970.0 - 2940.3。而由於目前價格落在波段 0，所以 <code>AMM.active_band()</code> 就會回傳 0。</p><p>至於每個區間的價格寬度則由 AMM 建構子所傳入的 A (Amplification) 決定，公式為：</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mrow><mfrac><msub><mi>p</mi><mo lspace="0em" rspace="0em">↓</mo></msub><msub><mi>p</mi><mo lspace="0em" rspace="0em">↑</mo></msub></mfrac><mo>=</mo><mfrac><mrow><mi>A</mi><mo>−</mo><mn>1</mn></mrow><mi>A</mi></mfrac></mrow><annotation encoding="application/x-tex">\frac{p_{\downarrow}}{p_{\uparrow}}=\frac{A-1}{A}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.0797em;vertical-align:-0.9721em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.1076em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">↑</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">↓</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9721em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:2.0463em;vertical-align:-0.686em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.3603em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span></span></span></span></span></div><p>舉例來說，當價格上界 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mo>↑</mo></msub></mrow><annotation encoding="application/x-tex">p_\uparrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">↑</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span></span> 為 3000 而 A 為 100 時，價格下界 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mo>↓</mo></msub></mrow><annotation encoding="application/x-tex">p_\downarrow</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.7167em;vertical-align:-0.2861em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mrel mtight">↓</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span></span> 則為：</p><div class="math math-display"><span class="katex-display"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML" display="block"><semantics><mtable rowspacing="0.25em" columnalign="right left" columnspacing="0em"><mtr><mtd><mstyle scriptlevel="0" displaystyle="true"><msub><mi>p</mi><mo lspace="0em" rspace="0em">↓</mo></msub></mstyle></mtd><mtd><mstyle scriptlevel="0" displaystyle="true"><mrow><mrow></mrow><mo>=</mo><mfrac><mrow><msub><mi>p</mi><mo lspace="0em" rspace="0em">↑</mo></msub><mo stretchy="false">(</mo><mi>A</mi><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mi>A</mi></mfrac><mo>=</mo><mfrac><mrow><mn>3000</mn><mo stretchy="false">(</mo><mn>100</mn><mo>−</mo><mn>1</mn><mo stretchy="false">)</mo></mrow><mn>100</mn></mfrac><mo>=</mo><mn>2970</mn></mrow></mstyle></mtd></mtr></mtable><annotation encoding="application/x-tex">\begin{aligned} p_{\downarrow} &amp;=\frac{p_{\uparrow}(A-1)}{A} =\frac{3000(100-1)}{100} = 2970 \end{aligned}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:2.413em;vertical-align:-0.9565em"></span><span class="mord"><span class="mtable"><span class="col-align-r"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4565em"><span style="top:-3.4565em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">↓</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9565em"><span></span></span></span></span></span><span class="col-align-l"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.4565em"><span style="top:-3.4565em"><span class="pstrut" style="height:3.427em"></span><span class="mord"><span class="mord"></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord mathnormal">A</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.3361em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mtight"><span class="mrel mtight">↑</span></span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.2861em"><span></span></span></span></span></span></span><span class="mopen">(</span><span class="mord mathnormal">A</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord"><span class="mopen nulldelimiter"></span><span class="mfrac"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:1.427em"><span style="top:-2.314em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">100</span></span></span><span style="top:-3.23em"><span class="pstrut" style="height:3em"></span><span class="frac-line" style="border-bottom-width:0.04em"></span></span><span style="top:-3.677em"><span class="pstrut" style="height:3em"></span><span class="mord"><span class="mord">3000</span><span class="mopen">(</span><span class="mord">100</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mbin">−</span><span class="mspace" style="margin-right:0.2222em"></span><span class="mord">1</span><span class="mclose">)</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.686em"><span></span></span></span></span></span><span class="mclose nulldelimiter"></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span><span class="mord">2970</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.9565em"><span></span></span></span></span></span></span></span></span></span></span></span></div><p>每個波段的價格下界正好會接著上個波段的價格上界形成一個連續的流動性區間，如果想知道該波段所代表的預言機價格上下界，可以用以下兩個函式查詢： </p><ul><li><code>AMM.p_oracle_up(band_number)</code></li><li><code>AMM.p_oracle_down(band_number)</code></li></ul><p>當每次有人借出 crvUSD 或是有人跟 AMM 交易時，系統會根據當下的外部預言機價格與目前的流動性交易情形來更新現行的區段 <code>amm.active_band</code>。</p><p>而在 <code>active_band</code> 裡面的流動性則會開始被交易，也就是抵押品可以被交易成為穩定幣，反之亦然。當 <code>active_band</code> 的流動性被交易殆盡後，會跳到下一個波段繼續交易，並且更新 <code>active_band</code> 到下一個波段。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="存入抵押品來鑄造-crvusd">存入抵押品來鑄造 crvUSD<a class="hash-link" href="#存入抵押品來鑄造-crvusd" title="Direct link to heading">​</a></h3><p>根據測試案例 <a href="https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L9" target="_blank" rel="noopener noreferrer">test_create_loan</a> 的前置條件如下：</p><ul><li>抵押品為 WETH，目前<a href="https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/conftest.py#L9" target="_blank" rel="noopener noreferrer">價格為 3000 USD</a></li><li>穩定幣為 crvUSD</li></ul><p>使用者呼叫 <code>Controller.create_loan(collateral, debt, number_of_bands)</code> 來鑄造穩定幣，存入了 <a href="https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L15" target="_blank" rel="noopener noreferrer">1000 WETH</a>，欲<a href="https://github.com/curvefi/curve-stablecoin/blob/2a35957b578b8c74a9b7140b33960d58cb9e3ec4/tests/lendborrow/test_create_repay.py#L17" target="_blank" rel="noopener noreferrer">鑄造或是說借出 500,000 crvUSD</a>，並且將流動性佈署在 5 個波段內：</p><div class="codeBlockContainer_J+bg language-python theme-code-block"><div class="codeBlockContent_csEI python"><pre tabindex="0" class="prism-code language-python codeBlock_rtdJ thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_1zSZ"><span class="token-line" style="color:#393A34"><span class="token plain">market_controller</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">create_loan</span><span class="token punctuation" style="color:#393A34">(</span><span class="token number" style="color:#36acaa">1000</span><span class="token plain"> ETH</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">500000</span><span class="token plain"> crvUSD</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token number" style="color:#36acaa">5</span><span class="token punctuation" style="color:#393A34">)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_M3SB clean-btn">Copy</button></div></div><p>此時系統會根據抵押品數量、欲鑄造的穩定幣數量決定要把流動性放在哪五個波段內。要決定是哪五個波段，可以透過 <code>Controller.calculate_debt_n1(collateral, debt, bands)</code> 來得到上界的波段，再加上波段總數 5 就可以取得下界。</p><p>以這個例子而言，<code>calculate_debt_n1(1000 WETH, 500000 crvUSD, 5)</code> 所回傳的上界 n1 為 <code>170</code>，總共放在五個波段內，所以下界就是 <code>174</code>。</p><p>若想查詢這個連續波段的上下界的預言機價格，可以用 <code>AMM.p_oracle_up(170)</code> 跟 <code>AMM.p_oracle_down(174)</code> 取得。這個連續的波段價格上界為 543.38，下界則為 516.75。這也代表當外部的預言機價格降到這個區間時，使用者存入的抵押品會在 AMM 裡面被以比預言機報價更便宜的價格賣出，讓套利者會想要到系統內買到更便宜的抵押品獲利。</p><p>存入的抵押品將會平均的佈署在這五個波段上，也可以透過 <code>AMM.bands_y(band_number)</code> 來取得特定波段的抵押品數量，比如說 <code>bands_y(170)</code> 會得到該波段總共有 200 WETH 的抵押品，查詢 170 - 174 都會是 200 WETH。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="跟-llammas-交易折扣的-weth-抵押品">跟 LLAMMAS 交易折扣的 WETH 抵押品<a class="hash-link" href="#跟-llammas-交易折扣的-weth-抵押品" title="Direct link to heading">​</a></h3><p>curve-stablecoin 提供了許多方便的工具可以使用，如測試用的預言機讓我們可以直接修改預言機價格進行測試。</p><p>我們可以透過 <code>price_oracle.set_price(p)</code> 來改變預言機價格。這邊我們用 <code>set_price(540)</code> 把價格從 3000 改成 540，這也是波段 170 的範圍。使用 <code>p_oracle_up(170)</code> 與 <code>p_oracle_down(170)</code> 可以得知波段 170 的範圍約是  543.38 - 537.95。</p><p>此時呼叫 <code>AMM.exchange(0, 1, in_amount, 0)</code> 可以用 crvUSD 交換 WETH 資產。若使用 100 crvUSD 可以交換到約 0.185634 WETH，平均價格為 538.69 crvUSD，相較起來會比起預言機價格的 540 USD 更為便宜。</p><p>假設上面這個交易沒有進行，但是預言機價格調到 535 USD，也就是調整到波段 171 時，此時再進行同樣的交易用 100 crvUSD 交易 WETH，則平均價格則為 523.87 crvUSD，這也說明了預言機價格也會影響 AMM 的內部價格，當預言機價格變低時，AMM 拋售抵押品的價格也會進一步的降低，讓套利者願意到系統裡面來套利，進一步的協助債務人的債務有更多穩定幣支撐。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="crvusd-的穩定機制-pegkeeper">crvUSD 的穩定機制 PegKeeper<a class="hash-link" href="#crvusd-的穩定機制-pegkeeper" title="Direct link to heading">​</a></h2><p>crvUSD 除了透過 LLAMMA 來執行轉換與清算外，還有另外一個模組 PegKeeper 合約進行穩定幣的錨定功能。</p><p>這邊會使用到一個 Curve 一般的 AMM 穩定幣交易池 StableSwap，裡面的代幣對是 crvUSD 以及另外一個 LP 代幣如 3Crv 進而組合成的 MetaPool。</p><p>當 crvUSD 的價格高於 1 USD 時（比如說 crvUSD 的使用需求增加），PegKeeper 會鑄造出無抵押的 crvUSD 並且注入這個 StableSwap。此時套利者發現市場上的 crvUSD 價格高於 1 USD，但是這個 StableSwap 價格卻接近 1 USD 時就會到 StableSwap Pool 來套利，進而讓市場上的 crvUSD 價格下跌靠近 1 USD。</p><p>當 crvUSD 價格低於 1 USD 時，反過來 PegKeeper 可以從 StableSwap 抽出資金並且銷毀，並且讓套利者進來重新平衡價格，讓市場上的 crvUSD 上漲靠近 1 USD。</p><p>這個 PegKeeper 合約雖然可以鑄造與銷毀 crvUSD，但它在智能合約的邏輯限制只能夠針對特定的 StableSwap 池子注入與抽出 crvUSD  來限制用途。</p><h2 class="anchor anchorWithStickyNavbar_y2LR" id="結論與疑問">結論與疑問<a class="hash-link" href="#結論與疑問" title="Direct link to heading">​</a></h2><p>本篇文章解釋了 crvUSD 所提出的新清算方式 LLAMMA 透過 AMM 的特性進行針對債務人更友善的清算/轉換方式，並且透過測試案例來一窺 crvUSD 實際運作的方式，並且概略的解釋了 PegKeeper 透過 Curve MetaPool 來進行的穩定機制。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="llamma-清算機制">LLAMMA 清算機制<a class="hash-link" href="#llamma-清算機制" title="Direct link to heading">​</a></h3><p>LLAMMA 是個新的概念，套用了 AMM 的 range order 特性到清算機制來，確實對於債務人更有友善，當價格回穩的時候損失的程度就會大幅降低。</p><p>相較於其他具備清算流程的穩定幣與借貸平台如 MakerDAO, Compound, AAVE 來說，這些平台在清算時會需要仰賴外部的去中心化交易所 (DEX) 協助清算。當外部的 DEX 流動性不足時，穩定幣/借貸平台就有可能產生壞帳。</p><p>比如說如果有個大戶持有 1M 的 CRV 資產作為抵押需要清算時，傳統的平台會透過折扣的方式一次出清這 1M 的資產，此時如果外部 DEX 流動性不足導致滑價太高，讓參與清算的利益不足進而降低清算者參與的意願時，無人清算的狀況下就會導致壞帳。</p><p>而 LLAMMA 因為內建了流動性的關係，當資產價值下跌時，抵押品會被逐漸的換成穩定幣，而最後真的需要清算的部位就會比傳統平台要小得多。以上面的例子來說 1M 的 CRV 在價格下跌時就會逐漸的被換成穩定幣，最終真的觸及硬清算門檻時，或許只剩下 1% 的資產需要清算，對於外部 DEX 的流動性的依賴就會低很多，加強平台的自主運作能力。</p><p>但交換代幣的折扣也會帶來一些隱憂。Paradigm 的首席研究員 Dan Robinson 在 <a href="https://twitter.com/danrobinson/status/1595090420740112385" target="_blank" rel="noopener noreferrer">他的 Tweet</a> 提到 LLAMMA 會有 <strong>Path-Dependence</strong> 的問題。由於 LLAMMA 內部用的 AMM （以下稱為 LLAMM）的定價 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><mi>p</mi></mrow><annotation encoding="application/x-tex">p</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord mathnormal">p</span></span></span></span></span> 會參考外部預言機的定價 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">p_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span>，我們假設外部的預言機價格來源以及 AMM 都是 Uniswap 來解釋這個問題。</p><p>當 ETH 價格從 1000 USD 變化到 1200 USD 的過程當中，假設 LLAMM 會需要在這個區段來把穩定幣換回抵押品。這個過程中 LLAMM 有可能會在換回抵押品的過程中承受價差的損失，端看外部價格 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">p_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> 的變化速度，我們來看價格緩慢上漲跟快速上漲的兩種狀況：</p><p><strong>價格緩慢上漲</strong>：當 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">p_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> 價格緩慢上漲時，LLAMM 內部的價格會參考 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">p_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> 定價，用稍微高一點的價格收購 ETH，比如說 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub><mo>=</mo><mtext>1000 USD</mtext></mrow><annotation encoding="application/x-tex">p_o = \text{1000 USD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">1000 USD</span></span></span></span></span></span> 時賣 1010 USD ，套利者就會在 Uniswap 買 ETH，在 LLAMM 賣 ETH。ETH 賣出之後 LLAMM 內部的價格就會慢慢靠近 1000 USD，所以在這個緩慢上漲的流程中，LLAMM 池子可能會以些微折扣的方式買回 ETH，比如說均價為 1150 USD。</p><p><strong>價格快速上漲</strong>：當 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub></mrow><annotation encoding="application/x-tex">p_o</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span></span></span></span></span> 快速從 1000 USD 上漲到 1200 USD 時，快到套利者沒有在這之間進行套利。此時因為 <span class="math math-inline"><span class="katex"><span class="katex-mathml"><math xmlns="http://www.w3.org/1998/Math/MathML"><semantics><mrow><msub><mi>p</mi><mi>o</mi></msub><mo>=</mo><mtext>1200 USD</mtext></mrow><annotation encoding="application/x-tex">p_o = \text{1200 USD}</annotation></semantics></math></span><span class="katex-html" aria-hidden="true"><span class="base"><span class="strut" style="height:0.625em;vertical-align:-0.1944em"></span><span class="mord"><span class="mord mathnormal">p</span><span class="msupsub"><span class="vlist-t vlist-t2"><span class="vlist-r"><span class="vlist" style="height:0.1514em"><span style="top:-2.55em;margin-left:0em;margin-right:0.05em"><span class="pstrut" style="height:2.7em"></span><span class="sizing reset-size6 size3 mtight"><span class="mord mathnormal mtight">o</span></span></span></span><span class="vlist-s">​</span></span><span class="vlist-r"><span class="vlist" style="height:0.15em"><span></span></span></span></span></span></span><span class="mspace" style="margin-right:0.2778em"></span><span class="mrel">=</span><span class="mspace" style="margin-right:0.2778em"></span></span><span class="base"><span class="strut" style="height:0.6833em"></span><span class="mord text"><span class="mord">1200 USD</span></span></span></span></span></span>，而 LLAMM 內部的價格為了要跟上外部預言機的價格，它就會用更高的價格收購 ETH，就可以吸引套利者在 Uniswap 買 ETH 並且在 LLAMM 賣 ETH。如此一來轉換 ETH 的均價就會高於 1200 USD。</p><p>如果站在 LLAMM 池子的角度來說，價格緩慢上漲的狀況會讓收購價格比較合理，但是如果遇到快速上漲時，就會造成 LLAMM 池子承受價差損失，而這個價差損失也就是債務人的損失。</p><p>當然，如果跟完全被清算相較起來，或許這樣的價差損失還是比較小。但由於之中還有許多不確定的因素，還會需要更多的資訊來判斷可能造成的損失程度。</p><p>總體來說，LLAMMA 確實是一個可以進一步研究的新清算方法，而且不一定是穩定幣，有需要清算的場合如借貸平台或是去中心化的衍生性商品協議也可以考慮用同樣的清算方式來減低債務人在清算抵押品帶來的損失。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="pegkeeper-穩定機制">PegKeeper 穩定機制<a class="hash-link" href="#pegkeeper-穩定機制" title="Direct link to heading">​</a></h3><p>至於 PegKeeper 透過 Curve MetaPool 所進行的穩定掛勾方式，我則比較存疑。如果說 DAI 是透過升息、降息的方式調整市場熱度，PegKeeper 則是更為激進直接透過類似量化寬鬆/緊縮的方式印出鈔票投到所需的市場。當然透過智能合約的限制還是會比起量化寬鬆更為透明，但是還需要進一步深究是否有影響市場經濟所帶來的副作用。</p><p>另外一方面在這個穩定錨定用的 MetaPool 當中新鑄造的 crvUSD 是無抵押生成的，或者是說是以另外一側的 LP 代幣如 3crv 作為抵押生成，而透過套利者的搬運來讓 crvUSD 重新錨定到 1 美金，實際上會損害流動性提供者的利益。因為套利者透過價差套利時，流動性提供者就作為他的對家承受損失。</p><p>這方面還不知道交易費是否足以覆蓋價差的損失，可能還需要進一步的機制去補償流動性提供者才可以完成整個穩定機制。如果沒有獎勵機制，要如何鼓勵使用者來為 crvUSD 提供穩定機制？這也是目前白皮書並沒有涵蓋到的概念。</p><h3 class="anchor anchorWithStickyNavbar_y2LR" id="結語">結語<a class="hash-link" href="#結語" title="Direct link to heading">​</a></h3><p>但 crvUSD 目前也還沒有上線，相信未來這些疑問還可以進一步的被回答或是改善，也期待他們正式上線來驗證他們的想法。</p><p>最後如果你對本文有任何的問題，歡迎到 <a href="https://github.com/lun-dao/LunDAO/discussions/100" target="_blank" rel="noopener noreferrer">討論區</a> 提出！</p><p>文末想感謝審稿人 <a href="https://github.com/paco0x" target="_blank" rel="noopener noreferrer">@paco0x</a> 對本文的貢獻，感謝他提供了 Path-Dependence 以及 LLAMMA 減低外部流動性依賴的相關資訊。關於文章審稿的討論，請見 <a href="https://github.com/lun-dao/LunDAO/pull/101" target="_blank" rel="noopener noreferrer">Pull Request #101</a>。</p></div><footer class="row docusaurus-mt-lg blogPostDetailsFull_xD8n"><div class="col"><b>Tags:</b><ul class="tags_NBRY padding--none margin-left--sm"><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/curve">curve</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/crvusd">crvusd</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/llamma">llamma</a></li><li class="tag_F03v"><a class="tag_WK-t tagRegular_LXbV" href="/blog/tags/amm">amm</a></li></ul></div><div class="col margin-top--sm"><a href="https://github.com/lun-dao/LunDAO/tree/main/blog/2022-12-05-crvusd/crvusd.md" target="_blank" rel="noreferrer noopener" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_mS5F" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div></footer></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/end-of-lundao"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« <!-- -->LunDAO 的結尾</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/diamond101-4"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Diamond 101 (4)<!-- --> »</div></a></div></nav></main><div class="col col--2"><div class="tableOfContents_vrFS thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#前情提要" class="table-of-contents__link toc-highlight">前情提要</a><ul><li><a href="#抵押品穩定幣" class="table-of-contents__link toc-highlight">抵押品穩定幣</a></li><li><a href="#dai-的清算方式" class="table-of-contents__link toc-highlight">DAI 的清算方式</a></li><li><a href="#傳統-amm-的運作方式" class="table-of-contents__link toc-highlight">傳統 AMM 的運作方式</a></li></ul></li><li><a href="#llamma" class="table-of-contents__link toc-highlight">LLAMMA</a></li><li><a href="#透過測試案例解釋實際運作方式" class="table-of-contents__link toc-highlight">透過測試案例解釋實際運作方式</a><ul><li><a href="#波段-band" class="table-of-contents__link toc-highlight">波段 (band)</a></li><li><a href="#存入抵押品來鑄造-crvusd" class="table-of-contents__link toc-highlight">存入抵押品來鑄造 crvUSD</a></li><li><a href="#跟-llammas-交易折扣的-weth-抵押品" class="table-of-contents__link toc-highlight">跟 LLAMMAS 交易折扣的 WETH 抵押品</a></li></ul></li><li><a href="#crvusd-的穩定機制-pegkeeper" class="table-of-contents__link toc-highlight">crvUSD 的穩定機制 PegKeeper</a></li><li><a href="#結論與疑問" class="table-of-contents__link toc-highlight">結論與疑問</a><ul><li><a href="#llamma-清算機制" class="table-of-contents__link toc-highlight">LLAMMA 清算機制</a></li><li><a href="#pegkeeper-穩定機制" class="table-of-contents__link toc-highlight">PegKeeper 穩定機制</a></li><li><a href="#結語" class="table-of-contents__link toc-highlight">結語</a></li></ul></li></ul></div></div></div></div></div><footer class="footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">關於</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>關於 LunDAO<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/publish-guideline">投稿文章</a></li><li class="footer__item"><a class="footer__link-item" href="/blog">閱讀文章</a></li><li class="footer__item"><a class="footer__link-item" href="/docs/request-for-article">文章提案</a></li><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/blob/main/CONTRIBUTING.md" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>社群貢獻指南<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div><div class="col footer__col"><div class="footer__title">DAO治理</div><ul class="footer__items"><li class="footer__item"><a href="https://coordinape.com/" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>貢獻投票 (Coordinape)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://snapshot.org/#/lundao.eth" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>治理投票 (Snapshot)<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a class="footer__link-item" href="/docs/treasury">社群金庫</a></li></ul></div><div class="col footer__col"><div class="footer__title">社群</div><ul class="footer__items"><li class="footer__item"><a href="https://github.com/lun-dao/LunDAO/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>討論區<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li><li class="footer__item"><a href="https://discord.gg/9s3RQmajBu" target="_blank" rel="noopener noreferrer" class="footer__link-item"><span>Discord<svg width="13.5" height="13.5" aria-hidden="true" viewBox="0 0 24 24" class="iconExternalLink_wgqa"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"></path></svg></span></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2024 LunDAO. Built with Docusaurus.</div></div></div></footer></div>
<script src="/assets/js/runtime~main.67d47840.js"></script>
<script src="/assets/js/main.2d5310ba.js"></script>
</body>
</html>